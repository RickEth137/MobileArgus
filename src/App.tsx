import "./utils/polyfill"
import { useState, useEffect, useRef } from "react"
import { Keypair, PublicKey } from "@solana/web3.js"
import { connection, createNewWallet, getKeypairFromSecret, SimpleWallet, getBalance, sendSol, deriveWalletFromSeed } from "./utils/solana"
import { createSquad, createTransferProposal, createSwapProposal, approveProposal, executeProposal, executeSwapProposal, getTransactionPda, getNextTransactionIndex } from "./utils/squads"
import { getBrowserLocation } from "./utils/geo"
import { getServerConfig, requestServerApproval, activateGeoGuard, registerVault, checkVaultExists, registerUser, getSecuritySettings, updateSecurityLayer, getExchangeRates, CURRENCY_INFO, type ExchangeRates, enrollVoiceFingerprint, getVoiceFingerprint, checkVoiceEnabled, disableVoiceAuth, updateHomeLocation, verifyServerPassword, setServerPassword, checkServerPassword, GeoFenceError } from "./utils/api"
import { fetchTransactionHistory, type Transaction } from "./utils/transactions"
import { useStorage } from "./hooks/useStorage"
import { pwaStorage, getMnemonic, saveMnemonic, verifyLocalPassword, savePasswordHash, openInNewTab, isExtensionContext, getAssetUrl } from "./utils/pwa-storage"
import bs58 from "bs58"
import { QRCodeSVG } from "qrcode.react"
import { fetchUserTokens, getSolanaPrice, fetchTokenDetailData, type TokenData, type TokenDetailData, cacheSuccessfulLogo, cacheFailedLogo } from "./utils/tokens"
import UnlockScreen from "./components/UnlockScreen"
import PlanetAvatar from "./components/PlanetAvatar"
import SecretParticles from "./components/SecretParticles"
import Globe from "./components/Globe"
import { PnlShareCard } from "./components/PnlShareCard"
import { subscribeToAccountChanges, unsubscribeFromAccountChanges, subscribeToLogs } from "./utils/subscriptions"
import { t, LANGUAGE_FROM_NAME, type Language } from "./utils/i18n"
import { FEATURES, getComingSoonMessage } from "./utils/feature-flags"
import { ComingSoonWrapper, ComingSoonBadge } from "./components/ComingSoon"
import { VoiceEnrollmentModal } from "./components/VoiceEnrollmentModal"
import { 
  startVoiceEnrollment,
  enrollVoiceSample, 
  completeVoiceEnrollment, 
  verifyVoice, 
  checkMicrophonePermission, 
  requestMicrophonePermission,
  VOICE_SETUP_CONFIG 
} from "./utils/voice-auth"
import { 
  getSwapQuote, 
  buildSwapTransaction, 
  getSwapInstructions,
  executeSwap,
  executeSwapJito,
  executeUltraSwapFull,
  executeSwapWithFallback,
  getUltraSwapOrder,
  formatAmount,
  formatAmountDisplay, 
  formatRoute, 
  calculateRate, 
  getRouteDexes,
  getPriceImpactLevel, 
  estimateNetworkFee,
  getSwapErrorMessage,
  getSwapFeeAccount,
  SLIPPAGE_PRESETS, 
  PRIORITY_LEVELS,
  type SwapQuote,
  type PriceImpactLevel,
  type UltraSwapOrder,
} from "./utils/swap"

// WebUSB type declarations
interface USBDevice {
  vendorId: number
  productId: number
  serialNumber?: string
  productName?: string
  manufacturerName?: string
  open(): Promise<void>
  close(): Promise<void>
}

interface USB {
  requestDevice(options: { filters: any[] }): Promise<USBDevice>
  getDevices(): Promise<USBDevice[]>
}

declare global {
  interface Navigator {
    usb?: USB
  }
}

// Minimum SOL to reserve for transaction fees when swapping SOL
// Covers: base fee (~0.000005) + priority fee (up to 0.001) + token account rent (~0.002) 
// + wSOL temp account (~0.002) + buffer for compute units
const MIN_SOL_RESERVE_FOR_FEES = 0.01 // 0.01 SOL = 10,000,000 lamports

// iOS Safari compatible clipboard copy function - MUST be synchronous for iOS
const copyToClipboardSafe = (text: string): boolean => {
  // Create a textarea element
  const textArea = document.createElement('textarea');
  textArea.value = text;
  
  // Make it invisible but part of the document
  textArea.style.position = 'fixed';
  textArea.style.left = '0';
  textArea.style.top = '0';
  textArea.style.width = '2em';
  textArea.style.height = '2em';
  textArea.style.padding = '0';
  textArea.style.border = 'none';
  textArea.style.outline = 'none';
  textArea.style.boxShadow = 'none';
  textArea.style.background = 'transparent';
  textArea.style.fontSize = '16px'; // Prevents iOS zoom
  
  document.body.appendChild(textArea);
  
  // iOS specific: need to use setSelectionRange
  textArea.focus();
  textArea.setSelectionRange(0, text.length);
  
  let success = false;
  try {
    success = document.execCommand('copy');
    console.log('[Clipboard] execCommand result:', success);
  } catch (err) {
    console.error('[Clipboard] execCommand failed:', err);
  }
  
  document.body.removeChild(textArea);
  return success;
};

// Wallet account interface for HD wallets
interface WalletAccount {
  index: number
  name: string
  publicKey: string
  secretKey: string // bs58 encoded
  isWatchOnly?: boolean // For tracked wallets (no private key)
  isImported?: boolean // True if wallet was imported (not derived from main seed)
  isVault?: boolean // True if this wallet has an active Vault
  passwordHash?: string // Per-wallet password hash (for imported Vaults)
}

// --- Styles (GeoArgus Elegant Dark Theme) ---
// Mobile web app - always full screen
const isMobileWeb = typeof window !== 'undefined' && !window.chrome?.runtime?.id;
console.log('[Styles] isMobileWeb:', isMobileWeb, 'chrome.runtime?.id:', (window as any).chrome?.runtime?.id);

// Detect if user is on a mobile device
const isMobileDevice = typeof window !== 'undefined' && (
  /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
  (navigator.maxTouchPoints && navigator.maxTouchPoints > 2)
);
console.log('[Device] isMobileDevice:', isMobileDevice);

const styles = {
  container: {
    width: '100vw',
    maxWidth: '100vw',
    minHeight: '100dvh',
    height: '100dvh',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
    backgroundColor: '#121216',
    color: '#fff',
    display: 'flex',
    flexDirection: 'column' as const,
    overflowY: 'auto' as const,
    overflowX: 'hidden' as const,
    position: 'fixed' as const,
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    fontSize: 16, // Base font size for mobile
    paddingBottom: 'env(safe-area-inset-bottom, 0px)'
  },
  header: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: '16px 20px 14px 20px',
    minHeight: 56,
    background: 'rgba(18, 18, 22, 0.95)',
    backdropFilter: 'blur(20px)',
    borderBottom: '1px solid rgba(255, 255, 255, 0.06)',
    position: 'relative' as const,
    zIndex: 1
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: 600,
    color: '#fff',
    display: 'flex',
    alignItems: 'center',
    gap: 8
  },
  balanceContainer: {
    display: 'flex',
    flexDirection: 'column' as const,
    alignItems: 'center',
    padding: '28px 20px 24px 20px',
    background: 'transparent',
    position: 'relative' as const,
    zIndex: 1
  },
  balanceLabel: {
    fontSize: 14,
    color: 'rgba(255, 255, 255, 0.5)',
    marginBottom: 10,
    textTransform: 'uppercase' as const,
    letterSpacing: '0.5px'
  },
  balanceValue: {
    fontSize: 48,
    fontWeight: 700,
    color: '#fff',
    letterSpacing: '-0.02em'
  },
  balanceChange: {
    fontSize: 14,
    color: '#10b981',
    marginTop: 10,
    fontWeight: 500,
    background: 'rgba(16, 185, 129, 0.1)',
    padding: '6px 12px',
    borderRadius: 20,
    border: '1px solid rgba(16, 185, 129, 0.2)'
  },
  actionButtons: {
    display: 'flex',
    justifyContent: 'space-around',
    padding: '8px 20px 24px 20px',
    position: 'relative' as const,
    zIndex: 1
  },
  actionButton: {
    display: 'flex',
    flexDirection: 'column' as const,
    alignItems: 'center',
    background: 'none',
    border: 'none',
    cursor: 'pointer',
    gap: 10,
    transition: 'transform 0.2s ease',
    minWidth: 70
  },
  actionIcon: {
    width: 60,
    height: 60,
    borderRadius: 18,
    backgroundColor: 'rgba(255, 255, 255, 0.06)',
    border: '1px solid rgba(255, 255, 255, 0.1)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: 22,
    color: '#fff',
    transition: 'all 0.2s ease'
  },
  actionLabel: {
    fontSize: 13,
    color: 'rgba(255, 255, 255, 0.7)',
    fontWeight: 500
  },
  tabs: {
    display: 'flex',
    padding: '0 20px',
    gap: 28,
    marginBottom: 16,
    borderBottom: '1px solid rgba(255, 255, 255, 0.08)',
    position: 'relative' as const,
    zIndex: 1,
    background: 'rgba(10, 10, 15, 0.6)'
  },
  tab: {
    fontSize: 16,
    fontWeight: 600,
    color: '#fff',
    paddingBottom: 14,
    borderBottom: '2px solid #fff',
    cursor: 'pointer',
    marginBottom: -1
  },
  inactiveTab: {
    fontSize: 16,
    fontWeight: 500,
    color: 'rgba(255, 255, 255, 0.4)',
    paddingBottom: 14,
    cursor: 'pointer',
    marginBottom: -1,
    transition: 'color 0.2s ease'
  },
  tokenList: {
    padding: '0 20px',
    position: 'relative' as const,
    zIndex: 1
  },
  tokenItem: {
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    padding: '16px 18px',
    marginBottom: 10,
    background: 'rgba(255, 255, 255, 0.03)',
    borderRadius: 16,
    border: '1px solid rgba(255, 255, 255, 0.06)',
    cursor: 'pointer',
    transition: 'all 0.2s ease',
    minHeight: 72
  },
  tokenIcon: {
    width: 48,
    height: 48,
    borderRadius: 14,
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    border: '1px solid rgba(255, 255, 255, 0.1)',
    marginRight: 14,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: 20
  },
  tokenInfo: {
    flex: 1
  },
  tokenName: {
    fontSize: 17,
    fontWeight: 600,
    color: '#fff',
    marginBottom: 4
  },
  tokenAmount: {
    fontSize: 14,
    color: 'rgba(255, 255, 255, 0.5)'
  },
  tokenValue: {
    textAlign: 'right' as const
  },
  tokenValueText: {
    fontSize: 17,
    fontWeight: 600,
    color: '#fff',
    marginBottom: 4
  },
  tokenChange: {
    fontSize: 14,
    color: '#10b981',
    textAlign: 'right' as const
  },
  card: {
    background: '#1a1a1f',
    padding: 24,
    borderRadius: 20,
    marginBottom: 20,
    border: '1px solid rgba(255, 255, 255, 0.1)',
    boxShadow: '0 8px 32px rgba(0, 0, 0, 0.6)'
  },
  button: {
    width: '100%',
    padding: 18,
    minHeight: 56,
    background: 'linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%)',
    color: '#000000',
    border: 'none',
    borderRadius: 16,
    cursor: 'pointer',
    fontWeight: 600,
    fontSize: 17,
    marginTop: 16,
    transition: 'all 0.3s ease',
    boxShadow: '0 4px 20px rgba(255, 255, 255, 0.15)'
  },
  secondaryButton: {
    background: 'rgba(255, 255, 255, 0.05)',
    border: '1px solid rgba(255, 255, 255, 0.15)',
    color: '#fff',
    boxShadow: 'none'
  },
  input: {
    width: '100%',
    padding: 16,
    minHeight: 52,
    marginBottom: 14,
    borderRadius: 14,
    border: '1px solid rgba(255, 255, 255, 0.1)',
    background: 'rgba(255, 255, 255, 0.05)',
    color: '#fff',
    fontSize: 17,
    boxSizing: 'border-box' as const,
    transition: 'all 0.3s ease'
  },
  label: {
    fontSize: 14,
    color: 'rgba(255, 255, 255, 0.6)',
    marginBottom: 10,
    display: 'block',
    fontWeight: 500
  },
  value: {
    fontSize: 15,
    wordBreak: 'break-all' as const,
    fontFamily: 'monospace',
    color: 'rgba(255, 255, 255, 0.8)'
  },
  seedBox: {
    background: 'rgba(0, 0, 0, 0.5)',
    padding: 16,
    borderRadius: 20,
    border: '1px solid rgba(255, 255, 255, 0.08)',
    marginBottom: 24,
    display: 'grid',
    gridTemplateColumns: 'repeat(3, 1fr)',
    gap: 10,
    width: '100%',
    boxSizing: 'border-box' as const,
    maxWidth: '100%',
    overflow: 'hidden'
  },
  seedWord: {
    background: 'rgba(255, 255, 255, 0.06)',
    padding: '12px 8px',
    borderRadius: 12,
    fontSize: 14,
    textAlign: 'center' as const,
    color: 'rgba(255, 255, 255, 0.9)',
    fontFamily: 'monospace',
    fontWeight: 500,
    border: '1px solid rgba(255, 255, 255, 0.08)',
    minWidth: 0,
    overflow: 'hidden',
    textOverflow: 'ellipsis',
    whiteSpace: 'nowrap' as const
  },
  addressPill: {
    background: 'rgba(255, 255, 255, 0.06)',
    padding: '8px 14px',
    borderRadius: 20,
    fontSize: 13,
    color: 'rgba(255, 255, 255, 0.85)',
    cursor: 'pointer',
    display: 'flex',
    alignItems: 'center',
    gap: 8,
    border: '1px solid rgba(255, 255, 255, 0.1)',
    marginLeft: 0,
    transition: 'all 0.2s ease',
    minHeight: 36,
    WebkitTapHighlightColor: 'transparent',
    touchAction: 'manipulation'
  },
  tooltip: {
    position: 'absolute' as const,
    top: 'calc(100% + 24px)',
    left: -52,
    background: '#131318',
    border: '1px solid rgba(255, 255, 255, 0.15)',
    borderRadius: 16,
    padding: 8,
    width: 260,
    zIndex: 9999,
    boxShadow: '0 12px 40px rgba(0, 0, 0, 1)'
  },
  tooltipRow: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: '10px 12px',
    borderRadius: 12,
    cursor: 'pointer',
    transition: 'background 0.2s ease',
    background: '#131318'
  },
  tooltipLabel: {
    fontSize: 11,
    color: 'rgba(255, 255, 255, 0.5)',
    marginBottom: 3,
    textTransform: 'uppercase' as const,
    letterSpacing: '0.3px'
  },
  tooltipValue: {
    fontSize: 13,
    color: '#fff',
    fontFamily: 'monospace'
  }
}

const shortenAddress = (address: string) => {
    if (!address) return "";
    return `${address.slice(0, 4)}...${address.slice(-4)}`;
}

// Coming Soon Layer Row - shows a disabled layer with "Soon" badge
const ComingSoonLayerRow = ({ 
  icon, 
  title, 
  subtitle
}: { 
  icon: React.ReactNode; 
  title: string; 
  subtitle: string;
}) => {
  return (
    <div 
      style={{ 
        display: 'flex', 
        alignItems: 'center', 
        justifyContent: 'space-between', 
        padding: '12px 16px',
        borderTop: '1px solid rgba(255, 255, 255, 0.06)',
        opacity: 0.5
      }}
    >
      <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
        <div style={{
          width: 32,
          height: 32,
          borderRadius: 8,
          background: 'rgba(255, 255, 255, 0.05)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }}>
          {icon}
        </div>
        <div>
          <div style={{ 
            fontSize: 13, 
            color: '#fff', 
            fontWeight: 500,
            display: 'flex',
            alignItems: 'center',
            gap: 8
          }}>
            {title}
            <span style={{
              padding: '2px 6px',
              background: 'rgba(255, 255, 255, 0.08)',
              border: '1px solid rgba(255, 255, 255, 0.12)',
              borderRadius: 4,
              fontSize: 8,
              fontWeight: 600,
              color: 'rgba(255, 255, 255, 0.5)',
              textTransform: 'uppercase' as const
            }}>
              Soon
            </span>
          </div>
          <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.3)' }}>
            {subtitle}
          </div>
        </div>
      </div>
      <div style={{
        padding: '6px 12px',
        background: 'rgba(255, 255, 255, 0.03)',
        border: '1px solid rgba(255, 255, 255, 0.08)',
        borderRadius: 8,
        fontSize: 11,
        color: 'rgba(255, 255, 255, 0.3)',
        fontWeight: 500
      }}>
        Locked
      </div>
    </div>
  );
};

function IndexPopup() {
  // Persistent Storage
  const [storedSecret, setStoredSecret] = useStorage<string>("geo_vault_secret")
  const [multisigPda, setMultisigPda] = useStorage<string>("geo_vault_multisig")
  const [vaultPda, setVaultPda] = useStorage<string>("geo_vault_vault")

  // Address Book types
  interface SavedAddress {
    address: string
    label: string
    lastUsed?: number
  }

  // Dynamic container style - always full height for mobile web
  const containerStyle = {
    ...styles.container,
    height: '100dvh',
    minHeight: '100dvh'
  };

  const [walletStatus, setWalletStatus] = useState<{ isOnboarded: boolean; isLocked: boolean } | null>(null)
  
  // Check if wallet should be locked on startup
  useEffect(() => {
    const checkLockStatus = () => {
      const hasPasswordHash = localStorage.getItem('geovault_password_hash');
      const isUnlocked = localStorage.getItem('geovault_wallet_unlocked');
      const hasWallet = localStorage.getItem('geovault_geo_vault_secret') || localStorage.getItem('geovault_geo_vault_accounts');
      
      if (hasWallet && hasPasswordHash && !isUnlocked) {
        // Wallet exists with password, but not unlocked - show lock screen
        setWalletStatus({ isOnboarded: true, isLocked: true });
      } else if (hasWallet) {
        // Wallet exists and is unlocked (or no password set)
        setWalletStatus({ isOnboarded: true, isLocked: false });
      } else {
        // No wallet
        setWalletStatus({ isOnboarded: false, isLocked: false });
      }
    };
    checkLockStatus();
  }, []);
  
  const [view, setView] = useState<"seed" | "main" | "settings" | "import" | "send" | "receive" | "swap" | "degen" | "buy" | "activity" | "vault_rules" | "activation_disclosure" | "activation_loading" | "manage-wallets" | "edit-wallet" | "token-detail" | "address-book">("main")
  const [wallet, setWallet] = useState<Keypair | null>(null)
  const [selectedToken, setSelectedToken] = useState<TokenData | null>(null)
  const [tokenDetailLoading, setTokenDetailLoading] = useState(false)
  const [tokenDetailData, setTokenDetailData] = useState<TokenDetailData | null>(null)
  const [mnemonic, setMnemonic] = useState<string>("")
  const [importSeed, setImportSeed] = useState("")
  const [status, setStatus] = useState("")
  const [recipient, setRecipient] = useState("")
  const [amount, setAmount] = useState("")
  const [balance, setBalance] = useState<number>(0)
  const [vaultBalance, setVaultBalance] = useState<number>(0)
  const [isLoading, setIsLoading] = useState(false)
  const [showPrivateKey, setShowPrivateKey] = useState(false)
  const [tokens, setTokens] = useState<TokenData[]>([])
  const [solPrice, setSolPrice] = useState<number>(0)
  // Send/Receive/Swap flow state
  const [sendStep, setSendStep] = useState<"select" | "details" | "confirm" | "success">("select")
  const [lastTxSignature, setLastTxSignature] = useState<string | null>(null)
  const [lastTxTime, setLastTxTime] = useState<number | null>(null)
  const [receiveSelectedToken, setReceiveSelectedToken] = useState<TokenData | null>(null)
  const [tokenSearchQuery, setTokenSearchQuery] = useState("")
  // Swap state
  const [swapFromToken, setSwapFromToken] = useState<TokenData | null>(null)
  const [swapToToken, setSwapToToken] = useState<{ mint: string; symbol: string; name: string; logoURI?: string; decimals?: number; bannerURI?: string; price?: number; marketCap?: number; liquidity?: number; volume24h?: number; priceChange24h?: number; dexId?: string; socials?: { twitter?: string; telegram?: string; discord?: string; website?: string } } | null>(null)
  const [swapAmount, setSwapAmount] = useState("")
  const [swapQuote, setSwapQuote] = useState<SwapQuote | null>(null)
  const [swapLoading, setSwapLoading] = useState(false)
  const [swapSelectingToken, setSwapSelectingToken] = useState<"from" | "to" | null>(null)
  const [searchedToken, setSearchedToken] = useState<{ mint: string; symbol: string; name: string; logoURI?: string; decimals?: number; bannerURI?: string; price?: number; marketCap?: number; liquidity?: number; volume24h?: number; priceChange24h?: number; dexId?: string; socials?: { twitter?: string; telegram?: string; discord?: string; website?: string } } | null>(null)
  const [searchingToken, setSearchingToken] = useState(false)
  // Swap token detail data (for rich info cards)
  const [swapFromTokenDetail, setSwapFromTokenDetail] = useState<TokenDetailData | null>(null)
  const [swapToTokenDetail, setSwapToTokenDetail] = useState<TokenDetailData | null>(null)
  const [loadingSwapTokenDetail, setLoadingSwapTokenDetail] = useState<"from" | "to" | null>(null)
  // Enhanced swap settings
  const [swapSlippage, setSwapSlippage] = useState<number>(SLIPPAGE_PRESETS.NORMAL) // 50 bps = 0.5%
  const [swapCustomSlippage, setSwapCustomSlippage] = useState<string>("")
  const [swapPriorityLevel, setSwapPriorityLevel] = useState<keyof typeof PRIORITY_LEVELS>("NONE")
  const [swapShowSettings, setSwapShowSettings] = useState(false)
  // Degen Mode settings
  const [degenMode, setDegenMode] = useState(false)
  const [sniperShortcuts, setSniperShortcuts] = useState(false)
  const [snipeAmounts, setSnipeAmounts] = useState<[string, string, string, string]>(['0.1', '0.5', '1.0', '5.0'])
  // Enhanced detected token with DexScreener real-time data
  const [detectedToken, setDetectedToken] = useState<{ 
    address: string; 
    symbol: string; 
    name: string; 
    logoURI?: string;
    headerURI?: string; // Banner/header image from DexScreener
    // DexScreener real-time data
    priceUsd?: number;
    priceNative?: number; // Price in SOL
    marketCap?: number;
    fdv?: number; // Fully diluted valuation
    volume24h?: number;
    liquidity?: number;
    priceChange5m?: number;
    priceChange1h?: number;
    priceChange6h?: number;
    priceChange24h?: number;
    txns24h?: { buys: number; sells: number };
    pairAddress?: string;
    dexId?: string;
    lastUpdated?: number;
  } | null>(null)
  const [isLoadingDetectedToken, setIsLoadingDetectedToken] = useState(false)
  const [degenAutoRefresh, setDegenAutoRefresh] = useState(true) // Auto-refresh price data
  const [degenRefreshInterval, setDegenRefreshInterval] = useState(3000) // 3 seconds default
  // Degen trade state
  const [degenMevProtection, setDegenMevProtection] = useState(true)
  const [degenSlippage, setDegenSlippage] = useState(1500) // 15% default for memecoins - they're volatile!
  const [degenBuyAmounts] = useState(['0.1', '0.2', '0.5', '1'])
  const [degenSellPercentages] = useState(['10', '25', '50', '100'])
  const [degenCustomBuy, setDegenCustomBuy] = useState('')
  const [degenCustomSell, setDegenCustomSell] = useState('')
  const [degenTradeExecuting, setDegenTradeExecuting] = useState<string | null>(null) // Track which button is executing
  const [degenTokenBalance, setDegenTokenBalance] = useState<number>(0)
  const [degenTokenDecimals, setDegenTokenDecimals] = useState<number>(6) // Default to 6 for pump.fun tokens
  
  // Trade type for history
  type DegenTrade = { 
    type: 'buy' | 'sell'; 
    amount: string; 
    success: boolean; 
    signature?: string; 
    tokenAmount?: number; 
    solAmount?: number; 
    symbol?: string;
    tokenAddress?: string;
    tokenLogo?: string;
    priceUsd?: number;
    costBasisAtTrade?: { totalSolSpent: number; totalTokensBought: number } | null;
    timestamp: number;
  };
  
  // Trade history - keeps all trades for current session
  const [degenTradeHistory, setDegenTradeHistory] = useState<DegenTrade[]>([])
  const [selectedTrade, setSelectedTrade] = useState<DegenTrade | null>(null)
  
  // PNL tracking - stores total cost basis and tokens bought (persisted per token)
  const [degenCostBasis, setDegenCostBasis] = useState<{ totalSolSpent: number; totalTokensBought: number } | null>(null)
  const [showPnlCard, setShowPnlCard] = useState(false)
  const [showTradeSummary, setShowTradeSummary] = useState(false)
  
  // Helper to save cost basis to storage
  const saveCostBasis = async (tokenAddress: string, costBasis: { totalSolSpent: number; totalTokensBought: number } | null) => {
    try {
      const key = `cost_basis_${tokenAddress}`;
      if (costBasis) {
        await pwaStorage.local.set({ [key]: costBasis });
        console.log('[PNL] Saved cost basis for', tokenAddress, costBasis);
      } else {
        await pwaStorage.local.remove(key);
      }
    } catch (e) {
      console.error('[PNL] Failed to save cost basis:', e);
    }
  };
  
  // Helper to load cost basis from storage
  const loadCostBasis = async (tokenAddress: string): Promise<{ totalSolSpent: number; totalTokensBought: number } | null> => {
    try {
      const key = `cost_basis_${tokenAddress}`;
      const result = await pwaStorage.local.get(key);
      const costBasis = result[key] || null;
      console.log('[PNL] Loaded cost basis for', tokenAddress, costBasis);
      return costBasis;
    } catch (e) {
      console.error('[PNL] Failed to load cost basis:', e);
      return null;
    }
  };
  
  // Swap execution state
  const [swapExecuting, setSwapExecuting] = useState(false)    // Transaction in progress
  const [swapResult, setSwapResult] = useState<{ 
    success: boolean; 
    signature?: string; 
    error?: string;
    errorType?: 'insufficient_master_funds' | 'insufficient_vault_funds' | 'network' | 'stale_route' | 'slippage' | 'unknown';
    neededAmount?: number;
    currentAmount?: number;
  } | null>(null)
  // Buy crypto state
  const [buySelectedToken, setBuySelectedToken] = useState<{ symbol: string; name: string; logoURI: string } | null>(null)
  const [buyAmount, setBuyAmount] = useState<string>("50")
  const [buyPaymentMethod, setBuyPaymentMethod] = useState<"card" | "apple_pay" | "google_pay">("card")
  // Tokens available to buy via MoonPay on Solana
  const buyableTokens = [
    { symbol: "SOL", name: "Solana", logoURI: "https://assets.coingecko.com/coins/images/4128/standard/solana.png", moonpayCode: "sol" },
    { symbol: "USDC", name: "USD Coin", logoURI: "https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/logo.png", moonpayCode: "usdc_sol" },
  ]
  // ARGUS token info - Real contract address
  const ARGUS_TOKEN = {
    mint: "EbD3Qptmezx1mEwMfa88q5L5CrA4QrBwmvvZUhEapump",
    symbol: "ARGUS", 
    name: "ARGUS Protocol",
    logoURI: "/assets/arguslogo.png",
    decimals: 6
  }
  const [popularTokens] = useState([
    { mint: "So11111111111111111111111111111111111111112", symbol: "SOL", name: "Solana", logoURI: "https://assets.coingecko.com/coins/images/4128/standard/solana.png", decimals: 9 },
    ARGUS_TOKEN,
    { mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v", symbol: "USDC", name: "USD Coin", logoURI: "https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/logo.png", decimals: 6 },
    { mint: "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB", symbol: "USDT", name: "Tether USD", logoURI: "https://coin-images.coingecko.com/coins/images/325/large/Tether.png", decimals: 6 },
    { mint: "JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN", symbol: "JUP", name: "Jupiter", logoURI: "https://static.jup.ag/jup/icon.png", decimals: 6 },
    { mint: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263", symbol: "BONK", name: "Bonk", logoURI: "https://arweave.net/hQiPZOsRZXGXBJd_82PhVdlM_hACsT_q6wqwf5cSY7I", decimals: 5 },
  ])
  const [showAddressTooltip, setShowAddressTooltip] = useState(false)
  const [copiedState, setCopiedState] = useState<"master" | "vault" | null>(null)
  const [activeTab, setActiveTab] = useState<"tokens" | "activity">("tokens")
  const [activeWallet, setActiveWallet] = useState<"master" | "vault">("master")
  const [transactions, setTransactions] = useState<Transaction[]>([])
  const [loadingTxs, setLoadingTxs] = useState(false)
  // Transaction Detail Modal
  const [selectedTransaction, setSelectedTransaction] = useState<Transaction | null>(null)
  const [showGeoTooltip, setShowGeoTooltip] = useState(false)
  const [showSidebar, setShowSidebar] = useState(false)
  const [failedLogos, setFailedLogos] = useState<Set<string>>(new Set())
  const [walletAccounts, setWalletAccounts] = useState<WalletAccount[]>([])
  const [activeAccountIndex, setActiveAccountIndex] = useState(0)
  const [isAddingWallet, setIsAddingWallet] = useState(false)
  const [showAddWalletModal, setShowAddWalletModal] = useState(false)
  const [addWalletView, setAddWalletView] = useState<"menu" | "import-seed" | "import-pk" | "create" | "track">("menu")
  const [importInput, setImportInput] = useState("")
  const [trackAddressInput, setTrackAddressInput] = useState("")
  const [newWalletName, setNewWalletName] = useState("")
  // Onboarding flow state (for new wallet creation)
  const [onboardingStep, setOnboardingStep] = useState<"welcome" | "username" | "password" | "seed" | "verify">("welcome")
  const [onboardingUsername, setOnboardingUsername] = useState("")
  const [onboardingPassword, setOnboardingPassword] = useState("")
  const [onboardingPasswordConfirm, setOnboardingPasswordConfirm] = useState("")
  const [onboardingSeedSaved, setOnboardingSeedSaved] = useState(false)
  const [onboardingGeneratedMnemonic, setOnboardingGeneratedMnemonic] = useState("")
  const [onboardingGeneratedKeypair, setOnboardingGeneratedKeypair] = useState<Keypair | null>(null)
  // Verification step state
  const [verifyFirstWordOptions, setVerifyFirstWordOptions] = useState<string[]>([])
  const [verifyLastWordOptions, setVerifyLastWordOptions] = useState<string[]>([])
  const [selectedFirstWord, setSelectedFirstWord] = useState<string | null>(null)
  const [selectedLastWord, setSelectedLastWord] = useState<string | null>(null)
  const [firstWordCorrect, setFirstWordCorrect] = useState<boolean | null>(null)
  const [lastWordCorrect, setLastWordCorrect] = useState<boolean | null>(null)
  const [verifyError, setVerifyError] = useState("")
  // Vault password setup (when enabling security layers on a wallet without server password)
  const [vaultPasswordSetup, setVaultPasswordSetup] = useState<{
    show: boolean
    publicKey: string
    password: string
    confirmPassword: string
    error: string
    isSubmitting: boolean
    layerToEnable: 'voice' | 'geo' | 'wifi' | 'biometric' | null
  }>({ show: false, publicKey: '', password: '', confirmPassword: '', error: '', isSubmitting: false, layerToEnable: null })
  const [showSeedPhrase, setShowSeedPhrase] = useState(false)
  const [seedPhrase, setSeedPhrase] = useState("")
  const [editingWallet, setEditingWallet] = useState<WalletAccount | null>(null)
  const [editWalletName, setEditWalletName] = useState("")
  const [isEditingName, setIsEditingName] = useState(false)
  const [showEditPrivateKey, setShowEditPrivateKey] = useState(false)
  const [copiedSeed, setCopiedSeed] = useState(false)
  const [copiedKey, setCopiedKey] = useState(false)
  const [showLinkSeedModal, setShowLinkSeedModal] = useState(false)
  const [linkSeedInput, setLinkSeedInput] = useState("")
  const [linkSeedPassword, setLinkSeedPassword] = useState("")
  const [isLinkingSeed, setIsLinkingSeed] = useState(false)
  const [noSeedStored, setNoSeedStored] = useState(false)
  // Vault Import state (for requiring password when importing a vault)
  const [importVaultDetected, setImportVaultDetected] = useState<{
    detected: boolean
    publicKey: string
    keypair: Keypair | null
    walletName: string
  }>({ detected: false, publicKey: '', keypair: null, walletName: '' })
  const [importVaultPassword, setImportVaultPassword] = useState("")
  const [importVaultError, setImportVaultError] = useState("")
  const [isVerifyingImportPassword, setIsVerifyingImportPassword] = useState(false)
  const [isCheckingVault, setIsCheckingVault] = useState(false)
  // Change Password state
  const [showChangePassword, setShowChangePassword] = useState(false)
  const [currentPassword, setCurrentPassword] = useState("")
  const [newPassword, setNewPassword] = useState("")
  const [confirmNewPassword, setConfirmNewPassword] = useState("")
  const [changePasswordError, setChangePasswordError] = useState("")
  const [isChangingPassword, setIsChangingPassword] = useState(false)
  const [changePasswordSuccess, setChangePasswordSuccess] = useState(false)
  const [showCurrentPassword, setShowCurrentPassword] = useState(false)
  const [showNewPassword, setShowNewPassword] = useState(false)
  const [showConfirmPassword, setShowConfirmPassword] = useState(false)
  const [currentPasswordShake, setCurrentPasswordShake] = useState(false)
  const [currentPasswordVerified, setCurrentPasswordVerified] = useState(false)
  const [verifyingCurrentPassword, setVerifyingCurrentPassword] = useState(false)
  // Voice Unlock state
  const [voiceUnlockEnabled, setVoiceUnlockEnabled] = useState(false)
  const [showVoiceSetup, setShowVoiceSetup] = useState(false)
  const [voiceSetupStep, setVoiceSetupStep] = useState(0) // 0-2 for 3 samples
  const [voiceSetupStatus, setVoiceSetupStatus] = useState("")
  const [isRecordingVoice, setIsRecordingVoice] = useState(false)
  const [voiceSamplesCollected, setVoiceSamplesCollected] = useState<boolean[]>([false, false, false])
  const [voiceSetupError, setVoiceSetupError] = useState("")
  const [voiceWaveformBars, setVoiceWaveformBars] = useState<number[]>([0.3, 0.5, 0.7, 0.4, 0.6, 0.8, 0.5, 0.3, 0.6, 0.4, 0.7, 0.5])
  // Preferences state (persisted)
  const [showPreferences, setShowPreferences] = useState<false | 'language' | 'currency'>(false)
  const [preferredLanguage, setPreferredLanguage] = useStorage("preferredLanguage", "English")
  const [preferredCurrency, setPreferredCurrency] = useStorage("preferredCurrency", "United States Dollar")
  // Exchange rates cache
  const [exchangeRates, setExchangeRates] = useState<ExchangeRates | null>(null)
  // Address Book state (persisted)
  const [addressBook, setAddressBook] = useStorage<SavedAddress[]>("addressBook", [])
  const [recentAddresses, setRecentAddresses] = useStorage<SavedAddress[]>("recentAddresses", [])
  const [showAddressModal, setShowAddressModal] = useState(false)
  const [editingAddress, setEditingAddress] = useState<SavedAddress | null>(null)
  const [addressLabelInput, setAddressLabelInput] = useState("")
  const [addressInput, setAddressInput] = useState("")
  const [addressBookSearch, setAddressBookSearch] = useState("")
  const [addressBookReturnView, setAddressBookReturnView] = useState<"settings" | "send">("settings")
  // Get current language code for translations
  const lang: Language = LANGUAGE_FROM_NAME[preferredLanguage] || 'en'
  
  // Editing wallet's vault data (for showing vault address & security in edit-wallet view)
  const [editingWalletVault, setEditingWalletVault] = useState<{ multisigPda: string; vaultPda: string } | null>(null)
  const [loadingEditingWalletVault, setLoadingEditingWalletVault] = useState(false)
  // Security Settings for edit-wallet view
  const [securitySettings, setSecuritySettings] = useState<{
    geoEnabled: boolean
    geoRange: number
    wifiEnabled: boolean
    wifiDevice: { bssid: string; ssid: string; userAgent: string } | null  // 2FA Mobile with WiFi
    bluetoothEnabled: boolean
    bluetoothDevice: { id: string; name: string } | null
    usbEnabled: boolean
    usbDevice: { vendorId: number; productId: number; serialNumber: string; productName: string } | null
    biometricEnabled: boolean
    biometricCredentialId: string | null
    voiceLayerEnabled: boolean  // Voice as security layer for transactions (separate from wallet unlock)
    voiceEnrolled: boolean      // Whether voice fingerprint exists (can enable voice layer)
  } | null>(null)
  const [loadingSecuritySettings, setLoadingSecuritySettings] = useState(false)
  const [updatingSecurityLayer, setUpdatingSecurityLayer] = useState<string | null>(null)
  // Vault Rules Configuration
  const [vaultRules, setVaultRules] = useState({
    geoEnabled: true,
    geoRange: 0.5, // km
    voiceEnabled: false,
    wifiEnabled: false,
    wifiDevice: null as { bssid: string; ssid: string; userAgent: string } | null,
    bluetoothEnabled: false,
    bluetoothDevice: null as { id: string; name: string } | null,
    usbEnabled: false,
    usbDevice: null as { vendorId: number; productId: number; serialNumber: string; productName: string } | null,
    biometricEnabled: false,
    password: '',
    confirmPassword: '',
    passwordError: ''
  })
  const [showUsbPicker, setShowUsbPicker] = useState(false)
  const [availableUsbDevices, setAvailableUsbDevices] = useState<USBDevice[]>([])
  const [confirmModal, setConfirmModal] = useState<{ show: boolean; title: string; message: string; onConfirm: (password?: string) => void; confirmText?: string; danger?: boolean; requirePassword?: boolean; iconType?: 'shield' | 'usb' | 'warning'; highlightText?: string }>({ show: false, title: '', message: '', onConfirm: () => {} })
  const [successModal, setSuccessModal] = useState<{ show: boolean; deviceName: string; type: 'enabled' | 'disabled'; deviceType?: 'usb' | 'bluetooth' | 'mobile' | 'biometric' | 'voice' }>({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' })
  const [usbErrorModal, setUsbErrorModal] = useState<{ show: boolean; deviceName: string }>({ show: false, deviceName: '' })
  const [bluetoothErrorModal, setBluetoothErrorModal] = useState<{ show: boolean; deviceName: string }>({ show: false, deviceName: '' })
  const [geoErrorModal, setGeoErrorModal] = useState<{ show: boolean; distance: number; requiredRange: number }>({ show: false, distance: 0, requiredRange: 0 })
  // 2FA Mobile QR Modal (supports wifi and biometric)
  const [mobileQRModal, setMobileQRModal] = useState<{
    show: boolean
    mode: 'setup' | 'verify'
    layerType: 'wifi' | 'biometric'  // Which security layer this is for
    sessionId: string | null
    qrData: string | null
    status: 'pending' | 'verified' | 'failed' | 'expired'
    publicKey: string | null
    onVerified?: () => void  // Callback when verification succeeds (for recalibration)
  }>({
    show: false,
    mode: 'setup',
    layerType: 'wifi',
    sessionId: null,
    qrData: null,
    status: 'pending',
    publicKey: null,
    onVerified: undefined
  })
  
  // Voice Enrollment Modal state
  const [voiceEnrollmentModal, setVoiceEnrollmentModal] = useState<{
    show: boolean
    mode: 'enroll' | 'verify' | 'verify-to-disable' | 'verify-for-tx'
    walletAddress: string
    enrolledFingerprint?: string
  }>({
    show: false,
    mode: 'enroll',
    walletAddress: ''
  })
  
  // Geo-fence recalibration state
  const [geoRecalibrationState, setGeoRecalibrationState] = useState<{
    isRecalibrating: boolean
    newLocation: { latitude: number; longitude: number; accuracy: number } | null
    error: string | null
  }>({
    isRecalibrating: false,
    newLocation: null,
    error: null
  })
  
  // Transaction Verification Modal with animated beams
  const [txVerificationModal, setTxVerificationModal] = useState<{
    show: boolean;
    enabledLayers: { voice: boolean; geo: boolean; usb: boolean; bluetooth: boolean; wifi: boolean; biometric: boolean };
    completedLayers: { voice: boolean; geo: boolean; usb: boolean; bluetooth: boolean; wifi: boolean; biometric: boolean };
    currentLayer: 'voice' | 'geo' | 'usb' | 'bluetooth' | 'wifi' | 'biometric' | 'proposal' | 'approval' | 'execute' | 'done' | null;
    error: string | null;
    pendingUserAction: boolean; // True when waiting for user to tap to verify
    biometricQrData?: string; // QR code data for biometric verification
    biometricSessionId?: string; // Session ID for biometric polling
    wifiQrData?: string; // QR code data for wifi verification
    wifiSessionId?: string; // Session ID for wifi polling
    txData?: {
      type: 'send' | 'swap' | 'sign';
      amount?: string;
      token?: string;
      toToken?: string;
      recipient?: string;
      recipientName?: string;
    };
  }>({
    show: false,
    enabledLayers: { voice: false, geo: true, usb: false, bluetooth: false, wifi: false, biometric: false },
    completedLayers: { voice: false, geo: false, usb: false, bluetooth: false, wifi: false, biometric: false },
    currentLayer: null,
    error: null,
    pendingUserAction: false,
    biometricQrData: undefined,
    biometricSessionId: undefined,
    wifiQrData: undefined,
    wifiSessionId: undefined,
    txData: undefined
  })
  
  // Refs for user-gesture-triggered verifications
  const pendingVerificationResolve = useRef<((result: boolean) => void) | null>(null)
  // Ref for voice verification callback during transaction security verification
  const pendingVoiceVerificationResolve = useRef<((result: { success: boolean; confidence?: number }) => void) | null>(null)
  // Simple Transaction Confirmation Modal (for master wallet - no security layers)
  const [simpleTxModal, setSimpleTxModal] = useState<{
    show: boolean;
    type: 'send' | 'swap';
    amount: string;
    token: string;
    toToken?: string;
    recipient?: string;
    recipientName?: string;
    status: 'confirm' | 'processing' | 'success' | 'error';
    error?: string;
    signature?: string;
    executionTime?: number;
    onConfirm: () => Promise<void>;
  }>({
    show: false,
    type: 'send',
    amount: '',
    token: '',
    status: 'confirm',
    onConfirm: async () => {}
  })
  const [confirmPassword, setConfirmPassword] = useState("")
  const [confirmPasswordError, setConfirmPasswordError] = useState("")
  const dropdownRef = useRef<HTMLDivElement>(null)
  const walletDropdownMenuRef = useRef<HTMLDivElement>(null)
  const geoToggleRef = useRef<HTMLDivElement>(null)
  const sidebarRef = useRef<HTMLDivElement>(null)
  const swapQuoteTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null)
  const swapAmountRef = useRef<string>("")

  // Currency conversion helper function
  const formatCurrency = (usdValue: number): string => {
    const currencyInfo = CURRENCY_INFO[preferredCurrency]
    if (!currencyInfo || preferredCurrency === 'United States Dollar') {
      return `$${usdValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
    }
    
    const rate = exchangeRates?.[currencyInfo.code as keyof ExchangeRates] || 1
    const convertedValue = usdValue * rate
    
    // Format based on currency
    if (['JPY', 'KRW'].includes(currencyInfo.code)) {
      // No decimals for Yen and Won
      return `${currencyInfo.symbol}${Math.round(convertedValue).toLocaleString()}`
    }
    return `${currencyInfo.symbol}${convertedValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
  }

  // Load wallet accounts from storage
  const [storedAccounts, setStoredAccounts] = useStorage<WalletAccount[]>("wallet_accounts")
  const [storedActiveIndex, setStoredActiveIndex] = useStorage<number>("active_account_index")
  const [storedUsername] = useStorage<string>("username")

  // Restore pending transaction state on mount (from chrome.storage.local for immediate access)
  // State to hold pre-completed verification layers (for resuming after USB/Bluetooth tab)
  const [pendingVerificationLayers, setPendingVerificationLayers] = useState<{
    voice?: boolean; geo?: boolean; usb?: boolean; bluetooth?: boolean; biometric?: boolean
  } | null>(null)
  
  // Store verified geo location for resuming after USB/Bluetooth verification
  const [pendingVerifiedGeoLocation, setPendingVerifiedGeoLocation] = useState<{
    latitude: number; longitude: number; accuracy?: number
  } | null>(null)
  
  // Store enabled layers for resuming after USB/Bluetooth verification
  const [pendingEnabledLayers, setPendingEnabledLayers] = useState<{
    voice: boolean; geo: boolean; usb: boolean; bluetooth: boolean; wifi: boolean; biometric: boolean
  } | null>(null)
  
  // Flag to trigger automatic transaction continuation
  const [shouldContinueTransaction, setShouldContinueTransaction] = useState(false)
  
  // Flag to prevent rendering until we check for pending state restoration
  const [isCheckingPendingState, setIsCheckingPendingState] = useState(true)

  useEffect(() => {
    // PWA: Skip USB/Bluetooth pending state restoration - only works in extension context
    if (!isExtensionContext()) {
      console.log('[Popup] PWA mode - skipping pending transaction state check')
      setIsCheckingPendingState(false)
      return
    }
    
    console.log('[Popup] Checking for pending transaction state on mount...')
    chrome.storage.local.get(['pending_tx_state', 'usb_verify_result', 'bluetooth_verify_result']).then(async (result) => {
      const pendingState = result.pending_tx_state
      const usbResult = result.usb_verify_result
      const bluetoothResult = result.bluetooth_verify_result
      
      console.log('[Popup] Storage check - pendingState:', !!pendingState, 'usbResult:', !!usbResult, 'bluetoothResult:', !!bluetoothResult)
      
      if (pendingState && Date.now() - pendingState.timestamp < 5 * 60 * 1000) { // 5 minute expiry
        console.log('[Popup] Found valid pending transaction state:', JSON.stringify(pendingState))
        console.log('[Popup] USB result:', JSON.stringify(usbResult))
        console.log('[Popup] Bluetooth result:', JSON.stringify(bluetoothResult))
        
        // Check for USB verification result
        if (usbResult && 
            usbResult.requestId === pendingState.requestId &&
            Date.now() - usbResult.timestamp < 120000) {
          console.log('[Popup] USB verified! Restoring transaction state...')
          
          if (usbResult.success) {
            // IMPORTANT: Set all states synchronously before clearing storage
            console.log('[Popup] Restoring: view=', pendingState.view, 'sendStep=', pendingState.sendStep, 'activeWallet=', pendingState.activeWallet)
            setView(pendingState.view as any)
            setSendStep(pendingState.sendStep as any)
            if (pendingState.selectedToken) {
              console.log('[Popup] Restoring selectedToken:', pendingState.selectedToken.symbol)
              setSelectedToken(pendingState.selectedToken)
            }
            if (pendingState.amount) {
              console.log('[Popup] Restoring amount:', pendingState.amount)
              setAmount(pendingState.amount)
            }
            if (pendingState.recipient) {
              console.log('[Popup] Restoring recipient:', pendingState.recipient)
              setRecipient(pendingState.recipient)
            }
            if (pendingState.activeWallet) {
              console.log('[Popup] Restoring activeWallet:', pendingState.activeWallet)
              setActiveWallet(pendingState.activeWallet as any)
            }
            
            // Set pre-completed layers (all previous layers + USB)
            const preCompleted = {
              ...pendingState.txVerificationModal?.completedLayers,
              usb: true
            }
            console.log('[Popup] Pre-completed layers:', preCompleted)
            console.log('[Popup] Resuming with verified geo location')
            console.log('[Popup] Enabled layers from storage:', pendingState.txVerificationModal?.enabledLayers)
            console.log('[Popup] Security settings from storage:', pendingState.securitySettings)
            setPendingVerificationLayers(preCompleted)
            if (pendingState.verifiedGeoLocation) {
              setPendingVerifiedGeoLocation(pendingState.verifiedGeoLocation)
            }
            // CRITICAL: Restore the enabledLayers so we know which layers to run after USB
            if (pendingState.txVerificationModal?.enabledLayers) {
              setPendingEnabledLayers(pendingState.txVerificationModal.enabledLayers)
            }
            // CRITICAL: Restore securitySettings so we have device info for remaining layers
            if (pendingState.securitySettings) {
              setSecuritySettings(pendingState.securitySettings)
            }
            setShouldContinueTransaction(true)
            
            // Clear storage AFTER setting state
            chrome.storage.local.remove(['usb_verify_result', 'pending_tx_state'])
          } else {
            // USB failed - show error but don't continue
            setView(pendingState.view as any)
            setStatus(usbResult.error || 'USB verification failed')
            chrome.storage.local.remove(['usb_verify_result', 'pending_tx_state'])
          }
          setIsCheckingPendingState(false)
          return
        }
        
        // Check for Bluetooth verification result
        if (bluetoothResult && 
            bluetoothResult.requestId === pendingState.requestId &&
            Date.now() - bluetoothResult.timestamp < 120000) {
          console.log('[Popup] Bluetooth verified! Restoring transaction state...')
          
          if (bluetoothResult.success) {
            console.log('[Popup] Restoring: view=', pendingState.view, 'sendStep=', pendingState.sendStep, 'activeWallet=', pendingState.activeWallet)
            setView(pendingState.view as any)
            setSendStep(pendingState.sendStep as any)
            if (pendingState.selectedToken) setSelectedToken(pendingState.selectedToken)
            if (pendingState.amount) setAmount(pendingState.amount)
            if (pendingState.recipient) setRecipient(pendingState.recipient)
            if (pendingState.activeWallet) setActiveWallet(pendingState.activeWallet as any)
            
            const preCompleted = {
              ...pendingState.txVerificationModal?.completedLayers,
              bluetooth: true
            }
            console.log('[Popup] Pre-completed layers:', preCompleted)
            console.log('[Popup] Resuming with verified geo location')
            console.log('[Popup] Enabled layers from storage:', pendingState.txVerificationModal?.enabledLayers)
            console.log('[Popup] Security settings from storage:', pendingState.securitySettings)
            setPendingVerificationLayers(preCompleted)
            if (pendingState.verifiedGeoLocation) {
              setPendingVerifiedGeoLocation(pendingState.verifiedGeoLocation)
            }
            // CRITICAL: Restore the enabledLayers so we know which layers to run after Bluetooth
            if (pendingState.txVerificationModal?.enabledLayers) {
              setPendingEnabledLayers(pendingState.txVerificationModal.enabledLayers)
            }
            // CRITICAL: Restore securitySettings so we have device info for remaining layers
            if (pendingState.securitySettings) {
              setSecuritySettings(pendingState.securitySettings)
            }
            setShouldContinueTransaction(true)
            
            chrome.storage.local.remove(['bluetooth_verify_result', 'pending_tx_state'])
          } else {
            setView(pendingState.view as any)
            setStatus(bluetoothResult.error || 'Bluetooth verification failed')
            chrome.storage.local.remove(['bluetooth_verify_result', 'pending_tx_state'])
          }
          setIsCheckingPendingState(false)
          return
        }
        
        // No verification result yet - this shouldn't happen normally
        // Clear stale pending state
        console.log('[Popup] No verification result, clearing stale pending state')
        chrome.storage.local.remove('pending_tx_state')
        
      } else if (pendingState) {
        // Clear expired state
        console.log('[Popup] Clearing expired pending transaction state')
        chrome.storage.local.remove('pending_tx_state')
      }
      
      // Done checking, allow rendering
      setIsCheckingPendingState(false)
    }).catch(err => {
      console.error('[Popup] Error checking pending state:', err)
      setIsCheckingPendingState(false)
    })
  }, []) // Only run once on mount

  // Load Degen settings on mount - EXTENSION ONLY (Degen/Sniper features)
  useEffect(() => {
    // PWA: Skip Degen/Sniper features - only work in extension context
    if (!isExtensionContext()) {
      console.log('[PWA] Skipping Degen/Sniper features')
      return
    }
    
    chrome.storage.sync.get('degen_settings').then((result) => {
      if (result.degen_settings) {
        const settings = result.degen_settings;
        if (typeof settings.degenMode === 'boolean') setDegenMode(settings.degenMode);
        if (typeof settings.sniperShortcuts === 'boolean') setSniperShortcuts(settings.sniperShortcuts);
        if (Array.isArray(settings.snipeAmounts) && settings.snipeAmounts.length === 4) {
          setSnipeAmounts(settings.snipeAmounts as [string, string, string, string]);
        }
        
        // If degen mode is ON, go straight to swap view
        if (settings.degenMode) {
          setView('swap');
          // Set SOL as from token
          setSwapFromToken({
            mint: 'So11111111111111111111111111111111111111112',
            symbol: 'SOL',
            name: 'Solana',
            logoURI: 'https://assets.coingecko.com/coins/images/4128/standard/solana.png',
            decimals: 9,
            amount: balance,
            price: solPrice,
            value: balance * solPrice
          });
        }
      }
    });
    
    // Check if we were opened via snipe context menu
    chrome.storage.local.get('snipe_request').then((result) => {
      if (result.snipe_request && Date.now() - result.snipe_request.timestamp < 30000) {
        const { tokenAddress, amount: snipeAmount } = result.snipe_request;
        console.log('[Snipe] Received snipe request:', tokenAddress, snipeAmount);
        
        // Clear the request
        chrome.storage.local.remove('snipe_request');
        
        // Set up swap with SOL -> Token
        setView('swap');
        setSwapFromToken({
          mint: 'So11111111111111111111111111111111111111112',
          symbol: 'SOL',
          name: 'Solana',
          logoURI: 'https://assets.coingecko.com/coins/images/4128/standard/solana.png',
          decimals: 9,
          amount: balance,
          price: solPrice,
          value: balance * solPrice
        });
        setSwapAmount(snipeAmount);
        
        // Search for the token to swap to
        setSwapSelectingToken('to');
        setTokenSearchQuery(tokenAddress);
      }
    });
    
    // Check if we were opened via Quick Trade context menu
    chrome.storage.local.get('quick_trade_request').then(async (result) => {
      if (result.quick_trade_request && Date.now() - result.quick_trade_request.timestamp < 30000) {
        const { tokenAddress } = result.quick_trade_request;
        console.log('[QuickTrade] Received quick trade request:', tokenAddress);
        
        // Clear the request
        chrome.storage.local.remove('quick_trade_request');
        
        // Enable degen mode and set view
        setDegenMode(true);
        setView('degen');
        setIsLoadingDetectedToken(true);
        
        // Clear trade history for new token
        setDegenTradeHistory([]);
        setSelectedTrade(null);
        
        // Fetch token info from DexScreener API
        try {
          const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenAddress}`);
          const data = await response.json();
          
          if (data.pairs && data.pairs.length > 0) {
            // Get the best pair (highest liquidity on Solana)
            const solanaPairs = data.pairs.filter((p: any) => p.chainId === 'solana');
            const bestPair = solanaPairs.sort((a: any, b: any) => (b.liquidity?.usd || 0) - (a.liquidity?.usd || 0))[0] || data.pairs[0];
            
            setDetectedToken({
              address: tokenAddress,
              symbol: bestPair.baseToken?.symbol || '???',
              name: bestPair.baseToken?.name || 'Unknown Token',
              logoURI: bestPair.info?.imageUrl,
              headerURI: bestPair.info?.header, // Banner image from DexScreener
              priceUsd: parseFloat(bestPair.priceUsd) || 0,
              priceNative: parseFloat(bestPair.priceNative) || 0,
              marketCap: bestPair.marketCap || bestPair.fdv || 0,
              fdv: bestPair.fdv || 0,
              volume24h: bestPair.volume?.h24 || 0,
              liquidity: bestPair.liquidity?.usd || 0,
              priceChange5m: bestPair.priceChange?.m5 || 0,
              priceChange1h: bestPair.priceChange?.h1 || 0,
              priceChange6h: bestPair.priceChange?.h6 || 0,
              priceChange24h: bestPair.priceChange?.h24 || 0,
              txns24h: bestPair.txns?.h24 ? { buys: bestPair.txns.h24.buys, sells: bestPair.txns.h24.sells } : undefined,
              pairAddress: bestPair.pairAddress,
              dexId: bestPair.dexId,
              lastUpdated: Date.now()
            });
            
            // Save settings to persist degen mode
            chrome.storage.sync.set({
              degen_settings: {
                degenMode: true,
                sniperShortcuts,
                snipeAmounts
              }
            });
          } else {
            // Token not found, still show with address
            setDetectedToken({
              address: tokenAddress,
              symbol: tokenAddress.slice(0, 4) + '...',
              name: 'Unknown Token',
              priceUsd: 0,
              lastUpdated: Date.now()
            });
          }
        } catch (e) {
          console.error('[QuickTrade] Failed to fetch token info:', e);
          setDetectedToken({
            address: tokenAddress,
            symbol: tokenAddress.slice(0, 4) + '...',
            name: 'Unknown Token',
            priceUsd: 0,
            lastUpdated: Date.now()
          });
        } finally {
          setIsLoadingDetectedToken(false);
        }
      }
    });
  }, []);
  
  // Degen Mode: Listen for URL changes from background and auto-detect token
  // Helper to fetch user's token balance
  const fetchDegenTokenBalance = async (tokenMint: string) => {
    if (!wallet || !connection) return;
    try {
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
        wallet.publicKey,
        { mint: new (await import('@solana/web3.js')).PublicKey(tokenMint) }
      );
      if (tokenAccounts.value.length > 0) {
        const tokenInfo = tokenAccounts.value[0].account.data.parsed.info.tokenAmount;
        const balance = tokenInfo.uiAmount || 0;
        const decimals = tokenInfo.decimals || 6; // Default to 6 for pump.fun tokens
        console.log(`[Degen] Token balance: ${balance}, decimals: ${decimals}`);
        setDegenTokenBalance(balance);
        setDegenTokenDecimals(decimals);
      } else {
        setDegenTokenBalance(0);
        setDegenTokenDecimals(6); // Default
      }
    } catch (e) {
      console.error('[Degen] Failed to fetch token balance:', e);
      setDegenTokenBalance(0);
    }
  };

  // Parse scraped DexScreener data into our format
  const parseScrapedData = (data: any) => {
    return {
      address: data.tokenAddress || data.baseToken?.address || '',
      symbol: data.tokenSymbol || data.baseToken?.symbol || '???',
      name: data.tokenName || data.baseToken?.name || 'Unknown',
      logoURI: undefined as string | undefined,
      priceUsd: data.priceUsd || 0,
      priceNative: 0,
      marketCap: data.marketCap || 0,
      fdv: data.fdv || 0,
      volume24h: data.volume24h || 0,
      liquidity: data.liquidity || 0,
      priceChange5m: data.priceChange5m || 0,
      priceChange1h: data.priceChange1h || 0,
      priceChange6h: data.priceChange6h || 0,
      priceChange24h: data.priceChange24h || 0,
      txns24h: data.txns24h,
      pairAddress: data.pairAddress,
      priceFormatted: data.price || '',
      lastUpdated: Date.now(),
      source: 'scraper' as const
    };
  };

  // Parse DexScreener API pair data (fallback)
  const parseDexScreenerPair = (pair: any, tokenAddress?: string) => {
    const isBase = !tokenAddress || pair.baseToken.address === tokenAddress;
    const token = isBase ? pair.baseToken : pair.quoteToken;
    
    return {
      address: token.address,
      symbol: token.symbol,
      name: token.name,
      logoURI: pair.info?.imageUrl,
      headerURI: pair.info?.header, // Banner image from DexScreener
      priceUsd: parseFloat(pair.priceUsd) || 0,
      priceNative: parseFloat(pair.priceNative) || 0,
      marketCap: pair.marketCap || pair.fdv || 0,
      fdv: pair.fdv || 0,
      volume24h: pair.volume?.h24 || 0,
      liquidity: pair.liquidity?.usd || 0,
      priceChange5m: pair.priceChange?.m5 || 0,
      priceChange1h: pair.priceChange?.h1 || 0,
      priceChange6h: pair.priceChange?.h6 || 0,
      priceChange24h: pair.priceChange?.h24 || 0,
      txns24h: pair.txns?.h24 ? { buys: pair.txns.h24.buys, sells: pair.txns.h24.sells } : undefined,
      pairAddress: pair.pairAddress,
      dexId: pair.dexId,
      lastUpdated: Date.now(),
      source: 'api' as const
    };
  };

  // Store pair address for refresh
  const [currentPairAddress, setCurrentPairAddress] = useState<string | null>(null);
  const [dataSource, setDataSource] = useState<'scraper' | 'api'>('api');

  useEffect(() => {
    if (!degenMode) return;
    
    // PWA: Degen scraper only works in extension context
    if (!isExtensionContext()) return;
    
    // Request data from the content script (if on DexScreener) - for live updates
    const requestScraperData = async () => {
      try {
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        if (tabs[0]?.id && tabs[0]?.url?.includes('dexscreener.com')) {
          try {
            chrome.tabs.sendMessage(tabs[0].id, { type: 'REQUEST_DEXSCREENER_DATA' }, (response) => {
              // Check for chrome runtime error (content script not available)
              if (chrome.runtime.lastError) {
                // Silently ignore - API is already being used
                return;
              }
              if (response?.success && response.data) {
                console.log('[Degen] Scraper connected, switching to live data');
                const tokenData = parseScrapedData(response.data);
                setDetectedToken(tokenData);
                setDataSource('scraper');
                if (tokenData.address) {
                  fetchDegenTokenBalance(tokenData.address);
                }
              }
            });
          } catch (e) {
            // Silently fail - API is already being used
          }
        }
      } catch (e) {
        // Silently fail
      }
    };

    // FAST: fetch from API immediately using pair address
    const fetchTokenFromPair = async (pairAddress: string) => {
      setIsLoadingDetectedToken(true);
      setCurrentPairAddress(pairAddress);
      
      try {
        const response = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${pairAddress}`);
        const data = await response.json();
        
        if (data.pair) {
          const tokenData = parseDexScreenerPair(data.pair);
          console.log('[Degen] Detected token from API:', tokenData);
          
          // Load saved cost basis for this token (or null if none)
          if (!detectedToken || detectedToken.address !== tokenData.address) {
            const savedCostBasis = await loadCostBasis(tokenData.address);
            setDegenCostBasis(savedCostBasis);
          }
          
          setDetectedToken(tokenData);
          setDataSource('api');
          
          setSwapToToken({
            mint: tokenData.address,
            symbol: tokenData.symbol,
            name: tokenData.name,
            logoURI: tokenData.logoURI,
            decimals: 9,
            price: tokenData.priceUsd
          });
          
          fetchDegenTokenBalance(tokenData.address);
          setView('degen');
          
          // After API loads, try to connect to scraper for live updates
          setTimeout(() => requestScraperData(), 500);
        }
      } catch (e) {
        console.error('[Degen] Failed to fetch token info:', e);
      }
      setIsLoadingDetectedToken(false);
    };
    
    // Function to fetch token info directly (for pump.fun)
    const fetchTokenDirect = async (tokenAddress: string) => {
      setIsLoadingDetectedToken(true);
      try {
        const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenAddress}`);
        const data = await response.json();
        
        if (data.pairs && data.pairs.length > 0) {
          const pair = data.pairs.sort((a: any, b: any) => 
            (b.liquidity?.usd || 0) - (a.liquidity?.usd || 0)
          )[0];
          
          const tokenData = parseDexScreenerPair(pair, tokenAddress);
          setCurrentPairAddress(pair.pairAddress);
          
          // Load saved cost basis for this token (or null if none)
          if (!detectedToken || detectedToken.address !== tokenData.address) {
            const savedCostBasis = await loadCostBasis(tokenAddress);
            setDegenCostBasis(savedCostBasis);
          }
          
          setDetectedToken(tokenData);
          setDataSource('api');
          
          setSwapToToken({
            mint: tokenAddress,
            symbol: tokenData.symbol,
            name: tokenData.name,
            logoURI: tokenData.logoURI,
            decimals: 9,
            price: tokenData.priceUsd
          });
          
          fetchDegenTokenBalance(tokenAddress);
          setView('degen');
          
          // After API loads, try to connect to scraper for live updates
          setTimeout(() => requestScraperData(), 500);
        }
      } catch (e) {
        console.error('[Degen] Failed to fetch token info:', e);
        setDetectedToken({
          address: tokenAddress,
          symbol: '???',
          name: 'Unknown Token'
        });
        fetchDegenTokenBalance(tokenAddress);
        setView('degen');
      }
      setIsLoadingDetectedToken(false);
    };
    
    // Listen for LIVE scraped data updates from content script (via background)
    const handleMessage = (message: any) => {
      // Real-time scraped data from DexScreener page (forwarded by background)
      if (message.type === 'DEXSCREENER_LIVE_UPDATE' && message.data) {
        console.log('[Degen] LIVE UPDATE received:', message.data.price, 'MC:', message.data.marketCap);
        const tokenData = parseScrapedData(message.data);
        setDetectedToken(prev => ({
          ...prev,
          ...tokenData
        }));
        setDataSource('scraper');
        setCurrentPairAddress(message.data.pairAddress);
        
        // Update swap token price
        if (tokenData.address) {
          setSwapToToken(prev => prev ? {
            ...prev,
            price: tokenData.priceUsd
          } : null);
        }
        
        // Fetch user balance if we have a new token
        if (tokenData.address && (!detectedToken || detectedToken.address !== tokenData.address)) {
          fetchDegenTokenBalance(tokenData.address);
          setView('degen');
        }
      }
      
      // URL changed (fallback if scraper isn't active)
      if (message.type === 'DEGEN_URL_CHANGED') {
        console.log('[Degen] URL changed:', message);
        // FAST: Immediately fetch from API
        if (message.pairAddress) {
          fetchTokenFromPair(message.pairAddress);
        } else if (message.tokenAddress) {
          fetchTokenDirect(message.tokenAddress);
        }
      }
      
      // Quick Trade from context menu - load token immediately
      if (message.type === 'QUICK_TRADE_TOKEN') {
        console.log('[Degen] Quick Trade token received:', message.tokenAddress);
        setDegenMode(true);
        setView('degen');
        fetchTokenDirect(message.tokenAddress);
      }
    };
    
    chrome.runtime.onMessage.addListener(handleMessage);
    
    // PRIORITY 1: Immediately check URL and fetch from API (FAST)
    chrome.tabs.query({ active: true, currentWindow: true }).then(tabs => {
      const url = tabs[0]?.url;
      if (url) {
        const dexMatch = url.match(/dexscreener\.com\/solana\/([a-zA-Z0-9]+)/);
        const pumpMatch = url.match(/pump\.fun\/coin\/([a-zA-Z0-9]+)/);
        
        // Immediately fetch from API - no waiting
        if (dexMatch) {
          console.log('[Degen] Fast load from URL:', dexMatch[1]);
          fetchTokenFromPair(dexMatch[1]);
        } else if (pumpMatch) {
          console.log('[Degen] Fast load from URL:', pumpMatch[1]);
          fetchTokenDirect(pumpMatch[1]);
        }
      }
    });
    
    return () => {
      chrome.runtime.onMessage.removeListener(handleMessage);
    };
  }, [degenMode, wallet, connection]);

  // Function to refresh DexScreener data - defined before the useEffect that uses it
  const refreshDexScreenerData = async () => {
    if (!currentPairAddress) return;
    
    try {
      const response = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${currentPairAddress}`);
      const data = await response.json();
      
      if (data.pair) {
        const tokenData = parseDexScreenerPair(data.pair);
        setDetectedToken(tokenData);
        setDataSource('api');
      }
    } catch (e) {
      console.error('[Degen] Failed to refresh token data:', e);
    }
  };

  // Degen Mode: Auto-refresh DexScreener data for real-time prices
  useEffect(() => {
    if (!degenMode || !degenAutoRefresh || !currentPairAddress || view !== 'degen') return;
    
    console.log('[Degen] Starting auto-refresh with interval:', degenRefreshInterval);
    
    const intervalId = setInterval(() => {
      refreshDexScreenerData();
    }, degenRefreshInterval);
    
    return () => {
      clearInterval(intervalId);
      console.log('[Degen] Stopped auto-refresh');
    };
  }, [degenMode, degenAutoRefresh, currentPairAddress, view, degenRefreshInterval]);

  // Effect to automatically continue transaction after USB/Bluetooth verification
  useEffect(() => {
    if (shouldContinueTransaction && pendingVerificationLayers && wallet && activeWallet === "vault") {
      console.log('[Popup] Auto-continuing vault transaction with pre-completed layers:', pendingVerificationLayers)
      console.log('[Popup] activeWallet:', activeWallet, 'amount:', amount, 'recipient:', recipient)
      setShouldContinueTransaction(false)
      
      // Small delay to let UI fully render
      setTimeout(() => {
        // Trigger the send confirmation which will run security verification
        // The handleTransfer function will be called with pre-completed layers
        handleTransferWithPrecompletedLayers()
      }, 500)
    }
  }, [shouldContinueTransaction, pendingVerificationLayers, wallet, activeWallet, amount, recipient])

  // Check wallet status on mount
  useEffect(() => {
    // Web version: check wallet status from localStorage
    const checkWalletStatus = async () => {
      try {
        const walletsData = localStorage.getItem('geovault_wallets');
        const isOnboarded = !!walletsData;
        
        if (!isOnboarded) {
          // Show onboarding view instead of redirecting
          setView('create');
        }
      } catch (e) {
        console.error('Error checking wallet status:', e);
      }
    };
    checkWalletStatus();
  }, []);

  // Close dropdown when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      const target = event.target as Node
      // Check if click is outside both the trigger and the dropdown menu
      if (dropdownRef.current && !dropdownRef.current.contains(target) &&
          walletDropdownMenuRef.current && !walletDropdownMenuRef.current.contains(target)) {
        setShowAddressTooltip(false)
      }
      // Also close if click is outside and menu ref doesn't exist yet
      if (dropdownRef.current && !dropdownRef.current.contains(target) && !walletDropdownMenuRef.current) {
        setShowAddressTooltip(false)
      }
      if (sidebarRef.current && !sidebarRef.current.contains(target)) {
        setShowSidebar(false)
      }
    }
    document.addEventListener("mousedown", handleClickOutside)
    return () => {
      document.removeEventListener("mousedown", handleClickOutside)
    }
  }, [])

  // Load wallet accounts from storage
  useEffect(() => {
    if (storedAccounts && storedAccounts.length > 0) {
      // Check if we need to update the first account name with username
      if (storedUsername && storedAccounts[0]?.name === "Account 1") {
        const updatedAccounts = [...storedAccounts]
        updatedAccounts[0] = { ...updatedAccounts[0], name: storedUsername }
        setWalletAccounts(updatedAccounts)
        setStoredAccounts(updatedAccounts)
      } else {
        setWalletAccounts(storedAccounts)
      }
      if (storedActiveIndex !== undefined) {
        setActiveAccountIndex(storedActiveIndex)
      }
    } else if (storedSecret && wallet) {
      // Initialize with the current wallet as the first account
      // Use stored username if available, otherwise default to "Account 1"
      const initialAccount: WalletAccount = {
        index: 0,
        name: storedUsername || "Account 1",
        publicKey: wallet.publicKey.toBase58(),
        secretKey: storedSecret
      }
      setWalletAccounts([initialAccount])
      setStoredAccounts([initialAccount])
    }
  }, [storedAccounts, storedSecret, wallet, storedUsername])

  // Check if we should open a specific vault after USB/Bluetooth setup - EXTENSION ONLY
  useEffect(() => {
    // PWA: Skip USB/Bluetooth setup flow - only works in extension context
    if (!isExtensionContext()) {
      return
    }
    
    console.log('[Setup] useEffect running, walletAccounts.length:', walletAccounts.length)
    
    // Run when we have wallet accounts loaded
    if (walletAccounts.length > 0) {
      console.log('[Setup] Checking storage for openVaultAfterSetup...')
      
      // Check local storage for vault to open (set by USB/Bluetooth setup tabs)
      chrome.storage.local.get('openVaultAfterSetup').then(async (result) => {
        console.log('[Setup] Storage result:', result)
        
        const data = result.openVaultAfterSetup
        if (data && data.publicKey && (Date.now() - data.timestamp) < 60000) {
          console.log('[Setup] Found valid vault to open:', data.publicKey)
          console.log('[Setup] Timestamp age:', Date.now() - data.timestamp, 'ms')
          
          // Clear it immediately so it doesn't trigger again
          chrome.storage.local.remove('openVaultAfterSetup')
          console.log('[Setup] Cleared storage')
          
          // Find the wallet that matches this public key
          const walletToOpen = walletAccounts.find(w => w.publicKey === data.publicKey)
          console.log('[Setup] Found wallet:', walletToOpen?.name || 'NOT FOUND')
          console.log('[Setup] All wallet publicKeys:', walletAccounts.map(w => w.publicKey))
          
          if (walletToOpen) {
            // Find the index of this wallet and set it as active
            const walletIndex = walletAccounts.findIndex(w => w.publicKey === data.publicKey)
            console.log('[Setup] Setting activeAccountIndex to:', walletIndex)
            if (walletIndex !== -1) {
              setActiveAccountIndex(walletIndex)
            }
            
            // Go to main view with this wallet selected
            console.log('[Setup] Setting view to main')
            setView('main')
          }
        } else {
          console.log('[Setup] No valid vault data found or expired')
          if (data) {
            console.log('[Setup] Data exists but:', {
              hasPublicKey: !!data.publicKey,
              age: Date.now() - data.timestamp
            })
          }
        }
      }).catch(err => {
        console.log('[Setup] Error checking for vault to open:', err)
      })
    }
  }, [walletAccounts])

  // Poll for 2FA Mobile/Biometric session status when QR modal is open
  useEffect(() => {
    if (!mobileQRModal.show || !mobileQRModal.sessionId || mobileQRModal.status !== 'pending') {
      return
    }
    
    let isCancelled = false
    const pollInterval = setInterval(async () => {
      if (isCancelled) return
      
      try {
        // Use appropriate check function based on layer type
        if (mobileQRModal.layerType === 'biometric') {
          const { checkBiometricSession } = await import('./utils/qr-verify')
          const result = await checkBiometricSession(mobileQRModal.sessionId!)
          
          if (isCancelled) return
          
          if (result.status === 'verified') {
            setMobileQRModal(prev => ({ ...prev, status: 'verified' }))
            
            // Save biometric to security settings
            if (mobileQRModal.publicKey) {
              setUpdatingSecurityLayer('biometric')
              await updateSecurityLayer(mobileQRModal.publicKey, 'biometric', true, {
                credentialId: mobileQRModal.sessionId // Using session ID as reference
              })
              setSecuritySettings(prev => prev ? { 
                ...prev, 
                biometricEnabled: true, 
                biometricCredentialId: mobileQRModal.sessionId
              } : null)
              // Also update vaultRules if in vault creation flow
              setVaultRules(prev => ({ ...prev, biometricEnabled: true }))
              setUpdatingSecurityLayer(null)
              
              // Show success and close modal
              setTimeout(() => {
                setMobileQRModal(prev => ({ ...prev, show: false }))
                setSuccessModal({ 
                  show: true, 
                  deviceName: 'Biometric (FaceID/TouchID)', 
                  type: 'enabled', 
                  deviceType: 'biometric' 
                })
                setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'biometric' }), 3500)
              }, 1000)
            }
          } else if (result.status === 'failed') {
            setMobileQRModal(prev => ({ ...prev, status: 'failed' }))
          }
        } else {
          // WiFi 2FA flow
          const { checkMobileSession } = await import('./utils/qr-verify')
          const result = await checkMobileSession(mobileQRModal.sessionId!)
          
          if (isCancelled) return
          
          if (result.status === 'verified' && result.device) {
            setMobileQRModal(prev => ({ ...prev, status: 'verified' }))
            
            // Check if this is a recalibration verification (has onVerified callback)
            if (mobileQRModal.onVerified) {
              // Call the callback and close modal
              setTimeout(() => {
                mobileQRModal.onVerified?.()
                setMobileQRModal(prev => ({ ...prev, show: false, onVerified: undefined }))
              }, 1000)
            } else if (mobileQRModal.publicKey) {
              // Normal setup flow - Save the device to security settings
              setUpdatingSecurityLayer('wifi')
              await updateSecurityLayer(mobileQRModal.publicKey, 'wifi', true, {
                bssid: result.device.bssid || 'unknown',
                ssid: result.device.ssid || 'WiFi Network',
                userAgent: result.device.userAgent
              })
              setSecuritySettings(prev => prev ? { 
                ...prev, 
                wifiEnabled: true, 
                wifiDevice: {
                  bssid: result.device!.bssid || 'unknown',
                  ssid: result.device!.ssid || 'WiFi Network',
                  userAgent: result.device!.userAgent
                }
              } : null)
              // Also update vaultRules if in vault creation flow
              setVaultRules(prev => ({ 
                ...prev, 
                wifiEnabled: true, 
                wifiDevice: {
                  bssid: result.device!.bssid || 'unknown',
                  ssid: result.device!.ssid || 'WiFi Network',
                  userAgent: result.device!.userAgent
                }
              }))
              setUpdatingSecurityLayer(null)
              
              // Show success and close modal
              setTimeout(() => {
                setMobileQRModal(prev => ({ ...prev, show: false }))
                setSuccessModal({ 
                  show: true, 
                  deviceName: result.device!.ssid || '2FA Mobile', 
                  type: 'enabled', 
                  deviceType: 'mobile' 
                })
                setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
              }, 1000)
            }
          } else if (result.status === 'failed') {
            setMobileQRModal(prev => ({ ...prev, status: 'failed' }))
          }
        }
      } catch (e) {
        console.error('Error polling session:', e)
      }
    }, 2000) // Poll every 2 seconds
    
    // Timeout after 2 minutes
    const timeout = setTimeout(() => {
      if (!isCancelled) {
        setMobileQRModal(prev => prev.status === 'pending' ? { ...prev, status: 'expired' } : prev)
      }
    }, 120000)
    
    return () => {
      isCancelled = true
      clearInterval(pollInterval)
      clearTimeout(timeout)
    }
  }, [mobileQRModal.show, mobileQRModal.sessionId, mobileQRModal.status, mobileQRModal.publicKey, mobileQRModal.layerType, mobileQRModal.onVerified])

  // Load vault data and security settings when entering edit-wallet view
  useEffect(() => {
    if (view === 'edit-wallet' && editingWallet) {
      // Reset state
      setEditingWalletVault(null)
      setSecuritySettings(null)
      setLoadingEditingWalletVault(true)
      setStatus("") // Clear any previous status messages
      
      // Check if this specific wallet has a vault
      checkVaultExists(editingWallet.publicKey)
        .then(vaultRes => {
          if (vaultRes && vaultRes.exists) {
            setEditingWalletVault({
              multisigPda: vaultRes.multisigPda,
              vaultPda: vaultRes.vaultPda
            })
            // Load security settings for this wallet
            setLoadingSecuritySettings(true)
            return getSecuritySettings(editingWallet.publicKey)
          }
          return null
        })
        .then(settings => {
          if (settings) {
            setSecuritySettings(settings)
          }
        })
        .catch(err => {
          console.error('Failed to load vault/security settings:', err)
        })
        .finally(() => {
          setLoadingEditingWalletVault(false)
          setLoadingSecuritySettings(false)
        })
      
      // Check if voice unlock is enabled for this wallet
      checkVoiceEnabled(editingWallet.publicKey).then(result => {
        setVoiceUnlockEnabled(result.enabled || false)
      }).catch(err => {
        console.error('Failed to check voice unlock status:', err)
      })
    }
  }, [view, editingWallet])

  // Function to derive a new wallet from seed phrase
  // If no seed phrase exists (genesis was imported via private key), generates a random wallet
  const createNewWalletFromSeed = async () => {
    setIsAddingWallet(true)
    try {
      const nextIndex = walletAccounts.length
      
      // Get stored mnemonic from localStorage
      const storedMnemonicRaw = localStorage.getItem('geovault_mnemonic')
      
      let publicKey: string
      let secretKey: string
      
      if (storedMnemonicRaw) {
        // Derive wallet from seed phrase
        const storedMnemonic = JSON.parse(storedMnemonicRaw)
        console.log('[PWA] Deriving wallet at index:', nextIndex)
        const derived = await deriveWalletFromSeed(storedMnemonic, nextIndex)
        publicKey = derived.publicKey
        secretKey = derived.secretKey
      } else {
        // No seed phrase stored (imported via private key), generate random wallet
        console.log('[PWA] No seed phrase, generating random wallet')
        const { Keypair } = await import("@solana/web3.js")
        const keypair = Keypair.generate()
        publicKey = keypair.publicKey.toBase58()
        secretKey = bs58.encode(keypair.secretKey)
      }

      const newAccount: WalletAccount = {
        index: nextIndex,
        name: newWalletName || `Account ${nextIndex + 1}`,
        publicKey,
        secretKey
      }
      
      const updatedAccounts = [...walletAccounts, newAccount]
      setWalletAccounts(updatedAccounts)
      setStoredAccounts(updatedAccounts)
      
      // Register the new wallet on the server
      try {
        await registerUser(publicKey)
        console.log('[PWA] New wallet registered on server:', publicKey)
      } catch (regErr) {
        console.error('[PWA] Failed to register new wallet on server:', regErr)
        // Continue anyway - local wallet is created
      }
      
      // Switch to the new account
      switchToAccount(nextIndex, newAccount)
      closeAddWalletModal()
      
    } catch (error) {
      console.error("Failed to add new wallet:", error)
      setStatus("Failed to create wallet: " + (error as Error).message)
    } finally {
      setIsAddingWallet(false)
    }
  }

  // Complete vault password setup (when enabling security layers on wallet without password)
  const completeVaultPasswordSetup = async () => {
    if (!vaultPasswordSetup.show) return
    
    const { publicKey, password, confirmPassword, layerToEnable } = vaultPasswordSetup
    
    // Validate password
    if (!password || password.length < 6) {
      setVaultPasswordSetup(prev => ({ ...prev, error: 'Password must be at least 6 characters' }))
      return
    }
    if (password !== confirmPassword) {
      setVaultPasswordSetup(prev => ({ ...prev, error: 'Passwords do not match' }))
      return
    }
    
    setVaultPasswordSetup(prev => ({ ...prev, isSubmitting: true, error: '' }))
    
    try {
      // Register user on server if not already registered
      await registerUser(publicKey)
      
      // Set password on server
      await setServerPassword(publicKey, password)
      
      // Close modal
      setVaultPasswordSetup({ show: false, publicKey: '', password: '', confirmPassword: '', error: '', isSubmitting: false, layerToEnable: null })
      
      setStatus("Vault password set! You can now enable security layers.")
      setTimeout(() => setStatus(""), 3000)
      
    } catch (error: any) {
      console.error("Failed to set vault password:", error)
      setVaultPasswordSetup(prev => ({ ...prev, error: error.message || 'Failed to set password', isSubmitting: false }))
    }
  }

  // Function to import wallet from private key
  const importWalletFromPrivateKey = async () => {
    setIsAddingWallet(true)
    setIsCheckingVault(true)
    try {
      if (!importInput.trim()) {
        throw new Error("Please enter a private key")
      }

      let keypair: Keypair
      try {
        // Try base58 first
        const decoded = bs58.decode(importInput.trim())
        keypair = Keypair.fromSecretKey(decoded)
      } catch {
        // Try base64
        try {
          const decoded = Buffer.from(importInput.trim(), "base64")
          keypair = Keypair.fromSecretKey(new Uint8Array(decoded))
        } catch {
          throw new Error("Invalid private key format")
        }
      }

      const publicKey = keypair.publicKey.toBase58()
      
      // Check if this wallet is a Vault (has existing vault on server)
      console.log('[Import] Checking if wallet has vault:', publicKey)
      const vaultData = await checkVaultExists(publicKey)
      console.log('[Import] Vault check result:', vaultData)
      
      // Check if vault exists (either by exists flag or by having multisigPda)
      if (vaultData && (vaultData.exists || vaultData.multisigPda)) {
        console.log('[Import] Vault detected, showing password input inline')
        // This is a Vault - show password input in same modal
        setImportVaultDetected({
          detected: true,
          publicKey,
          keypair,
          walletName: newWalletName || `Imported ${walletAccounts.length + 1}`
        })
        setIsAddingWallet(false)
        setIsCheckingVault(false)
        return // Don't proceed - wait for password verification
      }

      console.log('[Import] No vault found, importing directly')
      // Not a Vault - import directly
      const nextIndex = walletAccounts.length
      const newAccount: WalletAccount = {
        index: nextIndex,
        name: newWalletName || `Imported ${nextIndex + 1}`,
        publicKey,
        secretKey: bs58.encode(keypair.secretKey),
        isImported: true
      }
      
      const updatedAccounts = [...walletAccounts, newAccount]
      setWalletAccounts(updatedAccounts)
      setStoredAccounts(updatedAccounts)
      
      switchToAccount(nextIndex, newAccount)
      closeAddWalletModal()
      
    } catch (error) {
      console.error("Failed to import wallet:", error)
      setStatus((error as Error).message)
    } finally {
      setIsAddingWallet(false)
      setIsCheckingVault(false)
    }
  }

  // Function to import wallet from seed phrase
  const importWalletFromSeedPhrase = async () => {
    setIsAddingWallet(true)
    try {
      if (!importInput.trim()) {
        throw new Error("Please enter a seed phrase")
      }

      const bip39 = await import('bip39')
      if (!bip39.validateMnemonic(importInput.trim())) {
        throw new Error("Invalid seed phrase")
      }

      const seed = await bip39.mnemonicToSeed(importInput.trim())
      const keypair = Keypair.fromSeed(new Uint8Array(seed.slice(0, 32)))
      const publicKey = keypair.publicKey.toBase58()

      // Check if this wallet is a Vault (has existing vault on server)
      console.log('[Import Seed] Checking if wallet has vault:', publicKey)
      const vaultData = await checkVaultExists(publicKey)
      console.log('[Import Seed] Vault check result:', vaultData)
      
      // Check if vault exists (either by exists flag or by having multisigPda)
      if (vaultData && (vaultData.exists || vaultData.multisigPda)) {
        console.log('[Import Seed] Vault detected, showing password input inline')
        // This is a Vault - show password input in same modal
        setImportVaultDetected({
          detected: true,
          publicKey,
          keypair,
          walletName: newWalletName || `Imported ${walletAccounts.length + 1}`
        })
        setIsAddingWallet(false)
        setIsCheckingVault(false)
        return // Don't proceed - wait for password verification
      }

      console.log('[Import Seed] No vault found, importing directly')
      // Not a Vault - import directly
      const nextIndex = walletAccounts.length
      const newAccount: WalletAccount = {
        index: nextIndex,
        name: newWalletName || `Imported ${nextIndex + 1}`,
        publicKey,
        secretKey: bs58.encode(keypair.secretKey),
        isImported: true
      }
      
      const updatedAccounts = [...walletAccounts, newAccount]
      setWalletAccounts(updatedAccounts)
      setStoredAccounts(updatedAccounts)
      
      switchToAccount(nextIndex, newAccount)
      closeAddWalletModal()
      
    } catch (error) {
      console.error("Failed to import wallet:", error)
      setStatus((error as Error).message)
    } finally {
      setIsAddingWallet(false)
      setIsCheckingVault(false)
    }
  }

  // Complete vault import after password verification
  const completeVaultImport = async () => {
    if (!importVaultDetected.keypair) return
    
    setIsVerifyingImportPassword(true)
    setImportVaultError("")
    
    try {
      // Verify password against server
      const verifyResult = await verifyServerPassword(importVaultDetected.publicKey, importVaultPassword)
      if (!verifyResult.success) {
        setImportVaultError("Incorrect password. Please enter the Vault's original password.")
        setIsVerifyingImportPassword(false)
        return
      }
      
      // Hash the password for storage
      const encoder = new TextEncoder()
      const data = encoder.encode(importVaultPassword)
      const hashBuffer = await crypto.subtle.digest('SHA-256', data)
      const hashArray = Array.from(new Uint8Array(hashBuffer))
      const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
      
      // Password verified - complete the import
      const nextIndex = walletAccounts.length
      const newAccount: WalletAccount = {
        index: nextIndex,
        name: importVaultDetected.walletName,
        publicKey: importVaultDetected.publicKey,
        secretKey: bs58.encode(importVaultDetected.keypair!.secretKey),
        isImported: true,
        isVault: true,
        passwordHash
      }
      
      const updatedAccounts = [...walletAccounts, newAccount]
      setWalletAccounts(updatedAccounts)
      setStoredAccounts(updatedAccounts)
      
      switchToAccount(nextIndex, newAccount)
      
      // Reset state and close
      setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' })
      setImportVaultPassword("")
      closeAddWalletModal()
      
    } catch (error) {
      console.error("Failed to verify vault password:", error)
      setImportVaultError("Failed to verify password. Please try again.")
    } finally {
      setIsVerifyingImportPassword(false)
    }
  }

  // Close add wallet modal and reset state
  const closeAddWalletModal = () => {
    setShowAddWalletModal(false)
    setAddWalletView("menu")
    setImportInput("")
    setNewWalletName("")
    setStatus("")
    // Also reset vault import state
    setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' })
    setImportVaultPassword("")
    setImportVaultError("")
  }

  // Function to switch active account
  const switchToAccount = async (index: number, account?: WalletAccount) => {
    const acc = account || walletAccounts[index]
    if (!acc) return
    
    setActiveAccountIndex(index)
    setStoredActiveIndex(index)
    
    // Reset state
    setMultisigPda(null)
    setVaultPda(null)
    setBalance(0)
    setVaultBalance(0)
    setTokens([])
    
    // Handle watch-only wallets differently
    if (acc.isWatchOnly) {
      setStoredSecret('') // Clear secret for watch-only
      // Create a "fake" wallet object for display purposes only
      // We use a dummy keypair but will fetch balance using the tracked address
      setWallet(null as any) // Clear wallet - we'll use publicKey directly from account
      setShowSidebar(false)
      
      // Fetch balance for the tracked wallet
      try {
        const trackedPubKey = new PublicKey(acc.publicKey)
        const bal = await getBalance(trackedPubKey)
        setBalance(bal)
        
        // Fetch tokens
        const trackedTokens = await fetchUserTokens(connection, trackedPubKey)
        setTokens(trackedTokens)
      } catch (e) {
        console.error("Error fetching tracked wallet data:", e)
      }
      return
    }
    
    // Normal wallet with secret key
    setStoredSecret(acc.secretKey)
    
    const kp = getKeypairFromSecret(acc.secretKey)
    setWallet(kp)
    
    // Check for vault
    const vaultRes = await checkVaultExists(kp.publicKey.toBase58())
    if (vaultRes && vaultRes.exists) {
      setMultisigPda(vaultRes.multisigPda)
      setVaultPda(vaultRes.vaultPda)
    }
    
    setShowSidebar(false)
  }

  // Hydrate Wallet from Storage
  useEffect(() => {
    if (storedSecret) {
      try {
        const kp = getKeypairFromSecret(storedSecret)
        setWallet(kp)
        setView("main")
        
        // Ensure user is registered (Retroactive fix for existing users)
        registerUser(kp.publicKey.toBase58()).catch(e => console.error("Background reg failed", e))

        // Check voice unlock status
        checkVoiceEnabled(kp.publicKey.toBase58()).then(result => {
          setVoiceUnlockEnabled(result.enabled || false)
        }).catch(e => console.error("Failed to check voice status:", e))

        // Check for existing vault (Recovery Mode)
        if (!multisigPda) {
            checkVaultExists(kp.publicKey.toBase58()).then(res => {
                if (res && res.exists) {
                    console.log("Recovered Vault:", res)
                    setMultisigPda(res.multisigPda)
                    setVaultPda(res.vaultPda)
                    // Fetch security settings for this wallet
                    getSecuritySettings(kp.publicKey.toBase58()).then(settings => {
                        if (settings) {
                            setSecuritySettings(settings)
                        }
                    }).catch(e => console.error("Failed to fetch security settings:", e))
                }
            })
        } else {
            // Verify the Vault actually exists on-chain (Fix for "Ghost Vaults")
            connection.getAccountInfo(new PublicKey(multisigPda)).then(info => {
                // STRICT CHECK: If it's not owned by Squads, it is NOT a valid vault.
                // This catches "Burnt" addresses that are owned by System Program (1111...)
                const SQUADS_V4_PROGRAM_ID = "SQDS4ep65T869zMMBKyuUq6aD6EgTu8psMjkvj52pCf";
                
                // FIX: If info is null, it might just be RPC lag. Do NOT reset.
                // Only reset if info exists AND owner is wrong.
                if (info && info.owner.toBase58() !== SQUADS_V4_PROGRAM_ID) {
                    console.warn(`Detected Invalid Vault (Owner: ${info.owner.toBase58()}). Resetting state to force re-discovery.`);
                    setMultisigPda("")
                    setVaultPda("")
                }
            }).catch(e => console.error("Failed to verify vault:", e))
            
            // Fetch security settings for existing vault
            getSecuritySettings(kp.publicKey.toBase58()).then(settings => {
                if (settings) {
                    setSecuritySettings(settings)
                }
            }).catch(e => console.error("Failed to fetch security settings:", e))
        }
      } catch (e) {
        console.error("Invalid stored key", e)
      }
    }
  }, [storedSecret])

  // Fetch Balances with WebSocket subscriptions for real-time updates
  useEffect(() => {
    const currentAccount = walletAccounts[activeAccountIndex]
    const isWatchOnly = currentAccount?.isWatchOnly
    
    const fetchBalances = async () => {
      // Handle watch-only wallets
      if (isWatchOnly && currentAccount) {
        try {
          const trackedPubKey = new PublicKey(currentAccount.publicKey)
          const b = await getBalance(trackedPubKey)
          setBalance(b)
          
          // Fetch SOL Price
          const price = await getSolanaPrice()
          setSolPrice(price)
          
          // Fetch Tokens
          const trackedTokens = await fetchUserTokens(connection, trackedPubKey)
          setTokens(trackedTokens)
        } catch (e) {
          console.error("Error fetching watch-only wallet:", e)
        }
        return
      }
      
      // Normal wallet handling
      if (wallet) {
        const b = await getBalance(wallet.publicKey)
        setBalance(b)
        
        // Fetch SOL Price
        const price = await getSolanaPrice()
        setSolPrice(price)

        // Fetch Exchange Rates for currency conversion
        try {
          const rates = await getExchangeRates()
          setExchangeRates(rates)
        } catch (e) {
          console.error("Error fetching exchange rates:", e)
        }

        // Fetch Tokens (Default to wallet, override if vault exists below)
        if (activeWallet === "master") {
            const userTokens = await fetchUserTokens(connection, wallet.publicKey)
            setTokens(userTokens)
        }
      }
      if (vaultPda) {
        const vb = await getBalance(new PublicKey(vaultPda))
        setVaultBalance(vb)

        // Fetch Vault Tokens
        if (activeWallet === "vault") {
            const vaultTokens = await fetchUserTokens(connection, new PublicKey(vaultPda))
            setTokens(vaultTokens)
        }
      }
    }

    // Handle watch-only wallet subscriptions
    if (view === "main" && isWatchOnly && currentAccount) {
      fetchBalances()
      
      const trackedPubKey = new PublicKey(currentAccount.publicKey)
      
      // WebSocket subscription for watch-only wallet
      subscribeToAccountChanges(
        connection,
        trackedPubKey,
        (lamports) => {
          const newBalance = lamports / 1e9
          console.log(`[WebSocket] Tracked wallet balance updated: ${newBalance} SOL`)
          setBalance(newBalance)
          fetchUserTokens(connection, trackedPubKey).then(setTokens)
        }
      )
      
      subscribeToLogs(
        connection,
        trackedPubKey,
        (logs) => {
          console.log(`[WebSocket] Transaction detected for tracked wallet:`, logs.signature)
          fetchTransactionHistory(connection, trackedPubKey).then(setTransactions)
        }
      )
      
      const interval = setInterval(fetchBalances, 30000)
      
      return () => {
        clearInterval(interval)
        unsubscribeFromAccountChanges(connection, trackedPubKey)
      }
    }

    if (view === "main" && wallet) {
      // Initial fetch
      fetchBalances()

      // Set up WebSocket subscription for master wallet
      subscribeToAccountChanges(
        connection,
        wallet.publicKey,
        (lamports) => {
          const newBalance = lamports / 1e9
          console.log(`[WebSocket] Master wallet balance updated: ${newBalance} SOL`)
          setBalance(newBalance)
          // Also refresh tokens when balance changes
          fetchUserTokens(connection, wallet.publicKey).then(setTokens)
        }
      )

      // Subscribe to logs for transaction notifications
      subscribeToLogs(
        connection,
        wallet.publicKey,
        (logs) => {
          console.log(`[WebSocket] Transaction detected for master wallet:`, logs.signature)
          // Refresh transaction history when new tx is detected
          if (activeWallet === "master") {
            fetchTransactionHistory(connection, wallet.publicKey).then(setTransactions)
          }
        }
      )

      // Set up WebSocket subscription for vault if it exists
      if (vaultPda) {
        subscribeToAccountChanges(
          connection,
          new PublicKey(vaultPda),
          (lamports) => {
            const newBalance = lamports / 1e9
            console.log(`[WebSocket] Vault balance updated: ${newBalance} SOL`)
            setVaultBalance(newBalance)
            // Also refresh tokens when balance changes
            if (activeWallet === "vault") {
              fetchUserTokens(connection, new PublicKey(vaultPda)).then(setTokens)
            }
          }
        )

        subscribeToLogs(
          connection,
          new PublicKey(vaultPda),
          (logs) => {
            console.log(`[WebSocket] Transaction detected for vault:`, logs.signature)
            // Refresh transaction history when new tx is detected
            if (activeWallet === "vault") {
              fetchTransactionHistory(connection, new PublicKey(vaultPda)).then(setTransactions)
            }
          }
        )
      }

      // Fallback: Still poll every 30 seconds as backup (reduced frequency since we have WebSocket)
      const interval = setInterval(fetchBalances, 30000)
      
      return () => {
        clearInterval(interval)
        // Clean up WebSocket subscriptions
        if (wallet) {
          unsubscribeFromAccountChanges(connection, wallet.publicKey)
        }
        if (vaultPda) {
          unsubscribeFromAccountChanges(connection, new PublicKey(vaultPda))
        }
      }
    }
  }, [wallet, vaultPda, view, activeWallet, walletAccounts, activeAccountIndex])

  // When entering settings view, always fetch voice unlock status for genesis wallet
  useEffect(() => {
    if (view === "settings" && walletAccounts[0]?.publicKey) {
      const genesisPublicKey = walletAccounts[0].publicKey
      checkVoiceEnabled(genesisPublicKey).then(result => {
        setVoiceUnlockEnabled(result.enabled || false)
      }).catch(e => console.error("Failed to check genesis wallet voice status:", e))
    }
  }, [view, walletAccounts])

  // Fetch Token Detail Data when viewing a token
  useEffect(() => {
    if (view === "token-detail" && selectedToken) {
      const fetchDetail = async () => {
        setTokenDetailLoading(true);
        const detail = await fetchTokenDetailData(selectedToken.mint, selectedToken);
        setTokenDetailData(detail);
        setTokenDetailLoading(false);
      };
      fetchDetail();
    } else {
      setTokenDetailData(null);
    }
  }, [view, selectedToken?.mint])

  // Fetch Transaction History
  useEffect(() => {
    const currentAccount = walletAccounts[activeAccountIndex]
    const isWatchOnly = currentAccount?.isWatchOnly
    
    const fetchTxHistory = async () => {
      setLoadingTxs(true)
      try {
        let address: PublicKey
        
        // Handle watch-only wallets
        if (isWatchOnly && currentAccount) {
          address = new PublicKey(currentAccount.publicKey)
        } else if (!wallet) {
          setTransactions([])
          setLoadingTxs(false)
          return
        } else if (activeWallet === "master") {
          address = wallet.publicKey
        } else if (activeWallet === "vault" && vaultPda) {
          address = new PublicKey(vaultPda)
        } else {
          setTransactions([])
          setLoadingTxs(false)
          return
        }
        
        const txs = await fetchTransactionHistory(connection, address, 20)
        setTransactions(txs)
      } catch (error) {
        console.error("Failed to fetch transactions:", error)
        setTransactions([])
      } finally {
        setLoadingTxs(false)
      }
    }
    
    if (view === "main" && activeTab === "activity") {
      fetchTxHistory()
    }
  }, [wallet, vaultPda, activeWallet, activeTab, view, walletAccounts, activeAccountIndex])

  const handleCreateWallet = () => {
    const { mnemonic, keypair, secretKey } = createNewWallet()
    setMnemonic(mnemonic)
    setWallet(keypair)
    // Don't save yet, wait for user to confirm they saved seed
    setView("seed")
  }

  const handleImportWallet = async () => {
    try {
        // Basic validation - in prod use bip39.validateMnemonic
        if (importSeed.split(" ").length !== 12) {
            // Try as private key
            const kp = getKeypairFromSecret(importSeed.trim())
            setWallet(kp)
            
            try {
                // Register user in DB immediately upon import
                await registerUser(kp.publicKey.toBase58())
            } catch (e) {
                console.error("Failed to register user in DB", e)
            }

            setStoredSecret(bs58.encode(kp.secretKey))
            setView("main")
            return
        }
        // TODO: Implement Mnemonic Import
        setStatus("Mnemonic import not supported in MVP. Use Private Key.")
    } catch (e) {
        setStatus("Invalid Private Key")
    }
  }

  const confirmSeedSaved = async () => {
    if (wallet) {
      try {
        // Register user in DB immediately
        await registerUser(wallet.publicKey.toBase58())
        console.log("User registered in DB")
      } catch (e) {
        console.error("Failed to register user in DB", e)
        // We continue anyway, as the user has the seed
      }
      setStoredSecret(bs58.encode(wallet.secretKey))
      setView("main")
    }
  }

  const executeActivation = async () => {
    if (!wallet) return
    setIsLoading(true)
    setView("activation_loading") // Switch to globe loading view
    setStatus("Acquiring GPS coordinates...")
    try {
      // 1. Get Real Location
      const location = await getBrowserLocation()
      setStatus("Location secured")
      
      // Small delay to show the secured message
      await new Promise(resolve => setTimeout(resolve, 800))
      setStatus("Encrypting location with ZK proof...")
      
      // 2. Register with Server (include geo range and USB device from vault rules)
      await new Promise(resolve => setTimeout(resolve, 1000))
      setStatus("Generating zero-knowledge proof...")
      await activateGeoGuard(wallet.publicKey.toBase58(), location, vaultRules.geoRange, vaultRules.usbDevice)

      const config = await getServerConfig()
      const serverKey = new PublicKey(config.serverPublicKey)
      
      setStatus("Deploying secure vault contract...")

      const { multisigPda: mPda, vaultPda: vPda } = await createSquad(connection, wallet, serverKey)
      
      // 3. Register Vault with Server (For Recovery)
      setStatus("Finalizing vault encryption...")
      await registerVault(wallet.publicKey.toBase58(), mPda.toBase58(), vPda.toBase58())

      // 4. Register user and set vault password on server
      setStatus("Securing vault credentials...")
      await registerUser(wallet.publicKey.toBase58())
      await setServerPassword(wallet.publicKey.toBase58(), vaultRules.password)

      setMultisigPda(mPda.toBase58())
      setVaultPda(vPda.toBase58())
      
      setStatus("Vault Activated ")
      setTimeout(() => setView("main"), 2000)
    } catch (e: any) {
      console.error(e)
      setStatus("Activation Failed: " + e.message)
      // Stay on loading screen to show error, then go back
      setTimeout(() => setView("activation_disclosure"), 3000)
    } finally {
      setIsLoading(false)
    }
  }

  // Test function to preview the globe loading screen (for development)
  const testGlobeLoading = () => {
    setView("activation_loading")
    setStatus("Acquiring GPS coordinates...")
    
    // Simulate the ZK loading sequence
    setTimeout(() => setStatus("Location secured"), 2000)
    setTimeout(() => setStatus("Encrypting location with ZK proof..."), 3000)
    setTimeout(() => setStatus("Generating zero-knowledge proof..."), 5000)
    setTimeout(() => setStatus("Deploying secure vault contract..."), 7000)
    setTimeout(() => setStatus("Finalizing vault encryption..."), 9000)
    setTimeout(() => setStatus("Vault Activated "), 11000)
    setTimeout(() => setView("main"), 13000)
  }

  // Test function to preview the vault rules modal (for development)
  const testVaultRules = () => {
    setVaultRules({
      geoEnabled: true,
      geoRange: 0.5,
      voiceEnabled: false,
      wifiEnabled: false,
      wifiDevice: null,
      bluetoothEnabled: false,
      bluetoothDevice: null,
      usbEnabled: false,
      usbDevice: null,
      biometricEnabled: false,
      password: '',
      confirmPassword: '',
      passwordError: ''
    })
    setView("vault_rules")
  }

  const activateSecurity = () => {
      // Reset vault rules to defaults when starting new activation
      setVaultRules({
        geoEnabled: true,
        geoRange: 0.5,
        voiceEnabled: false,
        wifiEnabled: false,
        wifiDevice: null,
        bluetoothEnabled: false,
        bluetoothDevice: null,
        usbEnabled: false,
        usbDevice: null,
        biometricEnabled: false,
        password: '',
        confirmPassword: '',
        passwordError: ''
      })
      setView("vault_rules")
  }

  // USB Device Selection
  const handleUsbToggle = async () => {
    if (vaultRules.usbEnabled) {
      // Turning off - clear device
      setVaultRules(prev => ({ ...prev, usbEnabled: false, usbDevice: null }))
    } else {
      // Turning on - request USB device
      try {
        const device = await navigator.usb.requestDevice({ filters: [] })
        if (device) {
          await device.open()
          setVaultRules(prev => ({
            ...prev,
            usbEnabled: true,
            usbDevice: {
              vendorId: device.vendorId,
              productId: device.productId,
              serialNumber: device.serialNumber || '',
              productName: device.productName || `USB Device (${device.vendorId.toString(16)}:${device.productId.toString(16)})`
            }
          }))
          await device.close()
        }
      } catch (e: any) {
        console.log('USB selection cancelled or failed:', e.message)
      }
    }
  }

  // Verify USB device is connected (for transaction approval)
  const verifyUsbDevice = async (settings: typeof securitySettings): Promise<boolean> => {
    if (!settings?.usbEnabled || !settings?.usbDevice) return true // USB not required
    
    try {
      // Get all connected USB devices the browser has permission for
      const devices = await navigator.usb.getDevices()
      
      // Check if the registered device is connected
      const requiredDevice = {
        vendorId: settings.usbDevice.vendorId,
        productId: settings.usbDevice.productId,
        serialNumber: settings.usbDevice.serialNumber
      }
      
      const isConnected = devices.some(device => 
        device.vendorId === requiredDevice.vendorId &&
        device.productId === requiredDevice.productId &&
        (requiredDevice.serialNumber ? device.serialNumber === requiredDevice.serialNumber : true)
      )
      
      return isConnected
    } catch (e) {
      console.error('USB verification failed:', e)
      return false
    }
  }

  // Handler called when user taps "Verify" button for layers needing user gesture
  const handleVerifyButtonClick = async () => {
    const layer = txVerificationModal.currentLayer
    console.log('[handleVerifyButtonClick] Called for layer:', layer)
    
    let verified = false
    
    try {
      // USB and Bluetooth pickers CANNOT run from popup context in Chrome extensions
      // We open a dedicated popup window that can show the picker without closing the extension
      
      switch (layer) {
        case 'usb':
          if (securitySettings?.usbDevice) {
            console.log('[USB] Checking if registered device is connected...')
            const expectedDevice = securitySettings.usbDevice
            
            try {
              // Use getDevices() to check already-paired devices - NO PICKER NEEDED!
              // This only works if the device was previously paired via requestDevice()
              const devices = await navigator.usb.getDevices()
              console.log('[USB] Found', devices.length, 'paired devices')
              
              // Check if our registered device is connected
              const matchingDevice = devices.find(d => 
                d.vendorId === expectedDevice.vendorId && 
                d.productId === expectedDevice.productId
              )
              
              if (matchingDevice) {
                console.log('[USB]  Registered device is connected:', matchingDevice.productName)
                verified = true
              } else {
                console.log('[USB]  Registered device not found among connected devices')
                setTxVerificationModal(prev => ({
                  ...prev,
                  error: 'USB security key not detected. Please connect your device.'
                }))
                verified = false
              }
            } catch (e: any) {
              console.log('[USB] Error checking devices:', e.message)
              setTxVerificationModal(prev => ({
                ...prev,
                error: 'USB verification failed: ' + e.message
              }))
              verified = false
            }
          }
          break
          
        case 'bluetooth':
          // Bluetooth verification - open a tab where user can pick a Bluetooth device
          // MUST have a registered device to verify against
          // NOTE: This only works in extension context - PWA uses Web Bluetooth directly
          {
            console.log('[Bluetooth] User tapped verify, opening dedicated Bluetooth verify tab...')
            
            // PWA: Bluetooth verification via tab is extension-only
            if (!isExtensionContext()) {
              console.log('[Bluetooth] PWA mode - Bluetooth verification not supported')
              setTxVerificationModal(prev => ({
                ...prev,
                error: 'Bluetooth verification is only available in the browser extension.'
              }))
              verified = false
              break
            }
            
            const requestId = Date.now().toString()
            
            // Check for device in both new format (bluetoothDevice.id) and old storage format (bluetoothDeviceId)
            const expectedDeviceId = securitySettings?.bluetoothDevice?.id || (securitySettings as any)?.bluetoothDeviceId || ''
            const expectedDeviceName = securitySettings?.bluetoothDevice?.name || (securitySettings as any)?.bluetoothDeviceName || ''
            
            console.log('[Bluetooth] Expected device:', { id: expectedDeviceId, name: expectedDeviceName })
            
            // If no device registered, fail immediately
            if (!expectedDeviceId && !expectedDeviceName) {
              console.log('[Bluetooth] No device registered! Cannot verify.')
              setTxVerificationModal(prev => ({
                ...prev,
                error: 'No Bluetooth device registered. Configure in Security Settings.',
                pendingUserAction: false
              }))
              return false
            }
            
            // Save current state before opening tab (popup will close)
            // Use txVerificationModal state which has been set in runSecurityVerification
            const currentTxModal = {
              show: true,
              enabledLayers: { ...txVerificationModal.enabledLayers },
              completedLayers: { ...txVerificationModal.completedLayers },
              currentLayer: 'bluetooth' as const,
              error: null,
              pendingUserAction: false,
              txData: txVerificationModal.txData
            }
            console.log('[Bluetooth] Saving enabledLayers:', txVerificationModal.enabledLayers)
            console.log('[Bluetooth] Saving completedLayers:', txVerificationModal.completedLayers)
            
            await chrome.storage.local.set({
              pending_tx_state: {
                view,
                sendStep,
                selectedToken,
                amount,
                recipient,
                activeWallet,
                verifiedGeoLocation: pendingVerifiedGeoLocation || null, // Use state-tracked geo location
                securitySettings, // Save security settings for device info after resume
                txVerificationModal: currentTxModal,
                requestId,
                timestamp: Date.now()
              }
            })
            console.log('[Bluetooth] Saved pending transaction state with activeWallet:', activeWallet)
            
            // Create tab URL for Bluetooth verification - pass both ID and name for matching
            const tabUrl = chrome.runtime.getURL(
              `tabs/bluetooth-verify/index.html?requestId=${requestId}${expectedDeviceId ? `&id=${encodeURIComponent(expectedDeviceId)}` : ''}${expectedDeviceName ? `&name=${encodeURIComponent(expectedDeviceName)}` : ''}`
            )
            
            // Set up message listener before opening tab
            const verifyPromise = new Promise<boolean>((resolve) => {
              const timeout = setTimeout(() => {
                chrome.runtime.onMessage.removeListener(listener)
                console.log('[Bluetooth] Verification timed out')
                resolve(false)
              }, 120000) // 2 minute timeout
              
              const listener = (message: any) => {
                if (message.type === 'BLUETOOTH_VERIFY_RESULT' && message.requestId === requestId) {
                  chrome.runtime.onMessage.removeListener(listener)
                  clearTimeout(timeout)
                  console.log('[Bluetooth] Got result from tab:', message)
                  
                  // Clear pending state on success
                  chrome.storage.local.remove('pending_tx_state')
                  
                  if (message.success) {
                    resolve(true)
                  } else {
                    setTxVerificationModal(prev => ({
                      ...prev,
                      error: message.error || 'Bluetooth verification cancelled'
                    }))
                    resolve(false)
                  }
                }
              }
              chrome.runtime.onMessage.addListener(listener)
            })
            
            // Open as regular tab - tabs have full Web Bluetooth access
            await chrome.tabs.create({
              url: tabUrl,
              active: true
            })
            
            // Wait for result
            verified = await verifyPromise
            console.log('[Bluetooth] Verification result:', verified)
          }
          break
          
        case 'biometric':
          console.log('[Biometric] User tapped verify, triggering platform auth...')
          const challenge = new Uint8Array(32)
          crypto.getRandomValues(challenge)
          
          // PWA: Use window.location.hostname as rpId, extension uses chrome.runtime.id
          const rpId = isExtensionContext() ? chrome.runtime.id : window.location.hostname
          
          const credential = await navigator.credentials.get({
            publicKey: {
              challenge: challenge,
              timeout: 60000,
              userVerification: 'required',
              rpId: rpId,
              allowCredentials: []
            }
          })
          verified = !!credential
          console.log('[Biometric] Result:', verified)
          break
      }
    } catch (e: any) {
      console.log(`[${layer}] User cancelled or failed:`, e.message)
      verified = false
    }
    
    // Resolve the pending promise
    if (pendingVerificationResolve.current) {
      pendingVerificationResolve.current(verified)
      pendingVerificationResolve.current = null
    }
  }

  // ============================================================================
  // SECURITY VERIFICATION FLOW
  // Shows the animated verification modal and runs real verification for each layer
  // Returns true if all layers passed, false if any failed or user cancelled
  // preCompletedLayers allows resuming verification after USB/Bluetooth tab verification
  // preEnabledLayers allows using saved enabled layers (critical for resuming after tab closes!)
  // ============================================================================
  const runSecurityVerification = async (
    txData: { type: 'send' | 'swap' | 'sign'; amount?: string; token?: string; toToken?: string; recipient?: string; recipientName?: string },
    onAllLayersVerified: () => Promise<void>,
    preCompletedLayers?: { voice?: boolean; geo?: boolean; usb?: boolean; bluetooth?: boolean; wifi?: boolean; biometric?: boolean },
    preVerifiedGeoLocation?: { latitude: number; longitude: number; accuracy?: number },
    preEnabledLayers?: { voice: boolean; geo: boolean; usb: boolean; bluetooth: boolean; wifi: boolean; biometric: boolean }
  ): Promise<boolean> => {
    console.log('[runSecurityVerification] Called, preCompletedLayers:', preCompletedLayers ? 'yes' : 'no')
    if (!wallet) return false

    // Store verified geo location - either from pre-verified or will be set during geo verification
    let verifiedGeoLocation: { latitude: number; longitude: number; accuracy?: number } | null = preVerifiedGeoLocation || null

    // =========================================================================
    // CRITICAL SECURITY FIX: Always fetch FRESH security settings from the API
    // before running any transaction verification. This ensures we get the 
    // actual server-stored settings, not potentially stale/null React state.
    // If the user is not found in the database, we MUST block the transaction!
    // =========================================================================
    let freshSecuritySettings = securitySettings
    if (!preEnabledLayers) {
      try {
        console.log('[runSecurityVerification] Fetching FRESH security settings from API...')
        freshSecuritySettings = await getSecuritySettings(wallet.publicKey.toBase58())
        console.log('[runSecurityVerification] Fresh settings received:', JSON.stringify(freshSecuritySettings))
        // Update React state with fresh settings
        setSecuritySettings(freshSecuritySettings)
      } catch (e: any) {
        console.error('[runSecurityVerification] CRITICAL: Failed to fetch security settings from API:', e)
        // SECURITY BLOCK: If we can't verify the user exists in the database,
        // we MUST NOT allow the transaction to proceed!
        setStatus("Security verification failed: Vault not registered. Please re-activate your vault.")
        return false
      }
    }

    // Determine which layers are enabled - USE PRE-ENABLED IF PROVIDED (critical for resume!)
    // Otherwise calculate fresh from the API-fetched settings
    // NOTE: voice layer for transactions uses freshSecuritySettings.voiceLayerEnabled (separate from voiceUnlockEnabled which is for wallet unlock)
    const enabledLayers = preEnabledLayers || {
      voice: freshSecuritySettings?.voiceLayerEnabled || false,
      geo: true, // Geo is always enabled for vault
      usb: freshSecuritySettings?.usbEnabled || false,
      bluetooth: freshSecuritySettings?.bluetoothEnabled || false,
      wifi: freshSecuritySettings?.wifiEnabled || false,
      biometric: freshSecuritySettings?.biometricEnabled || false
    }
    console.log('[runSecurityVerification] enabledLayers:', enabledLayers, preEnabledLayers ? '(from saved state)' : '(FRESH from API)')

    // Initialize completed layers - use pre-completed if provided
    const completedLayers = {
      voice: preCompletedLayers?.voice || false,
      geo: preCompletedLayers?.geo || false,
      usb: preCompletedLayers?.usb || false,
      bluetooth: preCompletedLayers?.bluetooth || false,
      wifi: preCompletedLayers?.wifi || false,
      biometric: preCompletedLayers?.biometric || false
    }

    // Get the order of layers to verify (only enabled ones)
    const layerOrder: ('voice' | 'geo' | 'usb' | 'bluetooth' | 'wifi' | 'biometric')[] = []
    if (enabledLayers.voice) layerOrder.push('voice')
    if (enabledLayers.geo) layerOrder.push('geo')
    if (enabledLayers.usb) layerOrder.push('usb')
    if (enabledLayers.bluetooth) layerOrder.push('bluetooth')
    if (enabledLayers.wifi) layerOrder.push('wifi')
    if (enabledLayers.biometric) layerOrder.push('biometric')
    console.log('[runSecurityVerification] layerOrder:', layerOrder)

    // If no layers enabled (shouldn't happen, but safety check)
    if (layerOrder.length === 0) {
      console.log('[runSecurityVerification] No layers enabled, executing directly')
      await onAllLayersVerified()
      return true
    }

    // Find first non-completed layer to start from
    let startLayerIndex = 0
    for (let i = 0; i < layerOrder.length; i++) {
      if (!completedLayers[layerOrder[i]]) {
        startLayerIndex = i
        break
      }
    }
    console.log('[runSecurityVerification] Starting from layer index:', startLayerIndex, layerOrder[startLayerIndex])

    // Initialize the modal with pre-completed layers
    console.log('[runSecurityVerification] Setting modal to show: true')
    setTxVerificationModal({
      show: true,
      enabledLayers,
      completedLayers: completedLayers,
      currentLayer: layerOrder[startLayerIndex],
      error: null,
      pendingUserAction: false,
      txData
    })

    // Helper to wait for user gesture
    const waitForUserGesture = (): Promise<boolean> => {
      return new Promise((resolve) => {
        pendingVerificationResolve.current = resolve
        setTxVerificationModal(prev => ({ ...prev, pendingUserAction: true }))
      })
    }

    try {
      // Verify each layer in sequence
      console.log('[runSecurityVerification] Starting layer verification loop')
      for (let i = 0; i < layerOrder.length; i++) {
        const layer = layerOrder[i]
        console.log(`[runSecurityVerification] Processing layer ${i + 1}/${layerOrder.length}: ${layer}`)
        
        // Skip if this layer is already completed (from pre-completed layers)
        if (completedLayers[layer]) {
          console.log(`[runSecurityVerification] Layer ${layer} already completed, skipping`)
          continue
        }
        
        // Update current layer
        setTxVerificationModal(prev => ({
          ...prev,
          currentLayer: layer,
          pendingUserAction: false
        }))

        // Small delay before starting verification for UX
        await new Promise(r => setTimeout(r, 500))

        // Perform actual verification for this layer
        let verified = false
        
        switch (layer) {
          case 'voice':
            try {
              console.log('[Voice] Starting verification, wallet:', wallet.publicKey.toBase58())
              const fpResult = await getVoiceFingerprint(wallet.publicKey.toBase58())
              console.log('[Voice] Fingerprint result:', JSON.stringify(fpResult))
              
              // Check if user has enrolled voice - fingerprint field exists
              if (fpResult.fingerprint) {
                console.log('[Voice] Fingerprint found, opening voice verification modal...')
                
                // Open the VoiceEnrollmentModal in verify-for-tx mode and wait for result
                const verifyResult = await new Promise<{ success: boolean; confidence?: number }>((resolve) => {
                  // Store the resolve function so the modal's onComplete can call it
                  pendingVoiceVerificationResolve.current = resolve
                  
                  // Open the voice verification modal
                  setVoiceEnrollmentModal({
                    show: true,
                    mode: 'verify-for-tx',
                    walletAddress: wallet.publicKey.toBase58(),
                    enrolledFingerprint: fpResult.fingerprint
                  })
                  
                  // Force a re-render by using flushSync or small timeout
                  // React batches state updates, so we need to ensure the modal renders
                  console.log('[Voice] Modal state set, waiting for user interaction...')
                })
                
                console.log('[Voice] Verify result:', verifyResult.success)
                verified = verifyResult.success
                if (!verified) {
                  console.log('[Voice] Verification failed or cancelled')
                }
              } else {
                // CRITICAL SECURITY: Voice layer is ENABLED but no fingerprint on server!
                // This should not happen - block the transaction
                console.error('[Voice] SECURITY BLOCK: Voice enabled but no fingerprint on server!')
                setTxVerificationModal(prev => ({
                  ...prev,
                  error: 'Voice not enrolled. Please set up voice verification in Security settings.',
                  currentLayer: null
                }))
                verified = false
              }
            } catch (e) {
              // CRITICAL SECURITY: On error, we MUST NOT allow transaction
              console.error('[Voice] Verification error:', e)
              setTxVerificationModal(prev => ({
                ...prev,
                error: 'Voice verification failed. Please try again.',
                currentLayer: null
              }))
              verified = false
            }
            break
            
          case 'geo':
            try {
              console.log('[Geo] Starting location verification')
              const location = await getBrowserLocation()
              verified = !!location && typeof location.latitude === 'number'
              if (verified && location) {
                // Store verified location for later use (server approval) - include accuracy for adaptive geo-fence
                verifiedGeoLocation = { latitude: location.latitude, longitude: location.longitude, accuracy: location.accuracy }
                console.log('[Geo] Location captured')
                // Also save to state for use in handleVerifyButtonClick (for later USB/Bluetooth saves)
                setPendingVerifiedGeoLocation(verifiedGeoLocation)
              } else {
                console.log('[Geo] Location not available or denied')
              }
              console.log('[Geo] Verified:', verified)
            } catch (e) {
              // CRITICAL SECURITY: Geo is always required for vault transactions
              console.error('[Geo] Verification error:', e)
              setTxVerificationModal(prev => ({
                ...prev,
                error: 'Location verification failed. Please enable location access.',
                currentLayer: null
              }))
              verified = false
            }
            break
            
          case 'usb':
            console.log('[USB] Starting verification')
            console.log('[USB] freshSecuritySettings?.usbEnabled:', freshSecuritySettings?.usbEnabled)
            console.log('[USB] freshSecuritySettings?.usbDevice:', JSON.stringify(freshSecuritySettings?.usbDevice))
            if (freshSecuritySettings?.usbEnabled && freshSecuritySettings?.usbDevice) {
              console.log('[USB] Opening verification tab...')
              const expectedDevice = freshSecuritySettings.usbDevice
              const requestId = Date.now().toString()
              
              // Save current state before opening tab (popup will close)
              // IMPORTANT: Use local completedLayers AND local enabledLayers, not txVerificationModal state
              // because React state updates are async and may not reflect recent layer completions
              const currentTxModal = {
                show: true,
                enabledLayers: { ...enabledLayers }, // Use LOCAL enabledLayers!
                completedLayers: { ...completedLayers }, // Use LOCAL completedLayers!
                currentLayer: 'usb' as const,
                error: null,
                pendingUserAction: false,
                txData: txVerificationModal.txData
              }
              console.log('[USB] Saving enabledLayers:', enabledLayers)
              console.log('[USB] Saving completedLayers:', completedLayers)
              
              await chrome.storage.local.set({
                pending_tx_state: {
                  view,
                  sendStep,
                  selectedToken,
                  amount,
                  recipient,
                  activeWallet,
                  verifiedGeoLocation, // Save the geo location that was already verified
                  securitySettings: freshSecuritySettings, // Save FRESH security settings for device info after resume
                  txVerificationModal: currentTxModal,
                  requestId,
                  timestamp: Date.now()
                }
              })
              console.log('[USB] Saved pending transaction state')
              
              // Open as a FULL TAB - popup windows have WebUSB restrictions!
              const tabUrl = chrome.runtime.getURL(
                `tabs/usb-verify/index.html?requestId=${requestId}&name=${encodeURIComponent(expectedDevice.productName || '')}`
              )
              
              // Set up message listener before opening tab
              const verifyPromise = new Promise<boolean>((resolve) => {
                const timeout = setTimeout(() => {
                  chrome.runtime.onMessage.removeListener(listener)
                  console.log('[USB] Verification timed out')
                  resolve(false)
                }, 120000) // 2 minute timeout
                
                const listener = (message: any) => {
                  if (message.type === 'USB_VERIFY_RESULT' && message.requestId === requestId) {
                    chrome.runtime.onMessage.removeListener(listener)
                    clearTimeout(timeout)
                    console.log('[USB] Got result from tab:', message)
                    
                    // Clear pending state on success
                    chrome.storage.local.remove('pending_tx_state')
                    
                    if (message.success) {
                      resolve(true)
                    } else {
                      setTxVerificationModal(prev => ({
                        ...prev,
                        error: message.error || 'USB verification cancelled'
                      }))
                      resolve(false)
                    }
                  }
                }
                chrome.runtime.onMessage.addListener(listener)
              })
              
              // Open as regular tab (not popup) - tabs have full WebUSB access
              await chrome.tabs.create({
                url: tabUrl,
                active: true
              })
              
              // Wait for result
              verified = await verifyPromise
              console.log('[USB] Verification result:', verified)
            } else {
              console.log('[USB] Not enabled or no device configured, skipping')
              verified = true
            }
            break
            
          case 'bluetooth':
            console.log('[Bluetooth] Starting verification, enabled:', enabledLayers.bluetooth)
            if (enabledLayers.bluetooth) {
              // Bluetooth picker requires user gesture - show TAP TO VERIFY button
              // This will open a tab where user can select their Bluetooth device
              console.log('[Bluetooth] Waiting for user to tap verify button...')
              verified = await waitForUserGesture()
              console.log('[Bluetooth] User gesture result:', verified)
            } else {
              console.log('[Bluetooth] Not enabled, skipping')
              verified = true
            }
            break
            
          case 'wifi':
            console.log('[WiFi/2FA Mobile] Starting verification, enabled:', enabledLayers.wifi)
            // Check for BSSID in both new format (wifiDevice.bssid) and old storage format (wifiBssid)
            const expectedBssid = freshSecuritySettings?.wifiDevice?.bssid || (freshSecuritySettings as any)?.wifiBssid
            console.log('[WiFi/2FA Mobile] Expected BSSID:', expectedBssid)
            
            if (enabledLayers.wifi) {
              // WiFi/2FA Mobile - show QR code for user to scan with their phone
              // The phone will verify it's on the expected WiFi network
              try {
                const { createMobileSession, checkMobileSession, cancelMobileSession } = await import('./utils/qr-verify')
                
                // Use 'verify' mode - if we have an expected BSSID, pass it for network verification
                const session = await createMobileSession(wallet.publicKey.toBase58(), 'verify', expectedBssid || undefined)
                if (!session) {
                  console.log('[WiFi/2FA Mobile] Failed to create session')
                  verified = false
                } else {
                  console.log('[WiFi/2FA Mobile] Session created, showing QR code:', session.sessionId)
                  
                  // Update tx verification modal to show QR code
                  setTxVerificationModal(prev => ({
                    ...prev,
                    wifiQrData: session.qrData,
                    wifiSessionId: session.sessionId
                  }))
                  
                  // Poll for verification (max 60 seconds)
                  let attempts = 0
                  const maxAttempts = 30
                  
                  while (attempts < maxAttempts) {
                    await new Promise(r => setTimeout(r, 2000))
                    const status = await checkMobileSession(session.sessionId)
                    console.log('[WiFi/2FA Mobile] Poll status:', status.status)
                    
                    if (status.status === 'verified') {
                      verified = true
                      break
                    } else if (status.status === 'failed') {
                      verified = false
                      break
                    }
                    attempts++
                  }
                  
                  // Clear QR code from tx modal
                  setTxVerificationModal(prev => ({
                    ...prev,
                    wifiQrData: undefined,
                    wifiSessionId: undefined
                  }))
                  
                  if (!verified && attempts >= maxAttempts) {
                    await cancelMobileSession(session.sessionId)
                    console.log('[WiFi/2FA Mobile] Timed out waiting for scan')
                  }
                }
              } catch (e: any) {
                console.log('[WiFi/2FA Mobile] Error:', e.message)
                verified = false
              }
            } else {
              console.log('[WiFi/2FA Mobile] Not enabled, skipping')
              verified = true
            }
            break
            
          case 'biometric':
            console.log('[Biometric] Starting verification, enabled:', enabledLayers.biometric)
            if (enabledLayers.biometric) {
              // Use native biometric (Face ID / Touch ID) directly on device
              try {
                const { verifyBiometric, isBiometricEnrolled } = await import('./utils/native-biometric')
                
                // Check if biometric is enrolled LOCALLY (WebAuthn credential in localStorage)
                if (!isBiometricEnrolled(wallet.publicKey.toBase58())) {
                  // CRITICAL SECURITY: Biometric is ENABLED on server but no local credential!
                  // This could mean: cleared browser data, different device, or tampering
                  // We MUST NOT skip - require re-enrollment or block transaction
                  console.error('[Biometric] SECURITY BLOCK: Enabled on server but no local credential!')
                  setTxVerificationModal(prev => ({
                    ...prev,
                    error: 'Biometric not set up on this device. Please re-enroll Face ID/Touch ID in Security settings.',
                    currentLayer: null
                  }))
                  verified = false
                } else {
                  console.log('[Biometric] Prompting for Face ID / Touch ID...')
                  
                  const result = await verifyBiometric(wallet.publicKey.toBase58())
                  console.log('[Biometric] Result:', result)
                  
                  verified = result.success
                  if (!verified) {
                    console.log('[Biometric] Verification failed:', result.error)
                  }
                }
              } catch (e: any) {
                console.log('[Biometric] Error:', e.message)
                verified = false
              }
            } else {
              console.log('[Biometric] Not enabled, skipping')
              verified = true
            }
            break
        }

        // If verification failed, show error and abort
        if (!verified) {
          console.log(`[runSecurityVerification] Layer ${layer} FAILED`)
          setTxVerificationModal(prev => ({
            ...prev,
            error: `${layer.charAt(0).toUpperCase() + layer.slice(1)} verification failed`,
            currentLayer: null,
            pendingUserAction: false
          }))
          
          // Keep modal open for 2s to show error, then close
          await new Promise(r => setTimeout(r, 2000))
          setTxVerificationModal(prev => ({ ...prev, show: false }))
          return false
        }

        console.log(`[runSecurityVerification] Layer ${layer} PASSED `)
        // Mark layer as completed in local tracking AND React state
        completedLayers[layer] = true
        setTxVerificationModal(prev => ({
          ...prev,
          completedLayers: { ...prev.completedLayers, [layer]: true }
        }))

        // Small delay between layers for visual effect
        await new Promise(r => setTimeout(r, 800))
      }

      // All security layers passed! Now proceed to transaction
      console.log('[runSecurityVerification] ALL LAYERS PASSED! Starting transaction flow...')
      setTxVerificationModal(prev => ({
        ...prev,
        currentLayer: 'proposal'
      }))

      await new Promise(r => setTimeout(r, 1000))

      setTxVerificationModal(prev => ({
        ...prev,
        currentLayer: 'approval'
      }))

      // Execute the actual transaction
      console.log('[runSecurityVerification] Calling onAllLayersVerified...')
      await onAllLayersVerified()
      console.log('[runSecurityVerification] onAllLayersVerified completed!')

      setTxVerificationModal(prev => ({
        ...prev,
        currentLayer: 'execute'
      }))

      await new Promise(r => setTimeout(r, 1000))

      setTxVerificationModal(prev => ({
        ...prev,
        currentLayer: 'done'
      }))
      console.log('[runSecurityVerification] Transaction complete! Showing success.')

      // Keep modal showing success for 2s
      await new Promise(r => setTimeout(r, 2000))
      setTxVerificationModal(prev => ({ ...prev, show: false }))

      return true
    } catch (error: any) {
      console.error('[runSecurityVerification] ERROR:', error)
      
      // Check if this is a geo-fence error with distance data
      if (error instanceof GeoFenceError || error.name === 'GeoFenceError') {
        setTxVerificationModal(prev => ({ ...prev, show: false }))
        setGeoErrorModal({ 
          show: true, 
          distance: error.distance, 
          requiredRange: error.requiredRange 
        })
        return false
      }
      
      setTxVerificationModal(prev => ({
        ...prev,
        error: error.message || 'Verification failed',
        currentLayer: null
      }))
      await new Promise(r => setTimeout(r, 2000))
      setTxVerificationModal(prev => ({ ...prev, show: false }))
      return false
    }
  }

  // Wrapper to continue transfer with pre-completed security layers (after USB/Bluetooth tab verification)
  const handleTransferWithPrecompletedLayers = async () => {
    console.log('[handleTransferWithPrecompletedLayers] Called with layers:', pendingVerificationLayers)
    if (!wallet || !pendingVerificationLayers) {
      console.log('[handleTransferWithPrecompletedLayers] Missing wallet or layers')
      return
    }
    
    // This is similar to handleTransfer but passes pre-completed layers
    try {
      if (activeWallet !== "vault") {
        console.log('[handleTransferWithPrecompletedLayers] Not vault wallet, skipping')
        return
      }
      
      if (!multisigPda || !vaultPda) throw new Error("Vault not initialized")

      const savedRecipient = addressBook.find(a => a.address === recipient)
      let txSignature: string | null = null
      const txStartTime = Date.now()
      
      console.log('[handleTransferWithPrecompletedLayers] Running verification with pre-completed layers')
      console.log('[handleTransferWithPrecompletedLayers] pendingEnabledLayers:', pendingEnabledLayers)
      const verified = await runSecurityVerification(
        { 
          type: 'send', 
          amount: amount, 
          token: selectedToken?.symbol || 'SOL', 
          recipient: `${recipient.slice(0, 4)}...${recipient.slice(-4)}`,
          recipientName: savedRecipient?.label
        },
        async () => {
          // This runs after all security layers pass
          const multisigKey = new PublicKey(multisigPda)
          const vaultKey = new PublicKey(vaultPda)
          const recipientKey = new PublicKey(recipient)
          const lamports = Math.round(parseFloat(amount) * 1e9)
          
          // Use the pre-verified geo location if available, otherwise get a new one
          const location = pendingVerifiedGeoLocation || await getBrowserLocation()
          console.log("[Security] Requesting server approval...")
          
          const txIndex = await getNextTransactionIndex(connection, multisigKey)
          console.log("[Squads] Using transaction index:", txIndex.toString())

          await createTransferProposal(connection, wallet, multisigKey, vaultKey, recipientKey, lamports, txIndex)
          console.log(" Waiting 2 seconds for RPC to sync proposal...")
          await new Promise(resolve => setTimeout(resolve, 2000))

          await requestServerApproval(multisigPda, wallet.publicKey.toBase58(), txIndex.toString(), location)
          console.log("[Security]  Server approved (geo-fence verified)")
          
          txSignature = await executeProposal(connection, wallet, multisigKey, txIndex)
        },
        pendingVerificationLayers, // Pass pre-completed layers!
        pendingVerifiedGeoLocation || undefined, // Pass pre-verified geo location!
        pendingEnabledLayers || undefined // Pass pre-enabled layers! CRITICAL for knowing which layers to run
      )

      // Clear the pending layers, geo location, and enabled layers
      setPendingVerificationLayers(null)
      setPendingVerifiedGeoLocation(null)
      setPendingEnabledLayers(null)

      if (verified) {
        const existingIndex = recentAddresses.findIndex(a => a.address === recipient)
        const newRecentAddress: SavedAddress = {
          address: recipient,
          label: savedRecipient?.label || '',
          lastUsed: Date.now()
        }
        if (existingIndex >= 0) {
          setRecentAddresses(prev => prev.map((a, i) => i === existingIndex ? newRecentAddress : a))
        } else {
          setRecentAddresses(prev => [newRecentAddress, ...prev].slice(0, 10))
        }
        
        const txEndTime = Date.now()
        setLastTxTime((txEndTime - txStartTime) / 1000)
        console.log('[Vault Send] Transaction signature:', txSignature)
        setLastTxSignature(txSignature)
        setSendStep("success")
        setStatus("")
      } else {
        console.log('[handleTransferWithPrecompletedLayers] Verification failed or cancelled')
        setStatus("Transaction cancelled")
      }
    } catch (error: any) {
      console.error('[handleTransferWithPrecompletedLayers] Error:', error)
      setStatus(error.message || "Transfer failed")
    }
  }

  const handleTransfer = async () => {
    console.log('[handleTransfer] Called, wallet:', !!wallet, 'activeWallet:', activeWallet)
    if (!wallet) {
      console.log('[handleTransfer] No wallet, returning')
      return
    }
    
    try {
      console.log('[handleTransfer] Starting transfer, activeWallet:', activeWallet)
      if (activeWallet === "master") {
          // Master wallet - simple send (no security layers)
          setIsLoading(true)
          setStatus("Sending...")
          
          const txStartTime = Date.now()
          const signature = await sendSol(wallet, recipient, parseFloat(amount))
          const txEndTime = Date.now()
          setLastTxTime((txEndTime - txStartTime) / 1000)
          
          // Add recipient to recent addresses
          const savedRecipient = addressBook.find(a => a.address === recipient)
          const existingIndex = recentAddresses.findIndex(a => a.address === recipient)
          const newRecentAddress: SavedAddress = {
            address: recipient,
            label: savedRecipient?.label || '',
            lastUsed: Date.now()
          }
          if (existingIndex >= 0) {
            setRecentAddresses(prev => prev.map((a, i) => i === existingIndex ? newRecentAddress : a))
          } else {
            setRecentAddresses(prev => [newRecentAddress, ...prev].slice(0, 10))
          }
          
          // Set signature and go to success screen
          setLastTxSignature(signature || null)
          setSendStep("success")
          setIsLoading(false)
          setStatus("")
      } else {
          // Vault wallet - use security verification modal
          console.log('[handleTransfer] Vault wallet path, multisigPda:', multisigPda, 'vaultPda:', vaultPda)
          if (!multisigPda || !vaultPda) throw new Error("Vault not initialized")

          const savedRecipient = addressBook.find(a => a.address === recipient)
          let txSignature: string | null = null
          const txStartTime = Date.now()
          
          console.log('[handleTransfer] About to call runSecurityVerification')
          // Run security verification with animated modal
          const verified = await runSecurityVerification(
            { 
              type: 'send', 
              amount: amount, 
              token: selectedToken?.symbol || 'SOL', 
              recipient: `${recipient.slice(0, 4)}...${recipient.slice(-4)}`,
              recipientName: savedRecipient?.label
            },
            async () => {
              // This runs after all security layers pass
              const multisigKey = new PublicKey(multisigPda)
              const vaultKey = new PublicKey(vaultPda)
              const recipientKey = new PublicKey(recipient)
              const lamports = Math.round(parseFloat(amount) * 1e9)
              
              // Get location for server approval
              const location = await getBrowserLocation()
              
              // Get the actual next transaction index from the multisig
              const txIndex = await getNextTransactionIndex(connection, multisigKey)
              console.log("[Squads] Using transaction index:", txIndex.toString())

              // Create proposal
              await createTransferProposal(connection, wallet, multisigKey, vaultKey, recipientKey, lamports, txIndex)

              // Wait for RPC to sync proposal creation
              console.log(" Waiting 2 seconds for RPC to sync proposal...")
              await new Promise(resolve => setTimeout(resolve, 2000))

              // Server validates geo-fence and approves if within range
              await requestServerApproval(multisigPda, wallet.publicKey.toBase58(), txIndex.toString(), location)
              console.log("[Security]  Server approved (geo-fence verified)")
              
              // Execute the proposal and get signature
              txSignature = await executeProposal(connection, wallet, multisigKey, txIndex)
            }
          )

          if (verified) {
            // Add recipient to recent addresses
            const existingIndex = recentAddresses.findIndex(a => a.address === recipient)
            const newRecentAddress: SavedAddress = {
              address: recipient,
              label: savedRecipient?.label || '',
              lastUsed: Date.now()
            }
            if (existingIndex >= 0) {
              setRecentAddresses(prev => prev.map((a, i) => i === existingIndex ? newRecentAddress : a))
            } else {
              setRecentAddresses(prev => [newRecentAddress, ...prev].slice(0, 10))
            }
            
            // Set signature, timing, and go to success screen
            const txEndTime = Date.now()
            setLastTxTime((txEndTime - txStartTime) / 1000)
            setLastTxSignature(txSignature)
            setSendStep("success")
          }
      }
    } catch (e: any) {
      console.error(e)
      setStatus("Error: " + e.message)
      setIsLoading(false)
    }
  }

  // Handle unlock - defined before views that use it
  const handleUnlock = (response?: any) => {
    // Set unlocked flag
    localStorage.setItem('geovault_wallet_unlocked', 'true');
    
    // If response has secretKey, restore the wallet
    if (response?.secretKey) {
      const kp = getKeypairFromSecret(response.secretKey);
      setWallet(kp);
    } else if (storedSecret) {
      // Restore from stored secret
      const kp = getKeypairFromSecret(storedSecret);
      setWallet(kp);
    }
    
    setWalletStatus({ isOnboarded: true, isLocked: false });
    setView("main");
  }

  // --- Views ---

  // Show unlock screen if wallet is locked
  if (walletStatus?.isLocked) {
    return <UnlockScreen onUnlock={handleUnlock} />
  }

  // Show desktop-only message if NOT on a mobile device
  if (!isMobileDevice) {
    return (
      <div className="app-container" style={{
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '24px',
        textAlign: 'center',
        background: '#121216',
        minHeight: '100vh'
      }}>
        {/* CSS Keyframes for orbit animation */}
        <style>
          {`
            @keyframes desktopOrbitRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
            @keyframes desktopOrbitRotateReverse { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
            @keyframes desktopCounterRotate { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
            @keyframes desktopCounterRotateReverse { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
          `}
        </style>
        
        {/* Spacer */}
        <div style={{ flex: 1 }} />
        
        {/* Animated Logo with orbits */}
        <div style={{ 
          position: 'relative', 
          width: 200, 
          height: 200, 
          marginBottom: 40,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }}>
          {/* Logo */}
          <div style={{
            width: 80,
            height: 80,
            borderRadius: 20,
            background: 'rgba(255, 255, 255, 0.05)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.4)',
            zIndex: 2
          }}>
            <img 
              src="/assets/arguslogo.png"
              alt="ARGUS"
              style={{ width: 48, height: 48, objectFit: 'contain' }}
              onError={(e) => {
                e.currentTarget.style.display = 'none';
              }}
            />
          </div>
          
          {/* Inner orbit ring */}
          <div style={{
            position: 'absolute',
            width: 130,
            height: 130,
            borderRadius: '50%',
            border: '1px solid rgba(255, 255, 255, 0.08)'
          }} />
          
          {/* Outer orbit ring */}
          <div style={{
            position: 'absolute',
            width: 190,
            height: 190,
            borderRadius: '50%',
            border: '1px solid rgba(255, 255, 255, 0.05)'
          }} />
          
          {/* Inner rotating orbit with dots */}
          <div style={{ 
            position: 'absolute', 
            width: 130, 
            height: 130, 
            borderRadius: '50%', 
            animation: 'desktopOrbitRotate 20s linear infinite'
          }}>
            {[0, 120, 240].map((angle, i) => {
              const colors = ['#8b5cf6', '#3b82f6', '#10b981'];
              const rad = (angle * Math.PI) / 180;
              const x = 65 + 65 * Math.sin(rad);
              const y = 65 - 65 * Math.cos(rad);
              return (
                <div key={i} style={{
                  position: 'absolute',
                  width: 8,
                  height: 8,
                  borderRadius: '50%',
                  background: colors[i],
                  left: x - 4,
                  top: y - 4,
                  boxShadow: `0 0 10px ${colors[i]}`,
                  animation: 'desktopCounterRotate 20s linear infinite'
                }} />
              );
            })}
          </div>
          
          {/* Outer rotating orbit with dots (reverse) */}
          <div style={{ 
            position: 'absolute', 
            width: 190, 
            height: 190, 
            borderRadius: '50%', 
            animation: 'desktopOrbitRotateReverse 30s linear infinite'
          }}>
            {[45, 135, 225, 315].map((angle, i) => {
              const colors = ['#f59e0b', '#ec4899', '#06b6d4', '#6366f1'];
              const rad = (angle * Math.PI) / 180;
              const x = 95 + 95 * Math.sin(rad);
              const y = 95 - 95 * Math.cos(rad);
              return (
                <div key={i} style={{
                  position: 'absolute',
                  width: 6,
                  height: 6,
                  borderRadius: '50%',
                  background: colors[i],
                  left: x - 3,
                  top: y - 3,
                  boxShadow: `0 0 8px ${colors[i]}`,
                  opacity: 0.7,
                  animation: 'desktopCounterRotateReverse 30s linear infinite'
                }} />
              );
            })}
          </div>
        </div>
        
        <h1 style={{ 
          fontSize: 28, 
          fontWeight: 700, 
          color: '#fff', 
          marginBottom: 16, 
          marginTop: 0
        }}>
          Mobile Only
        </h1>
        
        <p style={{ 
          fontSize: 15, 
          color: 'rgba(255, 255, 255, 0.5)', 
          marginBottom: 32, 
          marginTop: 0,
          lineHeight: 1.7, 
          maxWidth: 360,
          padding: '0 20px'
        }}>
          ARGUS Mobile is designed exclusively for smartphones and tablets. 
          For desktop and laptop use, please install our browser extension.
        </p>
        
        {/* Extension Download Button */}
        <a
          href="https://argus.foundation"
          target="_blank"
          rel="noopener noreferrer"
          style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 10,
            padding: '16px 32px',
            background: '#fff',
            border: 'none',
            borderRadius: 14,
            color: '#000',
            fontSize: 15,
            fontWeight: 600,
            textDecoration: 'none',
            cursor: 'pointer',
            marginBottom: 16
          }}
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download Extension
        </a>
        
        <p style={{ 
          fontSize: 12, 
          color: 'rgba(255, 255, 255, 0.3)', 
          marginTop: 8
        }}>
          Available for Chrome, Brave & Edge
        </p>
        
        {/* Spacer */}
        <div style={{ flex: 1.3 }} />
        
        {/* Footer */}
        <div style={{ 
          fontSize: 11, 
          color: 'rgba(255, 255, 255, 0.25)',
          display: 'flex',
          alignItems: 'center',
          gap: 6
        }}>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
          Secured by ARGUS Protocol
        </div>
      </div>
    );
  }

  // Wait for storage to be fully loaded before showing anything
  // We consider storage "loaded" once the hook has run (value will be undefined for new users, but that's OK)
  // The hook now immediately reads from localStorage, so undefined means "no wallet" not "loading"
  const hasExistingWallet = (storedSecret && storedSecret.length > 0) || (storedAccounts && storedAccounts.length > 0)
  console.log('[App] hasExistingWallet:', hasExistingWallet, 'storedSecret:', !!storedSecret, 'storedAccounts:', storedAccounts?.length || 0)
  
  if (isCheckingPendingState) {
    return (
      <div className="app-container" style={{justifyContent: 'center', alignItems: 'center'}}>
        <div style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)' }}>{'Resuming...'}</div>
      </div>
    )
  }

  // CRITICAL: Transaction Verification Modal - renders as HIGHEST PRIORITY fixed overlay
  // This MUST be checked before any view-specific rendering to ensure the modal shows
  // regardless of which view is active during security verification
  if (txVerificationModal.show) {
    return (
      <>
        <style>
          {`
            @keyframes txFadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes txSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes txOrbitRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
            @keyframes txCounterRotate { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
            @keyframes txOrbitRotateReverse { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
            @keyframes txCounterRotateReverse { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
            @keyframes txIconPulseWhite { 0%, 100% { box-shadow: 0 0 8px rgba(255, 255, 255, 0.3); color: rgba(180, 180, 180, 0.9); } 50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.6); color: rgba(255, 255, 255, 1); } }
            @keyframes txSuccessPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
          `}
        </style>
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: '#0a0a0c', zIndex: 10000, animation: 'txFadeIn 0.3s ease-out', overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
          <video autoPlay loop muted playsInline style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', minWidth: '100%', minHeight: '100%', width: 'auto', height: 'auto', objectFit: 'cover', opacity: 0.35 }}>
            <source src="https://brown-traditional-sheep-998.mypinata.cloud/ipfs/bafybeicmrwektqnpcgast66rua3czhzwx2aasfncb6zdzysmnsfosewfw4" type="video/mp4" />
          </video>
          <div style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, background: 'radial-gradient(circle at 50% 35%, rgba(10,10,12,0.3) 0%, rgba(10,10,12,0.8) 50%, rgba(10,10,12,0.95) 100%)', pointerEvents: 'none' }} />
          <div style={{ position: 'relative', zIndex: 10, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '24px 20px', overflowY: 'auto' }}>
            <div style={{ textAlign: 'center', marginBottom: 16, animation: 'txSlideUp 0.4s ease-out' }}>
              <div style={{ fontSize: 11, fontWeight: 600, color: txVerificationModal.currentLayer === 'done' ? '#10b981' : 'rgba(255, 255, 255, 0.5)', textTransform: 'uppercase', letterSpacing: '2px', marginBottom: 4 }}>
                {txVerificationModal.currentLayer === 'done' ? ' VERIFIED' : 'AUTHENTICATING'}
              </div>
              <h1 style={{ fontSize: 20, fontWeight: 600, color: '#fff', margin: 0 }}>
                {txVerificationModal.currentLayer === 'done' ? 'Transaction Secured' : 'Security Verification'}
              </h1>
            </div>
            <div style={{ position: 'relative', width: 200, height: 200, margin: '8px 0 20px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
              <img src={getAssetUrl("assets/arguslogo.png")} alt="ARGUS" style={{ width: 75, height: 75, borderRadius: 18, objectFit: 'contain', zIndex: 10, position: 'relative', filter: txVerificationModal.currentLayer === 'done' ? 'drop-shadow(0 0 20px rgba(16, 185, 129, 0.5))' : 'none', animation: txVerificationModal.currentLayer === 'done' ? 'txSuccessPulse 2s ease-in-out infinite' : 'none' }} />
              <div style={{ position: 'absolute', width: 130, height: 130, borderRadius: '50%', border: txVerificationModal.currentLayer === 'done' ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255, 255, 255, 0.1)' }} />
              <div style={{ position: 'absolute', width: 190, height: 190, borderRadius: '50%', border: txVerificationModal.currentLayer === 'done' ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255, 255, 255, 0.1)' }} />
              <div style={{ position: 'absolute', width: 130, height: 130, borderRadius: '50%', animation: 'txOrbitRotate 30s linear infinite' }}>
                {[{ id: 'voice', color: '#8b5cf6', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg> }, { id: 'geo', color: '#3b82f6', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> }, { id: 'usb', color: '#f59e0b', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg> }].map((layer, index) => {
                  const pos = [{ top: 0, left: '50%', marginLeft: -14, marginTop: -14 }, { bottom: '15%', right: '5%', marginRight: -14, marginBottom: -14 }, { bottom: '15%', left: '5%', marginLeft: -14, marginBottom: -14 }][index];
                  const isEnabled = txVerificationModal.enabledLayers[layer.id as keyof typeof txVerificationModal.enabledLayers];
                  const isCompleted = txVerificationModal.completedLayers[layer.id as keyof typeof txVerificationModal.completedLayers];
                  const isCurrent = txVerificationModal.currentLayer === layer.id;
                  return <div key={layer.id} style={{ position: 'absolute', width: 28, height: 28, padding: 6, background: 'rgba(20, 20, 20, 0.95)', border: '1px solid rgba(255, 255, 255, 0.15)', borderRadius: 7, display: 'flex', alignItems: 'center', justifyContent: 'center', color: isCompleted ? layer.color : isEnabled ? 'rgba(120, 120, 120, 0.8)' : 'rgba(255, 255, 255, 0.2)', animation: `txCounterRotate 30s linear infinite${isCurrent && isEnabled ? ', txIconPulseWhite 1.5s ease-in-out infinite' : ''}`, boxShadow: isCurrent && isEnabled ? '0 0 15px rgba(255, 255, 255, 0.4)' : 'none', opacity: isEnabled ? 1 : 0.3, ...pos }}>{layer.icon}</div>;
                })}
              </div>
              <div style={{ position: 'absolute', width: 190, height: 190, borderRadius: '50%', animation: 'txOrbitRotateReverse 45s linear infinite' }}>
                {[{ id: 'bluetooth', color: '#06b6d4', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/></svg> }, { id: 'wifi', color: '#10b981', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg> }, { id: 'biometric', color: '#ec4899', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg> }, { id: 'deco1', color: '#6366f1', isDecorative: true, icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> }].map((layer, index) => {
                  const pos = [{ top: 0, left: '50%', marginLeft: -14, marginTop: -14 }, { top: '50%', right: 0, marginRight: -14, marginTop: -14 }, { bottom: 0, left: '50%', marginLeft: -14, marginBottom: -14 }, { top: '50%', left: 0, marginLeft: -14, marginTop: -14 }][index];
                  const isDecorative = (layer as any).isDecorative;
                  const isEnabled = isDecorative ? false : txVerificationModal.enabledLayers[layer.id as keyof typeof txVerificationModal.enabledLayers];
                  const isCompleted = isDecorative ? false : txVerificationModal.completedLayers[layer.id as keyof typeof txVerificationModal.completedLayers];
                  const isCurrent = txVerificationModal.currentLayer === layer.id;
                  return <div key={layer.id} style={{ position: 'absolute', width: 28, height: 28, padding: 6, background: 'rgba(20, 20, 20, 0.95)', border: '1px solid rgba(255, 255, 255, 0.15)', borderRadius: 7, display: 'flex', alignItems: 'center', justifyContent: 'center', color: isCompleted ? layer.color : isEnabled ? 'rgba(120, 120, 120, 0.8)' : 'rgba(255, 255, 255, 0.2)', animation: `txCounterRotateReverse 45s linear infinite${isCurrent && isEnabled ? ', txIconPulseWhite 1.5s ease-in-out infinite' : ''}`, boxShadow: isCurrent && isEnabled ? '0 0 15px rgba(255, 255, 255, 0.4)' : 'none', opacity: isEnabled ? 1 : 0.3, ...pos }}>{layer.icon}</div>;
                })}
              </div>
            </div>
            <div style={{ textAlign: 'center', marginBottom: 16, animation: 'txSlideUp 0.4s ease-out 0.1s both' }}>
              <div style={{ fontSize: 14, fontWeight: 500, color: txVerificationModal.currentLayer === 'done' ? '#10b981' : '#fff' }}>
                {txVerificationModal.currentLayer === 'voice' && 'Verifying voice print...'}
                {txVerificationModal.currentLayer === 'geo' && 'Checking location...'}
                {txVerificationModal.currentLayer === 'bluetooth' && (txVerificationModal.pendingUserAction ? 'Tap to connect Bluetooth' : 'Connecting Bluetooth...')}
                {txVerificationModal.currentLayer === 'usb' && (txVerificationModal.pendingUserAction ? 'Tap to verify USB key' : 'Reading USB key...')}
                {txVerificationModal.currentLayer === 'wifi' && 'Verifying 2FA Mobile...'}
                {txVerificationModal.currentLayer === 'biometric' && 'Verifying Face ID...'}
                {txVerificationModal.currentLayer === 'proposal' && 'Creating proposal (1/3)...'}
                {txVerificationModal.currentLayer === 'approval' && 'Awaiting approval (2/3)...'}
                {txVerificationModal.currentLayer === 'execute' && 'Executing transaction (3/3)...'}
                {txVerificationModal.currentLayer === 'done' && 'All security checks passed'}
              </div>
            </div>
            
            {/* TAP TO VERIFY Button - shown for USB and Bluetooth */}
            {txVerificationModal.pendingUserAction && (txVerificationModal.currentLayer === 'usb' || txVerificationModal.currentLayer === 'bluetooth') && (
              <button
                onClick={handleVerifyButtonClick}
                style={{
                  width: '100%',
                  padding: '16px',
                  background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                  border: 'none',
                  borderRadius: 16,
                  color: '#fff',
                  fontSize: 16,
                  fontWeight: 600,
                  cursor: 'pointer',
                  marginBottom: 16,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: 10,
                  boxShadow: '0 4px 20px rgba(16, 185, 129, 0.3)'
                }}
              >
                {txVerificationModal.currentLayer === 'usb' && (
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                )}
                {txVerificationModal.currentLayer === 'bluetooth' && (
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/></svg>
                )}
                TAP TO VERIFY
              </button>
            )}
            
            {/* QR Code for WiFi/2FA Mobile Verification */}
            {txVerificationModal.currentLayer === 'wifi' && txVerificationModal.wifiQrData && (
              <div style={{ width: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 12, marginBottom: 20, animation: 'txSlideUp 0.3s ease-out' }}>
                <div style={{ background: '#fff', padding: 12, borderRadius: 12, boxShadow: '0 4px 20px rgba(0,0,0,0.3)' }}>
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(txVerificationModal.wifiQrData)}`} alt="Scan with phone" style={{ width: 150, height: 150, display: 'block' }} />
                </div>
                <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', textAlign: 'center' }}>
                  Scan with your registered phone<br/>to verify 2FA Mobile
                </div>
              </div>
            )}
            
            {/* QR Code for Biometric Verification */}
            {txVerificationModal.currentLayer === 'biometric' && txVerificationModal.biometricQrData && (
              <div style={{ width: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 12, marginBottom: 20, animation: 'txSlideUp 0.3s ease-out' }}>
                <div style={{ background: '#fff', padding: 12, borderRadius: 12, boxShadow: '0 4px 20px rgba(0,0,0,0.3)' }}>
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(txVerificationModal.biometricQrData)}`} alt="Scan with phone" style={{ width: 150, height: 150, display: 'block' }} />
                </div>
                <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', textAlign: 'center' }}>
                  Open camera app on your phone<br/>and scan this QR code
                </div>
              </div>
            )}
            
            <div style={{ display: 'flex', justifyContent: 'center', gap: 6, marginBottom: 20 }}>
              {['voice', 'geo', 'usb', 'bluetooth', 'wifi', 'biometric'].filter(id => txVerificationModal.enabledLayers[id as keyof typeof txVerificationModal.enabledLayers]).map(layerId => (
                <div key={layerId} style={{ width: 8, height: 8, borderRadius: '50%', background: txVerificationModal.completedLayers[layerId as keyof typeof txVerificationModal.completedLayers] ? '#10b981' : '#fff', transition: 'all 0.3s ease' }} />
              ))}
            </div>
            <div style={{ flex: 1 }} />
            {txVerificationModal.txData && (
              <div style={{ width: '100%', background: 'rgba(255, 255, 255, 0.03)', borderRadius: 16, padding: 16, border: '1px solid rgba(255, 255, 255, 0.06)', animation: 'txSlideUp 0.4s ease-out 0.2s both' }}>
                <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.4)', textTransform: 'uppercase', letterSpacing: '1.5px', marginBottom: 8 }}>
                  {txVerificationModal.txData.type === 'send' ? 'SENDING' : txVerificationModal.txData.type === 'swap' ? 'SWAPPING' : 'SIGNING'}
                </div>
                <div style={{ fontSize: 28, fontWeight: 700, color: '#fff', display: 'flex', alignItems: 'baseline', gap: 8 }}>
                  {txVerificationModal.txData.amount || '0.00'}
                  <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>{txVerificationModal.txData.token || 'SOL'}</span>
                  {txVerificationModal.txData.toToken && (<><span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.3)', margin: '0 4px' }}></span><span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>{txVerificationModal.txData.toToken}</span></>)}
                </div>
                {txVerificationModal.txData.recipient && (
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginTop: 12, padding: '8px 10px', background: 'rgba(0, 0, 0, 0.3)', borderRadius: 8 }}>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.5)', fontFamily: 'monospace' }}>{txVerificationModal.txData.recipient}</div>
                  </div>
                )}
              </div>
            )}
            <div style={{ width: '100%', paddingTop: 16 }}>
              {txVerificationModal.currentLayer === 'done' ? (
                <button onClick={() => { setTxVerificationModal(prev => ({ ...prev, show: false })); setSendStep("success"); }} style={{ width: '100%', padding: '16px', background: 'linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%)', border: 'none', borderRadius: 16, color: '#000', fontSize: 16, fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 20px rgba(255, 255, 255, 0.15)' }}>Continue</button>
              ) : (
                <div style={{ textAlign: 'center', padding: '12px', color: 'rgba(255, 255, 255, 0.3)', fontSize: 11 }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Protected by ARGUS
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
        
        {/* Voice Enrollment Modal - MUST be inside txVerificationModal return block */}
        <VoiceEnrollmentModal
          show={voiceEnrollmentModal.show}
          mode={voiceEnrollmentModal.mode}
          walletAddress={voiceEnrollmentModal.walletAddress}
          enrolledFingerprint={voiceEnrollmentModal.enrolledFingerprint}
          onComplete={async (result) => {
            setVoiceEnrollmentModal(prev => ({ ...prev, show: false }))
            
            // Handle verify-for-tx mode - resolve the pending promise for transaction security verification
            if (voiceEnrollmentModal.mode === 'verify-for-tx') {
              if (pendingVoiceVerificationResolve.current) {
                pendingVoiceVerificationResolve.current({ success: result.success })
                pendingVoiceVerificationResolve.current = null
              }
              return
            }
          }}
          onClose={() => {
            setVoiceEnrollmentModal(prev => ({ ...prev, show: false }))
            // If we're in verify-for-tx mode and user closes, resolve with failure
            if (voiceEnrollmentModal.mode === 'verify-for-tx' && pendingVoiceVerificationResolve.current) {
              pendingVoiceVerificationResolve.current({ success: false })
              pendingVoiceVerificationResolve.current = null
            }
          }}
        />
      </>
    )
  }

  // Show seed phrase view BEFORE checking hasExistingWallet
  // This is important because after wallet creation we set storedSecret (making hasExistingWallet true)
  // but we need to show the seed phrase first
  if (view === "seed" && mnemonic) {
    return (
      <div style={containerStyle}>
        <div style={{ padding: 30 }}>
          <h3 style={{ ...styles.headerTitle, marginBottom: 12 }}>Secret Recovery Phrase</h3>
          <p style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: 14, marginBottom: 24, lineHeight: '1.5' }}>
            Save these words in a safe place. This is the only way to recover your wallet.
          </p>
          
          <div style={styles.seedBox}>
            {mnemonic.split(" ").map((word, i) => (
              <div key={i} style={styles.seedWord}>
                <span style={{ color: 'rgba(255, 255, 255, 0.3)', marginRight: 6, fontSize: 10 }}>{i+1}.</span>
                {word}
              </div>
            ))}
          </div>

          <div style={{ background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.2)', borderRadius: 12, padding: 14, marginBottom: 20 }}>
            <p style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.7)', lineHeight: '1.5', margin: 0 }}>
               Never share your recovery phrase. Anyone with these words can access your funds.
            </p>
          </div>

          <button 
            style={{
              width: '100%',
              padding: '16px',
              background: '#fff',
              border: 'none',
              borderRadius: 14,
              color: '#000',
              fontSize: 16,
              fontWeight: 600,
              cursor: 'pointer'
            }} 
            onClick={confirmSeedSaved}
          >
            I Saved My Secret Phrase
          </button>
        </div>
      </div>
    )
  }

  // If no wallet exists, show the onboarding/create wallet screen
  if (!hasExistingWallet) {
    // Handle multi-step onboarding for wallet creation
    const handleCreateContinue = async () => {
      if (onboardingStep === "welcome") {
        setOnboardingStep("username");
      } else if (onboardingStep === "username") {
        if (onboardingUsername.length < 3) {
          setStatus("Username must be at least 3 characters");
          return;
        }
        setStatus("");
        setOnboardingStep("password");
      } else if (onboardingStep === "password") {
        if (onboardingPassword.length < 8) {
          setStatus("Password must be at least 8 characters");
          return;
        }
        if (onboardingPassword !== onboardingPasswordConfirm) {
          setStatus("Passwords do not match");
          return;
        }
        setStatus("");
        // Generate wallet
        try {
          const newWallet = createNewWallet();
          setOnboardingGeneratedMnemonic(newWallet.mnemonic);
          setOnboardingGeneratedKeypair(newWallet.keypair);
          setOnboardingStep("seed");
        } catch (err: any) {
          setStatus(err.message || "Failed to generate wallet");
        }
      } else if (onboardingStep === "seed") {
        if (!onboardingSeedSaved) {
          setStatus("Please confirm you saved your seed phrase");
          return;
        }
        // Generate verification options and go to verify step
        const seedWords = onboardingGeneratedMnemonic.split(" ");
        const firstWord = seedWords[0];
        const lastWord = seedWords[11];
        
        // BIP39 word list sample for decoys
        const bip39Decoys = [
          "abandon", "ability", "able", "about", "above", "absent", "absorb", "abstract", "absurd", "abuse",
          "access", "accident", "account", "accuse", "achieve", "acid", "acoustic", "acquire", "across", "act",
          "action", "actor", "actual", "adapt", "add", "addict", "address", "adjust", "admit", "adult",
          "advance", "advice", "aerobic", "affair", "afford", "afraid", "again", "age", "agent", "agree",
          "ahead", "aim", "air", "airport", "aisle", "alarm", "album", "alcohol", "alert", "alien",
          "all", "alley", "allow", "almost", "alone", "alpha", "already", "also", "alter", "always",
          "amateur", "amazing", "among", "amount", "amused", "analyst", "anchor", "ancient", "anger", "angle",
          "angry", "animal", "ankle", "announce", "annual", "another", "answer", "antenna", "antique", "anxiety"
        ];
        
        const getRandomDecoys = (correctWord: string, count: number) => {
          const decoys: string[] = [];
          const available = bip39Decoys.filter(w => w !== correctWord && !seedWords.includes(w));
          while (decoys.length < count && available.length > 0) {
            const idx = Math.floor(Math.random() * available.length);
            decoys.push(available[idx]);
            available.splice(idx, 1);
          }
          return decoys;
        };
        
        const shuffleArray = (arr: string[]) => {
          const result = [...arr];
          for (let i = result.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [result[i], result[j]] = [result[j], result[i]];
          }
          return result;
        };
        
        setVerifyFirstWordOptions(shuffleArray([firstWord, ...getRandomDecoys(firstWord, 5)]));
        setVerifyLastWordOptions(shuffleArray([lastWord, ...getRandomDecoys(lastWord, 5)]));
        setSelectedFirstWord(null);
        setSelectedLastWord(null);
        setFirstWordCorrect(null);
        setLastWordCorrect(null);
        setVerifyError("");
        setOnboardingStep("verify");
      } else if (onboardingStep === "verify") {
        // Complete wallet creation
        console.log('[Onboarding] Starting wallet creation...');
        try {
          const keypair = onboardingGeneratedKeypair!;
          const newAccount: WalletAccount = {
            index: 0,
            name: onboardingUsername || "Account 1",
            publicKey: keypair.publicKey.toBase58(),
            secretKey: bs58.encode(keypair.secretKey)
          };
          
          console.log('[Onboarding] Account created:', newAccount.publicKey);
          
          // Store mnemonic for derivation
          localStorage.setItem('geovault_mnemonic', JSON.stringify(onboardingGeneratedMnemonic));
          
          // Store password hash for unlock screen (with fallback for non-HTTPS)
          if (onboardingPassword) {
            try {
              if (crypto.subtle) {
                const encoder = new TextEncoder();
                const data = encoder.encode(onboardingPassword);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                localStorage.setItem('geovault_password_hash', passwordHash);
              } else {
                // Fallback: simple hash for HTTP context (less secure but works)
                console.warn('[Onboarding] crypto.subtle not available, using simple hash');
                const simpleHash = btoa(onboardingPassword);
                localStorage.setItem('geovault_password_hash', simpleHash);
              }
            } catch (hashErr) {
              console.error('[Onboarding] Password hash error:', hashErr);
              // Fallback
              const simpleHash = btoa(onboardingPassword);
              localStorage.setItem('geovault_password_hash', simpleHash);
            }
          }
          
          // Mark wallet as unlocked (just created)
          localStorage.setItem('geovault_wallet_unlocked', 'true');
          
          // Store public key for voice/other features
          localStorage.setItem('geovault_publicKey', keypair.publicKey.toBase58());
          
          console.log('[Onboarding] Setting stored data...');
          
          setStoredSecret(newAccount.secretKey);
          setStoredAccounts([newAccount]);
          setStoredUsername(onboardingUsername);
          setWalletAccounts([newAccount]);
          setWallet(keypair);
          setMnemonic(onboardingGeneratedMnemonic);
          
          // Register user and set password on server - CRITICAL for database sync
          console.log('[Onboarding] Registering user and password on server...');
          console.log('[Onboarding] Public key:', keypair.publicKey.toBase58());
          console.log('[Onboarding] Password length:', onboardingPassword?.length || 0);
          
          try {
            const regResult = await registerUser(keypair.publicKey.toBase58());
            console.log('[Onboarding] registerUser result:', regResult);
            
            if (onboardingPassword) {
              const pwResult = await setServerPassword(keypair.publicKey.toBase58(), onboardingPassword);
              console.log('[Onboarding] setServerPassword result:', pwResult);
            }
            console.log('[Onboarding] Server registration complete!');
          } catch (serverErr: any) {
            console.error('[Onboarding] Server registration failed:', serverErr);
            console.error('[Onboarding] Error details:', serverErr.message);
            // Show error to user but don't block - they can still use the wallet locally
            setStatus('Warning: Could not sync to server. Your wallet works locally.');
          }
          
          console.log('[Onboarding] Wallet creation complete!');
          
          // Reset onboarding state
          setOnboardingStep("welcome");
          setOnboardingUsername("");
          setOnboardingPassword("");
          setOnboardingPasswordConfirm("");
          setOnboardingSeedSaved(false);
          setOnboardingGeneratedMnemonic("");
          setOnboardingGeneratedKeypair(null);
          setVerifyFirstWordOptions([]);
          setVerifyLastWordOptions([]);
          setSelectedFirstWord(null);
          setSelectedLastWord(null);
          setFirstWordCorrect(null);
          setLastWordCorrect(null);
          setVerifyError("");
          
          setView("main");
        } catch (err: any) {
          console.error('[Onboarding] Error creating wallet:', err);
          setStatus('Error creating wallet: ' + (err.message || 'Unknown error'));
        }
      }
    };

    const handleBack = () => {
      setStatus("");
      if (onboardingStep === "username") setOnboardingStep("welcome");
      else if (onboardingStep === "password") setOnboardingStep("username");
      else if (onboardingStep === "seed") setOnboardingStep("password");
      else if (onboardingStep === "verify") setOnboardingStep("seed");
    };

    return (
      <div className="app-container-padded" style={{
        display: 'flex',
        flexDirection: 'column',
        background: '#121216'
      }}>
        {/* Back Button (not on welcome) */}
        {onboardingStep !== "welcome" && (
          <button
            onClick={handleBack}
            style={{
              background: 'none',
              border: 'none',
              color: 'rgba(255, 255, 255, 0.6)',
              cursor: 'pointer',
              padding: 0,
              marginBottom: 24,
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              fontSize: 14
            }}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
          </button>
        )}

        {/* Step: Welcome */}
        {onboardingStep === "welcome" && (
          <>
            {/* CSS Keyframes for orbit animation */}
            <style>
              {`
                @keyframes orbitRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                @keyframes orbitRotateReverse { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
                @keyframes counterRotate { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
                @keyframes counterRotateReverse { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
              `}
            </style>
            
            {/* Spacer - pushes content down */}
            <div style={{ flex: 1 }} />
            
            {/* Logo with Orbit Animation Container */}
            <div style={{ 
              position: 'relative', 
              width: 220, 
              height: 220, 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              margin: '0 auto 24px auto'
            }}>
              {/* Logo */}
              <img 
                src="/assets/arguslogo.png" 
                alt="ARGUS" 
                style={{ 
                  width: 90, 
                  height: 90, 
                  borderRadius: 22, 
                  objectFit: 'contain',
                  zIndex: 10,
                  position: 'relative'
                }}
              />
              
              {/* Inner orbit ring (static) */}
              <div style={{ 
                position: 'absolute', 
                width: 130, 
                height: 130, 
                borderRadius: '50%', 
                border: '1px solid rgba(255, 255, 255, 0.1)'
              }} />
              
              {/* Outer orbit ring (static) */}
              <div style={{ 
                position: 'absolute', 
                width: 190, 
                height: 190, 
                borderRadius: '50%', 
                border: '1px solid rgba(255, 255, 255, 0.08)'
              }} />
              
              {/* Inner rotating orbit with dots */}
              <div style={{ 
                position: 'absolute', 
                width: 130, 
                height: 130, 
                borderRadius: '50%', 
                animation: 'orbitRotate 20s linear infinite'
              }}>
                {/* Orbit dots - inner ring */}
                {[0, 120, 240].map((angle, i) => {
                  const colors = ['#8b5cf6', '#3b82f6', '#10b981'];
                  const rad = (angle * Math.PI) / 180;
                  const x = 65 + 65 * Math.sin(rad);
                  const y = 65 - 65 * Math.cos(rad);
                  return (
                    <div key={i} style={{
                      position: 'absolute',
                      width: 8,
                      height: 8,
                      borderRadius: '50%',
                      background: colors[i],
                      left: x - 4,
                      top: y - 4,
                      boxShadow: `0 0 10px ${colors[i]}`,
                      animation: 'counterRotate 20s linear infinite'
                    }} />
                  );
                })}
              </div>
              
              {/* Outer rotating orbit with dots (reverse) */}
              <div style={{ 
                position: 'absolute', 
                width: 190, 
                height: 190, 
                borderRadius: '50%', 
                animation: 'orbitRotateReverse 30s linear infinite'
              }}>
                {/* Orbit dots - outer ring */}
                {[45, 135, 225, 315].map((angle, i) => {
                  const colors = ['#f59e0b', '#ec4899', '#06b6d4', '#6366f1'];
                  const rad = (angle * Math.PI) / 180;
                  const x = 95 + 95 * Math.sin(rad);
                  const y = 95 - 95 * Math.cos(rad);
                  return (
                    <div key={i} style={{
                      position: 'absolute',
                      width: 6,
                      height: 6,
                      borderRadius: '50%',
                      background: colors[i],
                      left: x - 3,
                      top: y - 3,
                      boxShadow: `0 0 8px ${colors[i]}`,
                      opacity: 0.7,
                      animation: 'counterRotateReverse 30s linear infinite'
                    }} />
                  );
                })}
              </div>
            </div>
            
            <h1 style={{ 
              fontSize: 32, 
              fontWeight: 700, 
              color: '#fff', 
              marginBottom: 16, 
              marginTop: 0,
              textAlign: 'center',
              width: '100%'
            }}>
              Welcome to ARGUS
            </h1>
            <p style={{ 
              fontSize: 16, 
              color: 'rgba(255, 255, 255, 0.5)', 
              marginBottom: 48, 
              marginTop: 0,
              lineHeight: 1.7, 
              textAlign: 'center', 
              maxWidth: 320,
              width: '100%',
              margin: '0 auto 48px auto',
              padding: '0 28px',
              boxSizing: 'border-box'
            }}>
              ARGUS Mobile Beta  Experience multi-layer security with geo-fencing, voice authentication, and biometrics right from your device.
            </p>

            <button
              onClick={() => setOnboardingStep("username")}
              onTouchEnd={(e) => {
                e.preventDefault();
                setOnboardingStep("username");
              }}
              style={{
                width: 'calc(100% - 48px)',
                maxWidth: 340,
                padding: '20px 24px',
                minHeight: 60,
                background: '#fff',
                border: 'none',
                borderRadius: 16,
                color: '#000',
                fontSize: 18,
                fontWeight: 600,
                cursor: 'pointer',
                margin: '0 auto 16px auto',
                WebkitTapHighlightColor: 'transparent',
                touchAction: 'manipulation'
              }}
            >
              Create New Wallet
            </button>

            <button
              onClick={() => {
                setAddWalletView('menu');
                setShowAddWalletModal(true);
              }}
              onTouchEnd={(e) => {
                e.preventDefault();
                setAddWalletView('menu');
                setShowAddWalletModal(true);
              }}
              style={{
                width: 'calc(100% - 48px)',
                maxWidth: 340,
                padding: '18px 24px',
                minHeight: 56,
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.15)',
                borderRadius: 16,
                color: 'rgba(255, 255, 255, 0.9)',
                fontSize: 16,
                fontWeight: 500,
                cursor: 'pointer',
                margin: '0 auto',
                WebkitTapHighlightColor: 'transparent',
                touchAction: 'manipulation'
              }}
            >
              Import Existing Wallet
            </button>
            
            {/* Spacer - pushes content up, balances with top spacer */}
            <div style={{ flex: 1.3 }} />
          </>
        )}

        {/* Step: Username */}
        {onboardingStep === "username" && (
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
            <h2 style={{ fontSize: 28, fontWeight: 600, color: '#fff', marginBottom: 12 }}>
              Create Your Identity
            </h2>
            <p style={{ fontSize: 16, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 36 }}>
              Choose a username for your ARGUS wallet
            </p>

            <div style={{ marginBottom: 24 }}>
              <label style={{ fontSize: 15, color: 'rgba(255, 255, 255, 0.6)', marginBottom: 10, display: 'block', fontWeight: 500 }}>
                Username
              </label>
              <input
                type="text"
                value={onboardingUsername}
                onChange={(e) => setOnboardingUsername(e.target.value)}
                placeholder="Enter username (min 3 characters)"
                style={{
                  width: '100%',
                  padding: '18px',
                  minHeight: 56,
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 14,
                  color: '#fff',
                  fontSize: 17,
                  outline: 'none'
                }}
              />
            </div>

            {status && <div style={{ color: '#ef4444', fontSize: 15, marginBottom: 14 }}>{status}</div>}

            <div style={{ flex: 1 }} />

            <button
              onClick={handleCreateContinue}
              onTouchEnd={(e) => {
                e.preventDefault();
                if (onboardingUsername.length >= 3) handleCreateContinue();
              }}
              disabled={onboardingUsername.length < 3}
              style={{
                width: '100%',
                padding: '20px',
                minHeight: 60,
                background: onboardingUsername.length < 3 ? 'rgba(255, 255, 255, 0.1)' : '#fff',
                border: 'none',
                borderRadius: 16,
                color: onboardingUsername.length < 3 ? 'rgba(255, 255, 255, 0.3)' : '#000',
                fontSize: 18,
                fontWeight: 600,
                cursor: onboardingUsername.length < 3 ? 'not-allowed' : 'pointer',
                WebkitTapHighlightColor: 'transparent',
                touchAction: 'manipulation',
                marginBottom: 60
              }}
            >
              Continue
            </button>
          </div>
        )}

        {/* Step: Password */}
        {onboardingStep === "password" && (
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
            <h2 style={{ fontSize: 28, fontWeight: 700, color: '#fff', marginBottom: 10 }}>
              Secure Your Wallet
            </h2>
            <p style={{ fontSize: 16, color: 'rgba(255, 255, 255, 0.6)', marginBottom: 36, lineHeight: 1.5 }}>
              Create a strong password to encrypt your wallet
            </p>

            <div style={{ marginBottom: 20 }}>
              <label style={{ fontSize: 15, color: 'rgba(255, 255, 255, 0.7)', marginBottom: 10, display: 'block', fontWeight: 500 }}>
                Password
              </label>
              <input
                type="password"
                value={onboardingPassword}
                onChange={(e) => setOnboardingPassword(e.target.value)}
                placeholder="Min 8 characters"
                style={{
                  width: '100%',
                  padding: '18px',
                  background: 'rgba(255, 255, 255, 0.06)',
                  border: '1px solid rgba(255, 255, 255, 0.12)',
                  borderRadius: 16,
                  color: '#fff',
                  fontSize: 17,
                  outline: 'none'
                }}
              />
            </div>

            <div style={{ marginBottom: 28 }}>
              <label style={{ fontSize: 15, color: 'rgba(255, 255, 255, 0.7)', marginBottom: 10, display: 'block', fontWeight: 500 }}>
                Confirm Password
              </label>
              <input
                type="password"
                value={onboardingPasswordConfirm}
                onChange={(e) => setOnboardingPasswordConfirm(e.target.value)}
                placeholder="Re-enter password"
                style={{
                  width: '100%',
                  padding: '18px',
                  background: 'rgba(255, 255, 255, 0.06)',
                  border: '1px solid rgba(255, 255, 255, 0.12)',
                  borderRadius: 16,
                  color: '#fff',
                  fontSize: 17,
                  outline: 'none'
                }}
              />
            </div>

            {status && <div style={{ color: '#ef4444', fontSize: 14, marginBottom: 14 }}>{status}</div>}

            <div style={{ flex: 1 }} />

            <button
              onClick={handleCreateContinue}
              onTouchEnd={(e) => {
                e.preventDefault();
                if (onboardingPassword.length >= 8) handleCreateContinue();
              }}
              disabled={onboardingPassword.length < 8}
              style={{
                width: '100%',
                padding: '20px',
                background: onboardingPassword.length < 8 ? 'rgba(255, 255, 255, 0.1)' : '#fff',
                border: 'none',
                borderRadius: 18,
                color: onboardingPassword.length < 8 ? 'rgba(255, 255, 255, 0.3)' : '#000',
                fontSize: 18,
                fontWeight: 600,
                cursor: onboardingPassword.length < 8 ? 'not-allowed' : 'pointer',
                WebkitTapHighlightColor: 'transparent',
                touchAction: 'manipulation',
                marginBottom: 60
              }}
            >
              Continue
            </button>
          </div>
        )}

        {/* Step: Seed Phrase */}
        {onboardingStep === "seed" && (
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
            <h2 style={{ fontSize: 28, fontWeight: 700, color: '#fff', marginBottom: 10 }}>
              Recovery Phrase
            </h2>
            <p style={{ fontSize: 16, color: 'rgba(255, 255, 255, 0.6)', marginBottom: 28, lineHeight: 1.5 }}>
              Write down these 12 words in order. Never share them with anyone.
            </p>

            <div style={styles.seedBox}>
              {onboardingGeneratedMnemonic.split(" ").map((word, i) => (
                <div key={i} style={styles.seedWord}>
                  <span style={{ color: 'rgba(255, 255, 255, 0.4)', marginRight: 8, fontSize: 12, fontWeight: 500 }}>{i+1}.</span>
                  {word}
                </div>
              ))}
            </div>

            <div style={{ background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.2)', borderRadius: 16, padding: 18, marginBottom: 24 }}>
              <p style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.8)', lineHeight: '1.6', margin: 0, display: 'flex', alignItems: 'flex-start', gap: 10 }}>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2" style={{ flexShrink: 0, marginTop: 2 }}>
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                If you lose this phrase, you will lose access to your funds forever.
              </p>
            </div>

            <label style={{ display: 'flex', alignItems: 'center', gap: 14, marginBottom: 28, cursor: 'pointer' }}>
              <input
                type="checkbox"
                checked={onboardingSeedSaved}
                onChange={(e) => setOnboardingSeedSaved(e.target.checked)}
                style={{ width: 24, height: 24, accentColor: '#10b981' }}
              />
              <span style={{ fontSize: 16, color: 'rgba(255, 255, 255, 0.9)', fontWeight: 500 }}>
                I have saved my recovery phrase securely
              </span>
            </label>

            {status && <div style={{ color: '#ef4444', fontSize: 14, marginBottom: 14 }}>{status}</div>}

            <div style={{ flex: 1 }} />

            <button
              onClick={handleCreateContinue}
              disabled={!onboardingSeedSaved}
              style={{
                width: '100%',
                padding: '20px',
                background: !onboardingSeedSaved ? 'rgba(255, 255, 255, 0.1)' : '#fff',
                border: 'none',
                borderRadius: 18,
                color: !onboardingSeedSaved ? 'rgba(255, 255, 255, 0.3)' : '#000',
                fontSize: 18,
                fontWeight: 600,
                cursor: !onboardingSeedSaved ? 'not-allowed' : 'pointer',
                WebkitTapHighlightColor: 'transparent',
                touchAction: 'manipulation',
                marginBottom: 60
              }}
            >
              Continue
            </button>
          </div>
        )}

        {/* Step: Verify Seed Phrase */}
        {onboardingStep === "verify" && (
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
            <h2 style={{ fontSize: 28, fontWeight: 700, color: '#fff', marginBottom: 10 }}>
              Verify Your Phrase
            </h2>
            <p style={{ fontSize: 16, color: 'rgba(255, 255, 255, 0.6)', marginBottom: 36, lineHeight: 1.5 }}>
              Select the correct words to confirm you saved your recovery phrase.
            </p>

            {/* First Word Question */}
            <div style={{ marginBottom: 36 }}>
              <div style={{ fontSize: 17, color: '#fff', marginBottom: 18, fontWeight: 600 }}>
                What is word #1?
              </div>
              <div style={{ display: 'flex', flexWrap: 'wrap', gap: 12 }}>
                {verifyFirstWordOptions.map((word, i) => {
                  const isSelected = selectedFirstWord === word;
                  const isCorrect = firstWordCorrect;
                  let bgColor = 'rgba(255, 255, 255, 0.06)';
                  let borderColor = 'rgba(255, 255, 255, 0.12)';
                  if (isSelected) {
                    if (isCorrect === true) {
                      bgColor = 'rgba(16, 185, 129, 0.2)';
                      borderColor = '#10b981';
                    } else if (isCorrect === false) {
                      bgColor = 'rgba(239, 68, 68, 0.2)';
                      borderColor = '#ef4444';
                    }
                  }
                  return (
                    <button
                      key={i}
                      onClick={() => {
                        if (firstWordCorrect === true) return; // Already correct
                        const seedWords = onboardingGeneratedMnemonic.split(" ");
                        const correct = word === seedWords[0];
                        setSelectedFirstWord(word);
                        setFirstWordCorrect(correct);
                        if (!correct) {
                          setVerifyError("Incorrect! Please try again.");
                          setTimeout(() => {
                            setSelectedFirstWord(null);
                            setFirstWordCorrect(null);
                            setVerifyError("");
                          }, 1500);
                        } else {
                          setVerifyError("");
                        }
                      }}
                      disabled={firstWordCorrect === true}
                      style={{
                        padding: '14px 22px',
                        background: bgColor,
                        border: `1px solid ${borderColor}`,
                        borderRadius: 14,
                        color: isSelected && isCorrect ? '#10b981' : isSelected && isCorrect === false ? '#ef4444' : '#fff',
                        fontSize: 16,
                        fontWeight: 500,
                        cursor: firstWordCorrect === true ? 'default' : 'pointer',
                        opacity: firstWordCorrect === true && !isSelected ? 0.5 : 1,
                        transition: 'all 0.2s ease',
                        WebkitTapHighlightColor: 'transparent',
                        touchAction: 'manipulation'
                      }}
                    >
                      {word}
                      {isSelected && isCorrect === true && (
                        <span style={{ marginLeft: 10 }}></span>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* Second Word Question (only show after first is correct) */}
            <div style={{ 
              marginBottom: 28,
              opacity: firstWordCorrect === true ? 1 : 0.4,
              pointerEvents: firstWordCorrect === true ? 'auto' : 'none'
            }}>
              <div style={{ fontSize: 17, color: '#fff', marginBottom: 18, fontWeight: 600 }}>
                What is word #12?
              </div>
              <div style={{ display: 'flex', flexWrap: 'wrap', gap: 12 }}>
                {verifyLastWordOptions.map((word, i) => {
                  const isSelected = selectedLastWord === word;
                  const isCorrect = lastWordCorrect;
                  let bgColor = 'rgba(255, 255, 255, 0.06)';
                  let borderColor = 'rgba(255, 255, 255, 0.12)';
                  if (isSelected) {
                    if (isCorrect === true) {
                      bgColor = 'rgba(16, 185, 129, 0.2)';
                      borderColor = '#10b981';
                    } else if (isCorrect === false) {
                      bgColor = 'rgba(239, 68, 68, 0.2)';
                      borderColor = '#ef4444';
                    }
                  }
                  return (
                    <button
                      key={i}
                      onClick={() => {
                        if (lastWordCorrect === true) return;
                        const seedWords = onboardingGeneratedMnemonic.split(" ");
                        const correct = word === seedWords[11];
                        setSelectedLastWord(word);
                        setLastWordCorrect(correct);
                        if (!correct) {
                          setVerifyError("Incorrect! Please try again.");
                          setTimeout(() => {
                            setSelectedLastWord(null);
                            setLastWordCorrect(null);
                            setVerifyError("");
                          }, 1500);
                        } else {
                          setVerifyError("");
                        }
                      }}
                      disabled={lastWordCorrect === true}
                      style={{
                        padding: '14px 22px',
                        background: bgColor,
                        border: `1px solid ${borderColor}`,
                        borderRadius: 14,
                        color: isSelected && isCorrect ? '#10b981' : isSelected && isCorrect === false ? '#ef4444' : '#fff',
                        fontSize: 16,
                        fontWeight: 500,
                        cursor: lastWordCorrect === true ? 'default' : 'pointer',
                        opacity: lastWordCorrect === true && !isSelected ? 0.5 : 1,
                        transition: 'all 0.2s ease',
                        WebkitTapHighlightColor: 'transparent',
                        touchAction: 'manipulation'
                      }}
                    >
                      {word}
                      {isSelected && isCorrect === true && (
                        <span style={{ marginLeft: 10 }}></span>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>

            {verifyError && (
              <div style={{ 
                color: '#ef4444', 
                fontSize: 15, 
                marginBottom: 18,
                display: 'flex',
                alignItems: 'center',
                gap: 10
              }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                {verifyError}
              </div>
            )}

            {firstWordCorrect === true && lastWordCorrect === true && (
              <div style={{ 
                background: 'rgba(16, 185, 129, 0.1)', 
                border: '1px solid rgba(16, 185, 129, 0.3)', 
                borderRadius: 16, 
                padding: 18, 
                marginBottom: 28,
                display: 'flex',
                alignItems: 'center',
                gap: 14
              }}>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <span style={{ color: '#10b981', fontSize: 16, fontWeight: 600 }}>
                  Perfect! You've verified your recovery phrase.
                </span>
              </div>
            )}

            <div style={{ flex: 1 }} />

            <button
              onClick={async () => {
                console.log('[Verify] Complete Setup clicked');
                await handleCreateContinue();
              }}
              disabled={!(firstWordCorrect === true && lastWordCorrect === true)}
              style={{
                width: '100%',
                padding: '20px',
                background: !(firstWordCorrect === true && lastWordCorrect === true) ? 'rgba(255, 255, 255, 0.1)' : '#fff',
                border: 'none',
                borderRadius: 18,
                color: !(firstWordCorrect === true && lastWordCorrect === true) ? 'rgba(255, 255, 255, 0.3)' : '#000',
                fontSize: 18,
                fontWeight: 600,
                cursor: !(firstWordCorrect === true && lastWordCorrect === true) ? 'not-allowed' : 'pointer',
                WebkitTapHighlightColor: 'transparent',
                touchAction: 'manipulation',
                userSelect: 'none',
                WebkitUserSelect: 'none',
                marginBottom: 60
              }}
            >
              Complete Setup
            </button>
          </div>
        )}

        {/* Spacer to push version to bottom */}
        <div style={{ flex: 1, minHeight: 20 }} />
        
        {/* Version - at bottom of container */}
        <div style={{ 
          textAlign: 'center',
          padding: '20px 0 24px 0',
          color: 'rgba(255, 255, 255, 0.3)', 
          fontSize: 12
        }}>
          v1.0.2 Mobile Beta
        </div>

        {/* Import Wallet Modal (for Import Existing Wallet button) */}
        {showAddWalletModal && (
          <>
            <div 
              onClick={() => setShowAddWalletModal(false)}
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.85)',
                backdropFilter: 'blur(8px)',
                zIndex: 2000
              }}
            />
            <div style={{
              position: 'fixed',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              width: 'calc(100% - 32px)',
              maxWidth: 360,
              maxHeight: 'calc(100vh - 80px)',
              background: '#1a1a1f',
              borderRadius: 20,
              border: '1px solid rgba(255, 255, 255, 0.1)',
              overflow: 'hidden',
              zIndex: 2001
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '16px 20px',
                borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
              }}>
                {addWalletView !== 'menu' && (
                  <button
                    onClick={() => setAddWalletView('menu')}
                    style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 0 }}
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                  </button>
                )}
                <span style={{ fontSize: 16, fontWeight: 600, color: '#fff', flex: 1, textAlign: addWalletView === 'menu' ? 'left' : 'center' }}>
                  {addWalletView === 'menu' && 'Import Wallet'}
                  {addWalletView === 'import-seed' && 'Import Seed Phrase'}
                  {addWalletView === 'import-pk' && 'Import Private Key'}
                </span>
                <button
                  onClick={() => setShowAddWalletModal(false)}
                  style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.4)', cursor: 'pointer', padding: 0 }}
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              </div>

              <div style={{ padding: 20, maxHeight: 'calc(100vh - 200px)', overflowY: 'auto' }}>
                {addWalletView === 'menu' && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                    <button
                      onClick={() => setAddWalletView('import-seed')}
                      style={{
                        display: 'flex', alignItems: 'center', gap: 14, padding: '16px',
                        background: 'rgba(255, 255, 255, 0.03)', border: '1px solid rgba(255, 255, 255, 0.08)',
                        borderRadius: 14, cursor: 'pointer', textAlign: 'left'
                      }}
                    >
                      <div style={{
                        width: 44, height: 44, borderRadius: 12,
                        background: 'rgba(168, 85, 247, 0.1)', border: '1px solid rgba(168, 85, 247, 0.2)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center'
                      }}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" strokeWidth="2">
                          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                      </div>
                      <div>
                        <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>Import Seed Phrase</div>
                        <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>Recover with 12/24 words</div>
                      </div>
                    </button>

                    <button
                      onClick={() => setAddWalletView('import-pk')}
                      style={{
                        display: 'flex', alignItems: 'center', gap: 14, padding: '16px',
                        background: 'rgba(255, 255, 255, 0.03)', border: '1px solid rgba(255, 255, 255, 0.08)',
                        borderRadius: 14, cursor: 'pointer', textAlign: 'left'
                      }}
                    >
                      <div style={{
                        width: 44, height: 44, borderRadius: 12,
                        background: 'rgba(245, 158, 11, 0.1)', border: '1px solid rgba(245, 158, 11, 0.2)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center'
                      }}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2">
                          <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                        </svg>
                      </div>
                      <div>
                        <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>Import Private Key</div>
                        <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>Use Base58 private key</div>
                      </div>
                    </button>
                  </div>
                )}

                {addWalletView === 'import-seed' && (
                  <div>
                    {!importVaultDetected.detected ? (
                      <>
                        <p style={{ color: 'rgba(255,255,255,0.6)', fontSize: 14, marginBottom: 16, lineHeight: 1.5 }}>
                          Enter your 12 or 24 word seed phrase, separated by spaces.
                        </p>
                        <textarea
                          placeholder="Enter seed phrase..."
                          value={importInput}
                          onChange={(e) => setImportInput(e.target.value)}
                          style={{
                            width: '100%', height: 100, padding: '14px 16px',
                            background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)',
                            borderRadius: 12, color: '#fff', fontSize: 14, marginBottom: 12,
                            outline: 'none', resize: 'none', fontFamily: 'monospace'
                          }}
                        />
                        {status && <div style={{ color: '#ef4444', fontSize: 13, marginBottom: 12 }}>{status}</div>}
                        <button
                          onClick={async () => {
                            setIsAddingWallet(true);
                            setStatus('');
                            try {
                              const bip39 = await import('bip39');
                              const words = importInput.trim().split(/\s+/);
                              if (words.length !== 12 && words.length !== 24) {
                                throw new Error('Seed phrase must be 12 or 24 words');
                              }
                              if (!bip39.validateMnemonic(importInput.trim())) {
                                throw new Error('Invalid seed phrase');
                              }
                              const seed = await bip39.mnemonicToSeed(importInput.trim());
                              const keypair = Keypair.fromSeed(seed.slice(0, 32));
                              const publicKey = keypair.publicKey.toBase58();
                              
                              // Check if this wallet has an existing vault
                              console.log('[Onboarding Import Seed] Checking if wallet has vault:', publicKey);
                              const vaultData = await checkVaultExists(publicKey);
                              console.log('[Onboarding Import Seed] Vault check result:', vaultData);
                              
                              if (vaultData && (vaultData.exists || vaultData.multisigPda)) {
                                // Vault detected - show password input
                                console.log('[Onboarding Import Seed] Vault detected, showing password input');
                                setImportVaultDetected({
                                  detected: true,
                                  publicKey,
                                  keypair,
                                  walletName: 'Account 1'
                                });
                                // Store mnemonic for after password verification
                                localStorage.setItem('geovault_mnemonic_temp', JSON.stringify(importInput.trim()));
                                setIsAddingWallet(false);
                                return;
                              }
                              
                              // No vault - import directly
                              console.log('[Onboarding Import Seed] No vault found, importing directly');
                              const newAccount: WalletAccount = {
                                index: 0,
                                name: 'Account 1',
                                publicKey,
                                secretKey: bs58.encode(keypair.secretKey)
                              };
                              
                              localStorage.setItem('geovault_mnemonic', JSON.stringify(importInput.trim()));
                              setStoredSecret(newAccount.secretKey);
                              setStoredAccounts([newAccount]);
                              setWalletAccounts([newAccount]);
                              setWallet(keypair);
                              
                              setShowAddWalletModal(false);
                              setImportInput('');
                              setView('main');
                            } catch (err: any) {
                              setStatus(err.message || 'Failed to import wallet');
                            } finally {
                              setIsAddingWallet(false);
                            }
                          }}
                          disabled={isAddingWallet || !importInput.trim()}
                          style={{
                            width: '100%', padding: '16px',
                            background: (isAddingWallet || !importInput.trim()) ? 'rgba(255, 255, 255, 0.1)' : '#fff',
                        border: 'none', borderRadius: 14,
                        color: (isAddingWallet || !importInput.trim()) ? 'rgba(255, 255, 255, 0.3)' : '#000',
                        fontSize: 16, fontWeight: 600,
                        cursor: (isAddingWallet || !importInput.trim()) ? 'not-allowed' : 'pointer'
                      }}
                    >
                      {isAddingWallet ? 'Importing...' : 'Import Wallet'}
                    </button>
                      </>
                    ) : (
                      /* Vault Password Required UI for Seed Import in Onboarding */
                      <>
                        <div style={{ 
                          background: 'rgba(168, 85, 247, 0.1)', 
                          border: '1px solid rgba(168, 85, 247, 0.3)',
                          borderRadius: 12, 
                          padding: 16, 
                          marginBottom: 16 
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 8 }}>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" strokeWidth="2">
                              <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            <span style={{ fontSize: 14, fontWeight: 600, color: '#a855f7' }}>Vault Detected</span>
                          </div>
                          <p style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.6)', margin: 0 }}>
                            This wallet has an existing ARGUS Vault. Enter your vault password to continue.
                          </p>
                        </div>
                        
                        <input
                          type="password"
                          value={importVaultPassword}
                          onChange={(e) => setImportVaultPassword(e.target.value)}
                          placeholder="Enter vault password"
                          style={{
                            width: '100%', padding: '14px 16px',
                            background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)',
                            borderRadius: 12, color: '#fff', fontSize: 14, marginBottom: 12,
                            outline: 'none', boxSizing: 'border-box'
                          }}
                        />
                        
                        {importVaultError && (
                          <div style={{ color: '#ef4444', fontSize: 13, marginBottom: 12 }}>{importVaultError}</div>
                        )}
                        
                        <button
                          onClick={async () => {
                            if (!importVaultDetected.keypair || !importVaultPassword.trim()) return;
                            setIsVerifyingImportPassword(true);
                            setImportVaultError('');
                            
                            try {
                              const verifyResult = await verifyServerPassword(importVaultDetected.publicKey, importVaultPassword);
                              
                              if (verifyResult.success) {
                                // Password correct - complete import
                                const newAccount: WalletAccount = {
                                  index: 0,
                                  name: importVaultDetected.walletName,
                                  publicKey: importVaultDetected.publicKey,
                                  secretKey: bs58.encode(importVaultDetected.keypair!.secretKey)
                                };
                                
                                // Move temp mnemonic to permanent storage
                                const tempMnemonic = localStorage.getItem('geovault_mnemonic_temp');
                                if (tempMnemonic) {
                                  localStorage.setItem('geovault_mnemonic', tempMnemonic);
                                  localStorage.removeItem('geovault_mnemonic_temp');
                                }
                                
                                // Store the password hash for unlock screen
                                try {
                                  if (crypto.subtle) {
                                    const encoder = new TextEncoder();
                                    const data = encoder.encode(importVaultPassword);
                                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                                    const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                                    localStorage.setItem('geovault_password_hash', passwordHash);
                                  } else {
                                    localStorage.setItem('geovault_password_hash', btoa(importVaultPassword));
                                  }
                                } catch (e) {
                                  localStorage.setItem('geovault_password_hash', btoa(importVaultPassword));
                                }
                                
                                localStorage.setItem('geovault_wallet_unlocked', 'true');
                                localStorage.setItem('geovault_publicKey', importVaultDetected.publicKey);
                                
                                setStoredSecret(newAccount.secretKey);
                                setStoredAccounts([newAccount]);
                                setWalletAccounts([newAccount]);
                                setWallet(importVaultDetected.keypair!);
                                
                                // Reset state
                                setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' });
                                setImportVaultPassword('');
                                setShowAddWalletModal(false);
                                setImportInput('');
                                setView('main');
                              } else {
                                setImportVaultError('Incorrect password');
                              }
                            } catch (err: any) {
                              setImportVaultError(err.message || 'Failed to verify password');
                            } finally {
                              setIsVerifyingImportPassword(false);
                            }
                          }}
                          disabled={isVerifyingImportPassword || !importVaultPassword.trim()}
                          style={{
                            width: '100%', padding: '16px',
                            background: (isVerifyingImportPassword || !importVaultPassword.trim()) ? 'rgba(255, 255, 255, 0.1)' : '#a855f7',
                            border: 'none', borderRadius: 14,
                            color: '#fff', fontSize: 16, fontWeight: 600,
                            cursor: (isVerifyingImportPassword || !importVaultPassword.trim()) ? 'not-allowed' : 'pointer',
                            marginBottom: 12
                          }}
                        >
                          {isVerifyingImportPassword ? 'Verifying...' : 'Import Vault'}
                        </button>
                        
                        <button
                          onClick={() => {
                            setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' });
                            setImportVaultPassword('');
                            setImportVaultError('');
                            localStorage.removeItem('geovault_mnemonic_temp');
                          }}
                          style={{
                            width: '100%', padding: '12px',
                            background: 'transparent', border: '1px solid rgba(255, 255, 255, 0.1)',
                            borderRadius: 12, color: 'rgba(255, 255, 255, 0.5)', fontSize: 13,
                            cursor: 'pointer'
                          }}
                        >
                           Back
                        </button>
                      </>
                    )}
                  </div>
                )}

                {addWalletView === 'import-pk' && (
                  <div>
                    {!importVaultDetected.detected ? (
                      <>
                        <p style={{ color: 'rgba(255,255,255,0.6)', fontSize: 14, marginBottom: 16, lineHeight: 1.5 }}>
                          Enter your Base58 encoded private key.
                        </p>
                        <textarea
                          placeholder="Enter private key..."
                          value={importInput}
                          onChange={(e) => setImportInput(e.target.value)}
                          style={{
                            width: '100%', height: 100, padding: '14px 16px',
                            background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)',
                            borderRadius: 12, color: '#fff', fontSize: 14, marginBottom: 12,
                            outline: 'none', resize: 'none', fontFamily: 'monospace'
                          }}
                        />
                        {status && <div style={{ color: '#ef4444', fontSize: 13, marginBottom: 12 }}>{status}</div>}
                        <button
                          onClick={async () => {
                            setIsAddingWallet(true);
                            setStatus('');
                            try {
                              const decoded = bs58.decode(importInput.trim());
                              const keypair = Keypair.fromSecretKey(decoded);
                              const publicKey = keypair.publicKey.toBase58();
                              
                              // Check if this wallet has an existing vault
                              console.log('[Onboarding Import PK] Checking if wallet has vault:', publicKey);
                              const vaultData = await checkVaultExists(publicKey);
                              console.log('[Onboarding Import PK] Vault check result:', vaultData);
                              
                              if (vaultData && (vaultData.exists || vaultData.multisigPda)) {
                                // Vault detected - show password input
                                console.log('[Onboarding Import PK] Vault detected, showing password input');
                                setImportVaultDetected({
                                  detected: true,
                                  publicKey,
                                  keypair,
                                  walletName: 'Account 1'
                                });
                                setIsAddingWallet(false);
                                return;
                              }
                              
                              // No vault - import directly
                              console.log('[Onboarding Import PK] No vault found, importing directly');
                              const newAccount: WalletAccount = {
                                index: 0,
                                name: 'Account 1',
                                publicKey,
                                secretKey: bs58.encode(keypair.secretKey)
                              };
                              
                              setStoredSecret(newAccount.secretKey);
                              setStoredAccounts([newAccount]);
                              setWalletAccounts([newAccount]);
                              setWallet(keypair);
                              
                              setShowAddWalletModal(false);
                              setImportInput('');
                              setView('main');
                            } catch (err: any) {
                              setStatus(err.message || 'Invalid private key');
                            } finally {
                              setIsAddingWallet(false);
                            }
                          }}
                          disabled={isAddingWallet || !importInput.trim()}
                          style={{
                            width: '100%', padding: '16px',
                            background: (isAddingWallet || !importInput.trim()) ? 'rgba(255, 255, 255, 0.1)' : '#fff',
                            border: 'none', borderRadius: 14,
                            color: (isAddingWallet || !importInput.trim()) ? 'rgba(255, 255, 255, 0.3)' : '#000',
                            fontSize: 16, fontWeight: 600,
                            cursor: (isAddingWallet || !importInput.trim()) ? 'not-allowed' : 'pointer'
                          }}
                        >
                          {isAddingWallet ? 'Importing...' : 'Import Wallet'}
                        </button>
                      </>
                    ) : (
                      /* Vault Password Required UI for Private Key Import in Onboarding */
                      <>
                        <div style={{ 
                          background: 'rgba(168, 85, 247, 0.1)', 
                          border: '1px solid rgba(168, 85, 247, 0.3)',
                          borderRadius: 12, 
                          padding: 16, 
                          marginBottom: 16 
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 8 }}>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" strokeWidth="2">
                              <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            <span style={{ fontSize: 14, fontWeight: 600, color: '#a855f7' }}>Vault Detected</span>
                          </div>
                          <p style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.6)', margin: 0 }}>
                            This wallet has an existing ARGUS Vault. Enter your vault password to continue.
                          </p>
                        </div>
                        
                        <input
                          type="password"
                          value={importVaultPassword}
                          onChange={(e) => setImportVaultPassword(e.target.value)}
                          placeholder="Enter vault password"
                          style={{
                            width: '100%', padding: '14px 16px',
                            background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)',
                            borderRadius: 12, color: '#fff', fontSize: 14, marginBottom: 12,
                            outline: 'none', boxSizing: 'border-box'
                          }}
                        />
                        
                        {importVaultError && (
                          <div style={{ color: '#ef4444', fontSize: 13, marginBottom: 12 }}>{importVaultError}</div>
                        )}
                        
                        <button
                          onClick={async () => {
                            if (!importVaultDetected.keypair || !importVaultPassword.trim()) return;
                            setIsVerifyingImportPassword(true);
                            setImportVaultError('');
                            
                            try {
                              const verifyResult = await verifyServerPassword(importVaultDetected.publicKey, importVaultPassword);
                              
                              if (verifyResult.success) {
                                // Password correct - complete import
                                const newAccount: WalletAccount = {
                                  index: 0,
                                  name: importVaultDetected.walletName,
                                  publicKey: importVaultDetected.publicKey,
                                  secretKey: bs58.encode(importVaultDetected.keypair!.secretKey)
                                };
                                
                                // Store the password hash for unlock screen
                                try {
                                  if (crypto.subtle) {
                                    const encoder = new TextEncoder();
                                    const data = encoder.encode(importVaultPassword);
                                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                                    const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                                    localStorage.setItem('geovault_password_hash', passwordHash);
                                  } else {
                                    localStorage.setItem('geovault_password_hash', btoa(importVaultPassword));
                                  }
                                } catch (e) {
                                  localStorage.setItem('geovault_password_hash', btoa(importVaultPassword));
                                }
                                
                                localStorage.setItem('geovault_wallet_unlocked', 'true');
                                localStorage.setItem('geovault_publicKey', importVaultDetected.publicKey);
                                
                                setStoredSecret(newAccount.secretKey);
                                setStoredAccounts([newAccount]);
                                setWalletAccounts([newAccount]);
                                setWallet(importVaultDetected.keypair!);
                                
                                // Reset state
                                setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' });
                                setImportVaultPassword('');
                                setShowAddWalletModal(false);
                                setImportInput('');
                                setView('main');
                              } else {
                                setImportVaultError('Incorrect password');
                              }
                            } catch (err: any) {
                              setImportVaultError(err.message || 'Failed to verify password');
                            } finally {
                              setIsVerifyingImportPassword(false);
                            }
                          }}
                          disabled={isVerifyingImportPassword || !importVaultPassword.trim()}
                          style={{
                            width: '100%', padding: '16px',
                            background: (isVerifyingImportPassword || !importVaultPassword.trim()) ? 'rgba(255, 255, 255, 0.1)' : '#a855f7',
                            border: 'none', borderRadius: 14,
                            color: '#fff', fontSize: 16, fontWeight: 600,
                            cursor: (isVerifyingImportPassword || !importVaultPassword.trim()) ? 'not-allowed' : 'pointer',
                            marginBottom: 12
                          }}
                        >
                          {isVerifyingImportPassword ? 'Verifying...' : 'Import Vault'}
                        </button>
                        
                        <button
                          onClick={() => {
                            setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' });
                            setImportVaultPassword('');
                            setImportVaultError('');
                          }}
                          style={{
                            width: '100%', padding: '12px',
                            background: 'transparent', border: '1px solid rgba(255, 255, 255, 0.1)',
                            borderRadius: 12, color: 'rgba(255, 255, 255, 0.5)', fontSize: 13,
                            cursor: 'pointer'
                          }}
                        >
                           Back
                        </button>
                      </>
                    )}
                  </div>
                )}
              </div>
            </div>
          </>
        )}
      </div>
    );
  }

  if (view === "import") {
    return (
      <div style={containerStyle}>
        <div style={{ padding: 30 }}>
          <h3 style={{ ...styles.headerTitle, marginBottom: 12 }}>Import Wallet</h3>
          <p style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: 14, marginBottom: 24, lineHeight: '1.5' }}>
            Paste your Private Key (Base58) below.
          </p>
          
          <textarea 
              style={{ ...styles.input, height: 120, fontFamily: 'monospace', resize: 'none' as const }}
              placeholder="5Maik..."
              value={importSeed}
              onChange={e => setImportSeed(e.target.value)}
          />

          {status && <div style={{ color: '#ef4444', fontSize: 13, marginBottom: 12, padding: '10px 14px', background: 'rgba(239, 68, 68, 0.1)', borderRadius: 12, border: '1px solid rgba(239, 68, 68, 0.2)' }}>{status}</div>}

          <div style={{ marginTop: 20 }}>
            <button style={styles.button} onClick={handleImportWallet}>
              Import Wallet
            </button>
            <button 
              style={{ ...styles.button, ...styles.secondaryButton, marginTop: 12 }} 
              onClick={() => setView("manage-wallets")}
            >
              Back
            </button>
          </div>
        </div>
      </div>
    )
  }

  if (view === "seed") {
    return (
      <div style={containerStyle}>
        <div style={{ padding: 30 }}>
          <h3 style={{ ...styles.headerTitle, marginBottom: 12 }}>Secret Recovery Phrase</h3>
          <p style={{ color: 'rgba(255, 255, 255, 0.5)', fontSize: 14, marginBottom: 24, lineHeight: '1.5' }}>
            Save these words in a safe place. This is the only way to recover your wallet.
          </p>
          
          <div style={styles.seedBox}>
            {mnemonic.split(" ").map((word, i) => (
              <div key={i} style={styles.seedWord}>
                <span style={{ color: 'rgba(255, 255, 255, 0.3)', marginRight: 6, fontSize: 10 }}>{i+1}.</span>
                {word}
              </div>
            ))}
          </div>

          <div style={{ background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.2)', borderRadius: 12, padding: 14, marginBottom: 20 }}>
            <p style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.7)', lineHeight: '1.5', margin: 0 }}>
               Never share your recovery phrase. Anyone with these words can access your funds.
            </p>
          </div>

          <button style={styles.button} onClick={confirmSeedSaved}>
            I Saved My Secret Phrase
          </button>
        </div>
      </div>
    )
  }

  if (view === "settings") {
    // Main settings view always operates on the genesis wallet (first wallet in the list)
    const genesisWallet = walletAccounts[0]
    const genesisPublicKey = genesisWallet?.publicKey || ''
    const genesisSecretKey = genesisWallet?.secretKey || ''
    // Get genesis keypair for private key display
    const genesisKeypair = genesisSecretKey ? getKeypairFromSecret(genesisSecretKey) : null
    
    const fetchSeedPhrase = async () => {
      try {
        // PWA: Read mnemonic directly from localStorage instead of chrome.runtime.sendMessage
        const storedMnemonic = getMnemonic()
        if (storedMnemonic) {
          setSeedPhrase(storedMnemonic)
          setShowSeedPhrase(true)
          setNoSeedStored(false)
        } else {
          setNoSeedStored(true)
          setShowLinkSeedModal(true)
        }
      } catch (e: any) {
        setNoSeedStored(true)
        setShowLinkSeedModal(true)
      }
    }

    const handleLinkSeedPhrase = async () => {
      setIsLinkingSeed(true)
      try {
        // PWA: Validate and save mnemonic directly to localStorage
        const bip39 = await import('bip39')
        const trimmedSeed = linkSeedInput.trim()
        
        if (!bip39.validateMnemonic(trimmedSeed)) {
          setStatus("Invalid seed phrase")
          return
        }
        
        // Verify password matches stored hash
        const passwordValid = await verifyLocalPassword(linkSeedPassword)
        if (!passwordValid) {
          setStatus("Incorrect password")
          return
        }
        
        // Save mnemonic to localStorage
        saveMnemonic(trimmedSeed)
        
        setStatus("Seed phrase linked successfully!")
        setShowLinkSeedModal(false)
        setLinkSeedInput("")
        setLinkSeedPassword("")
        setNoSeedStored(false)
      } catch (e: any) {
        setStatus(e.message || "Error linking seed phrase")
      } finally {
        setIsLinkingSeed(false)
      }
    }

    const copyToClipboard = async (text: string, type: 'seed' | 'key') => {
      copyToClipboardSafe(text)
      if (type === 'seed') {
        setCopiedSeed(true)
        setTimeout(() => setCopiedSeed(false), 2000)
      } else {
        setCopiedKey(true)
        setTimeout(() => setCopiedKey(false), 2000)
      }
    }

    return (
      <div style={containerStyle}>
        {/* Confirm Modal */}
        {confirmModal.show && (
          <>
            <div 
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.8)',
                backdropFilter: 'blur(8px)',
                zIndex: 2000
              }} 
              onClick={() => setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })} 
            />
            <div style={{
              position: 'fixed',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              width: 300,
              background: '#1a1a1f',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              borderRadius: 20,
              padding: 24,
              zIndex: 2001
            }}>
              <div style={{
                width: 48,
                height: 48,
                borderRadius: 14,
                background: confirmModal.danger ? 'rgba(239, 68, 68, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                margin: '0 auto 16px auto'
              }}>
                {confirmModal.danger ? (
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                ) : (
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" strokeWidth="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  </svg>
                )}
              </div>
              <h3 style={{ 
                margin: '0 0 8px 0', 
                fontSize: 16, 
                fontWeight: 600, 
                color: '#fff',
                textAlign: 'center'
              }}>
                {confirmModal.title}
              </h3>
              <p style={{ 
                margin: '0 0 16px 0', 
                fontSize: 13, 
                color: 'rgba(255, 255, 255, 0.5)',
                textAlign: 'center',
                lineHeight: 1.5
              }}>
                {confirmModal.message}
              </p>
              {confirmModal.requirePassword && (
                <div style={{ marginBottom: 16 }}>
                  <input
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => {
                      setConfirmPassword(e.target.value)
                      setConfirmPasswordError("")
                    }}
                    placeholder="Enter your password"
                    style={{
                      width: '100%',
                      padding: '12px 14px',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: confirmPasswordError ? '1px solid #ef4444' : '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 10,
                      fontSize: 14,
                      color: '#fff',
                      outline: 'none',
                      boxSizing: 'border-box'
                    }}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && confirmPassword) {
                        confirmModal.onConfirm(confirmPassword)
                      }
                    }}
                    autoFocus
                  />
                  {confirmPasswordError && (
                    <div style={{ fontSize: 11, color: '#ef4444', marginTop: 6 }}>
                      {confirmPasswordError}
                    </div>
                  )}
                </div>
              )}
              <div style={{ display: 'flex', gap: 10 }}>
                <button
                  onClick={() => {
                    setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                  }}
                  style={{
                    flex: 1,
                    padding: '12px 16px',
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 12,
                    color: 'rgba(255, 255, 255, 0.7)',
                    fontSize: 13,
                    fontWeight: 500,
                    cursor: 'pointer'
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={() => confirmModal.onConfirm(confirmPassword)}
                  disabled={confirmModal.requirePassword && !confirmPassword}
                  style={{
                    flex: 1,
                    padding: '12px 16px',
                    background: confirmModal.danger ? '#ef4444' : (confirmModal.requirePassword && !confirmPassword) ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.1)',
                    border: 'none',
                    borderRadius: 12,
                    color: (confirmModal.requirePassword && !confirmPassword) ? 'rgba(255, 255, 255, 0.3)' : '#fff',
                    fontSize: 13,
                    fontWeight: 600,
                    cursor: (confirmModal.requirePassword && !confirmPassword) ? 'not-allowed' : 'pointer'
                  }}
                >
                  {confirmModal.confirmText || 'Confirm'}
                </button>
              </div>
            </div>
          </>
        )}

        {/* EPIC Transaction Verification Modal - Same Orbit as Lock Screen */}
        {txVerificationModal.show && (
          <>
            <style>
              {`
                @keyframes txFadeIn {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                @keyframes txSlideUp {
                  from { opacity: 0; transform: translateY(20px); }
                  to { opacity: 1; transform: translateY(0); }
                }
                @keyframes txOrbitRotate {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(360deg); }
                }
                @keyframes txCounterRotate {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(-360deg); }
                }
                @keyframes txOrbitRotateReverse {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(-360deg); }
                }
                @keyframes txCounterRotateReverse {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(360deg); }
                }
                @keyframes txPulseGlow {
                  0%, 100% { box-shadow: 0 0 0 0 currentColor; }
                  50% { box-shadow: 0 0 15px 3px currentColor; }
                }
                @keyframes txIconPulseWhite {
                  0%, 100% { 
                    box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
                    color: rgba(180, 180, 180, 0.9);
                  }
                  50% { 
                    box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
                    color: rgba(255, 255, 255, 1);
                  }
                }
                @keyframes txCheckPop {
                  0% { transform: scale(0); }
                  50% { transform: scale(1.2); }
                  100% { transform: scale(1); }
                }
                @keyframes txSuccessPulse {
                  0%, 100% { transform: scale(1); }
                  50% { transform: scale(1.03); }
                }
              `}
            </style>
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: '#0a0a0c',
              zIndex: 10000,
              animation: 'txFadeIn 0.3s ease-out',
              overflow: 'hidden',
              display: 'flex',
              flexDirection: 'column'
            }}>
              {/* Video Background */}
              <video
                autoPlay
                loop
                muted
                playsInline
                style={{
                  position: 'absolute',
                  top: '50%',
                  left: '50%',
                  transform: 'translate(-50%, -50%)',
                  minWidth: '100%',
                  minHeight: '100%',
                  width: 'auto',
                  height: 'auto',
                  objectFit: 'cover',
                  opacity: 0.35
                }}
              >
                <source src="https://brown-traditional-sheep-998.mypinata.cloud/ipfs/bafybeicmrwektqnpcgast66rua3czhzwx2aasfncb6zdzysmnsfosewfw4" type="video/mp4" />
              </video>

              {/* Dark Gradient Overlay */}
              <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'radial-gradient(circle at 50% 35%, rgba(10,10,12,0.3) 0%, rgba(10,10,12,0.8) 50%, rgba(10,10,12,0.95) 100%)',
                pointerEvents: 'none'
              }} />

              {/* Content */}
              <div style={{
                position: 'relative',
                zIndex: 10,
                flex: 1,
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                padding: '24px 20px',
                overflowY: 'auto'
              }}>
                
                {/* Top Title */}
                <div style={{ 
                  textAlign: 'center', 
                  marginBottom: 16,
                  animation: 'txSlideUp 0.4s ease-out'
                }}>
                  <div style={{
                    fontSize: 11,
                    fontWeight: 600,
                    color: txVerificationModal.currentLayer === 'done' ? '#10b981' : 'rgba(255, 255, 255, 0.5)',
                    textTransform: 'uppercase',
                    letterSpacing: '2px',
                    marginBottom: 4
                  }}>
                    {txVerificationModal.currentLayer === 'done' ? ' VERIFIED' : 'AUTHENTICATING'}
                  </div>
                  <h1 style={{
                    fontSize: 20,
                    fontWeight: 600,
                    color: '#fff',
                    margin: 0
                  }}>
                    {txVerificationModal.currentLayer === 'done' ? 'Transaction Secured' : 'Security Verification'}
                  </h1>
                </div>

                {/* ORBIT SYSTEM - SAME AS LOCK SCREEN */}
                <div style={{
                  position: 'relative',
                  width: 200,
                  height: 200,
                  margin: '8px 0 20px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  
                  {/* Center ARGUS Logo */}
                  <img 
                    src={getAssetUrl("assets/arguslogo.png")} 
                    alt="ARGUS" 
                    style={{
                      width: 75,
                      height: 75,
                      borderRadius: 18,
                      objectFit: 'contain',
                      zIndex: 10,
                      position: 'relative',
                      filter: txVerificationModal.currentLayer === 'done' ? 'drop-shadow(0 0 20px rgba(16, 185, 129, 0.5))' : 'none',
                      animation: txVerificationModal.currentLayer === 'done' ? 'txSuccessPulse 2s ease-in-out infinite' : 'none'
                    }}
                  />

                  {/* Inner Orbit Ring */}
                  <div style={{
                    position: 'absolute',
                    width: 130,
                    height: 130,
                    borderRadius: '50%',
                    border: txVerificationModal.currentLayer === 'done' 
                      ? '1px solid rgba(16, 185, 129, 0.3)'
                      : '1px solid rgba(255, 255, 255, 0.1)'
                  }} />

                  {/* Outer Orbit Ring */}
                  <div style={{
                    position: 'absolute',
                    width: 190,
                    height: 190,
                    borderRadius: '50%',
                    border: txVerificationModal.currentLayer === 'done' 
                      ? '1px solid rgba(16, 185, 129, 0.3)'
                      : '1px solid rgba(255, 255, 255, 0.1)'
                  }} />

                  {/* Inner Orbit - Rotating container with icons (Voice, Geo on inner) */}
                  <div style={{
                    position: 'absolute',
                    width: 130,
                    height: 130,
                    borderRadius: '50%',
                    animation: 'txOrbitRotate 30s linear infinite'
                  }}>
                    {(() => {
                      const innerLayers = [
                        { id: 'voice', color: '#8b5cf6', icon: (
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                          </svg>
                        )},
                        { id: 'geo', color: '#3b82f6', icon: (
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                          </svg>
                        )},
                        { id: 'usb', color: '#f59e0b', icon: (
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                          </svg>
                        )}
                      ];
                      
                      // Position at top, right-bottom, left-bottom (3 positions for inner orbit)
                      const positions = [
                        { top: 0, left: '50%', ml: -14, mt: -14 }, // top
                        { bottom: '15%', right: '5%', mr: -14, mb: -14 }, // right-bottom
                        { bottom: '15%', left: '5%', ml: -14, mb: -14 } // left-bottom
                      ];
                      
                      return innerLayers.map((layer, index) => {
                        const isEnabled = txVerificationModal.enabledLayers[layer.id as keyof typeof txVerificationModal.enabledLayers];
                        const isCompleted = txVerificationModal.completedLayers[layer.id as keyof typeof txVerificationModal.completedLayers];
                        const isCurrent = txVerificationModal.currentLayer === layer.id;
                        const pos = positions[index];
                        
                        return (
                          <div
                            key={layer.id}
                            style={{
                              position: 'absolute',
                              width: 28,
                              height: 28,
                              padding: 6,
                              background: 'rgba(20, 20, 20, 0.95)',
                              border: '1px solid rgba(255, 255, 255, 0.15)',
                              borderRadius: 7,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              color: isCompleted 
                                ? layer.color
                                : isEnabled 
                                  ? 'rgba(120, 120, 120, 0.8)'
                                  : 'rgba(255, 255, 255, 0.2)',
                              animation: `txCounterRotate 30s linear infinite${isCurrent && isEnabled ? ', txIconPulseWhite 1.5s ease-in-out infinite' : ''}`,
                              boxShadow: isCurrent && isEnabled ? '0 0 15px rgba(255, 255, 255, 0.4)' : 'none',
                              transition: 'color 0.3s ease, box-shadow 0.3s ease',
                              ...pos,
                              opacity: isEnabled ? 1 : 0.3
                            }}
                          >
                            {layer.icon}
                          </div>
                        );
                      });
                    })()}
                  </div>

                  {/* Outer Orbit - Rotating container with icons (Bluetooth, WiFi, Biometric on outer) */}
                  <div style={{
                    position: 'absolute',
                    width: 190,
                    height: 190,
                    borderRadius: '50%',
                    animation: 'txOrbitRotateReverse 45s linear infinite'
                  }}>
                    {(() => {
                      const outerLayers = [
                        { id: 'bluetooth', color: '#06b6d4', icon: (
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
                          </svg>
                        )},
                        { id: 'wifi', color: '#10b981', icon: (
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                            <line x1="12" y1="18" x2="12.01" y2="18"/>
                          </svg>
                        )},
                        { id: 'biometric', color: '#ec4899', icon: (
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                            <line x1="9" y1="9" x2="9.01" y2="9"/>
                            <line x1="15" y1="9" x2="15.01" y2="9"/>
                          </svg>
                        )},
                        // Decorative icon (always disabled)
                        { id: 'deco1', color: '#6366f1', isDecorative: true, icon: (
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                          </svg>
                        )}
                      ];
                      
                      // Position at 4 cardinal points
                      const positions = [
                        { top: 0, left: '50%', ml: -14, mt: -14 }, // top
                        { top: '50%', right: 0, mr: -14, mt: -14 }, // right
                        { bottom: 0, left: '50%', ml: -14, mb: -14 }, // bottom
                        { top: '50%', left: 0, ml: -14, mt: -14 } // left
                      ];
                      
                      return outerLayers.map((layer, index) => {
                        const isDecorative = (layer as any).isDecorative;
                        const isEnabled = isDecorative ? false : txVerificationModal.enabledLayers[layer.id as keyof typeof txVerificationModal.enabledLayers];
                        const isCompleted = isDecorative ? false : txVerificationModal.completedLayers[layer.id as keyof typeof txVerificationModal.completedLayers];
                        const isCurrent = txVerificationModal.currentLayer === layer.id;
                        const pos = positions[index];
                        
                        return (
                          <div
                            key={layer.id}
                            style={{
                              position: 'absolute',
                              width: 28,
                              height: 28,
                              padding: 6,
                              background: 'rgba(20, 20, 20, 0.95)',
                              border: '1px solid rgba(255, 255, 255, 0.15)',
                              borderRadius: 7,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              color: isCompleted 
                                ? layer.color
                                : isEnabled 
                                  ? 'rgba(120, 120, 120, 0.8)'
                                  : 'rgba(255, 255, 255, 0.2)',
                              animation: `txCounterRotateReverse 45s linear infinite${isCurrent && isEnabled ? ', txIconPulseWhite 1.5s ease-in-out infinite' : ''}`,
                              boxShadow: isCurrent && isEnabled ? '0 0 15px rgba(255, 255, 255, 0.4)' : 'none',
                              transition: 'color 0.3s ease, box-shadow 0.3s ease',
                              ...pos,
                              opacity: isEnabled ? 1 : 0.3
                            }}
                          >
                            {layer.icon}
                          </div>
                        );
                      });
                    })()}
                  </div>
                </div>

                {/* Status Text */}
                <div style={{
                  textAlign: 'center',
                  marginBottom: 16,
                  animation: 'txSlideUp 0.4s ease-out 0.1s both'
                }}>
                  <div style={{
                    fontSize: 14,
                    fontWeight: 500,
                    color: txVerificationModal.currentLayer === 'done' ? '#10b981' : '#fff'
                  }}>
                    {txVerificationModal.currentLayer === 'voice' && 'Verifying voice print...'}
                    {txVerificationModal.currentLayer === 'geo' && 'Checking location...'}
                    {txVerificationModal.currentLayer === 'bluetooth' && 'Connecting device...'}
                    {txVerificationModal.currentLayer === 'usb' && 'Reading hardware key...'}
                    {txVerificationModal.currentLayer === 'wifi' && 'Verifying 2FA Mobile...'}
                    {txVerificationModal.currentLayer === 'biometric' && 'Scanning biometric...'}
                    {txVerificationModal.currentLayer === 'proposal' && 'Creating proposal (1/3)...'}
                    {txVerificationModal.currentLayer === 'approval' && 'Awaiting approval (2/3)...'}
                    {txVerificationModal.currentLayer === 'execute' && 'Executing transaction (3/3)...'}
                    {txVerificationModal.currentLayer === 'done' && 'All security checks passed'}
                  </div>
                </div>

                {/* Progress Dots */}
                <div style={{
                  display: 'flex',
                  justifyContent: 'center',
                  gap: 6,
                  marginBottom: 20
                }}>
                  {['voice', 'geo', 'usb', 'bluetooth', 'wifi', 'biometric'].filter(
                    id => txVerificationModal.enabledLayers[id as keyof typeof txVerificationModal.enabledLayers]
                  ).map((layerId) => {
                    const isCompleted = txVerificationModal.completedLayers[layerId as keyof typeof txVerificationModal.completedLayers];
                    
                    return (
                      <div
                        key={layerId}
                        style={{
                          width: 8,
                          height: 8,
                          borderRadius: '50%',
                          background: isCompleted 
                            ? '#10b981'
                            : '#fff',
                          transition: 'all 0.3s ease'
                        }}
                      />
                    );
                  })}
                </div>

                {/* Spacer */}
                <div style={{ flex: 1 }} />

                {/* Transaction Info Card - At Bottom */}
                {txVerificationModal.txData && (
                  <div style={{
                    width: '100%',
                    background: 'rgba(255, 255, 255, 0.03)',
                    borderRadius: 16,
                    padding: 16,
                    border: '1px solid rgba(255, 255, 255, 0.06)',
                    animation: 'txSlideUp 0.4s ease-out 0.2s both'
                  }}>
                    <div style={{
                      fontSize: 10,
                      color: 'rgba(255, 255, 255, 0.4)',
                      textTransform: 'uppercase',
                      letterSpacing: '1.5px',
                      marginBottom: 8
                    }}>
                      {txVerificationModal.txData.type === 'send' ? 'SENDING' : txVerificationModal.txData.type === 'swap' ? 'SWAPPING' : 'SIGNING'}
                    </div>
                    
                    <div style={{
                      fontSize: 28,
                      fontWeight: 700,
                      color: '#fff',
                      display: 'flex',
                      alignItems: 'baseline',
                      gap: 8
                    }}>
                      {txVerificationModal.txData.amount || '0.00'}
                      <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>
                        {txVerificationModal.txData.token || 'SOL'}
                      </span>
                      {txVerificationModal.txData.toToken && (
                        <>
                          <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.3)', margin: '0 4px' }}></span>
                          <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>
                            {txVerificationModal.txData.toToken}
                          </span>
                        </>
                      )}
                    </div>
                    
                    {txVerificationModal.txData.recipient && (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 8,
                        marginTop: 12,
                        padding: '8px 10px',
                        background: 'rgba(0, 0, 0, 0.3)',
                        borderRadius: 8
                      }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2">
                          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                        <div style={{ 
                          fontSize: 11, 
                          color: 'rgba(255, 255, 255, 0.5)',
                          fontFamily: 'monospace'
                        }}>
                          {txVerificationModal.txData.recipient}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Bottom Action */}
                <div style={{ width: '100%', paddingTop: 16 }}>
                  {txVerificationModal.currentLayer === 'done' ? (
                    <button
                      onClick={() => setTxVerificationModal(prev => ({ ...prev, show: false }))}
                      style={{
                        width: '100%',
                        padding: '16px',
                        background: 'linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%)',
                        border: 'none',
                        borderRadius: 16,
                        color: '#000',
                        fontSize: 16,
                        fontWeight: 600,
                        cursor: 'pointer',
                        boxShadow: '0 4px 20px rgba(255, 255, 255, 0.15)'
                      }}
                    >
                      Continue
                    </button>
                  ) : (
                    <div style={{
                      textAlign: 'center',
                      padding: '12px',
                      color: 'rgba(255, 255, 255, 0.3)',
                      fontSize: 11
                    }}>
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: 6
                      }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Protected by ARGUS
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </>
        )}

        {/* Simple Transaction Modal (Master Wallet - No Security Layers) */}
        {simpleTxModal.show && (
          <>
            <style>
              {`
                @keyframes simpleTxFadeIn {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                @keyframes simpleTxSlideUp {
                  from { transform: translateY(20px); opacity: 0; }
                  to { transform: translateY(0); opacity: 1; }
                }
                @keyframes simpleTxSpin {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(360deg); }
                }
                @keyframes simpleTxSuccessPop {
                  0% { transform: scale(0); }
                  50% { transform: scale(1.2); }
                  100% { transform: scale(1); }
                }
              `}
            </style>
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.85)',
              backdropFilter: 'blur(10px)',
              zIndex: 10000,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              padding: 24,
              animation: 'simpleTxFadeIn 0.3s ease-out'
            }}>
              {/* Warning Banner - Not Protected */}
              <div style={{
                background: 'linear-gradient(90deg, rgba(245, 158, 11, 0.15), rgba(239, 68, 68, 0.15))',
                border: '1px solid rgba(245, 158, 11, 0.3)',
                borderRadius: 12,
                padding: '10px 16px',
                marginBottom: 24,
                display: 'flex',
                alignItems: 'center',
                gap: 10,
                animation: 'simpleTxSlideUp 0.3s ease-out'
              }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <span style={{ fontSize: 12, color: '#f59e0b', fontWeight: 500 }}>
                  Master Wallet - Not Protected by ARGUS
                </span>
              </div>

              {/* Main Content */}
              <div style={{
                background: 'rgba(20, 20, 20, 0.95)',
                borderRadius: 24,
                padding: 24,
                width: '100%',
                maxWidth: 320,
                border: '1px solid rgba(255, 255, 255, 0.1)',
                animation: 'simpleTxSlideUp 0.3s ease-out 0.1s both'
              }}>
                {/* Status Icon */}
                <div style={{
                  display: 'flex',
                  justifyContent: 'center',
                  marginBottom: 20
                }}>
                  {simpleTxModal.status === 'confirm' && (
                    <div style={{
                      width: 64,
                      height: 64,
                      borderRadius: '50%',
                      background: 'rgba(59, 130, 246, 0.1)',
                      border: '2px solid rgba(59, 130, 246, 0.3)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                      </svg>
                    </div>
                  )}
                  {simpleTxModal.status === 'processing' && (
                    <div style={{
                      width: 64,
                      height: 64,
                      borderRadius: '50%',
                      border: '3px solid rgba(59, 130, 246, 0.2)',
                      borderTopColor: '#3b82f6',
                      animation: 'simpleTxSpin 1s linear infinite'
                    }} />
                  )}
                  {simpleTxModal.status === 'success' && (
                    <div style={{
                      width: 80,
                      height: 80,
                      borderRadius: '50%',
                      background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.08) 100%)',
                      border: '1px solid rgba(34, 197, 94, 0.2)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      animation: 'simpleTxSuccessPop 0.4s ease-out'
                    }}>
                      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#22c55e" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    </div>
                  )}
                  {simpleTxModal.status === 'error' && (
                    <div style={{
                      width: 64,
                      height: 64,
                      borderRadius: '50%',
                      background: 'rgba(239, 68, 68, 0.1)',
                      border: '2px solid #ef4444',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </div>
                  )}
                </div>

                {/* Title */}
                <div style={{
                  textAlign: 'center',
                  marginBottom: simpleTxModal.status === 'success' ? 8 : 20
                }}>
                  <div style={{
                    fontSize: simpleTxModal.status === 'success' ? 22 : 18,
                    fontWeight: 600,
                    color: '#fff',
                    marginBottom: simpleTxModal.status === 'success' ? 6 : 4,
                    letterSpacing: simpleTxModal.status === 'success' ? '-0.02em' : 'normal'
                  }}>
                    {simpleTxModal.status === 'confirm' && 'Confirm Transaction'}
                    {simpleTxModal.status === 'processing' && 'Processing...'}
                    {simpleTxModal.status === 'success' && 'Transaction Successful'}
                    {simpleTxModal.status === 'error' && 'Transaction Failed'}
                  </div>
                  {simpleTxModal.status !== 'success' && (
                    <div style={{
                      fontSize: 12,
                      color: 'rgba(255, 255, 255, 0.5)'
                    }}>
                      {simpleTxModal.status === 'confirm' && 'Review the details below'}
                      {simpleTxModal.status === 'processing' && 'Please wait...'}
                      {simpleTxModal.status === 'error' && (simpleTxModal.error || 'Something went wrong')}
                    </div>
                  )}
                </div>

                {/* Success Amount Display */}
                {simpleTxModal.status === 'success' && (
                  <div style={{ textAlign: 'center', marginBottom: 16 }}>
                    <div style={{ fontSize: 32, fontWeight: 700, color: '#fff', marginBottom: 4 }}>
                      {simpleTxModal.amount} {simpleTxModal.token}
                    </div>
                    {simpleTxModal.recipient && (
                      <div style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.4)' }}>
                        to {simpleTxModal.recipientName || `${simpleTxModal.recipient.slice(0, 4)}...${simpleTxModal.recipient.slice(-4)}`}
                      </div>
                    )}
                    {simpleTxModal.executionTime && (
                      <div style={{
                        display: 'inline-flex',
                        alignItems: 'center',
                        gap: 4,
                        marginTop: 12,
                        padding: '6px 12px',
                        background: 'rgba(34, 197, 94, 0.1)',
                        border: '1px solid rgba(34, 197, 94, 0.2)',
                        borderRadius: 20,
                        fontSize: 12,
                        color: '#22c55e'
                      }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <circle cx="12" cy="12" r="10"/>
                          <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        {simpleTxModal.executionTime.toFixed(2)}s
                      </div>
                    )}
                  </div>
                )}

                {/* Transaction Details - only show on confirm/processing */}
                {(simpleTxModal.status === 'confirm' || simpleTxModal.status === 'processing') && (
                  <div style={{
                    background: 'rgba(0, 0, 0, 0.3)',
                    borderRadius: 12,
                    padding: 16,
                    marginBottom: 20
                  }}>
                    <div style={{
                      fontSize: 10,
                      color: 'rgba(255, 255, 255, 0.4)',
                      textTransform: 'uppercase',
                      letterSpacing: '1px',
                      marginBottom: 8
                    }}>
                      {simpleTxModal.type === 'send' ? 'SENDING' : 'SWAPPING'}
                    </div>
                    <div style={{
                      fontSize: 24,
                      fontWeight: 700,
                      color: '#fff',
                      display: 'flex',
                      alignItems: 'baseline',
                      gap: 6
                    }}>
                      {simpleTxModal.amount}
                      <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>
                        {simpleTxModal.token}
                      </span>
                      {simpleTxModal.toToken && (
                        <>
                          <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.3)', margin: '0 2px' }}></span>
                          <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>
                            {simpleTxModal.toToken}
                          </span>
                        </>
                      )}
                    </div>
                    {simpleTxModal.recipient && (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 6,
                        marginTop: 10,
                        paddingTop: 10,
                        borderTop: '1px solid rgba(255, 255, 255, 0.06)'
                      }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2">
                          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                        <span style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.5)', fontFamily: 'monospace' }}>
                          {simpleTxModal.recipient}
                        </span>
                        {simpleTxModal.recipientName && (
                          <span style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.3)' }}>
                            ({simpleTxModal.recipientName})
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {/* Action Buttons */}
                {simpleTxModal.status === 'confirm' && (
                  <div style={{ display: 'flex', gap: 10 }}>
                    <button
                      onClick={() => setSimpleTxModal(prev => ({ ...prev, show: false }))}
                      style={{
                        flex: 1,
                        padding: '14px',
                        background: 'rgba(255, 255, 255, 0.05)',
                        border: '1px solid rgba(255, 255, 255, 0.1)',
                        borderRadius: 12,
                        color: 'rgba(255, 255, 255, 0.7)',
                        fontSize: 14,
                        fontWeight: 500,
                        cursor: 'pointer'
                      }}
                    >
                      Cancel
                    </button>
                    <button
                      onClick={() => simpleTxModal.onConfirm()}
                      style={{
                        flex: 1,
                        padding: '14px',
                        background: '#3b82f6',
                        border: 'none',
                        borderRadius: 12,
                        color: '#fff',
                        fontSize: 14,
                        fontWeight: 600,
                        cursor: 'pointer'
                      }}
                    >
                      Confirm
                    </button>
                  </div>
                )}
                {simpleTxModal.status === 'success' && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 12, width: '100%' }}>
                    {/* View on Orbit Button */}
                    {simpleTxModal.signature && (
                      <button
                        onClick={() => window.open(`https://orb.helius.dev/tx/${simpleTxModal.signature}?tab=summary`, '_blank')}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: 8,
                          padding: '12px 16px',
                          background: 'transparent',
                          border: '1px solid rgba(255, 255, 255, 0.08)',
                          borderRadius: 12,
                          color: 'rgba(255, 255, 255, 0.5)',
                          fontSize: 14,
                          cursor: 'pointer',
                          transition: 'all 0.2s ease'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.15)';
                          e.currentTarget.style.color = 'rgba(255, 255, 255, 0.7)';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.08)';
                          e.currentTarget.style.color = 'rgba(255, 255, 255, 0.5)';
                        }}
                      >
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                          <polyline points="15 3 21 3 21 9"/>
                          <line x1="10" y1="14" x2="21" y2="3"/>
                        </svg>
                        View on Orb
                      </button>
                    )}
                    {/* Done Button */}
                    <button
                      onClick={() => setSimpleTxModal(prev => ({ ...prev, show: false }))}
                      style={{
                        width: '100%',
                        padding: '14px',
                        background: 'rgba(255, 255, 255, 0.05)',
                        border: '1px solid rgba(255, 255, 255, 0.08)',
                        borderRadius: 12,
                        color: '#fff',
                        fontSize: 15,
                        fontWeight: 500,
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.05)';
                      }}
                    >
                      Done
                    </button>
                  </div>
                )}
                {simpleTxModal.status === 'error' && (
                  <div style={{ display: 'flex', gap: 10 }}>
                    <button
                      onClick={() => setSimpleTxModal(prev => ({ ...prev, show: false }))}
                      style={{
                        flex: 1,
                        padding: '14px',
                        background: 'rgba(255, 255, 255, 0.05)',
                        border: '1px solid rgba(255, 255, 255, 0.1)',
                        borderRadius: 12,
                        color: 'rgba(255, 255, 255, 0.7)',
                        fontSize: 14,
                        fontWeight: 500,
                        cursor: 'pointer'
                      }}
                    >
                      Close
                    </button>
                    <button
                      onClick={() => setSimpleTxModal(prev => ({ ...prev, status: 'confirm' }))}
                      style={{
                        flex: 1,
                        padding: '14px',
                        background: '#ef4444',
                        border: 'none',
                        borderRadius: 12,
                        color: '#fff',
                        fontSize: 14,
                        fontWeight: 600,
                        cursor: 'pointer'
                      }}
                    >
                      Try Again
                    </button>
                  </div>
                )}
              </div>
            </div>
          </>
        )}

        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '18px 20px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 14 }}>
            <button 
              onClick={() => setView("main")}
              onTouchEnd={(e) => {
                e.preventDefault();
                setView("main");
              }}
              style={{ 
                background: 'rgba(255, 255, 255, 0.06)', 
                border: 'none', 
                color: 'rgba(255, 255, 255, 0.8)', 
                cursor: 'pointer', 
                fontSize: 20,
                width: 44,
                height: 44,
                borderRadius: 12,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                transition: 'all 0.2s',
                WebkitTapHighlightColor: 'transparent',
                touchAction: 'manipulation'
              }}
            >
              
            </button>
            <h3 style={{ 
              margin: 0, 
              fontSize: 20, 
              fontWeight: 600,
              color: '#fff'
            }}>{t('settings', lang)}</h3>
          </div>
          <div style={{
            fontSize: 12,
            color: 'rgba(255, 255, 255, 0.35)',
            fontWeight: 500
          }}>
            v1.0.2 Beta
          </div>
        </div>

        <div style={{ padding: '18px 20px', overflowY: 'auto', flex: 1 }}>
          {/* Preferences Section */}
          <div style={{ marginBottom: 28 }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 10,
              marginBottom: 14
            }}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.45)" strokeWidth="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
              </svg>
              <span style={{ fontSize: 13, fontWeight: 600, color: 'rgba(255, 255, 255, 0.55)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{t('preferences', lang)}</span>
            </div>

            <div style={{
              background: 'rgba(255, 255, 255, 0.03)',
              border: '1px solid rgba(255, 255, 255, 0.08)',
              borderRadius: 18,
              overflow: 'hidden'
            }}>
              {/* Language Option */}
              <button
                onClick={() => setShowPreferences(showPreferences === 'language' ? false : 'language')}
                style={{
                  width: '100%',
                  padding: '16px 18px',
                  background: 'transparent',
                  border: 'none',
                  borderBottom: '1px solid rgba(255, 255, 255, 0.06)',
                  color: '#fff',
                  fontSize: 16,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  transition: 'all 0.2s',
                  minHeight: 56,
                  WebkitTapHighlightColor: 'transparent',
                  touchAction: 'manipulation'
                }}
              >
                <span style={{ color: 'rgba(255, 255, 255, 0.8)' }}>{t('displayLanguage', lang)}</span>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                  <span style={{ color: 'rgba(255, 255, 255, 0.55)', fontSize: 15 }}>{preferredLanguage}</span>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </div>
              </button>

              {/* Language Dropdown */}
              {showPreferences === 'language' && (
                <div style={{ background: 'rgba(0, 0, 0, 0.25)', borderBottom: '1px solid rgba(255, 255, 255, 0.06)' }}>
                  {['English', 'Espaol', '', '', '', 'Franais', 'Deutsch', 'Portugus'].map((langName) => (
                    <button
                      key={langName}
                      onClick={() => {
                        setPreferredLanguage(langName)
                        setShowPreferences(false)
                      }}
                      style={{
                        width: '100%',
                        padding: '14px 18px',
                        background: preferredLanguage === langName ? 'rgba(16, 185, 129, 0.12)' : 'transparent',
                        border: 'none',
                        color: preferredLanguage === langName ? '#10b981' : 'rgba(255, 255, 255, 0.75)',
                        fontSize: 15,
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        textAlign: 'left',
                        minHeight: 50,
                        WebkitTapHighlightColor: 'transparent',
                        touchAction: 'manipulation'
                      }}
                    >
                      {langName}
                      {preferredLanguage === langName && (
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                      )}
                    </button>
                  ))}
                </div>
              )}

              {/* Currency Option */}
              <button
                onClick={() => setShowPreferences(showPreferences === 'currency' ? false : 'currency')}
                style={{
                  width: '100%',
                  padding: '16px 18px',
                  background: 'transparent',
                  border: 'none',
                  color: '#fff',
                  fontSize: 16,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  transition: 'all 0.2s',
                  minHeight: 56,
                  WebkitTapHighlightColor: 'transparent',
                  touchAction: 'manipulation'
                }}
              >
                <span style={{ color: 'rgba(255, 255, 255, 0.8)' }}>{t('currency', lang)}</span>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                  <span style={{ color: 'rgba(255, 255, 255, 0.55)', fontSize: 15 }}>{preferredCurrency}</span>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </div>
              </button>

              {/* Currency Dropdown */}
              {showPreferences === 'currency' && (
                <div style={{ background: 'rgba(0, 0, 0, 0.25)' }}>
                  {[
                    'United States Dollar',
                    'Euro',
                    'British Pound',
                    'Japanese Yen',
                    'Chinese Yuan',
                    'Korean Won',
                    'Canadian Dollar',
                    'Australian Dollar',
                    'Swiss Franc',
                    'Mexican Peso'
                  ].map((currency) => (
                    <button
                      key={currency}
                      onClick={() => {
                        setPreferredCurrency(currency)
                        setShowPreferences(false)
                      }}
                      style={{
                        width: '100%',
                        padding: '14px 18px',
                        background: preferredCurrency === currency ? 'rgba(16, 185, 129, 0.12)' : 'transparent',
                        border: 'none',
                        color: preferredCurrency === currency ? '#10b981' : 'rgba(255, 255, 255, 0.75)',
                        fontSize: 15,
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        textAlign: 'left',
                        minHeight: 50,
                        WebkitTapHighlightColor: 'transparent',
                        touchAction: 'manipulation'
                      }}
                    >
                      {currency}
                      {preferredCurrency === currency && (
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                      )}
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Manage Accounts Section */}
          <div style={{ marginBottom: 28 }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 10,
              marginBottom: 14
            }}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.45)" strokeWidth="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                <path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
              <span style={{ fontSize: 13, fontWeight: 600, color: 'rgba(255, 255, 255, 0.55)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{t('accounts', lang)}</span>
            </div>

            <div style={{
              background: 'rgba(255, 255, 255, 0.03)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              padding: 16
            }}>
              <button
                onClick={() => setView("manage-wallets")}
                style={{
                  width: '100%',
                  padding: '14px 16px',
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 12,
                  color: '#fff',
                  fontSize: 14,
                  fontWeight: 500,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  transition: 'all 0.2s'
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{
                    width: 36,
                    height: 36,
                    borderRadius: 10,
                    background: 'rgba(255, 255, 255, 0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.6)" strokeWidth="2">
                      <rect x="2" y="5" width="20" height="14" rx="2"/>
                      <path d="M2 10h20"/>
                    </svg>
                  </div>
                  <span>{t('manageAccounts', lang)}</span>
                </div>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </button>
            </div>
          </div>

          {/* Address Book Section */}
          <div style={{ marginBottom: 24 }}>
            <div style={{
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              padding: 16
            }}>
              <button
                onClick={() => { setAddressBookReturnView("settings"); setView("address-book"); }}
                style={{
                  width: '100%',
                  padding: '14px 16px',
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 12,
                  color: '#fff',
                  fontSize: 14,
                  fontWeight: 500,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  transition: 'all 0.2s'
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{
                    width: 36,
                    height: 36,
                    borderRadius: 10,
                    background: 'rgba(255, 255, 255, 0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.6)" strokeWidth="2">
                      <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
                      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
                      <circle cx="12" cy="10" r="2"/>
                      <path d="M12 12c-2 0-3.5 1-3.5 2.5"/>
                    </svg>
                  </div>
                  <span>{t('addressBook', lang)}</span>
                </div>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </button>
            </div>
          </div>

          {/* Change Password Section */}
          <div style={{ marginBottom: 24 }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              marginBottom: 12
            }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0110 0v4"/>
              </svg>
              <span style={{ fontSize: 12, fontWeight: 500, color: 'rgba(255, 255, 255, 0.5)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{t('security', lang)}</span>
            </div>

            <div style={{
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              padding: 16
            }}>
              {!showChangePassword ? (
                <button
                  onClick={() => {
                    setShowChangePassword(true)
                    setCurrentPassword("")
                    setNewPassword("")
                    setConfirmNewPassword("")
                    setChangePasswordError("")
                    setChangePasswordSuccess(false)
                  }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 10,
                    color: '#fff',
                    fontSize: 13,
                    fontWeight: 500,
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: 8,
                    transition: 'all 0.2s'
                  }}
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                  </svg>
                  {t('changePassword', lang)}
                </button>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 4 }}>
                    <span style={{ fontSize: 13, fontWeight: 500, color: 'rgba(255, 255, 255, 0.9)' }}>{t('changePassword', lang)}</span>
                    <button
                      onClick={() => {
                        setShowChangePassword(false)
                        setChangePasswordError("")
                        setChangePasswordSuccess(false)
                        setCurrentPasswordVerified(false)
                        setShowCurrentPassword(false)
                        setShowNewPassword(false)
                        setShowConfirmPassword(false)
                      }}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: 'rgba(255, 255, 255, 0.5)',
                        cursor: 'pointer',
                        padding: 4
                      }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </button>
                  </div>

                  {changePasswordSuccess ? (
                    <div style={{
                      background: 'rgba(16, 185, 129, 0.1)',
                      border: '1px solid rgba(16, 185, 129, 0.2)',
                      borderRadius: 10,
                      padding: 16,
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      gap: 8
                    }}>
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                      </svg>
                      <span style={{ fontSize: 14, fontWeight: 600, color: '#10b981' }}>Password Changed!</span>
                      <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', textAlign: 'center' }}>
                        Your password has been updated successfully.
                      </span>
                    </div>
                  ) : (
                    <>
                      {/* Current Password */}
                      <div style={{ 
                        position: 'relative',
                        animation: currentPasswordShake ? 'shake 0.5s ease-in-out' : 'none'
                      }}>
                        <input
                          type={showCurrentPassword ? "text" : "password"}
                          placeholder="Current Password"
                          value={currentPassword}
                          onChange={(e) => {
                            setCurrentPassword(e.target.value)
                            setChangePasswordError("")
                            setCurrentPasswordVerified(false)
                          }}
                          onBlur={async () => {
                            if (currentPassword.length >= 6) {
                              setVerifyingCurrentPassword(true)
                              try {
                                // Verify password locally - same logic as UnlockScreen
                                const storedHash = localStorage.getItem('geovault_password_hash');
                                if (!storedHash) {
                                  setCurrentPasswordShake(true)
                                  setCurrentPassword("")
                                  setTimeout(() => setCurrentPasswordShake(false), 500)
                                  return
                                }
                                
                                // Hash the input password
                                let inputHash: string;
                                try {
                                  if (crypto.subtle) {
                                    const encoder = new TextEncoder();
                                    const data = encoder.encode(currentPassword);
                                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                                    inputHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                                  } else {
                                    inputHash = btoa(currentPassword);
                                  }
                                } catch {
                                  inputHash = btoa(currentPassword);
                                }
                                
                                if (storedHash === inputHash) {
                                  setCurrentPasswordVerified(true)
                                } else {
                                  setCurrentPasswordShake(true)
                                  setCurrentPassword("")
                                  setTimeout(() => setCurrentPasswordShake(false), 500)
                                }
                              } catch {
                                setCurrentPasswordShake(true)
                                setCurrentPassword("")
                                setTimeout(() => setCurrentPasswordShake(false), 500)
                              } finally {
                                setVerifyingCurrentPassword(false)
                              }
                            }
                          }}
                          style={{
                            width: '100%',
                            padding: '12px 40px 12px 12px',
                            background: 'rgba(0, 0, 0, 0.3)',
                            border: currentPasswordVerified 
                              ? '1px solid rgba(16, 185, 129, 0.5)' 
                              : '1px solid rgba(255, 255, 255, 0.1)',
                            borderRadius: 8,
                            color: '#fff',
                            fontSize: 13,
                            outline: 'none',
                            boxSizing: 'border-box'
                          }}
                        />
                        {/* Eye toggle & verification icons */}
                        <div style={{ position: 'absolute', right: 8, top: '50%', transform: 'translateY(-50%)', display: 'flex', alignItems: 'center', gap: 4 }}>
                          {verifyingCurrentPassword ? (
                            <div style={{
                              width: 16,
                              height: 16,
                              border: '2px solid rgba(255, 255, 255, 0.2)',
                              borderTopColor: 'rgba(255, 255, 255, 0.6)',
                              borderRadius: '50%',
                              animation: 'spin 1s linear infinite'
                            }} />
                          ) : currentPasswordVerified ? (
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2.5">
                              <polyline points="20 6 9 17 4 12"/>
                            </svg>
                          ) : null}
                          <button
                            type="button"
                            onClick={() => setShowCurrentPassword(!showCurrentPassword)}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4, display: 'flex', alignItems: 'center' }}
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2">
                              {showCurrentPassword ? (
                                <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>
                              ) : (
                                <><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>
                              )}
                            </svg>
                          </button>
                        </div>
                      </div>

                      {/* New Password */}
                      <div style={{ position: 'relative' }}>
                        <input
                          type={showNewPassword ? "text" : "password"}
                          placeholder="New Password (min 6 characters)"
                          value={newPassword}
                          onChange={(e) => {
                            setNewPassword(e.target.value)
                            setChangePasswordError("")
                          }}
                          style={{
                            width: '100%',
                            padding: '12px 40px 12px 12px',
                            background: 'rgba(0, 0, 0, 0.3)',
                            border: '1px solid rgba(255, 255, 255, 0.1)',
                            borderRadius: 8,
                            color: '#fff',
                            fontSize: 13,
                            outline: 'none',
                            boxSizing: 'border-box'
                          }}
                        />
                        <button
                          type="button"
                          onClick={() => setShowNewPassword(!showNewPassword)}
                          style={{ position: 'absolute', right: 8, top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', cursor: 'pointer', padding: 4, display: 'flex', alignItems: 'center' }}
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2">
                            {showNewPassword ? (
                              <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>
                            ) : (
                              <><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>
                            )}
                          </svg>
                        </button>
                      </div>
                      {/* Confirm New Password */}
                      <div style={{ position: 'relative' }}>
                        <input
                          type={showConfirmPassword ? "text" : "password"}
                          placeholder="Confirm New Password"
                          value={confirmNewPassword}
                          onChange={(e) => {
                            setConfirmNewPassword(e.target.value)
                            setChangePasswordError("")
                          }}
                          style={{
                            width: '100%',
                            padding: '12px 40px 12px 12px',
                            background: 'rgba(0, 0, 0, 0.3)',
                            border: confirmNewPassword && newPassword !== confirmNewPassword 
                              ? '1px solid rgba(239, 68, 68, 0.5)' 
                              : confirmNewPassword && newPassword === confirmNewPassword 
                                ? '1px solid rgba(16, 185, 129, 0.5)'
                                : '1px solid rgba(255, 255, 255, 0.1)',
                            borderRadius: 8,
                            color: '#fff',
                            fontSize: 13,
                            outline: 'none',
                            boxSizing: 'border-box'
                          }}
                        />
                        <div style={{ position: 'absolute', right: 8, top: '50%', transform: 'translateY(-50%)', display: 'flex', alignItems: 'center', gap: 4 }}>
                          {confirmNewPassword && newPassword === confirmNewPassword && (
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2.5">
                              <polyline points="20 6 9 17 4 12"/>
                            </svg>
                          )}
                          <button
                            type="button"
                            onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                            style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 4, display: 'flex', alignItems: 'center' }}
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2">
                              {showConfirmPassword ? (
                                <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>
                              ) : (
                                <><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>
                              )}
                            </svg>
                          </button>
                        </div>
                      </div>

                      {changePasswordError && (
                        <div style={{
                          background: 'rgba(239, 68, 68, 0.1)',
                          border: '1px solid rgba(239, 68, 68, 0.2)',
                          borderRadius: 8,
                          padding: '10px 12px',
                          fontSize: 12,
                          color: '#ef4444'
                        }}>
                          {changePasswordError}
                        </div>
                      )}

                      <button
                        onClick={async () => {
                          if (!currentPassword) {
                            setChangePasswordError("Please enter your current password")
                            return
                          }
                          if (!newPassword || newPassword.length < 6) {
                            setChangePasswordError("New password must be at least 6 characters")
                            return
                          }
                          if (newPassword !== confirmNewPassword) {
                            setChangePasswordError("New passwords do not match")
                            return
                          }
                          if (currentPassword === newPassword) {
                            setChangePasswordError("New password must be different from current password")
                            return
                          }

                          setIsChangingPassword(true)
                          setChangePasswordError("")

                          try {
                            // PWA: Verify old password locally and update hash
                            const oldPasswordValid = await verifyLocalPassword(currentPassword)
                            if (!oldPasswordValid) {
                              setChangePasswordError("Current password is incorrect")
                              setIsChangingPassword(false)
                              return
                            }
                            
                            // Update password hash locally
                            await savePasswordHash(newPassword)
                            
                            // Also update on server if possible
                            try {
                              await setServerPassword(genesisPublicKey, newPassword)
                            } catch (e) {
                              console.warn('[PWA] Failed to update server password:', e)
                            }

                            setChangePasswordSuccess(true)
                            setCurrentPassword("")
                            setNewPassword("")
                            setConfirmNewPassword("")
                            // Auto-close after success
                            setTimeout(() => {
                              setShowChangePassword(false)
                              setChangePasswordSuccess(false)
                            }, 2500)
                          } catch (error: any) {
                            setChangePasswordError(error.message || "An error occurred")
                          } finally {
                            setIsChangingPassword(false)
                          }
                        }}
                        disabled={isChangingPassword || !currentPassword || !newPassword || !confirmNewPassword}
                        style={{
                          width: '100%',
                          padding: '12px',
                          background: isChangingPassword || !currentPassword || !newPassword || !confirmNewPassword 
                            ? 'rgba(255, 255, 255, 0.05)' 
                            : 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                          border: 'none',
                          borderRadius: 10,
                          color: isChangingPassword || !currentPassword || !newPassword || !confirmNewPassword 
                            ? 'rgba(255, 255, 255, 0.3)' 
                            : '#fff',
                          fontSize: 13,
                          fontWeight: 600,
                          cursor: isChangingPassword || !currentPassword || !newPassword || !confirmNewPassword 
                            ? 'not-allowed' 
                            : 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: 8,
                          transition: 'all 0.2s'
                        }}
                      >
                        {isChangingPassword ? (
                          <>
                            <div style={{
                              width: 14,
                              height: 14,
                              border: '2px solid rgba(255, 255, 255, 0.3)',
                              borderTopColor: '#fff',
                              borderRadius: '50%',
                              animation: 'spin 1s linear infinite'
                            }} />
                            Updating...
                          </>
                        ) : (
                          'Update Password'
                        )}
                      </button>
                    </>
                  )}
                </div>
              )}

              {/* Voice Unlock - Always tied to genesis wallet (index 0), shown regardless of which wallet is active */}
              {FEATURES.VOICE_UNLOCK_LAYER ? (
                walletAccounts[0] && (
                <div style={{ 
                  borderTop: '1px solid rgba(255, 255, 255, 0.06)',
                  marginTop: 16,
                  paddingTop: 16
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: showVoiceSetup ? 16 : 0 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                      <div style={{
                        width: 32,
                        height: 32,
                        borderRadius: 8,
                        background: voiceUnlockEnabled ? 'rgba(34, 197, 94, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={voiceUnlockEnabled ? '#22c55e' : 'rgba(255, 255, 255, 0.5)'} strokeWidth="2">
                          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                          <line x1="12" y1="19" x2="12" y2="23"/>
                          <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                      </div>
                      <div>
                        <div style={{ fontSize: 13, fontWeight: 500, color: '#fff' }}>Voice Unlock</div>
                        <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)' }}>
                          {voiceUnlockEnabled ? 'Enabled' : 'Unlock with your voice'}
                        </div>
                      </div>
                    </div>
                  
                  {!showVoiceSetup && (
                    <button
                      onClick={async () => {
                        if (voiceUnlockEnabled) {
                          setConfirmPassword("")
                          setConfirmPasswordError("")
                          setConfirmModal({
                            show: true,
                            title: 'Disable Voice Unlock',
                            message: 'Enter your password to disable voice unlock.',
                            confirmText: 'Disable',
                            danger: true,
                            requirePassword: true,
                            onConfirm: async (password?: string) => {
                              if (!password) {
                                setConfirmPasswordError('Password required')
                                return
                              }
                              try {
                                await disableVoiceAuth(genesisPublicKey, password)
                                setVoiceUnlockEnabled(false)
                                setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                                setStatus('Voice unlock disabled')
                              } catch (e: any) {
                                setConfirmPasswordError(e.message || 'Failed to disable')
                              }
                            }
                          })
                        } else {
                          setConfirmPassword("")
                          setConfirmPasswordError("")
                          setConfirmModal({
                            show: true,
                            title: 'Enable Voice Unlock',
                            message: 'Enter your password to set up voice unlock. You can always use your password as a backup.',
                            confirmText: 'Continue',
                            danger: false,
                            requirePassword: true,
                            onConfirm: async (password?: string) => {
                              console.log('[Voice Setup] onConfirm called with password:', !!password)
                              if (!password) {
                                setConfirmPasswordError('Password required')
                                return
                              }
                              try {
                                console.log('[Voice Setup] Verifying password locally...')
                                // Verify password locally - same logic as UnlockScreen
                                const storedHash = localStorage.getItem('geovault_password_hash');
                                if (!storedHash) {
                                  setConfirmPasswordError('No password set')
                                  return
                                }
                                
                                // Hash the input password
                                let inputHash: string;
                                try {
                                  if (crypto.subtle) {
                                    const encoder = new TextEncoder();
                                    const data = encoder.encode(password);
                                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                                    inputHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                                  } else {
                                    inputHash = btoa(password);
                                  }
                                } catch {
                                  inputHash = btoa(password);
                                }
                                
                                if (storedHash !== inputHash) {
                                  setConfirmPasswordError('Incorrect password')
                                  return
                                }
                                
                                console.log('[Voice Setup] Password verified, opening voice recording window...')
                                setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                                
                                // Open the voice recording window - use genesis wallet
                                const enrollResult = await startVoiceEnrollment(genesisPublicKey)
                                
                                if (enrollResult.success && enrollResult.fingerprint) {
                                  // Save the voice fingerprint to server using API
                                  console.log('[Voice Setup] Saving fingerprint to server...')
                                  try {
                                    await enrollVoiceFingerprint(genesisPublicKey, enrollResult.fingerprint)
                                    setVoiceUnlockEnabled(true)
                                    console.log('[Voice Setup] Voice enrollment complete!')
                                    setStatus('Voice unlock enabled!')
                                  } catch (saveErr: any) {
                                    console.error('[Voice Setup] Failed to save fingerprint:', saveErr)
                                    alert('Failed to save voice fingerprint: ' + (saveErr.message || 'Unknown error'))
                                  }
                                } else {
                                  console.error('[Voice Setup] Enrollment failed:', enrollResult.error)
                                  // Show error to user if needed
                                }
                              } catch (err: any) {
                                console.error('[Voice Setup] Error:', err)
                                setConfirmPasswordError(err.message || 'An error occurred')
                              }
                            }
                          })
                        }
                      }}
                      style={{
                        padding: '6px 12px',
                        background: voiceUnlockEnabled ? 'rgba(239, 68, 68, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                        border: voiceUnlockEnabled ? '1px solid rgba(239, 68, 68, 0.2)' : '1px solid rgba(255, 255, 255, 0.1)',
                        borderRadius: 8,
                        color: voiceUnlockEnabled ? '#ef4444' : 'rgba(255, 255, 255, 0.7)',
                        fontSize: 11,
                        fontWeight: 500,
                        cursor: 'pointer'
                      }}
                    >
                      {voiceUnlockEnabled ? 'Disable' : 'Set Up'}
                    </button>
                  )}
                </div>
              </div>
              )
              ) : (
                <ComingSoonLayerRow 
                  icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                  </svg>}
                  title="Voice Unlock"
                  subtitle="Unlock wallet with your voice"
                />
              )}
            </div>
          </div>

          {/* Voice Setup Full-Screen Modal */}
          {FEATURES.VOICE_UNLOCK_LAYER && showVoiceSetup && (
            <>
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: '#0a0a0f',
                zIndex: 3000,
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
              }}>
                {/* Globe Background */}
                <div style={{
                  position: 'absolute',
                  top: '50%',
                  left: '50%',
                  transform: 'translate(-50%, -50%)',
                  width: 400,
                  height: 400,
                  opacity: 0.15,
                  pointerEvents: 'none'
                }}>
                  <Globe />
                </div>

                {/* Header */}
                <div style={{
                  padding: '16px 20px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  borderBottom: '1px solid rgba(255, 255, 255, 0.06)',
                  position: 'relative',
                  zIndex: 1
                }}>
                  <button
                    onClick={() => {
                      setShowVoiceSetup(false)
                      setVoiceSetupStep(0)
                      setVoiceSamplesCollected([false, false, false])
                      setVoiceSetupError('')
                      setVoiceSetupStatus('')
                    }}
                    style={{
                      background: 'none',
                      border: 'none',
                      color: 'rgba(255, 255, 255, 0.6)',
                      cursor: 'pointer',
                      padding: 4,
                      display: 'flex',
                      alignItems: 'center',
                      gap: 6,
                      fontSize: 13
                    }}
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back
                  </button>
                  <span style={{ fontSize: 14, fontWeight: 600, color: '#fff' }}>Voice Unlock</span>
                  <div style={{ width: 50 }} />
                </div>

                {/* Main Content */}
                <div style={{
                  flex: 1,
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '20px',
                  position: 'relative',
                  zIndex: 1
                }}>
                  {/* Progress Steps */}
                  <div style={{ 
                    display: 'flex', 
                    gap: 8, 
                    marginBottom: 40,
                    width: '80%',
                    maxWidth: 200
                  }}>
                    {[0, 1, 2].map((i) => (
                      <div
                        key={i}
                        style={{
                          flex: 1,
                          height: 4,
                          borderRadius: 2,
                          background: voiceSamplesCollected[i] 
                            ? '#22c55e' 
                            : i === voiceSetupStep 
                              ? 'rgba(34, 197, 94, 0.5)' 
                              : 'rgba(255, 255, 255, 0.1)',
                          transition: 'all 0.3s ease'
                        }}
                      />
                    ))}
                  </div>

                  {/* Step Indicator */}
                  <div style={{ 
                    fontSize: 13, 
                    color: 'rgba(255, 255, 255, 0.4)', 
                    marginBottom: 8,
                    textTransform: 'uppercase',
                    letterSpacing: '1px'
                  }}>
                    Sample {voiceSetupStep + 1} of 3
                  </div>

                  {/* Instruction */}
                  <div style={{ 
                    fontSize: 16, 
                    color: 'rgba(255, 255, 255, 0.7)', 
                    marginBottom: 40,
                    textAlign: 'center'
                  }}>
                    Say: <strong style={{ color: '#fff' }}>"Argus secure my wallet"</strong>
                  </div>

                  {/* Waveform Visualizer */}
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    gap: 4,
                    height: 80,
                    marginBottom: 30,
                    opacity: isRecordingVoice ? 1 : 0.3,
                    transition: 'opacity 0.3s ease'
                  }}>
                    {[0.4, 0.6, 0.8, 0.5, 0.9, 0.7, 0.5, 0.8, 0.6, 0.7, 0.5, 0.6, 0.8, 0.4, 0.7, 0.5, 0.9, 0.6].map((h, i) => (
                      <div
                        key={i}
                        style={{
                          width: 4,
                          borderRadius: 2,
                          background: isRecordingVoice 
                            ? 'linear-gradient(to top, #22c55e, #4ade80)' 
                            : 'rgba(255, 255, 255, 0.2)',
                          height: isRecordingVoice ? '60%' : '30%',
                          minHeight: 8,
                          animation: isRecordingVoice 
                            ? `voiceWave ${0.3 + (i % 5) * 0.08}s ease-in-out infinite alternate` 
                            : 'none',
                          animationDelay: `${i * 0.04}s`
                        }}
                      />
                    ))}
                  </div>

                  <style>{`
                    @keyframes voiceWave {
                      0% { transform: scaleY(0.3); }
                      100% { transform: scaleY(1); }
                    }
                    @keyframes pulse-ring {
                      0% { transform: scale(0.8); opacity: 0.5; }
                      100% { transform: scale(1.2); opacity: 0; }
                    }
                  `}</style>

                  {/* Record Button */}
                  <div style={{ position: 'relative', marginBottom: 30 }}>
                    {isRecordingVoice && (
                      <div style={{
                        position: 'absolute',
                        top: '50%',
                        left: '50%',
                        transform: 'translate(-50%, -50%)',
                        width: 120,
                        height: 120,
                        borderRadius: '50%',
                        border: '2px solid rgba(34, 197, 94, 0.3)',
                        animation: 'pulse-ring 1.5s ease-out infinite'
                      }} />
                    )}
                    <button
                      onClick={async () => {
                        if (isRecordingVoice) return
                        
                        setIsRecordingVoice(true)
                        setVoiceSetupError('')
                        setVoiceSetupStatus('Listening...')
                        
                        try {
                          const result = await enrollVoiceSample(voiceSetupStep)
                          
                          if (result.success) {
                            if (result.isPassphraseMatch) {
                              const newSamples = [...voiceSamplesCollected]
                              newSamples[voiceSetupStep] = true
                              setVoiceSamplesCollected(newSamples)
                              setVoiceSetupStatus(' Sample recorded!')
                              
                              if (voiceSetupStep < 2) {
                                setTimeout(() => {
                                  setVoiceSetupStep(voiceSetupStep + 1)
                                  setVoiceSetupStatus('')
                                }, 1200)
                              } else {
                                setVoiceSetupStatus('Finalizing voice profile...')
                                const enrollResult = await completeVoiceEnrollment(genesisPublicKey)
                                
                                if (enrollResult.success && enrollResult.fingerprint) {
                                  await enrollVoiceFingerprint(genesisPublicKey, enrollResult.fingerprint)
                                  setVoiceUnlockEnabled(true)
                                  setShowVoiceSetup(false)
                                  setStatus('Voice unlock enabled!')
                                } else {
                                  setVoiceSetupError(enrollResult.error || 'Failed to create voice profile')
                                }
                              }
                            } else {
                              setVoiceSetupError('Please say the exact phrase clearly')
                              setVoiceSetupStatus('')
                            }
                          } else {
                            setVoiceSetupError(result.error || 'Recording failed')
                            setVoiceSetupStatus('')
                          }
                        } catch (e: any) {
                          console.error('[Voice] Recording error:', e)
                          setVoiceSetupError(e.message || 'Microphone access denied')
                          setVoiceSetupStatus('')
                        } finally {
                          setIsRecordingVoice(false)
                        }
                      }}
                      disabled={isRecordingVoice}
                      style={{
                        width: 100,
                        height: 100,
                        borderRadius: '50%',
                        background: isRecordingVoice 
                          ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.05))' 
                          : 'rgba(255, 255, 255, 0.03)',
                        border: isRecordingVoice 
                          ? '2px solid rgba(34, 197, 94, 0.5)' 
                          : '2px solid rgba(255, 255, 255, 0.1)',
                        cursor: isRecordingVoice ? 'default' : 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.3s ease',
                        position: 'relative',
                        zIndex: 1
                      }}
                    >
                      <svg 
                        width="40" 
                        height="40" 
                        viewBox="0 0 24 24" 
                        fill="none" 
                        stroke={isRecordingVoice ? '#22c55e' : 'rgba(255, 255, 255, 0.5)'} 
                        strokeWidth="1.5"
                      >
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                      </svg>
                    </button>
                  </div>

                  {/* Status / Instructions */}
                  <div style={{ height: 40, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                    {voiceSetupStatus ? (
                      <div style={{ 
                        fontSize: 14, 
                        color: voiceSetupStatus.includes('') ? '#22c55e' : 'rgba(255, 255, 255, 0.6)',
                        fontWeight: 500
                      }}>
                        {voiceSetupStatus}
                      </div>
                    ) : voiceSetupError ? (
                      <div style={{ fontSize: 13, color: '#ef4444' }}>
                        {voiceSetupError}
                      </div>
                    ) : (
                      <div style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.4)' }}>
                        Tap the microphone to start recording
                      </div>
                    )}
                  </div>
                </div>

                {/* Footer Info */}
                <div style={{
                  padding: '16px 20px',
                  borderTop: '1px solid rgba(255, 255, 255, 0.06)',
                  textAlign: 'center',
                  position: 'relative',
                  zIndex: 1
                }}>
                  <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.3)', lineHeight: 1.5 }}>
                    Your voice is encrypted and stored securely.<br/>
                    You can always use your password as a backup.
                  </div>
                </div>
              </div>
            </>
          )}

          {/* Security Section */}
          <div style={{
            marginBottom: 24
          }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              marginBottom: 12
            }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              <span style={{ fontSize: 12, fontWeight: 500, color: 'rgba(255, 255, 255, 0.5)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{t('security', lang)}</span>
            </div>

            {/* Private Key Card */}
            <div style={{
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              padding: 16,
              marginBottom: 12
            }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.6)" strokeWidth="2">
                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                  </svg>
                  <span style={{ fontSize: 13, fontWeight: 500, color: 'rgba(255, 255, 255, 0.9)' }}>{t('privateKey', lang)}</span>
                </div>
                <span style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.4)', fontWeight: 500 }}>BASE58</span>
              </div>

              {showPrivateKey ? (
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 10,
                  padding: 12,
                  marginBottom: 12,
                  wordBreak: 'break-all',
                  fontSize: 11,
                  color: 'rgba(255, 255, 255, 0.8)',
                  fontFamily: 'monospace',
                  lineHeight: 1.5
                }}>
                  {genesisKeypair ? bs58.encode(genesisKeypair.secretKey) : ''}
                </div>
              ) : (
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 10,
                  padding: 12,
                  marginBottom: 12,
                  position: 'relative',
                  overflow: 'hidden'
                }}>
                  <SecretParticles height={35} />
                  <div style={{ 
                    fontSize: 11, 
                    color: 'rgba(255, 255, 255, 0.15)',
                    filter: 'blur(4px)',
                    fontFamily: 'monospace',
                    userSelect: 'none',
                    position: 'relative',
                    zIndex: 0
                  }}>
                    5Maik9GdeRKNUfZFFxYfJhzXdY7J...
                  </div>
                </div>
              )}

              <div style={{ display: 'flex', gap: 8 }}>
                <button 
                  style={{
                    flex: 1,
                    padding: '10px 16px',
                    background: showPrivateKey ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 10,
                    color: '#fff',
                    fontSize: 12,
                    fontWeight: 600,
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                  onClick={() => {
                    if (showPrivateKey) {
                      setShowPrivateKey(false)
                    } else {
                      setConfirmPassword("")
                      setConfirmPasswordError("")
                      setConfirmModal({
                        show: true,
                        title: t('revealPrivateKey', lang),
                        message: 'Enter your password to reveal your private key.',
                        confirmText: t('reveal', lang),
                        danger: false,
                        requirePassword: true,
                        onConfirm: async (password?: string) => {
                          if (!password) {
                            setConfirmPasswordError(t('passwordRequired', lang))
                            return
                          }
                          try {
                            // PWA: Verify password locally first, fall back to server
                            const localValid = await verifyLocalPassword(password)
                            if (localValid) {
                              setShowPrivateKey(true)
                              setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                            } else {
                              // Try server verification as fallback
                              const serverResult = await verifyServerPassword(genesisPublicKey, password)
                              if (serverResult.success) {
                                setShowPrivateKey(true)
                                setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                              } else {
                                setConfirmPasswordError(t('incorrectPassword', lang))
                              }
                            }
                          } catch (error) {
                            setConfirmPasswordError(t('incorrectPassword', lang))
                          }
                        }
                      })
                    }
                  }}
                >
                  {showPrivateKey ? t('hideKey', lang) : t('revealKey', lang)}
                </button>
                {showPrivateKey && (
                  <button 
                    style={{
                      padding: '10px 16px',
                      background: copiedKey ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 255, 255, 0.1)',
                      border: copiedKey ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 10,
                      color: copiedKey ? '#10b981' : '#fff',
                      fontSize: 12,
                      fontWeight: 600,
                      cursor: 'pointer',
                      transition: 'all 0.2s',
                      display: 'flex',
                      alignItems: 'center',
                      gap: 6
                    }}
                    onClick={() => copyToClipboard(genesisKeypair ? bs58.encode(genesisKeypair.secretKey) : '', 'key')}
                  >
                    {copiedKey ? (
                      <>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        {t('copied', lang)}
                      </>
                    ) : (
                      <>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                          <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                        </svg>
                        {t('copy', lang)}
                      </>
                    )}
                  </button>
                )}
              </div>
            </div>

            {/* Seed Phrase Card */}
            <div style={{
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              padding: 16
            }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0110 0v4"/>
                  </svg>
                  <span style={{ fontSize: 13, fontWeight: 500, color: 'rgba(255, 255, 255, 0.9)' }}>{t('recoveryPhrase', lang)}</span>
                </div>
                <span style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.3)', fontWeight: 500 }}>12 {t('words', lang).toUpperCase()}</span>
              </div>

              {showSeedPhrase && seedPhrase ? (
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 12,
                  padding: 12,
                  marginBottom: 12
                }}>
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(3, 1fr)',
                    gap: 8
                  }}>
                    {seedPhrase.split(' ').map((word, i) => (
                      <div key={i} style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 6,
                        padding: '6px 8px',
                        background: 'rgba(255, 255, 255, 0.03)',
                        borderRadius: 6,
                        fontSize: 11
                      }}>
                        <span style={{ color: 'rgba(255, 255, 255, 0.3)', fontWeight: 500, minWidth: 16 }}>{i + 1}.</span>
                        <span style={{ color: 'rgba(255, 255, 255, 0.9)' }}>{word}</span>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 12,
                  padding: 16,
                  marginBottom: 12,
                  textAlign: 'center',
                  position: 'relative',
                  overflow: 'hidden'
                }}>
                  <SecretParticles height={45} />
                  <div style={{ 
                    fontSize: 12, 
                    color: 'rgba(255, 255, 255, 0.15)',
                    filter: 'blur(4px)',
                    userSelect: 'none',
                    position: 'relative',
                    zIndex: 0
                  }}>
                    word word word word word word word word word word word word
                  </div>
                </div>
              )}

              <div style={{ display: 'flex', gap: 8 }}>
                <button 
                  style={{
                    flex: 1,
                    padding: '10px 16px',
                    background: showSeedPhrase ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.1)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 10,
                    color: '#fff',
                    fontSize: 12,
                    fontWeight: 600,
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                  onClick={() => {
                    if (showSeedPhrase) {
                      setShowSeedPhrase(false)
                      setSeedPhrase("")
                    } else {
                      setConfirmPassword("")
                      setConfirmPasswordError("")
                      setConfirmModal({
                        show: true,
                        title: t('revealRecoveryPhrase', lang),
                        message: 'Enter your password to reveal your recovery phrase.',
                        confirmText: t('reveal', lang),
                        danger: false,
                        requirePassword: true,
                        onConfirm: async (password?: string) => {
                          if (!password) {
                            setConfirmPasswordError(t('passwordRequired', lang))
                            return
                          }
                          try {
                            // PWA: Verify password locally first, fall back to server
                            const localValid = await verifyLocalPassword(password)
                            if (localValid) {
                              fetchSeedPhrase()
                              setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                              setConfirmPassword("")
                              setConfirmPasswordError("")
                            } else {
                              // Try server verification as fallback
                              const serverResult = await verifyServerPassword(genesisPublicKey, password)
                              if (serverResult.success) {
                                fetchSeedPhrase()
                                setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                                setConfirmPassword("")
                                setConfirmPasswordError("")
                              } else {
                                setConfirmPasswordError(t('incorrectPassword', lang))
                              }
                            }
                          } catch (e) {
                            setConfirmPasswordError(t('incorrectPassword', lang))
                          }
                        }
                      })
                    }
                  }}
                >
                  {showSeedPhrase ? t('hidePhrase', lang) : t('revealPhrase', lang)}
                </button>
                {showSeedPhrase && seedPhrase && (
                  <button 
                    style={{
                      padding: '10px 16px',
                      background: copiedSeed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 255, 255, 0.1)',
                      border: copiedSeed ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 10,
                      color: copiedSeed ? '#10b981' : '#fff',
                      fontSize: 12,
                      fontWeight: 600,
                      cursor: 'pointer',
                      transition: 'all 0.2s',
                      display: 'flex',
                      alignItems: 'center',
                      gap: 6
                    }}
                    onClick={() => copyToClipboard(seedPhrase, 'seed')}
                  >
                    {copiedSeed ? (
                      <>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        {t('copied', lang)}
                      </>
                    ) : (
                      <>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                          <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                        </svg>
                        {t('copy', lang)}
                      </>
                    )}
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* Network Section */}
          <div style={{ marginBottom: 24 }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              marginBottom: 12
            }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="2" y1="12" x2="22" y2="12"/>
                <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>
              </svg>
              <span style={{ fontSize: 12, fontWeight: 500, color: 'rgba(255, 255, 255, 0.5)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{t('network', lang)}</span>
            </div>

            <div style={{
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              padding: 16,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <div style={{
                  width: 40,
                  height: 40,
                  borderRadius: 12,
                  background: 'rgba(255, 255, 255, 0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <img 
                    src="https://assets.coingecko.com/coins/images/4128/standard/solana.png"
                    style={{ width: 24, height: 24, borderRadius: 6 }}
                    alt="SOL"
                  />
                </div>
                <div>
                  <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>{t('solanaMainnet', lang)}</div>
                  <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)' }}>mainnet-beta.solana.com</div>
                </div>
              </div>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: 6
              }}>
                <div style={{ width: 6, height: 6, borderRadius: 3, background: '#10b981' }}></div>
                <span style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>{t('connected', lang)}</span>
              </div>
            </div>
          </div>

          {/* ARGUS Vault Section */}
          <div style={{ marginBottom: 24 }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              marginBottom: 12
            }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2">
                <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
              </svg>
              <span style={{ fontSize: 12, fontWeight: 500, color: 'rgba(255, 255, 255, 0.5)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{t('geoArgusVault', lang)}</span>
            </div>

            <div style={{
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              padding: 16
            }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{
                    width: 40,
                    height: 40,
                    borderRadius: 12,
                    background: 'rgba(255, 255, 255, 0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" strokeWidth="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                      <path d="M7 11V7a5 5 0 0110 0v4"/>
                    </svg>
                  </div>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>
                      {multisigPda ? t('vaultActive', lang) : t('notConfigured', lang)}
                    </div>
                    {multisigPda && (
                      <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)', fontFamily: 'monospace' }}>
                        {multisigPda.slice(0, 8)}...{multisigPda.slice(-6)}
                      </div>
                    )}
                  </div>
                </div>
                <span style={{
                  fontSize: 11,
                  color: 'rgba(255, 255, 255, 0.4)',
                  fontWeight: 500
                }}>
                  {multisigPda ? t('active', lang) : t('vaultInactive', lang)}
                </span>
              </div>
            </div>
          </div>

          {/* Danger Zone */}
          <div style={{ marginBottom: 24 }}>
            <div style={{
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              padding: 16
            }}>
              <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 12, lineHeight: 1.5 }}>
                {t('backupWarning', lang)}
              </div>
              <button 
                style={{
                  width: '100%',
                  padding: '12px 16px',
                  background: 'transparent',
                  border: '1px solid rgba(239, 68, 68, 0.3)',
                  borderRadius: 10,
                  color: '#ef4444',
                  fontSize: 12,
                  fontWeight: 500,
                  cursor: 'pointer',
                  transition: 'all 0.2s',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: 8
                }}
                onClick={() => {
                  setConfirmModal({
                    show: true,
                    title: t('deleteAllData', lang),
                    message: t('deleteWarning', lang),
                    confirmText: t('deleteEverything', lang),
                    danger: true,
                    onConfirm: () => {
                      // Clear all wallet data
                      setStoredSecret("")
                      setStoredAccounts([])
                      setMultisigPda("")
                      setVaultPda("")
                      setWalletAccounts([])
                      setWallet(null)
                      setMnemonic("")
                      // Clear localStorage
                      localStorage.clear()
                      // Reload to show welcome screen
                      window.location.reload()
                    }
                  })
                }}
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                  <line x1="10" y1="11" x2="10" y2="17"/>
                  <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
                {t('resetWallet', lang)} ({t('deleteAllData', lang)})
              </button>
            </div>
          </div>

          {/* About */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.02)',
            border: '1px solid rgba(255, 255, 255, 0.06)',
            borderRadius: 16,
            padding: 20,
            textAlign: 'center'
          }}>
            <div style={{
              width: 48,
              height: 48,
              borderRadius: 12,
              background: 'rgba(255, 255, 255, 0.05)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              margin: '0 auto 12px auto'
            }}>
              <img 
                src={getAssetUrl("assets/arguslogo.png")}
                style={{ width: 28, height: 28, borderRadius: 6 }}
                alt="ARGUS-1"
              />
            </div>
            <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 4 }}>ARGUS-1</div>
            <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)' }}>Version 1.2.3  Squads V4</div>
          </div>
        </div>

        {/* Link Seed Phrase Modal */}
        {showLinkSeedModal && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.9)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: 20
          }}>
            <div style={{
              background: 'linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%)',
              borderRadius: 20,
              padding: 24,
              width: '100%',
              maxWidth: 340,
              border: '1px solid rgba(255, 255, 255, 0.1)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20 }}>
                <h3 style={{ margin: 0, fontSize: 18, fontWeight: 600, color: '#fff' }}>Link Recovery Phrase</h3>
                <button
                  onClick={() => {
                    setShowLinkSeedModal(false)
                    setLinkSeedInput("")
                    setLinkSeedPassword("")
                  }}
                  style={{
                    background: 'none',
                    border: 'none',
                    color: 'rgba(255, 255, 255, 0.5)',
                    fontSize: 20,
                    cursor: 'pointer'
                  }}
                >
                  
                </button>
              </div>

              <div style={{
                background: 'rgba(245, 158, 11, 0.1)',
                border: '1px solid rgba(245, 158, 11, 0.2)',
                borderRadius: 12,
                padding: 12,
                marginBottom: 20,
                fontSize: 12,
                color: '#f59e0b',
                lineHeight: 1.5
              }}>
                <strong> Important:</strong> Your wallet was created before seed phrase storage was implemented. Enter your backed-up 12-word recovery phrase to enable wallet derivation features.
              </div>

              <div style={{ marginBottom: 16 }}>
                <label style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.6)', marginBottom: 8, display: 'block' }}>
                  Recovery Phrase (12 words)
                </label>
                <textarea
                  value={linkSeedInput}
                  onChange={(e) => setLinkSeedInput(e.target.value)}
                  placeholder="Enter your 12-word recovery phrase..."
                  style={{
                    width: '100%',
                    padding: 12,
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 10,
                    color: '#fff',
                    fontSize: 13,
                    resize: 'none',
                    height: 80,
                    fontFamily: 'monospace'
                  }}
                />
              </div>

              <div style={{ marginBottom: 20 }}>
                <label style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.6)', marginBottom: 8, display: 'block' }}>
                  Wallet Password
                </label>
                <input
                  type="password"
                  value={linkSeedPassword}
                  onChange={(e) => setLinkSeedPassword(e.target.value)}
                  placeholder="Enter your wallet password"
                  style={{
                    width: '100%',
                    padding: 12,
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 10,
                    color: '#fff',
                    fontSize: 13
                  }}
                />
              </div>

              <button
                onClick={handleLinkSeedPhrase}
                disabled={isLinkingSeed || !linkSeedInput.trim() || !linkSeedPassword}
                style={{
                  width: '100%',
                  padding: '14px 20px',
                  background: isLinkingSeed || !linkSeedInput.trim() || !linkSeedPassword
                    ? 'rgba(255, 255, 255, 0.1)'
                    : 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)',
                  border: 'none',
                  borderRadius: 12,
                  color: '#fff',
                  fontSize: 14,
                  fontWeight: 600,
                  cursor: isLinkingSeed || !linkSeedInput.trim() || !linkSeedPassword ? 'not-allowed' : 'pointer',
                  transition: 'all 0.2s'
                }}
              >
                {isLinkingSeed ? "Linking..." : "Link Seed Phrase"}
              </button>
            </div>
          </div>
        )}
      </div>
    )
  }

  // Manage Wallets View
  if (view === "manage-wallets") {
    // If no wallets exist, show the onboarding/create wallet modal automatically
    const noWalletsExist = walletAccounts.length === 0;
    
    return (
      <div style={containerStyle}>
        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '16px 20px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
        }}>
          {noWalletsExist ? (
            <div style={{ width: 26 }} /> // Spacer when no back button
          ) : (
            <button 
              onClick={() => setView("main")}
              style={{ 
                background: 'none', 
                border: 'none', 
                color: 'rgba(255, 255, 255, 0.7)', 
                cursor: 'pointer', 
                fontSize: 18,
                padding: 4
              }}
            >
              
            </button>
          )}
          <h3 style={{ 
            margin: 0, 
            fontSize: 16, 
            fontWeight: 600,
            color: '#fff'
          }}>Manage Accounts</h3>
          <button 
            onClick={() => {
              setShowAddWalletModal(true)
            }}
            style={{ 
              background: 'none', 
              border: 'none', 
              color: 'rgba(255, 255, 255, 0.7)', 
              cursor: 'pointer', 
              fontSize: 20,
              padding: 4
            }}
          >
            +
          </button>
        </div>

        {/* Wallet List */}
        <div style={{ padding: '12px 16px', flex: 1, overflowY: 'auto' }}>
          {walletAccounts.filter(acc => acc && acc.publicKey).map((account, index) => (
            <button
              key={account.publicKey || index}
              onClick={() => {
                setEditingWallet(account)
                setEditWalletName(account.name)
                setShowEditPrivateKey(false)
                setShowSeedPhrase(false)
                setSeedPhrase("")
                setIsEditingName(false)
                setView("edit-wallet")
              }}
              style={{
                width: '100%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '16px',
                background: 'rgba(255, 255, 255, 0.03)',
                border: '1px solid rgba(255, 255, 255, 0.06)',
                borderRadius: 12,
                marginBottom: 8,
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <div style={{
                  width: 40,
                  height: 40,
                  borderRadius: '50%',
                  overflow: 'hidden',
                  border: index === activeAccountIndex 
                    ? '2px solid #10b981'
                    : '2px solid transparent',
                  boxSizing: 'content-box',
                  flexShrink: 0,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  position: 'relative'
                }}>
                  <PlanetAvatar seed={account.publicKey || ''} size={40} />
                  {account.isWatchOnly && (
                    <div style={{
                      position: 'absolute',
                      inset: 0,
                      background: 'rgba(0, 0, 0, 0.35)',
                      borderRadius: '50%',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" strokeWidth="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                        <circle cx="12" cy="12" r="3" />
                      </svg>
                    </div>
                  )}
                </div>
                <div style={{ textAlign: 'left' }}>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#fff' }}>{account.name}</div>
                  <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                    {account.publicKey?.slice(0, 4) || '????'}...{account.publicKey?.slice(-4) || '????'}
                  </div>
                </div>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                {index === activeAccountIndex && (
                  <div style={{
                    width: 8,
                    height: 8,
                    borderRadius: 4,
                    background: '#10b981'
                  }} />
                )}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2">
                  <circle cx="12" cy="12" r="1"/>
                  <circle cx="12" cy="5" r="1"/>
                  <circle cx="12" cy="19" r="1"/>
                </svg>
              </div>
            </button>
          ))}
          
          {/* Welcome screen for new users with no wallets */}
          {noWalletsExist && (
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '60px 24px',
              textAlign: 'center'
            }}>
              <img 
                src="/assets/arguslogo.png" 
                alt="ARGUS" 
                style={{ width: 80, height: 80, marginBottom: 24, borderRadius: 20 }}
              />
              <h2 style={{ 
                fontSize: 24, 
                fontWeight: 700, 
                color: '#fff', 
                marginBottom: 12 
              }}>
                Welcome to GeoVault
              </h2>
              <p style={{ 
                fontSize: 14, 
                color: 'rgba(255, 255, 255, 0.5)', 
                marginBottom: 32,
                lineHeight: 1.6,
                maxWidth: 280
              }}>
                The most secure mobile wallet with geo-fencing, voice authentication, and multi-layer security.
              </p>
              <button
                onClick={() => setShowAddWalletModal(true)}
                style={{
                  width: '100%',
                  maxWidth: 280,
                  padding: '16px 24px',
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  border: 'none',
                  borderRadius: 14,
                  color: '#fff',
                  fontSize: 16,
                  fontWeight: 600,
                  cursor: 'pointer',
                  marginBottom: 12
                }}
              >
                Create New Wallet
              </button>
              <button
                onClick={() => {
                  setShowAddWalletModal(true);
                  setAddWalletView('import');
                }}
                style={{
                  width: '100%',
                  maxWidth: 280,
                  padding: '14px 24px',
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 14,
                  color: 'rgba(255, 255, 255, 0.8)',
                  fontSize: 14,
                  fontWeight: 500,
                  cursor: 'pointer'
                }}
              >
                Import Existing Wallet
              </button>
            </div>
          )}
        </div>

        {/* Add Account Button - only show if wallets exist */}
        {!noWalletsExist && (
          <div style={{ padding: '16px' }}>
            <button
              onClick={() => setShowAddWalletModal(true)}
              style={{
                width: '100%',
                padding: '16px',
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.1)',
                borderRadius: 12,
                color: '#fff',
                fontSize: 14,
                fontWeight: 500,
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
            >
              Add Account
            </button>
          </div>
        )}

        {/* Add Wallet Modal - for manage-wallets view */}
        {showAddWalletModal && (
          <>
            {/* Modal Backdrop */}
            <div 
              onClick={closeAddWalletModal}
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.8)',
                backdropFilter: 'blur(8px)',
                zIndex: 2000,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}
            >
              {/* Modal Content */}
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  width: 320,
                  background: '#131318',
                  borderRadius: 16,
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  overflow: 'hidden',
                  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.9)'
                }}
              >
                {/* Modal Header */}
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  padding: '20px 20px 16px 20px',
                  borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    {addWalletView !== 'menu' && (
                      <button
                        onClick={() => {
                          setAddWalletView('menu')
                          setImportInput('')
                          setNewWalletName('')
                          setStatus('')
                        }}
                        style={{
                          background: 'none',
                          border: 'none',
                          color: 'rgba(255, 255, 255, 0.5)',
                          cursor: 'pointer',
                          padding: 4,
                          display: 'flex',
                          alignItems: 'center'
                        }}
                      >
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M15 18l-6-6 6-6" />
                        </svg>
                      </button>
                    )}
                    <span style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>
                      {addWalletView === 'menu' && t('addWallet', lang)}
                      {addWalletView === 'import-pk' && t('importPrivateKey', lang)}
                      {addWalletView === 'import-seed' && t('importSeedPhrase', lang)}
                      {addWalletView === 'create' && t('createNewWallet', lang)}
                      {addWalletView === 'track' && t('trackWallet', lang)}
                    </span>
                  </div>
                  <button
                    onClick={closeAddWalletModal}
                    style={{
                      background: 'none',
                      border: 'none',
                      color: 'rgba(255, 255, 255, 0.5)',
                      cursor: 'pointer',
                      padding: 4
                    }}
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <line x1="18" y1="6" x2="6" y2="18" />
                      <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                  </button>
                </div>

                {/* Modal Body */}
                <div style={{ padding: '16px 20px 20px 20px' }}>
                  {/* Menu View */}
                  {addWalletView === 'menu' && (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {/* Import Private Key Option */}
                      <button
                        onClick={() => setAddWalletView('import-pk')}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 14,
                          padding: '16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.08)',
                          borderRadius: 14,
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          textAlign: 'left'
                        }}
                      >
                        <div style={{
                          width: 44,
                          height: 44,
                          borderRadius: 12,
                          background: 'rgba(34, 211, 238, 0.1)',
                          border: '1px solid rgba(34, 211, 238, 0.2)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" strokeWidth="2">
                            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
                          </svg>
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>
                            Import Private Key
                          </div>
                          <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                            Add an existing wallet
                          </div>
                        </div>
                      </button>

                      {/* Import Seed Phrase Option */}
                      <button
                        onClick={() => setAddWalletView('import-seed')}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 14,
                          padding: '16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.08)',
                          borderRadius: 14,
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          textAlign: 'left'
                        }}
                      >
                        <div style={{
                          width: 44,
                          height: 44,
                          borderRadius: 12,
                          background: 'rgba(168, 85, 247, 0.1)',
                          border: '1px solid rgba(168, 85, 247, 0.2)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" strokeWidth="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                          </svg>
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>
                            Import Seed Phrase
                          </div>
                          <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                            Recover with 12/24 words
                          </div>
                        </div>
                      </button>

                      {/* Create New Wallet Option */}
                      <button
                        onClick={() => setAddWalletView('create')}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 14,
                          padding: '16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.08)',
                          borderRadius: 14,
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          textAlign: 'left'
                        }}
                      >
                        <div style={{
                          width: 44,
                          height: 44,
                          borderRadius: 12,
                          background: 'rgba(16, 185, 129, 0.1)',
                          border: '1px solid rgba(16, 185, 129, 0.2)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                          </svg>
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>
                            {t('createNewWallet', lang)}
                          </div>
                          <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                            {t('deriveFromSeed', lang)}
                          </div>
                        </div>
                      </button>

                      {/* Track Wallet Option */}
                      <button
                        onClick={() => setAddWalletView('track')}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 14,
                          padding: '16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.08)',
                          borderRadius: 14,
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          textAlign: 'left'
                        }}
                      >
                        <div style={{
                          width: 44,
                          height: 44,
                          borderRadius: 12,
                          background: 'rgba(59, 130, 246, 0.1)',
                          border: '1px solid rgba(59, 130, 246, 0.2)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center'
                        }}>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                            <circle cx="12" cy="12" r="3" />
                          </svg>
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>
                            Track Wallet
                          </div>
                          <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                            Watch any address (view only)
                          </div>
                        </div>
                      </button>
                    </div>
                  )}

                  {/* Import Private Key View */}
                  {addWalletView === 'import-pk' && (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                      {!importVaultDetected.detected ? (
                        <>
                          <input
                            type="password"
                            value={importInput}
                            onChange={(e) => setImportInput(e.target.value)}
                            placeholder="Enter private key (Base58)"
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              fontFamily: 'monospace',
                              boxSizing: 'border-box'
                            }}
                          />
                          <input
                            type="text"
                            value={newWalletName}
                            onChange={(e) => setNewWalletName(e.target.value)}
                            placeholder="Wallet name (optional)"
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              boxSizing: 'border-box'
                            }}
                          />
                          <button
                            onClick={importWalletFromPrivateKey}
                            disabled={isAddingWallet || !importInput.trim()}
                            style={{
                              width: '100%',
                              padding: '14px',
                              background: importInput.trim() ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'rgba(255, 255, 255, 0.1)',
                              border: 'none',
                              borderRadius: 12,
                              fontSize: 14,
                              fontWeight: 600,
                              color: importInput.trim() ? '#000' : 'rgba(255, 255, 255, 0.3)',
                              cursor: isAddingWallet || !importInput.trim() ? 'not-allowed' : 'pointer'
                            }}
                          >
                            {isAddingWallet ? (isCheckingVault ? 'Checking...' : 'Importing...') : 'Import Wallet'}
                          </button>
                        </>
                      ) : (
                        <>
                          {/* Vault Detected - Show password input */}
                          <div style={{
                            padding: '16px',
                            background: 'rgba(16, 185, 129, 0.08)',
                            border: '1px solid rgba(16, 185, 129, 0.2)',
                            borderRadius: 12,
                            textAlign: 'center'
                          }}>
                            <div style={{
                              width: 48,
                              height: 48,
                              borderRadius: 12,
                              background: 'rgba(16, 185, 129, 0.15)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              margin: '0 auto 12px auto'
                            }}>
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                              </svg>
                            </div>
                            <div style={{ fontSize: 14, fontWeight: 600, color: '#10b981', marginBottom: 4 }}>
                              ARGUS Vault Detected
                            </div>
                            <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>
                              Enter the vault's password to import
                            </div>
                          </div>
                          
                          <input
                            type="password"
                            value={importVaultPassword}
                            onChange={(e) => {
                              setImportVaultPassword(e.target.value)
                              setImportVaultError("")
                            }}
                            placeholder="Vault Password"
                            autoFocus
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && importVaultPassword.trim()) {
                                completeVaultImport()
                              }
                            }}
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: importVaultError ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              boxSizing: 'border-box'
                            }}
                          />
                          
                          {importVaultError && (
                            <div style={{ fontSize: 12, color: '#ef4444', marginTop: -8 }}>
                              {importVaultError}
                            </div>
                          )}
                          
                          <button
                            onClick={completeVaultImport}
                            disabled={isVerifyingImportPassword || !importVaultPassword.trim()}
                            style={{
                              width: '100%',
                              padding: '14px',
                              background: importVaultPassword.trim() ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'rgba(255, 255, 255, 0.1)',
                              border: 'none',
                              borderRadius: 12,
                              fontSize: 14,
                              fontWeight: 600,
                              color: importVaultPassword.trim() ? '#000' : 'rgba(255, 255, 255, 0.3)',
                              cursor: isVerifyingImportPassword || !importVaultPassword.trim() ? 'not-allowed' : 'pointer'
                            }}
                          >
                            {isVerifyingImportPassword ? 'Verifying...' : 'Import Vault'}
                          </button>
                          
                          <button
                            onClick={() => {
                              setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' })
                              setImportVaultPassword("")
                              setImportVaultError("")
                            }}
                            style={{
                              width: '100%',
                              padding: '12px',
                              background: 'transparent',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 13,
                              color: 'rgba(255, 255, 255, 0.5)',
                              cursor: 'pointer'
                            }}
                          >
                             Back
                          </button>
                        </>
                      )}
                    </div>
                  )}

                  {/* Import Seed Phrase View */}
                  {addWalletView === 'import-seed' && (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                      {!importVaultDetected.detected ? (
                        <>
                          <textarea
                            value={importInput}
                            onChange={(e) => setImportInput(e.target.value)}
                            placeholder="Enter seed phrase (12 or 24 words)"
                            rows={3}
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              resize: 'none',
                              fontFamily: 'monospace',
                              boxSizing: 'border-box'
                            }}
                          />
                          <input
                            type="text"
                            value={newWalletName}
                            onChange={(e) => setNewWalletName(e.target.value)}
                            placeholder="Wallet name (optional)"
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              boxSizing: 'border-box'
                            }}
                          />
                          <button
                            onClick={importWalletFromSeedPhrase}
                            disabled={isAddingWallet || !importInput.trim()}
                            style={{
                              width: '100%',
                              padding: '14px',
                              background: importInput.trim() ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : 'rgba(255, 255, 255, 0.1)',
                              border: 'none',
                              borderRadius: 12,
                              fontSize: 14,
                              fontWeight: 600,
                              color: importInput.trim() ? '#fff' : 'rgba(255, 255, 255, 0.3)',
                              cursor: isAddingWallet || !importInput.trim() ? 'not-allowed' : 'pointer'
                            }}
                          >
                            {isAddingWallet ? (isCheckingVault ? 'Checking...' : 'Importing...') : 'Import Wallet'}
                          </button>
                        </>
                      ) : (
                        <>
                          {/* Vault Detected - Show password input */}
                          <div style={{
                            padding: '16px',
                            background: 'rgba(139, 92, 246, 0.08)',
                            border: '1px solid rgba(139, 92, 246, 0.2)',
                            borderRadius: 12,
                            textAlign: 'center'
                          }}>
                            <div style={{
                              width: 48,
                              height: 48,
                              borderRadius: 12,
                              background: 'rgba(139, 92, 246, 0.15)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              margin: '0 auto 12px auto'
                            }}>
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                              </svg>
                            </div>
                            <div style={{ fontSize: 14, fontWeight: 600, color: '#8b5cf6', marginBottom: 4 }}>
                              ARGUS Vault Detected
                            </div>
                            <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>
                              Enter the vault's password to import
                            </div>
                          </div>
                          
                          <input
                            type="password"
                            value={importVaultPassword}
                            onChange={(e) => {
                              setImportVaultPassword(e.target.value)
                              setImportVaultError("")
                            }}
                            placeholder="Vault Password"
                            autoFocus
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && importVaultPassword.trim()) {
                                completeVaultImport()
                              }
                            }}
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: importVaultError ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              boxSizing: 'border-box'
                            }}
                          />
                          
                          {importVaultError && (
                            <div style={{ fontSize: 12, color: '#ef4444', marginTop: -8 }}>
                              {importVaultError}
                            </div>
                          )}
                          
                          <button
                            onClick={completeVaultImport}
                            disabled={isVerifyingImportPassword || !importVaultPassword.trim()}
                            style={{
                              width: '100%',
                              padding: '14px',
                              background: importVaultPassword.trim() ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : 'rgba(255, 255, 255, 0.1)',
                              border: 'none',
                              borderRadius: 12,
                              fontSize: 14,
                              fontWeight: 600,
                              color: importVaultPassword.trim() ? '#fff' : 'rgba(255, 255, 255, 0.3)',
                              cursor: isVerifyingImportPassword || !importVaultPassword.trim() ? 'not-allowed' : 'pointer'
                            }}
                          >
                            {isVerifyingImportPassword ? 'Verifying...' : 'Import Vault'}
                          </button>
                          
                          <button
                            onClick={() => {
                              setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' })
                              setImportVaultPassword("")
                              setImportVaultError("")
                            }}
                            style={{
                              width: '100%',
                              padding: '12px',
                              background: 'transparent',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 13,
                              color: 'rgba(255, 255, 255, 0.5)',
                              cursor: 'pointer'
                            }}
                          >
                             Back
                          </button>
                        </>
                      )}
                    </div>
                  )}

                  {/* Create New Wallet View */}
                  {addWalletView === 'create' && (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                      <div style={{
                        padding: '12px',
                        background: 'rgba(16, 185, 129, 0.08)',
                        border: '1px solid rgba(16, 185, 129, 0.2)',
                        borderRadius: 12,
                        fontSize: 12,
                        color: 'rgba(255, 255, 255, 0.6)',
                        lineHeight: 1.5
                      }}>
                        Creates a new wallet derived from your existing seed phrase.
                      </div>
                      <input
                        type="text"
                        value={newWalletName}
                        onChange={(e) => setNewWalletName(e.target.value)}
                        placeholder={`Account ${walletAccounts.length + 1}`}
                        style={{
                          width: '100%',
                          padding: '14px 16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.1)',
                          borderRadius: 12,
                          fontSize: 14,
                          color: '#fff',
                          outline: 'none',
                          boxSizing: 'border-box'
                        }}
                      />
                      <button
                        onClick={createNewWalletFromSeed}
                        disabled={isAddingWallet}
                        style={{
                          width: '100%',
                          padding: '14px',
                          background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                          border: 'none',
                          borderRadius: 12,
                          fontSize: 14,
                          fontWeight: 600,
                          color: '#000',
                          cursor: isAddingWallet ? 'not-allowed' : 'pointer'
                        }}
                      >
                        {isAddingWallet ? 'Creating...' : 'Create Wallet'}
                      </button>
                    </div>
                  )}

                  {/* Track Wallet View */}
                  {addWalletView === 'track' && (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                      <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', lineHeight: 1.5 }}>
                        Track any Solana wallet address. You'll be able to view balance, tokens, and activity, but won't be able to make transactions.
                      </div>
                      <input
                        type="text"
                        value={trackAddressInput}
                        onChange={(e) => setTrackAddressInput(e.target.value)}
                        placeholder="Enter wallet address"
                        style={{
                          width: '100%',
                          padding: '14px 16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.1)',
                          borderRadius: 12,
                          fontSize: 14,
                          color: '#fff',
                          outline: 'none',
                          fontFamily: 'monospace',
                          boxSizing: 'border-box'
                        }}
                      />
                      <input
                        type="text"
                        value={newWalletName}
                        onChange={(e) => setNewWalletName(e.target.value)}
                        placeholder="Wallet name (e.g. Whale Wallet)"
                        style={{
                          width: '100%',
                          padding: '14px 16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.1)',
                          borderRadius: 12,
                          fontSize: 14,
                          color: '#fff',
                          outline: 'none',
                          boxSizing: 'border-box'
                        }}
                      />
                      <button
                        onClick={async () => {
                          if (!trackAddressInput.trim()) {
                            setStatus("Please enter a wallet address")
                            return
                          }
                          
                          // Validate the address
                          try {
                            new PublicKey(trackAddressInput.trim())
                          } catch {
                            setStatus("Invalid wallet address")
                            return
                          }
                          
                          // Check if already tracking this address
                          if (walletAccounts.some(acc => acc.publicKey === trackAddressInput.trim())) {
                            setStatus("This wallet is already added")
                            return
                          }
                          
                          setIsAddingWallet(true)
                          
                          const newAccount: WalletAccount = {
                            index: -1, // Watch-only wallets don't have an index
                            name: newWalletName.trim() || `Tracked ${walletAccounts.filter(a => a.isWatchOnly).length + 1}`,
                            publicKey: trackAddressInput.trim(),
                            secretKey: '', // No secret key for watch-only
                            isWatchOnly: true
                          }
                          
                          const updatedAccounts = [...walletAccounts, newAccount]
                          setWalletAccounts(updatedAccounts)
                          setStoredAccounts(updatedAccounts)
                          
                          // Switch to the tracked wallet
                          const newIndex = updatedAccounts.length - 1
                          setActiveAccountIndex(newIndex)
                          setStoredActiveIndex(newIndex)
                          
                          setStatus("Wallet added for tracking!")
                          setTrackAddressInput("")
                          setNewWalletName("")
                          setShowAddWalletModal(false)
                          setAddWalletView("menu")
                          setIsAddingWallet(false)
                        }}
                        disabled={isAddingWallet || !trackAddressInput.trim()}
                        style={{
                          width: '100%',
                          padding: '14px',
                          background: !trackAddressInput.trim() ? 'rgba(59, 130, 246, 0.3)' : 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                          border: 'none',
                          borderRadius: 12,
                          fontSize: 14,
                          fontWeight: 600,
                          color: '#fff',
                          cursor: isAddingWallet || !trackAddressInput.trim() ? 'not-allowed' : 'pointer',
                          opacity: !trackAddressInput.trim() ? 0.5 : 1
                        }}
                      >
                        {isAddingWallet ? 'Adding...' : 'Track Wallet'}
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </>
        )}

        {/* Vault Password Setup Modal (for enabling security layers on wallets without password) */}
        {vaultPasswordSetup.show && (
          <>
            {/* Modal Backdrop */}
            <div 
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.9)',
                backdropFilter: 'blur(12px)',
                zIndex: 2001,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}
            >
              {/* Modal Content */}
              <div 
                onClick={(e) => e.stopPropagation()}
                style={{
                  width: 320,
                  background: '#131318',
                  borderRadius: 16,
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  overflow: 'hidden',
                  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.9)'
                }}
              >
                {/* Modal Header */}
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  padding: '20px 20px 16px 20px',
                  borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
                }}>
                  <span style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>
                    Set Vault Password
                  </span>
                </div>

                {/* Modal Body */}
                <div style={{ padding: 20, display: 'flex', flexDirection: 'column', gap: 16 }}>
                  {/* Info Box */}
                  <div style={{
                    padding: '16px',
                    background: 'rgba(139, 92, 246, 0.1)',
                    border: '1px solid rgba(139, 92, 246, 0.3)',
                    borderRadius: 12,
                    textAlign: 'center'
                  }}>
                    <div style={{
                      width: 48,
                      height: 48,
                      borderRadius: 12,
                      background: 'rgba(139, 92, 246, 0.15)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      margin: '0 auto 12px auto'
                    }}>
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                      </svg>
                    </div>
                    <div style={{ fontSize: 14, fontWeight: 600, color: '#8b5cf6', marginBottom: 4 }}>
                      Vault Password Required
                    </div>
                    <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', lineHeight: 1.5 }}>
                      Create a password to enable security layers on this wallet. This password will be used for vault transactions.
                    </div>
                  </div>

                  {/* Wallet Info */}
                  <div style={{
                    padding: '12px',
                    background: 'rgba(255, 255, 255, 0.03)',
                    borderRadius: 10,
                    display: 'flex',
                    alignItems: 'center',
                    gap: 12
                  }}>
                    <PlanetAvatar seed={vaultPasswordSetup.publicKey} size={36} />
                    <div>
                      <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>{editingWallet?.name || 'Wallet'}</div>
                      <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', fontFamily: 'monospace' }}>
                        {vaultPasswordSetup.publicKey.slice(0, 8)}...{vaultPasswordSetup.publicKey.slice(-6)}
                      </div>
                    </div>
                  </div>

                  {/* Password Input */}
                  <input
                    type="password"
                    value={vaultPasswordSetup.password}
                    onChange={(e) => {
                      setVaultPasswordSetup(prev => ({ ...prev, password: e.target.value, error: '' }))
                    }}
                    placeholder="Password (min 6 characters)"
                    autoFocus
                    style={{
                      width: '100%',
                      padding: '14px 16px',
                      background: 'rgba(255, 255, 255, 0.03)',
                      border: vaultPasswordSetup.error ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 12,
                      fontSize: 14,
                      color: '#fff',
                      outline: 'none',
                      boxSizing: 'border-box'
                    }}
                  />

                  {/* Confirm Password Input */}
                  <input
                    type="password"
                    value={vaultPasswordSetup.confirmPassword}
                    onChange={(e) => {
                      setVaultPasswordSetup(prev => ({ ...prev, confirmPassword: e.target.value, error: '' }))
                    }}
                    placeholder="Confirm Password"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && vaultPasswordSetup.password && vaultPasswordSetup.confirmPassword) {
                        completeVaultPasswordSetup()
                      }
                    }}
                    style={{
                      width: '100%',
                      padding: '14px 16px',
                      background: 'rgba(255, 255, 255, 0.03)',
                      border: vaultPasswordSetup.error ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 12,
                      fontSize: 14,
                      color: '#fff',
                      outline: 'none',
                      boxSizing: 'border-box'
                    }}
                  />

                  {/* Error Message */}
                  {vaultPasswordSetup.error && (
                    <div style={{ fontSize: 12, color: '#ef4444', marginTop: -8 }}>
                      {vaultPasswordSetup.error}
                    </div>
                  )}

                  {/* Submit Button */}
                  <button
                    onClick={completeVaultPasswordSetup}
                    disabled={vaultPasswordSetup.isSubmitting || !vaultPasswordSetup.password || !vaultPasswordSetup.confirmPassword}
                    style={{
                      width: '100%',
                      padding: '14px',
                      background: (vaultPasswordSetup.password && vaultPasswordSetup.confirmPassword) 
                        ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' 
                        : 'rgba(255, 255, 255, 0.1)',
                      border: 'none',
                      borderRadius: 12,
                      fontSize: 14,
                      fontWeight: 600,
                      color: (vaultPasswordSetup.password && vaultPasswordSetup.confirmPassword) ? '#fff' : 'rgba(255, 255, 255, 0.3)',
                      cursor: vaultPasswordSetup.isSubmitting || !vaultPasswordSetup.password || !vaultPasswordSetup.confirmPassword ? 'not-allowed' : 'pointer'
                    }}
                  >
                    {vaultPasswordSetup.isSubmitting ? 'Setting password...' : 'Set Password & Continue'}
                  </button>

                  {/* Cancel Button */}
                  <button
                    onClick={() => {
                      setVaultPasswordSetup({ show: false, publicKey: '', password: '', confirmPassword: '', error: '', isSubmitting: false, layerToEnable: null })
                    }}
                    style={{
                      width: '100%',
                      padding: '12px',
                      background: 'transparent',
                      border: '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 12,
                      fontSize: 13,
                      color: 'rgba(255, 255, 255, 0.5)',
                      cursor: 'pointer'
                    }}
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </>
        )}
      </div>
    )
  }

  // Token Detail View
  if (view === "token-detail" && selectedToken) {
    const formatNumber = (num: number | undefined): string => {
      if (num === undefined || num === null) return '-';
      if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
      if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
      if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
      return `$${num.toFixed(2)}`;
    };

    const priceChange = tokenDetailData?.priceChange24h ?? selectedToken.change24h;
    const isPositiveChange = priceChange && priceChange >= 0;

    return (
      <div style={containerStyle}>
        {/* Banner Background - More prominent */}
        {(tokenDetailData?.bannerURI || selectedToken.bannerURI) && (
          <div style={{
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            height: 220,
            backgroundImage: `url(${tokenDetailData?.bannerURI || selectedToken.bannerURI})`,
            backgroundSize: 'cover',
            backgroundPosition: 'center',
            opacity: 0.4,
            zIndex: 0
          }} />
        )}
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          height: 250,
          background: 'linear-gradient(to bottom, transparent 0%, #121216 85%)',
          zIndex: 1
        }} />

        {/* Minimal Back Button */}
        <div style={{
          position: 'relative',
          zIndex: 2,
          padding: '16px 20px'
        }}>
          <button
            onClick={() => {
              setView("main");
              setSelectedToken(null);
              setTokenDetailData(null);
            }}
            style={{
              background: 'transparent',
              border: 'none',
              padding: 0,
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: 4,
              opacity: 0.7,
              transition: 'opacity 0.2s'
            }}
            onMouseEnter={(e) => e.currentTarget.style.opacity = '1'}
            onMouseLeave={(e) => e.currentTarget.style.opacity = '0.7'}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2" strokeLinecap="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span style={{ color: '#fff', fontSize: 14, fontWeight: 400 }}>{t('back', lang)}</span>
          </button>
        </div>

        {/* Main Content */}
        <div style={{
          position: 'relative',
          zIndex: 2,
          padding: '0 20px'
        }}>
          {/* Token Header - Logo, Name, Price all together */}
          <div style={{ textAlign: 'center', marginBottom: 32 }}>
            {/* Logo */}
            <div style={{
              width: 72,
              height: 72,
              borderRadius: 18,
              overflow: 'hidden',
              background: 'rgba(255, 255, 255, 0.1)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              margin: '0 auto 16px auto',
              boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)'
            }}>
              {(tokenDetailData?.logoURI || selectedToken.logoURI) && !failedLogos.has(selectedToken.mint) ? (
                <img 
                  src={tokenDetailData?.logoURI || selectedToken.logoURI}
                  alt={selectedToken.symbol}
                  width={72}
                  height={72}
                  onError={() => setFailedLogos(prev => new Set(prev).add(selectedToken.mint))}
                />
              ) : (
                <span style={{ fontSize: 28, fontWeight: 700, color: 'rgba(255, 255, 255, 0.6)' }}>
                  {selectedToken.symbol?.[0] || '?'}
                </span>
              )}
            </div>
            
            {/* Name and Symbol with Socials */}
            <div style={{ fontSize: 22, fontWeight: 600, color: '#fff', marginBottom: 4 }}>
              {tokenDetailData?.name || selectedToken.name}
            </div>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, marginBottom: 20 }}>
              <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.4)', fontWeight: 500 }}>
                {tokenDetailData?.symbol || selectedToken.symbol}
              </span>
              {(tokenDetailData?.socials || selectedToken.socials) && (
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  {(tokenDetailData?.socials?.twitter || selectedToken.socials?.twitter) && (
                    <a href={tokenDetailData?.socials?.twitter || selectedToken.socials?.twitter} target="_blank" rel="noopener noreferrer" style={{ display: 'flex', opacity: 0.4, transition: 'opacity 0.2s' }} onMouseEnter={(e) => e.currentTarget.style.opacity = '1'} onMouseLeave={(e) => e.currentTarget.style.opacity = '0.4'}>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="#fff"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    </a>
                  )}
                  {(tokenDetailData?.socials?.telegram || selectedToken.socials?.telegram) && (
                    <a href={tokenDetailData?.socials?.telegram || selectedToken.socials?.telegram} target="_blank" rel="noopener noreferrer" style={{ display: 'flex', opacity: 0.4, transition: 'opacity 0.2s' }} onMouseEnter={(e) => e.currentTarget.style.opacity = '1'} onMouseLeave={(e) => e.currentTarget.style.opacity = '0.4'}>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="#fff"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                    </a>
                  )}
                  {(tokenDetailData?.socials?.website || selectedToken.socials?.website) && (
                    <a href={tokenDetailData?.socials?.website || selectedToken.socials?.website} target="_blank" rel="noopener noreferrer" style={{ display: 'flex', opacity: 0.4, transition: 'opacity 0.2s' }} onMouseEnter={(e) => e.currentTarget.style.opacity = '1'} onMouseLeave={(e) => e.currentTarget.style.opacity = '0.4'}>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                    </a>
                  )}
                </div>
              )}
            </div>

            {/* Price - Large and centered */}
            <div style={{ fontSize: 36, fontWeight: 700, color: '#fff', marginBottom: 8 }}>
              {formatCurrency(tokenDetailData?.price ?? selectedToken.price ?? 0)}
            </div>
            {priceChange !== undefined && (
              <div style={{
                display: 'inline-block',
                fontSize: 13,
                fontWeight: 600,
                color: isPositiveChange ? '#10b981' : '#ef4444',
                background: isPositiveChange ? 'rgba(16, 185, 129, 0.12)' : 'rgba(239, 68, 68, 0.12)',
                padding: '5px 12px',
                borderRadius: 20
              }}>
                {isPositiveChange ? '+' : ''}{priceChange.toFixed(2)}%
              </div>
            )}
          </div>

          {/* Your Holdings - Clean card */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.06)',
            borderRadius: 16,
            padding: '16px 18px',
            marginBottom: 12
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: 4 }}>Your Balance</div>
                <div style={{ fontSize: 18, fontWeight: 600, color: '#fff' }}>
                  {selectedToken.amount.toLocaleString(undefined, { maximumFractionDigits: 4 })} <span style={{ color: 'rgba(255, 255, 255, 0.5)', fontWeight: 400 }}>{selectedToken.symbol}</span>
                </div>
              </div>
              <div style={{ textAlign: 'right' }}>
                <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: 4 }}>Value</div>
                <div style={{ fontSize: 18, fontWeight: 600, color: '#fff' }}>
                  {formatCurrency(selectedToken.value)}
                </div>
              </div>
            </div>
          </div>

          {/* Market Stats - Minimal grid */}
          {tokenDetailLoading ? (
            <div style={{ textAlign: 'center', padding: '24px 0', color: 'rgba(255, 255, 255, 0.3)', fontSize: 13 }}>
              {t('loading', lang)}
            </div>
          ) : tokenDetailData && (
            <div style={{
              display: 'grid',
              gridTemplateColumns: '1fr 1fr',
              gap: '1px',
              background: 'rgba(255, 255, 255, 0.06)',
              borderRadius: 16,
              overflow: 'hidden',
              marginBottom: 12
            }}>
              <div style={{ background: '#121216', padding: '14px 16px' }}>
                <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)', marginBottom: 4 }}>Market Cap</div>
                <div style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{formatNumber(tokenDetailData.marketCap)}</div>
              </div>
              <div style={{ background: '#121216', padding: '14px 16px' }}>
                <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)', marginBottom: 4 }}>FDV</div>
                <div style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{formatNumber(tokenDetailData.fdv)}</div>
              </div>
              <div style={{ background: '#121216', padding: '14px 16px' }}>
                <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)', marginBottom: 4 }}>24h Volume</div>
                <div style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{formatNumber(tokenDetailData.volume24h)}</div>
              </div>
              <div style={{ background: '#121216', padding: '14px 16px' }}>
                <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.35)', marginBottom: 4 }}>Liquidity</div>
                <div style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{formatNumber(tokenDetailData.liquidity)}</div>
              </div>
            </div>
          )}

          {/* Trading On - Inline */}
          {tokenDetailData?.dexId && (
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: 8,
              padding: '10px 0',
              marginBottom: 16
            }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.35)' }}>Trading on</span>
              <img 
                src={`https://dd.dexscreener.com/ds-data/dexes/${tokenDetailData.dexId}.png`}
                alt={tokenDetailData.dexId}
                width={16}
                height={16}
                style={{ borderRadius: 4 }}
                onError={(e) => (e.currentTarget.style.display = 'none')}
              />
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.6)', fontWeight: 500, textTransform: 'capitalize' }}>{tokenDetailData.dexId}</span>
            </div>
          )}

          {/* External Links - Cleaner buttons */}
          <div style={{ display: 'flex', gap: 10, paddingBottom: 20 }}>
            <a
              href={`https://orb.helius.dev/address/${selectedToken.mint}`}
              target="_blank"
              rel="noopener noreferrer"
              style={{
                flex: 1,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: 6,
                background: 'rgba(255, 255, 255, 0.04)',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                padding: '12px',
                borderRadius: 12,
                color: 'rgba(255, 255, 255, 0.7)',
                textDecoration: 'none',
                fontSize: 13,
                fontWeight: 500,
                transition: 'all 0.2s'
              }}
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="4"/>
                <line x1="12" y1="2" x2="12" y2="4"/>
                <line x1="12" y1="20" x2="12" y2="22"/>
              </svg>
              Orbit
            </a>
            <a
              href={`https://dexscreener.com/solana/${selectedToken.mint}`}
              target="_blank"
              rel="noopener noreferrer"
              style={{
                flex: 1,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: 6,
                background: 'rgba(255, 255, 255, 0.04)',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                padding: '12px',
                borderRadius: 12,
                color: 'rgba(255, 255, 255, 0.7)',
                textDecoration: 'none',
                fontSize: 13,
                fontWeight: 500,
                transition: 'all 0.2s'
              }}
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
              </svg>
              DexScreener
            </a>
          </div>
        </div>
      </div>
    )
  }

  // Edit Wallet View
  if (view === "edit-wallet" && editingWallet) {
    const saveWalletName = () => {
      if (!editWalletName.trim()) return
      
      const updatedAccounts = walletAccounts.map(acc => 
        acc.publicKey === editingWallet.publicKey 
          ? { ...acc, name: editWalletName.trim() }
          : acc
      )
      setWalletAccounts(updatedAccounts)
      setStoredAccounts(updatedAccounts)
      setEditingWallet({ ...editingWallet, name: editWalletName.trim() })
      setStatus("Account name updated!")
    }

    const deleteWallet = () => {
      if (walletAccounts.length <= 1) {
        setStatus("Cannot delete the only account")
        return
      }
      
      setConfirmModal({
        show: true,
        title: 'Remove Account',
        message: `Are you sure you want to remove "${editingWallet.name}"? This will only remove it from this device.`,
        confirmText: 'Remove',
        danger: true,
        onConfirm: () => {
          setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
          const updatedAccounts = walletAccounts.filter(acc => acc.publicKey !== editingWallet.publicKey)
          setWalletAccounts(updatedAccounts)
          setStoredAccounts(updatedAccounts)
          
          // If we deleted the active account, switch to first one
          if (editingWallet.index === activeAccountIndex) {
            const newActive = updatedAccounts[0]
            setActiveAccountIndex(newActive.index)
            setStoredActiveIndex(newActive.index)
            const kp = getKeypairFromSecret(newActive.secretKey)
            setWallet(kp)
            setStoredSecret(newActive.secretKey)
          }
          
          setView("manage-wallets")
        }
      })
    }

    const copyPrivateKey = async () => {
      copyToClipboardSafe(editingWallet.secretKey)
      setCopiedKey(true)
      setTimeout(() => setCopiedKey(false), 2000)
    }

    return (
      <div style={containerStyle}>
        {/* Confirm Modal */}
        {confirmModal.show && (
          <>
            <div 
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.8)',
                backdropFilter: 'blur(8px)',
                zIndex: 2000
              }} 
              onClick={() => {
                setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                setConfirmPassword("")
                setConfirmPasswordError("")
              }} 
            />
            <div style={{
              position: 'fixed',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              width: 300,
              background: '#1a1a1f',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              borderRadius: 20,
              padding: 24,
              zIndex: 2001
            }}>
              <div style={{
                width: 48,
                height: 48,
                borderRadius: 14,
                background: confirmModal.danger ? 'rgba(239, 68, 68, 0.1)' : confirmModal.iconType === 'usb' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                margin: '0 auto 16px auto'
              }}>
                {confirmModal.danger ? (
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                ) : confirmModal.iconType === 'usb' ? (
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                    <rect x="9" y="9" width="6" height="6"/>
                    <line x1="9" y1="2" x2="9" y2="4"/>
                    <line x1="15" y1="2" x2="15" y2="4"/>
                    <line x1="9" y1="20" x2="9" y2="22"/>
                    <line x1="15" y1="20" x2="15" y2="22"/>
                  </svg>
                ) : (
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" strokeWidth="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  </svg>
                )}
              </div>
              <h3 style={{ 
                margin: '0 0 8px 0', 
                fontSize: 16, 
                fontWeight: 600, 
                color: '#fff',
                textAlign: 'center'
              }}>
                {confirmModal.title}
              </h3>
              {confirmModal.highlightText ? (
                <div style={{ margin: '0 0 16px 0', textAlign: 'center' }}>
                  <div style={{ 
                    fontSize: 14, 
                    fontWeight: 600,
                    color: '#10b981',
                    marginBottom: 8
                  }}>
                    {confirmModal.highlightText}
                  </div>
                  <p style={{ 
                    margin: 0, 
                    fontSize: 13, 
                    color: 'rgba(255, 255, 255, 0.5)',
                    lineHeight: 1.5
                  }}>
                    {confirmModal.message}
                  </p>
                </div>
              ) : (
                <p style={{ 
                  margin: '0 0 16px 0', 
                  fontSize: 13, 
                  color: 'rgba(255, 255, 255, 0.5)',
                  textAlign: 'center',
                  lineHeight: 1.5
                }}>
                  {confirmModal.message}
                </p>
              )}
              {confirmModal.requirePassword && (
                <div style={{ marginBottom: 16 }}>
                  <input
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => {
                      setConfirmPassword(e.target.value)
                      setConfirmPasswordError("")
                    }}
                    placeholder="Enter your password"
                    style={{
                      width: '100%',
                      padding: '12px 14px',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: confirmPasswordError ? '1px solid #ef4444' : '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 10,
                      fontSize: 14,
                      color: '#fff',
                      outline: 'none',
                      boxSizing: 'border-box'
                    }}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && confirmPassword) {
                        confirmModal.onConfirm(confirmPassword)
                      }
                    }}
                    autoFocus
                  />
                  {confirmPasswordError && (
                    <div style={{ fontSize: 11, color: '#ef4444', marginTop: 6 }}>
                      {confirmPasswordError}
                    </div>
                  )}
                </div>
              )}
              <div style={{ display: 'flex', gap: 10 }}>
                <button
                  onClick={() => {
                    setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                  }}
                  style={{
                    flex: 1,
                    padding: '12px 16px',
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 12,
                    color: 'rgba(255, 255, 255, 0.7)',
                    fontSize: 13,
                    fontWeight: 500,
                    cursor: 'pointer'
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={async () => {
                    console.log('[Edit-Wallet Modal] Continue clicked, password provided:', !!confirmPassword)
                    try {
                      await confirmModal.onConfirm(confirmPassword)
                    } catch (err) {
                      console.error('[Edit-Wallet Modal] onConfirm error:', err)
                    }
                  }}
                  disabled={confirmModal.requirePassword && !confirmPassword}
                  style={{
                    flex: 1,
                    padding: '12px 16px',
                    background: confirmModal.danger 
                      ? '#ef4444' 
                      : (confirmModal.requirePassword && !confirmPassword) 
                        ? 'rgba(255, 255, 255, 0.05)' 
                        : 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                    border: 'none',
                    borderRadius: 12,
                    color: (confirmModal.requirePassword && !confirmPassword) ? 'rgba(255, 255, 255, 0.3)' : '#fff',
                    fontSize: 13,
                    fontWeight: 600,
                    cursor: (confirmModal.requirePassword && !confirmPassword) ? 'not-allowed' : 'pointer'
                  }}
                >
                  {confirmModal.confirmText || 'Confirm'}
                </button>
              </div>
            </div>
          </>
        )}

        {/* Security Layer Success/Disabled Modal - Elegant Design */}
        {successModal.show && (
          <>
            <style>{`
              @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
              @keyframes modalScaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
            `}</style>
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.85)',
              backdropFilter: 'blur(20px)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
              animation: 'modalFadeIn 0.2s ease-out forwards'
            }}>
              <div style={{
                background: 'linear-gradient(180deg, rgba(17, 17, 20, 0.98) 0%, rgba(12, 12, 14, 0.98) 100%)',
                borderRadius: 20,
                padding: '36px 28px 28px',
                width: '88%',
                maxWidth: 300,
                textAlign: 'center',
                border: '1px solid rgba(255, 255, 255, 0.06)',
                boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.7)',
                animation: 'modalScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              }}>
                {/* Icon - Matches swap success design */}
                <div style={{
                  width: 72,
                  height: 72,
                  borderRadius: '50%',
                  background: successModal.type === 'enabled' 
                    ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.08) 100%)'
                    : 'linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.08) 100%)',
                  border: `1px solid ${successModal.type === 'enabled' ? 'rgba(34, 197, 94, 0.25)' : 'rgba(239, 68, 68, 0.25)'}`,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  margin: '0 auto 20px'
                }}>
                  {successModal.type === 'enabled' ? (
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#22c55e" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  ) : (
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                  )}
                </div>

                {/* Title */}
                <h3 style={{
                  fontSize: 18,
                  fontWeight: 600,
                  color: '#fff',
                  margin: '0 0 8px 0',
                  letterSpacing: '-0.02em'
                }}>
                  {successModal.type === 'enabled' ? 'Layer Enabled' : 'Layer Disabled'}
                </h3>

                {/* Subtitle */}
                <p style={{
                  fontSize: 13,
                  color: 'rgba(255, 255, 255, 0.45)',
                  margin: '0 0 24px 0',
                  lineHeight: 1.5
                }}>
                  {successModal.type === 'enabled' ? (
                    <><span style={{ color: '#22c55e', fontWeight: 500 }}>{successModal.deviceName}</span> is now active</>
                  ) : (
                    <>{successModal.deviceType === 'voice' ? 'Voice' : successModal.deviceType === 'mobile' ? '2FA Mobile' : successModal.deviceType === 'bluetooth' ? 'Bluetooth' : successModal.deviceType === 'biometric' ? 'Biometric' : 'USB Key'} has been removed</>
                  )}
                </p>

                {/* Done Button */}
                <button
                  onClick={() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' })}
                  style={{
                    width: '100%',
                    padding: '12px',
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.08)',
                    borderRadius: 12,
                    color: 'rgba(255, 255, 255, 0.8)',
                    fontSize: 14,
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                >
                  Done
                </button>
              </div>
            </div>
          </>
        )}

        {/* Voice Enrollment Modal */}
        <VoiceEnrollmentModal
          show={voiceEnrollmentModal.show}
          mode={voiceEnrollmentModal.mode}
          walletAddress={voiceEnrollmentModal.walletAddress}
          enrolledFingerprint={voiceEnrollmentModal.enrolledFingerprint}
          onComplete={async (result) => {
            setVoiceEnrollmentModal(prev => ({ ...prev, show: false }))
            
            // Handle verify-for-tx mode - resolve the pending promise for transaction security verification
            if (voiceEnrollmentModal.mode === 'verify-for-tx') {
              if (pendingVoiceVerificationResolve.current) {
                pendingVoiceVerificationResolve.current({ success: result.success })
                pendingVoiceVerificationResolve.current = null
              }
              return
            }
            
            // Handle verify-to-disable mode - if voice verified, disable the layer
            if (voiceEnrollmentModal.mode === 'verify-to-disable') {
              if (result.success) {
                try {
                  setUpdatingSecurityLayer('voice')
                  await updateSecurityLayer(voiceEnrollmentModal.walletAddress, 'voice', false)
                  setSecuritySettings(prev => prev ? { ...prev, voiceLayerEnabled: false } : null)
                  setSuccessModal({ show: true, deviceName: 'Voice Layer', type: 'disabled', deviceType: 'voice' })
                  setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                } catch (err: any) {
                  console.error('[Voice Disable] Error:', err)
                  setStatus(err.message || 'Failed to disable voice layer')
                  setTimeout(() => setStatus(''), 3000)
                } finally {
                  setUpdatingSecurityLayer(null)
                }
              } else {
                setStatus(result.error || 'Voice verification failed')
                setTimeout(() => setStatus(''), 3000)
              }
              return
            }
            
            if (result.success && result.fingerprint) {
              try {
                // Save the voice fingerprint to server using the API directly (not chrome.runtime)
                console.log('[Voice Enroll] Saving fingerprint to server for:', voiceEnrollmentModal.walletAddress);
                const saveResult = await enrollVoiceFingerprint(voiceEnrollmentModal.walletAddress, result.fingerprint);
                console.log('[Voice Enroll] Save result:', saveResult);
                
                if (saveResult && saveResult.success) {
                  setUpdatingSecurityLayer('voice')
                  await updateSecurityLayer(voiceEnrollmentModal.walletAddress, 'voice', true)
                  setSecuritySettings(prev => prev ? { ...prev, voiceLayerEnabled: true, voiceEnrolled: true } : null)
                  // NOTE: Do NOT enable voiceUnlockEnabled here - that's a separate setting for wallet unlock
                  // Voice layer for transactions is different from voice unlock for the wallet
                  setSuccessModal({ show: true, deviceName: 'Voice Layer', type: 'enabled', deviceType: 'voice' })
                  setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                  setUpdatingSecurityLayer(null)
                } else {
                  setStatus('Failed to save voice fingerprint')
                  setTimeout(() => setStatus(''), 3000)
                }
              } catch (err: any) {
                console.error('[Voice Enroll] Error saving fingerprint:', err);
                setStatus(err.message || 'Failed to save voice fingerprint')
                setTimeout(() => setStatus(''), 3000)
              }
            } else if (result.error) {
              setStatus(result.error)
              setTimeout(() => setStatus(''), 3000)
            }
          }}
          onClose={() => {
            setVoiceEnrollmentModal(prev => ({ ...prev, show: false }))
            // If we're in verify-for-tx mode and user closes, resolve with failure
            if (voiceEnrollmentModal.mode === 'verify-for-tx' && pendingVoiceVerificationResolve.current) {
              pendingVoiceVerificationResolve.current({ success: false })
              pendingVoiceVerificationResolve.current = null
            }
          }}
        />

        {/* 2FA Mobile QR Modal */}
        {mobileQRModal.show && (
          <>
            <div 
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.9)',
                backdropFilter: 'blur(12px)',
                zIndex: 9999,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                animation: 'modalFadeIn 0.2s ease-out'
              }}
              onClick={() => {
                setMobileQRModal(prev => ({ ...prev, show: false }))
              }}
            >
              <div 
                style={{
                  background: 'linear-gradient(180deg, #111114 0%, #0c0c0e 100%)',
                  borderRadius: 16,
                  padding: '28px 24px 24px',
                  width: 300,
                  textAlign: 'center',
                  border: '1px solid rgba(255, 255, 255, 0.06)',
                  boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.7)',
                  animation: 'modalSlideIn 0.3s ease-out'
                }}
                onClick={e => e.stopPropagation()}
              >
                <h3 style={{ 
                  fontSize: 17, 
                  fontWeight: 600, 
                  color: '#fff', 
                  margin: '0 0 6px',
                  letterSpacing: '-0.01em'
                }}>
                  {mobileQRModal.onVerified 
                    ? 'Verify Recalibration'
                    : mobileQRModal.layerType === 'biometric' 
                      ? (mobileQRModal.mode === 'setup' ? 'Setup Biometric' : 'Verify Biometric')
                      : (mobileQRModal.mode === 'setup' ? 'Setup 2FA Mobile' : 'Verify with Phone')}
                </h3>
                
                <p style={{ 
                  fontSize: 12, 
                  color: 'rgba(255, 255, 255, 0.4)', 
                  margin: '0 0 20px',
                  lineHeight: 1.5
                }}>
                  {mobileQRModal.onVerified
                    ? 'Scan with your registered phone to authorize the geo-fence recalibration'
                    : mobileQRModal.layerType === 'biometric'
                      ? (mobileQRModal.mode === 'setup' 
                          ? 'Scan with your phone to register FaceID or TouchID'
                          : 'Scan to verify with biometrics')
                      : (mobileQRModal.mode === 'setup' 
                          ? 'Scan this QR code with your phone to register your device'
                          : 'Scan to verify your network')}
                </p>
                
                {/* QR Code */}
                {mobileQRModal.qrData && mobileQRModal.status === 'pending' && (
                  <div style={{
                    background: '#fff',
                    borderRadius: 10,
                    padding: 12,
                    display: 'inline-block',
                    marginBottom: 16
                  }}>
                    <QRCodeSVG 
                      value={mobileQRModal.qrData} 
                      size={140}
                      level="M"
                    />
                  </div>
                )}
                
                {/* Status */}
                <div style={{
                  padding: '10px 14px',
                  background: mobileQRModal.status === 'verified' 
                    ? 'rgba(16, 185, 129, 0.1)' 
                    : mobileQRModal.status === 'failed'
                    ? 'rgba(239, 68, 68, 0.1)'
                    : 'rgba(16, 185, 129, 0.06)',
                  border: `1px solid ${mobileQRModal.status === 'verified' 
                    ? 'rgba(16, 185, 129, 0.2)' 
                    : mobileQRModal.status === 'failed'
                    ? 'rgba(239, 68, 68, 0.2)'
                    : 'rgba(16, 185, 129, 0.1)'}`,
                  borderRadius: 8,
                  marginBottom: 14
                }}>
                  {mobileQRModal.status === 'pending' && (
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}>
                      <div style={{
                        width: 6,
                        height: 6,
                        borderRadius: '50%',
                        background: '#10b981',
                        animation: 'pulse 1.5s infinite'
                      }}/>
                      <span style={{ fontSize: 12, color: 'rgba(16, 185, 129, 0.9)' }}>Waiting for phone scan...</span>
                    </div>
                  )}
                  {mobileQRModal.status === 'verified' && (
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}>
                      <span style={{ fontSize: 12, color: '#10b981' }}>Device verified!</span>
                    </div>
                  )}
                  {mobileQRModal.status === 'failed' && (
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}>
                      <span style={{ fontSize: 12, color: '#ef4444' }}>Verification failed</span>
                    </div>
                  )}
                </div>
                
                {/* Cancel button */}
                <button
                  onClick={() => {
                    setMobileQRModal(prev => ({ ...prev, show: false }))
                  }}
                  style={{
                    width: '100%',
                    padding: '11px',
                    background: 'transparent',
                    border: '1px solid rgba(255, 255, 255, 0.08)',
                    borderRadius: 8,
                    color: 'rgba(255, 255, 255, 0.5)',
                    fontSize: 13,
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'all 0.15s ease'
                  }}
                >
                  Cancel
                </button>
              </div>
            </div>
          </>
        )}

        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '16px 20px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
        }}>
          <button 
            onClick={() => setView("manage-wallets")}
            style={{ 
              background: 'none', 
              border: 'none', 
              color: 'rgba(255, 255, 255, 0.7)', 
              cursor: 'pointer', 
              fontSize: 16,
              padding: 4,
              display: 'flex',
              alignItems: 'center',
              gap: 4
            }}
          >
             
          </button>
          <h3 style={{ 
            margin: 0, 
            fontSize: 16, 
            fontWeight: 600,
            color: '#fff'
          }}>Edit Account</h3>
          <div style={{ width: 24 }} />
        </div>

        {/* Avatar */}
        <div style={{ 
          display: 'flex', 
          flexDirection: 'column', 
          alignItems: 'center', 
          padding: '32px 20px 24px 20px'
        }}>
          <div style={{
            width: 80,
            height: 80,
            borderRadius: '50%',
            overflow: 'hidden',
            marginBottom: 8,
            border: '3px solid rgba(255, 255, 255, 0.1)',
            boxSizing: 'content-box',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
          }}>
            <PlanetAvatar seed={editingWallet.publicKey} size={80} />
          </div>
        </div>

        {/* Settings Cards */}
        <div style={{ padding: '0 16px' }}>
          {/* Account Name */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.06)',
            borderRadius: 12,
            marginBottom: 12,
            overflow: 'hidden'
          }}>
            {isEditingName ? (
              <div style={{ padding: '12px 16px' }}>
                <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>Account Name</div>
                <input
                  type="text"
                  value={editWalletName}
                  onChange={(e) => setEditWalletName(e.target.value)}
                  autoFocus
                  style={{
                    width: '100%',
                    padding: '12px',
                    background: 'rgba(0, 0, 0, 0.3)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 8,
                    color: '#fff',
                    fontSize: 14,
                    outline: 'none',
                    marginBottom: 12
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && editWalletName.trim()) {
                      const updatedAccounts = walletAccounts.map(acc => 
                        acc.publicKey === editingWallet.publicKey 
                          ? { ...acc, name: editWalletName.trim() }
                          : acc
                      )
                      setWalletAccounts(updatedAccounts)
                      setStoredAccounts(updatedAccounts)
                      setEditingWallet({ ...editingWallet, name: editWalletName.trim() })
                      setIsEditingName(false)
                      setStatus("Account name updated!")
                    } else if (e.key === 'Escape') {
                      setEditWalletName(editingWallet.name)
                      setIsEditingName(false)
                    }
                  }}
                />
                <div style={{ display: 'flex', gap: 8 }}>
                  <button
                    onClick={() => {
                      setEditWalletName(editingWallet.name)
                      setIsEditingName(false)
                    }}
                    style={{
                      flex: 1,
                      padding: '10px',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 8,
                      color: 'rgba(255, 255, 255, 0.6)',
                      fontSize: 13,
                      cursor: 'pointer'
                    }}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => {
                      if (editWalletName.trim()) {
                        const updatedAccounts = walletAccounts.map(acc => 
                          acc.publicKey === editingWallet.publicKey 
                            ? { ...acc, name: editWalletName.trim() }
                            : acc
                        )
                        setWalletAccounts(updatedAccounts)
                        setStoredAccounts(updatedAccounts)
                        setEditingWallet({ ...editingWallet, name: editWalletName.trim() })
                        setIsEditingName(false)
                        setStatus("Account name updated!")
                      }
                    }}
                    style={{
                      flex: 1,
                      padding: '10px',
                      background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                      border: 'none',
                      borderRadius: 8,
                      color: '#fff',
                      fontSize: 13,
                      fontWeight: 600,
                      cursor: 'pointer'
                    }}
                  >
                    Save
                  </button>
                </div>
              </div>
            ) : (
              <button
                onClick={() => setIsEditingName(true)}
                style={{
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  padding: '16px',
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer'
                }}
              >
                <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.7)' }}>Account Name</span>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <span style={{ fontSize: 14, color: '#fff' }}>{editingWallet.name}</span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2">
                    <path d="M12 20h9"/>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                  </svg>
                </div>
              </button>
            )}
            
            <div style={{ height: 1, background: 'rgba(255, 255, 255, 0.06)' }} />
            
            <button
              onClick={async () => {
                copyToClipboardSafe(editingWallet.publicKey)
                setStatus("Address copied!")
                setTimeout(() => setStatus(""), 2000)
              }}
              style={{
                width: '100%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '16px',
                background: 'none',
                border: 'none',
                cursor: 'pointer'
              }}
            >
              <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.7)' }}>Address</span>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                <span style={{ fontSize: 14, color: '#fff', fontFamily: 'monospace' }}>
                  {editingWallet.publicKey.slice(0, 4)}...{editingWallet.publicKey.slice(-4)}
                </span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                  <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                </svg>
              </div>
            </button>
            
            {/* Vault Address - Only show if this account has a vault */}
            {editingWalletVault && (
              <>
                <div style={{ height: 1, background: 'rgba(255, 255, 255, 0.06)' }} />
                <button
                  onClick={async () => {
                    copyToClipboardSafe(editingWalletVault.vaultPda)
                    setStatus("Vault address copied!")
                    setTimeout(() => setStatus(""), 2000)
                  }}
                  style={{
                    width: '100%',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '16px',
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer'
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                      <path d="M7 11V7a5 5 0 0110 0v4"/>
                    </svg>
                    <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.7)' }}>Vault Address</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 14, color: '#10b981', fontFamily: 'monospace' }}>
                      {editingWalletVault.vaultPda.slice(0, 4)}...{editingWalletVault.vaultPda.slice(-4)}
                    </span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(16, 185, 129, 0.5)" strokeWidth="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                      <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                    </svg>
                  </div>
                </button>
              </>
            )}
            
            {/* Loading indicator for vault check */}
            {loadingEditingWalletVault && (
              <>
                <div style={{ height: 1, background: 'rgba(255, 255, 255, 0.06)' }} />
                <div style={{ padding: '16px', display: 'flex', alignItems: 'center', gap: 8 }}>
                  <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.4)' }}>Checking vault...</span>
                </div>
              </>
            )}
          </div>

          {/* Security Layers Section - Only show if this account has a vault */}
          {editingWalletVault && (
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.06)',
            borderRadius: 12,
            marginBottom: 12,
            overflow: 'hidden'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <span style={{ fontSize: 13, fontWeight: 500, color: 'rgba(255, 255, 255, 0.9)' }}>Security Layers</span>
              </div>
              {loadingSecuritySettings && (
                <span style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.3)' }}>{t('loading', lang)}</span>
              )}
            </div>

            {/* Geo-Fence Layer (Always Active) */}
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between', 
              padding: '12px 16px',
              borderTop: '1px solid rgba(255, 255, 255, 0.06)',
              position: 'relative'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <div style={{
                  width: 32,
                  height: 32,
                  borderRadius: 8,
                  background: 'rgba(16, 185, 129, 0.1)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </div>
                <div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                    <span style={{ fontSize: 13, color: '#fff', fontWeight: 500 }}>Geo-Fence</span>
                    {/* Help icon with tooltip */}
                    <div 
                      style={{ position: 'relative', display: 'inline-flex', alignItems: 'center' }}
                      onMouseEnter={() => setShowGeoTooltip(true)}
                      onMouseLeave={() => setShowGeoTooltip(false)}
                    >
                      <div style={{
                        width: 14,
                        height: 14,
                        borderRadius: '50%',
                        background: 'rgba(255, 255, 255, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        cursor: 'help',
                        fontSize: 9,
                        fontWeight: 600,
                        color: 'rgba(255, 255, 255, 0.5)'
                      }}>
                        ?
                      </div>
                      {/* Tooltip */}
                      {showGeoTooltip && (
                        <div style={{
                          position: 'fixed',
                          top: '50%',
                          left: '50%',
                          transform: 'translate(-50%, -50%)',
                          padding: '12px 14px',
                          background: 'rgba(20, 20, 25, 0.98)',
                          border: '1px solid rgba(255, 255, 255, 0.15)',
                          borderRadius: 10,
                          fontSize: 11,
                          color: 'rgba(255, 255, 255, 0.85)',
                          width: 240,
                          lineHeight: 1.5,
                          zIndex: 99999,
                          boxShadow: '0 8px 32px rgba(0, 0, 0, 0.6)'
                        }}>
                          <div style={{ fontWeight: 600, color: '#f59e0b', marginBottom: 6, fontSize: 12 }}> Location Accuracy</div>
                          Browser geolocation can vary by several kilometers depending on your network and device. If your location appears inaccurate, use <span style={{ color: '#10b981', fontWeight: 600 }}>Recalibrate</span> to update to your current position.
                        </div>
                      )}
                    </div>
                  </div>
                  <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)' }}>
                    {securitySettings ? `${securitySettings.geoRange < 1 ? `${(securitySettings.geoRange * 1000).toFixed(0)}m` : `${securitySettings.geoRange.toFixed(1)}km`} range` : 'ZK encrypted coordinates'}
                  </div>
                </div>
              </div>
              {/* Recalibrate button */}
              <button
                onClick={async () => {
                  if (geoRecalibrationState.isRecalibrating) return
                  if (!editingWallet) return
                  
                  try {
                    // First, get the new location
                    setGeoRecalibrationState({ isRecalibrating: true, newLocation: null, error: null })
                    const location = await getBrowserLocation()
                    setGeoRecalibrationState(prev => ({ ...prev, newLocation: location }))
                    
                    // Check if 2FA Mobile is enabled - require verification
                    if (securitySettings?.wifiEnabled) {
                      // Need 2FA verification before recalibration
                      const { createMobileSession } = await import('./utils/qr-verify')
                      const { sessionId, qrData } = await createMobileSession(editingWallet.publicKey, 'recalibrate')
                      
                      setMobileQRModal({
                        show: true,
                        mode: 'verify',
                        layerType: 'wifi',
                        sessionId,
                        qrData,
                        status: 'pending',
                        publicKey: editingWallet.publicKey,
                        onVerified: async () => {
                          // After 2FA verification, update the home location
                          try {
                            await updateHomeLocation(editingWallet.publicKey, location.latitude, location.longitude)
                            setGeoRecalibrationState({ isRecalibrating: false, newLocation: null, error: null })
                            setSuccessModal({
                              show: true,
                              deviceName: 'Geo-Fence Location',
                              type: 'enabled',
                              deviceType: 'mobile'
                            })
                            setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'mobile' }), 3500)
                          } catch (e) {
                            setGeoRecalibrationState(prev => ({ ...prev, isRecalibrating: false, error: 'Failed to update location' }))
                          }
                        }
                      })
                    } else {
                      // No 2FA enabled - show warning and require password confirmation
                      setConfirmPassword("")
                      setConfirmPasswordError("")
                      setConfirmModal({
                        show: true,
                        title: 'Recalibrate Geo-Fence',
                        message: `Update your home location to your current position? This will change where transactions are allowed from.\n\nNew coordinates: ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}\nAccuracy: ${location.accuracy < 1000 ? `${location.accuracy.toFixed(0)}m` : `${(location.accuracy / 1000).toFixed(1)}km`}`,
                        confirmText: 'Recalibrate',
                        danger: false,
                        requirePassword: true,
                        onConfirm: async (password?: string) => {
                          if (!password) return
                          try {
                            // Verify password first
                            const { verifyServerPassword } = await import('./utils/api')
                            const isValid = await verifyServerPassword(editingWallet.publicKey, password)
                            if (!isValid) {
                              setConfirmPasswordError('Incorrect password')
                              return
                            }
                            
                            // Update location
                            await updateHomeLocation(editingWallet.publicKey, location.latitude, location.longitude)
                            setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                            setGeoRecalibrationState({ isRecalibrating: false, newLocation: null, error: null })
                            setSuccessModal({
                              show: true,
                              deviceName: 'Geo-Fence Location',
                              type: 'enabled',
                              deviceType: 'mobile'
                            })
                            setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'mobile' }), 3500)
                          } catch (e: any) {
                            setConfirmPasswordError(e.message || 'Failed to update location')
                          }
                        }
                      })
                      setGeoRecalibrationState(prev => ({ ...prev, isRecalibrating: false }))
                    }
                  } catch (e: any) {
                    console.error('[Geo Recalibrate] Error:', e)
                    setGeoRecalibrationState({ isRecalibrating: false, newLocation: null, error: e.message || 'Failed to get location' })
                  }
                }}
                disabled={geoRecalibrationState.isRecalibrating}
                style={{
                  padding: '4px 10px',
                  background: 'transparent',
                  border: '1px solid rgba(255, 255, 255, 0.15)',
                  borderRadius: 6,
                  fontSize: 10,
                  color: geoRecalibrationState.isRecalibrating ? 'rgba(255, 255, 255, 0.3)' : 'rgba(255, 255, 255, 0.7)',
                  fontWeight: 500,
                  cursor: geoRecalibrationState.isRecalibrating ? 'wait' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: 5,
                  transition: 'all 0.2s ease'
                }}
              >
                {geoRecalibrationState.isRecalibrating ? (
                  <>
                    <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" style={{ animation: 'spin 1s linear infinite' }}>
                      <circle cx="12" cy="12" r="10" strokeDasharray="60" strokeDashoffset="20" />
                    </svg>
                    Calibrating...
                  </>
                ) : (
                  <>
                    <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2.5">
                      <path d="M23 4v6h-6"/>
                      <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Recalibrate
                  </>
                )}
              </button>
            </div>

            {/* 2FA Mobile (WiFi BSSID) Layer */}
            {FEATURES.MOBILE_2FA_LAYER ? (
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between', 
              padding: '12px 16px',
              borderTop: '1px solid rgba(255, 255, 255, 0.06)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <div style={{
                  width: 32,
                  height: 32,
                  borderRadius: 8,
                  background: securitySettings?.wifiEnabled ? 'rgba(168, 85, 247, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.wifiEnabled ? '#a855f7' : 'rgba(255,255,255,0.4)'} strokeWidth="2">
                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                    <path d="M12 18h.01"/>
                  </svg>
                </div>
                <div>
                  <div style={{ fontSize: 13, color: '#fff', fontWeight: 500 }}>2FA Mobile</div>
                  <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.3)' }}>
                    {securitySettings?.wifiEnabled && securitySettings?.wifiDevice 
                      ? `${securitySettings.wifiDevice.ssid || 'WiFi'} verified`
                      : 'Mobile ID + WiFi BSSID'}
                  </div>
                </div>
              </div>
              <button
                onClick={async () => {
                  if (updatingSecurityLayer) return
                  
                  if (securitySettings?.wifiEnabled) {
                    // Disable 2FA Mobile - requires password
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: 'Disable 2FA Mobile',
                      message: 'Enter this wallet\'s password to disable 2FA Mobile verification.',
                      confirmText: 'Disable',
                      danger: true,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError("Password is required")
                          return
                        }
                        try {
                          // PWA: Verify password locally first, fall back to server
                          const localValid = await verifyLocalPassword(password)
                          const serverResult = !localValid ? await verifyServerPassword(editingWallet.publicKey, password) : { success: true }
                          if (localValid || serverResult.success) {
                            setUpdatingSecurityLayer('wifi')
                            const deviceName = securitySettings?.wifiDevice?.ssid || '2FA Mobile'
                            await updateSecurityLayer(editingWallet.publicKey, 'wifi', false)
                            setSecuritySettings(prev => prev ? { ...prev, wifiEnabled: false, wifiDevice: null } : null)
                            setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                            setSuccessModal({ show: true, deviceName: deviceName, type: 'disabled', deviceType: 'mobile' })
                            setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                          } else {
                            setConfirmPasswordError("Incorrect password")
                          }
                        } catch (error: any) {
                          setConfirmPasswordError(error.message || "Failed to update")
                        } finally {
                          setUpdatingSecurityLayer(null)
                        }
                      }
                    })
                  } else {
                    // Enable 2FA Mobile - requires password first
                    const passwordCheck = await checkServerPassword(editingWallet?.publicKey || '')
                    
                    if (!passwordCheck.hasPassword) {
                      setVaultPasswordSetup({
                        show: true,
                        publicKey: editingWallet?.publicKey || '',
                        password: '',
                        confirmPassword: '',
                        error: '',
                        isSubmitting: false,
                        layerToEnable: 'wifi'
                      })
                      return
                    }
                    
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: 'Set Up 2FA Mobile',
                      message: 'Enter this wallet\'s password to configure mobile 2FA verification.',
                      confirmText: 'Continue',
                      danger: false,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError("Password is required")
                          return
                        }
                        try {
                          // PWA: Verify password against server API with wallet's public key
                          const response = await verifyServerPassword(editingWallet.publicKey, password)
                          if (!response.success) {
                            setConfirmPasswordError("Incorrect password")
                            return
                          }
                          
                          setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                          
                          // Now show QR code modal
                          const { createMobileSession } = await import('./utils/qr-verify')
                          const session = await createMobileSession(editingWallet.publicKey, 'setup')
                          if (session) {
                            setMobileQRModal({
                              show: true,
                              mode: 'setup',
                              layerType: 'wifi',
                              sessionId: session.sessionId,
                              qrData: session.qrData,
                              status: 'pending',
                              publicKey: editingWallet.publicKey
                            })
                          }
                        } catch (error: any) {
                          setConfirmPasswordError(error.message || "Failed to verify password")
                        }
                      }
                    })
                  }
                }}
                disabled={updatingSecurityLayer === 'wifi'}
                style={{
                  padding: '6px 12px',
                  background: securitySettings?.wifiEnabled ? 'rgba(239, 68, 68, 0.1)' : 'rgba(168, 85, 247, 0.1)',
                  border: `1px solid ${securitySettings?.wifiEnabled ? 'rgba(239, 68, 68, 0.2)' : 'rgba(168, 85, 247, 0.2)'}`,
                  borderRadius: 8,
                  fontSize: 11,
                  color: securitySettings?.wifiEnabled ? '#ef4444' : '#a855f7',
                  fontWeight: 600,
                  cursor: updatingSecurityLayer === 'wifi' ? 'not-allowed' : 'pointer',
                  opacity: updatingSecurityLayer === 'wifi' ? 0.5 : 1
                }}
              >
                {updatingSecurityLayer === 'wifi' ? '...' : (securitySettings?.wifiEnabled ? 'Disable' : 'Enable')}
              </button>
            </div>
            ) : (
              <ComingSoonLayerRow
                icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><path d="M12 18h.01"/></svg>}
                title="2FA Mobile"
                subtitle="Mobile ID + WiFi BSSID"
              />
            )}

            {/* Bluetooth Layer */}
            {FEATURES.BLUETOOTH_LAYER ? (
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between', 
              padding: '12px 16px',
              borderTop: '1px solid rgba(255, 255, 255, 0.06)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <div style={{
                  width: 32,
                  height: 32,
                  borderRadius: 8,
                  background: securitySettings?.bluetoothEnabled ? 'rgba(59, 130, 246, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.bluetoothEnabled ? '#3b82f6' : 'rgba(255,255,255,0.4)'} strokeWidth="2">
                    <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
                  </svg>
                </div>
                <div>
                  <div style={{ fontSize: 13, color: '#fff', fontWeight: 500 }}>Bluetooth</div>
                  <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)' }}>
                    {securitySettings?.bluetoothEnabled && securitySettings?.bluetoothDevice 
                      ? securitySettings.bluetoothDevice.name || 'Paired Device'
                      : 'Not configured'}
                  </div>
                </div>
              </div>
              <button
                onClick={async () => {
                  console.log('[Bluetooth] Button clicked, updatingSecurityLayer:', updatingSecurityLayer)
                  console.log('[Bluetooth] securitySettings?.bluetoothEnabled:', securitySettings?.bluetoothEnabled)
                  
                  if (updatingSecurityLayer) return
                  
                  if (securitySettings?.bluetoothEnabled) {
                    // Disable Bluetooth - requires password
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: 'Disable Bluetooth',
                      message: 'Enter this wallet\'s password to disable Bluetooth security layer.',
                      confirmText: 'Disable',
                      danger: true,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError("Password is required")
                          return
                        }
                        try {
                          // PWA: Verify password against server API with wallet's public key
                          const response = await verifyServerPassword(editingWallet.publicKey, password)
                          if (response.success) {
                            setUpdatingSecurityLayer('bluetooth')
                            const deviceName = securitySettings?.bluetoothDevice?.name || 'Bluetooth Device'
                            await updateSecurityLayer(editingWallet.publicKey, 'bluetooth', false)
                            setSecuritySettings(prev => prev ? { ...prev, bluetoothEnabled: false, bluetoothDevice: null } : null)
                            setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                            setSuccessModal({ show: true, deviceName: deviceName, type: 'disabled', deviceType: 'bluetooth' })
                            setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                          } else {
                            setConfirmPasswordError("Incorrect password")
                          }
                        } catch (error: any) {
                          setConfirmPasswordError(error.message || "Failed to update")
                        } finally {
                          setUpdatingSecurityLayer(null)
                        }
                      }
                    })
                  } else {
                    // Enable Bluetooth - Open dedicated setup tab (most reliable for Bluetooth picker)
                    // PWA: Bluetooth setup requires extension context
                    if (!isExtensionContext()) {
                      setStatus('Bluetooth setup is only available in the browser extension')
                      setTimeout(() => setStatus(''), 3000)
                      return
                    }
                    const publicKey = editingWallet.publicKey
                    
                    chrome.tabs.create({
                      url: chrome.runtime.getURL(`tabs/bluetooth-setup/index.html?publicKey=${encodeURIComponent(publicKey)}`),
                      active: true
                    })
                  }
                }}
                disabled={updatingSecurityLayer === 'bluetooth'}
                style={{
                  padding: '6px 12px',
                  background: securitySettings?.bluetoothEnabled ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)',
                  border: `1px solid ${securitySettings?.bluetoothEnabled ? 'rgba(239, 68, 68, 0.2)' : 'rgba(59, 130, 246, 0.2)'}`,
                  borderRadius: 8,
                  fontSize: 11,
                  color: securitySettings?.bluetoothEnabled ? '#ef4444' : '#3b82f6',
                  fontWeight: 600,
                  cursor: updatingSecurityLayer === 'bluetooth' ? 'not-allowed' : 'pointer',
                  opacity: updatingSecurityLayer === 'bluetooth' ? 0.5 : 1
                }}
              >
                {updatingSecurityLayer === 'bluetooth' ? '...' : (securitySettings?.bluetoothEnabled ? 'Disable' : 'Enable')}
              </button>
            </div>
            ) : (
              <ComingSoonLayerRow
                icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2"><path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/></svg>}
                title="Bluetooth"
                subtitle="Not configured"
              />
            )}

            {/* USB Device Layer */}
            {FEATURES.USB_LAYER ? (
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between', 
              padding: '12px 16px',
              borderTop: '1px solid rgba(255, 255, 255, 0.06)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <div style={{
                  width: 32,
                  height: 32,
                  borderRadius: 8,
                  background: securitySettings?.usbEnabled ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.usbEnabled ? '#10b981' : 'rgba(255,255,255,0.4)'} strokeWidth="2">
                    <path d="M12 18v-6"/>
                    <path d="M8 18v-1"/>
                    <path d="M16 18v-1"/>
                    <rect x="6" y="18" width="12" height="4" rx="1"/>
                    <path d="M12 12l-4-4h8l-4 4z"/>
                    <path d="M12 2v6"/>
                    <circle cx="12" cy="5" r="1"/>
                  </svg>
                </div>
                <div>
                  <div style={{ fontSize: 13, color: '#fff', fontWeight: 500 }}>USB Key</div>
                  <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)' }}>
                    {securitySettings?.usbEnabled && securitySettings?.usbDevice 
                      ? securitySettings.usbDevice.productName || `Device ${securitySettings.usbDevice.vendorId?.toString(16)}:${securitySettings.usbDevice.productId?.toString(16)}`
                      : 'Not configured'}
                  </div>
                </div>
              </div>
              <button
                onClick={async () => {
                  if (updatingSecurityLayer) return
                  
                  if (securitySettings?.usbEnabled) {
                    // Disable USB - requires password
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: 'Disable USB Key',
                      message: 'Enter this wallet\'s password to disable USB key security layer.',
                      confirmText: 'Disable',
                      danger: true,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError("Password is required")
                          return
                        }
                        try {
                          // PWA: Verify password against server API with wallet's public key
                          const response = await verifyServerPassword(editingWallet.publicKey, password)
                          if (response.success) {
                            setUpdatingSecurityLayer('usb')
                            // Get device name before disabling
                            const deviceName = securitySettings?.usbDevice?.productName || 'USB Device'
                            await updateSecurityLayer(editingWallet.publicKey, 'usb', false)
                            setSecuritySettings(prev => prev ? { ...prev, usbEnabled: false, usbDevice: null } : null)
                            setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                            // Show beautiful disabled modal
                            setSuccessModal({ show: true, deviceName: deviceName, type: 'disabled', deviceType: 'usb' })
                            // Auto-close after 3 seconds
                            setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                          } else {
                            setConfirmPasswordError("Incorrect password")
                          }
                        } catch (error: any) {
                          setConfirmPasswordError(error.message || "Failed to update")
                        } finally {
                          setUpdatingSecurityLayer(null)
                        }
                      }
                    })
                  } else {
                    // Enable USB - Open dedicated setup tab (most reliable for USB picker)
                    // PWA: USB setup requires extension context
                    if (!isExtensionContext()) {
                      setStatus('USB key setup is only available in the browser extension')
                      setTimeout(() => setStatus(''), 3000)
                      return
                    }
                    const publicKey = editingWallet.publicKey
                    
                    chrome.tabs.create({
                      url: chrome.runtime.getURL(`tabs/usb-setup/index.html?publicKey=${encodeURIComponent(publicKey)}`),
                      active: true
                    })
                  }
                }}
                disabled={updatingSecurityLayer === 'usb'}
                style={{
                  padding: '6px 12px',
                  background: securitySettings?.usbEnabled ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)',
                  border: `1px solid ${securitySettings?.usbEnabled ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)'}`,
                  borderRadius: 8,
                  fontSize: 11,
                  color: securitySettings?.usbEnabled ? '#ef4444' : '#10b981',
                  fontWeight: 600,
                  cursor: updatingSecurityLayer === 'usb' ? 'not-allowed' : 'pointer',
                  opacity: updatingSecurityLayer === 'usb' ? 0.5 : 1
                }}
              >
                {updatingSecurityLayer === 'usb' ? '...' : (securitySettings?.usbEnabled ? 'Disable' : 'Enable')}
              </button>
            </div>
            ) : (
              <ComingSoonLayerRow
                icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2"><path d="M12 18v-6"/><path d="M8 18v-1"/><path d="M16 18v-1"/><rect x="6" y="18" width="12" height="4" rx="1"/><path d="M12 12l-4-4h8l-4 4z"/><path d="M12 2v6"/><circle cx="12" cy="5" r="1"/></svg>}
                title="USB Key"
                subtitle="Not configured"
              />
            )}

            {/* Biometric Layer (FaceID/TouchID) */}
            {FEATURES.BIOMETRIC_LAYER ? (
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between', 
              padding: '12px 16px',
              borderTop: '1px solid rgba(255, 255, 255, 0.06)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <div style={{
                  width: 32,
                  height: 32,
                  borderRadius: 8,
                  background: securitySettings?.biometricEnabled ? 'rgba(236, 72, 153, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.biometricEnabled ? '#ec4899' : 'rgba(255,255,255,0.4)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                  </svg>
                </div>
                <div>
                  <div style={{ fontSize: 13, color: '#fff', fontWeight: 500 }}>Biometric</div>
                  <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.3)' }}>
                    {securitySettings?.biometricEnabled 
                      ? 'FaceID / TouchID'
                      : 'FaceID / TouchID'}
                  </div>
                </div>
              </div>
              <button
                onClick={async () => {
                  if (updatingSecurityLayer) return
                  
                  if (securitySettings?.biometricEnabled) {
                    // Disable Biometric - verify with biometric itself (not password)
                    setUpdatingSecurityLayer('biometric')
                    try {
                      const { verifyBiometric, removeBiometric } = await import('./utils/native-biometric')
                      
                      // Verify with Face ID/Touch ID before disabling
                      const verifyResult = await verifyBiometric(editingWallet.publicKey)
                      
                      if (verifyResult.success) {
                        // Biometric verified - now disable it
                        removeBiometric(editingWallet.publicKey)
                        await updateSecurityLayer(editingWallet.publicKey, 'biometric', false)
                        setSecuritySettings(prev => prev ? { ...prev, biometricEnabled: false, biometricCredentialId: null } : null)
                        setSuccessModal({ show: true, deviceName: 'Biometric', type: 'disabled', deviceType: 'biometric' })
                        setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                      } else {
                        // Verification failed or cancelled
                        setStatus(verifyResult.error || 'Biometric verification failed')
                        setTimeout(() => setStatus(''), 3000)
                      }
                    } catch (error: any) {
                      console.error('[Biometric] Disable error:', error)
                      setStatus(error.message || 'Failed to verify biometric')
                      setTimeout(() => setStatus(''), 3000)
                    } finally {
                      setUpdatingSecurityLayer(null)
                    }
                  } else {
                    // Enable Biometric - requires password first
                    const passwordCheck = await checkServerPassword(editingWallet?.publicKey || '')
                    
                    if (!passwordCheck.hasPassword) {
                      setVaultPasswordSetup({
                        show: true,
                        publicKey: editingWallet?.publicKey || '',
                        password: '',
                        confirmPassword: '',
                        error: '',
                        isSubmitting: false,
                        layerToEnable: 'biometric'
                      })
                      return
                    }
                    
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: 'Set Up Biometric',
                      message: 'Enter this wallet\'s password to configure FaceID/TouchID verification.',
                      confirmText: 'Continue',
                      danger: false,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError("Password is required")
                          return
                        }
                        try {
                          // PWA: Verify password against server API with wallet's public key
                          const response = await verifyServerPassword(editingWallet.publicKey, password)
                          if (!response.success) {
                            setConfirmPasswordError("Incorrect password")
                            return
                          }
                          
                          setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                          
                          // Use native biometric enrollment (Face ID / Touch ID)
                          setUpdatingSecurityLayer('biometric')
                          try {
                            const { enrollBiometric, isBiometricAvailable } = await import('./utils/native-biometric')
                            
                            // Check if device supports biometrics
                            const available = await isBiometricAvailable()
                            if (!available) {
                              setSuccessModal({ show: true, deviceName: 'Face ID/Touch ID not available on this device', type: 'disabled', deviceType: 'biometric' })
                              setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                              return
                            }
                            
                            // Enroll biometric
                            const result = await enrollBiometric(editingWallet.publicKey)
                            if (result.success) {
                              await updateSecurityLayer(editingWallet.publicKey, 'biometric', true)
                              setSecuritySettings(prev => prev ? { ...prev, biometricEnabled: true, biometricCredentialId: result.credentialId || null } : null)
                              setSuccessModal({ show: true, deviceName: 'Face ID', type: 'enabled', deviceType: 'biometric' })
                              setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                            } else {
                              setSuccessModal({ show: true, deviceName: result.error || 'Enrollment failed', type: 'disabled', deviceType: 'biometric' })
                              setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                            }
                          } catch (e: any) {
                            setSuccessModal({ show: true, deviceName: e.message || 'Enrollment failed', type: 'disabled', deviceType: 'biometric' })
                            setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                          } finally {
                            setUpdatingSecurityLayer(null)
                          }
                        } catch (error: any) {
                          setConfirmPasswordError(error.message || "Failed to verify password")
                        }
                      }
                    })
                  }
                }}
                disabled={updatingSecurityLayer === 'biometric'}
                style={{
                  padding: '6px 12px',
                  background: securitySettings?.biometricEnabled ? 'rgba(239, 68, 68, 0.1)' : 'rgba(236, 72, 153, 0.1)',
                  border: `1px solid ${securitySettings?.biometricEnabled ? 'rgba(239, 68, 68, 0.2)' : 'rgba(236, 72, 153, 0.2)'}`,
                  borderRadius: 8,
                  fontSize: 11,
                  color: securitySettings?.biometricEnabled ? '#ef4444' : '#ec4899',
                  fontWeight: 600,
                  cursor: updatingSecurityLayer === 'biometric' ? 'not-allowed' : 'pointer',
                  opacity: updatingSecurityLayer === 'biometric' ? 0.5 : 1
                }}
              >
                {updatingSecurityLayer === 'biometric' ? '...' : (securitySettings?.biometricEnabled ? 'Disable' : 'Enable')}
              </button>
            </div>
            ) : (
              <ComingSoonLayerRow
                icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>}
                title="Biometric"
                subtitle="FaceID / TouchID"
              />
            )}

            {/* Voice Layer for Transactions (separate from wallet unlock) */}
            {FEATURES.VOICE_LAYER ? (
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'space-between', 
              padding: '12px 16px',
              borderTop: '1px solid rgba(255, 255, 255, 0.06)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <div style={{
                  width: 32,
                  height: 32,
                  borderRadius: 8,
                  background: securitySettings?.voiceLayerEnabled ? 'rgba(34, 197, 94, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.voiceLayerEnabled ? '#22c55e' : 'rgba(255,255,255,0.4)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                  </svg>
                </div>
                <div>
                  <div style={{ fontSize: 13, color: '#fff', fontWeight: 500 }}>Voice Layer</div>
                  <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.3)' }}>
                    {securitySettings?.voiceLayerEnabled 
                      ? 'Required for transactions'
                      : 'Record voice phrase for security'}
                  </div>
                </div>
              </div>
              <button
                onClick={async () => {
                  console.log('[Voice Layer] Button clicked, updatingSecurityLayer:', updatingSecurityLayer)
                  console.log('[Voice Layer] securitySettings:', securitySettings)
                  console.log('[Voice Layer] editingWallet:', editingWallet?.publicKey)
                  
                  if (updatingSecurityLayer) return
                  
                  // Check if voice is enrolled for this wallet (voiceEnrolled from API)
                  console.log('[Voice Layer] voiceEnrolled:', securitySettings?.voiceEnrolled, 'voiceLayerEnabled:', securitySettings?.voiceLayerEnabled)
                  
                  if (!securitySettings?.voiceEnrolled && !securitySettings?.voiceLayerEnabled) {
                    console.log('[Voice Layer] Entering enrollment flow (voice not enrolled)')
                    // Voice not enrolled - start voice enrollment for this wallet
                    // First check if wallet has a password set on server
                    try {
                      const passwordCheck = await checkServerPassword(editingWallet?.publicKey || '')
                      console.log('[Voice Layer] Password check result:', passwordCheck)
                    
                    if (!passwordCheck.hasPassword) {
                      // No password on server - need to set one first
                      setVaultPasswordSetup({
                        show: true,
                        publicKey: editingWallet?.publicKey || '',
                        password: '',
                        confirmPassword: '',
                        error: '',
                        isSubmitting: false,
                        layerToEnable: 'voice'
                      })
                      return
                    }
                    
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: 'Set Up Voice for This Wallet',
                      message: 'Enter this wallet\'s password to set up voice verification for transactions.',
                      confirmText: 'Continue',
                      danger: false,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError("Password is required")
                          return
                        }
                        try {
                          // PWA: Verify password against server API with wallet's public key
                          const response = await verifyServerPassword(editingWallet.publicKey, password)
                          if (!response.success) {
                            setConfirmPasswordError("Incorrect password")
                            return
                          }
                          
                          // Close modal and show voice enrollment modal
                          setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                          
                          // Open voice enrollment modal for this wallet
                          setVoiceEnrollmentModal({
                            show: true,
                            mode: 'enroll',
                            walletAddress: editingWallet?.publicKey || ''
                          })
                        } catch (error: any) {
                          setConfirmPasswordError(error.message || "Failed to set up voice")
                        } finally {
                          setUpdatingSecurityLayer(null)
                        }
                      }
                    })
                    return
                    } catch (error: any) {
                      console.error('[Voice Layer] Error in enrollment flow:', error)
                      setStatus('Error: ' + (error.message || 'Failed to set up voice'))
                      setTimeout(() => setStatus(''), 3000)
                      return
                    }
                  }
                  
                  if (securitySettings?.voiceLayerEnabled) {
                    console.log('[Voice Layer] Entering disable flow - verify with voice')
                    // Disable Voice Layer - verify with voice itself (not password)
                    
                    try {
                      // Get the user's voice fingerprint from server
                      const fpResult = await getVoiceFingerprint(editingWallet.publicKey)
                      
                      if (!fpResult.fingerprint) {
                        // No fingerprint on server - just disable
                        setUpdatingSecurityLayer('voice')
                        await updateSecurityLayer(editingWallet.publicKey, 'voice', false)
                        setSecuritySettings(prev => prev ? { ...prev, voiceLayerEnabled: false } : null)
                        setSuccessModal({ show: true, deviceName: 'Voice Layer', type: 'disabled', deviceType: 'voice' })
                        setTimeout(() => setSuccessModal({ show: false, deviceName: '', type: 'enabled', deviceType: 'usb' }), 3500)
                        setUpdatingSecurityLayer(null)
                        return
                      }
                      
                      // Open voice verification modal with enrolled fingerprint
                      setVoiceEnrollmentModal({
                        show: true,
                        mode: 'verify-to-disable',
                        walletAddress: editingWallet.publicKey,
                        enrolledFingerprint: fpResult.fingerprint
                      })
                    } catch (error: any) {
                      console.error('[Voice Layer] Disable error:', error)
                      setStatus(error.message || 'Failed to verify voice')
                      setTimeout(() => setStatus(''), 3000)
                    }
                  } else {
                    // Enable Voice Layer - ALWAYS requires re-recording the phrase
                    // The new fingerprint will overwrite the old one on the server
                    console.log('[Voice Layer] Entering enable flow - requires voice recording')
                    
                    const passwordCheck = await checkServerPassword(editingWallet?.publicKey || '')
                    
                    if (!passwordCheck.hasPassword) {
                      setVaultPasswordSetup({
                        show: true,
                        publicKey: editingWallet?.publicKey || '',
                        password: '',
                        confirmPassword: '',
                        error: '',
                        isSubmitting: false,
                        layerToEnable: 'voice'
                      })
                      return
                    }
                    
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: 'Set Up Voice Layer',
                      message: 'Enter this wallet\'s password to record your voice phrase for transaction security.',
                      confirmText: 'Continue',
                      danger: false,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError("Password is required")
                          return
                        }
                        try {
                          // PWA: Verify password against server API with wallet's public key
                          const response = await verifyServerPassword(editingWallet.publicKey, password)
                          if (!response.success) {
                            setConfirmPasswordError("Incorrect password")
                            return
                          }
                          
                          setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                          
                          // Open voice enrollment modal - will overwrite any existing fingerprint
                          setVoiceEnrollmentModal({
                            show: true,
                            mode: 'enroll',
                            walletAddress: editingWallet?.publicKey || ''
                          })
                        } catch (error: any) {
                          setConfirmPasswordError(error.message || "Failed to set up voice")
                        } finally {
                          setUpdatingSecurityLayer(null)
                        }
                      }
                    })
                  }
                }}
                style={{
                  padding: '6px 12px',
                  background: securitySettings?.voiceLayerEnabled ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                  border: `1px solid ${securitySettings?.voiceLayerEnabled ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)'}`,
                  borderRadius: 8,
                  fontSize: 11,
                  color: securitySettings?.voiceLayerEnabled ? '#ef4444' : '#22c55e',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                {securitySettings?.voiceLayerEnabled ? 'Disable' : 'Set Up'}
              </button>
            </div>
            ) : (
              <ComingSoonLayerRow
                icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>}
                title="Voice Layer"
                subtitle="Record voice phrase for security"
              />
            )}
          </div>
          )}

          {/* Show Private Key - Only for non-watch-only wallets */}
          {!editingWallet.isWatchOnly && (
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.06)',
            borderRadius: 12,
            marginBottom: 12,
            overflow: 'hidden'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                  <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                </svg>
                <span style={{ fontSize: 13, fontWeight: 500, color: 'rgba(255, 255, 255, 0.9)' }}>{t('privateKey', lang)}</span>
              </div>
              <span style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.3)', fontWeight: 500 }}>BASE58</span>
            </div>

            {showEditPrivateKey ? (
              <div style={{ padding: '0 16px 12px 16px' }}>
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 8,
                  padding: 12,
                  fontSize: 11,
                  fontFamily: 'monospace',
                  color: 'rgba(255, 255, 255, 0.8)',
                  wordBreak: 'break-all',
                  marginBottom: 12
                }}>
                  {editingWallet.secretKey}
                </div>
                <div style={{ display: 'flex', gap: 8 }}>
                  <button
                    onClick={() => setShowEditPrivateKey(false)}
                    style={{
                      flex: 1,
                      padding: '10px',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 8,
                      color: '#fff',
                      fontSize: 12,
                      cursor: 'pointer'
                    }}
                  >
                    {t('hideKey', lang)}
                  </button>
                  <button
                    onClick={copyPrivateKey}
                    style={{
                      flex: 1,
                      padding: '10px',
                      background: copiedKey ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 255, 255, 0.05)',
                      border: copiedKey ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 8,
                      color: copiedKey ? '#10b981' : '#fff',
                      fontSize: 12,
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                  >
                    {copiedKey ? t('copied', lang) : t('copyKey', lang)}
                  </button>
                </div>
              </div>
            ) : (
              <div style={{ padding: '0 16px 12px 16px' }}>
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 8,
                  padding: '8px 12px',
                  marginBottom: 12,
                  position: 'relative',
                  overflow: 'hidden',
                  height: 32
                }}>
                  <SecretParticles height={32} />
                </div>
                <button
                  onClick={() => {
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: t('revealPrivateKey', lang),
                      message: 'Enter this wallet\'s password to reveal your private key.',
                      confirmText: t('reveal', lang),
                      danger: false,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError(t('passwordRequired', lang))
                          return
                        }
                        try {
                          // PWA: Verify password against server API with wallet's public key
                          const response = await verifyServerPassword(editingWallet.publicKey, password)
                          if (response.success) {
                            setShowEditPrivateKey(true)
                            setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                          } else {
                            setConfirmPasswordError(t('incorrectPassword', lang))
                          }
                        } catch (error) {
                          setConfirmPasswordError(t('incorrectPassword', lang))
                        }
                      }
                    })
                  }}
                  style={{
                    width: '100%',
                    padding: '10px',
                    background: 'rgba(255, 255, 255, 0.1)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 8,
                    color: '#fff',
                    fontSize: 12,
                    fontWeight: 600,
                    cursor: 'pointer'
                  }}
                >
                  {t('revealKey', lang)}
                </button>
              </div>
            )}
          </div>
          )}

          {/* Seed Phrase Section - Only for non-watch-only wallets */}
          {!editingWallet.isWatchOnly && (
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.06)',
            borderRadius: 12,
            marginBottom: 12,
            overflow: 'hidden'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0110 0v4"/>
                </svg>
                <span style={{ fontSize: 13, fontWeight: 500, color: 'rgba(255, 255, 255, 0.9)' }}>{t('recoveryPhrase', lang)}</span>
              </div>
              <span style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.3)', fontWeight: 500 }}>12 {t('words', lang).toUpperCase()}</span>
            </div>

            {showSeedPhrase && seedPhrase ? (
              <div style={{ padding: '0 16px 12px 16px' }}>
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 8,
                  padding: 12,
                  marginBottom: 12
                }}>
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(3, 1fr)',
                    gap: 6
                  }}>
                    {seedPhrase.split(' ').map((word, i) => (
                      <div key={i} style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 4,
                        padding: '4px 6px',
                        background: 'rgba(255, 255, 255, 0.03)',
                        borderRadius: 4,
                        fontSize: 10
                      }}>
                        <span style={{ color: 'rgba(255, 255, 255, 0.3)', fontWeight: 500, minWidth: 14 }}>{i + 1}.</span>
                        <span style={{ color: 'rgba(255, 255, 255, 0.9)' }}>{word}</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div style={{ display: 'flex', gap: 8 }}>
                  <button
                    onClick={() => {
                      setShowSeedPhrase(false)
                      setSeedPhrase("")
                    }}
                    style={{
                      flex: 1,
                      padding: '10px',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 8,
                      color: '#fff',
                      fontSize: 12,
                      cursor: 'pointer'
                    }}
                  >
                    {t('hidePhrase', lang)}
                  </button>
                  <button
                    onClick={async () => {
                      copyToClipboardSafe(seedPhrase)
                      setCopiedSeed(true)
                      setTimeout(() => setCopiedSeed(false), 2000)
                    }}
                    style={{
                      flex: 1,
                      padding: '10px',
                      background: copiedSeed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 255, 255, 0.05)',
                      border: copiedSeed ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 8,
                      color: copiedSeed ? '#10b981' : '#fff',
                      fontSize: 12,
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                  >
                    {copiedSeed ? t('copied', lang) : t('copySeedPhrase', lang)}
                  </button>
                </div>
              </div>
            ) : (
              <div style={{ padding: '0 16px 12px 16px' }}>
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 8,
                  padding: '8px 12px',
                  marginBottom: 12,
                  position: 'relative',
                  overflow: 'hidden',
                  height: 32
                }}>
                  <SecretParticles height={32} />
                </div>
                <button
                  onClick={() => {
                    setConfirmPassword("")
                    setConfirmPasswordError("")
                    setConfirmModal({
                      show: true,
                      title: t('revealRecoveryPhrase', lang),
                      message: 'Enter this wallet\'s password to reveal your recovery phrase.',
                      confirmText: t('reveal', lang),
                      danger: false,
                      requirePassword: true,
                      onConfirm: async (password?: string) => {
                        if (!password) {
                          setConfirmPasswordError(t('passwordRequired', lang))
                          return
                        }
                        try {
                          // PWA: Verify password against server API with wallet's public key
                          const response = await verifyServerPassword(editingWallet.publicKey, password)
                          if (response.success) {
                            // PWA: Get the seed phrase from localStorage
                            const storedMnemonic = getMnemonic()
                            if (storedMnemonic) {
                              setSeedPhrase(storedMnemonic)
                              setShowSeedPhrase(true)
                              setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                            } else {
                              setConfirmPasswordError(t('incorrectPassword', lang))
                            }
                          } else {
                            setConfirmPasswordError(t('incorrectPassword', lang))
                          }
                        } catch (error) {
                          setConfirmPasswordError(t('incorrectPassword', lang))
                        }
                      }
                    })
                  }}
                  style={{
                    width: '100%',
                    padding: '10px',
                    background: 'rgba(255, 255, 255, 0.1)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 8,
                    color: '#fff',
                    fontSize: 12,
                    fontWeight: 600,
                    cursor: 'pointer'
                  }}
                >
                  {t('revealPhrase', lang)}
                </button>
              </div>
            )}
          </div>
          )}

          {/* Delete Account */}
          <button
            onClick={deleteWallet}
            disabled={walletAccounts.length <= 1}
            style={{
              width: '100%',
              padding: '16px',
              background: 'none',
              border: '1px solid rgba(239, 68, 68, 0.3)',
              borderRadius: 12,
              color: walletAccounts.length <= 1 ? 'rgba(239, 68, 68, 0.3)' : '#ef4444',
              fontSize: 14,
              cursor: walletAccounts.length <= 1 ? 'not-allowed' : 'pointer',
              transition: 'all 0.2s',
              marginBottom: walletAccounts.length <= 1 ? 0 : 24
            }}
          >
            Remove Account
          </button>
          
          {walletAccounts.length <= 1 && (
            <div style={{ 
              fontSize: 11, 
              color: 'rgba(255, 255, 255, 0.3)', 
              textAlign: 'center',
              marginTop: 8,
              marginBottom: 24
            }}>
              Cannot remove the only account
            </div>
          )}
        </div>

        {/* Status */}
        {status && (
          <div style={{
            position: 'fixed',
            bottom: 20,
            left: 20,
            right: 20,
            padding: '12px 16px',
            background: 'rgba(16, 185, 129, 0.2)',
            border: '1px solid rgba(16, 185, 129, 0.3)',
            borderRadius: 12,
            color: '#10b981',
            fontSize: 13,
            textAlign: 'center'
          }}>
            {status}
          </div>
        )}
      </div>
    )
  }

  if (view === "send") {
    // Create SOL token data for display
    const solTokenData: TokenData = {
      mint: "So11111111111111111111111111111111111111112",
      symbol: "SOL",
      name: "Solana",
      amount: activeWallet === "master" ? balance : vaultBalance,
      decimals: 9,
      price: solPrice,
      value: (activeWallet === "master" ? balance : vaultBalance) * solPrice,
      logoURI: "https://assets.coingecko.com/coins/images/4128/standard/solana.png"
    }
    
    // All available tokens including SOL
    const allTokensForSend = [solTokenData, ...tokens].filter(t => t.amount > 0)
    const filteredTokensForSend = tokenSearchQuery 
      ? allTokensForSend.filter(t => 
          t.symbol.toLowerCase().includes(tokenSearchQuery.toLowerCase()) ||
          t.name.toLowerCase().includes(tokenSearchQuery.toLowerCase())
        )
      : allTokensForSend

    // Transaction Verification Modal - renders as fixed overlay on top of any sendStep
    if (txVerificationModal.show) {
      return (
        <>
          <style>
            {`
              @keyframes txFadeIn { from { opacity: 0; } to { opacity: 1; } }
              @keyframes txSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
              @keyframes txOrbitRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
              @keyframes txCounterRotate { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
              @keyframes txOrbitRotateReverse { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
              @keyframes txCounterRotateReverse { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
              @keyframes txIconPulseWhite { 0%, 100% { box-shadow: 0 0 8px rgba(255, 255, 255, 0.3); color: rgba(180, 180, 180, 0.9); } 50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.6); color: rgba(255, 255, 255, 1); } }
              @keyframes txSuccessPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
            `}
          </style>
          <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: '#0a0a0c', zIndex: 10000, animation: 'txFadeIn 0.3s ease-out', overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
            <video autoPlay loop muted playsInline style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', minWidth: '100%', minHeight: '100%', width: 'auto', height: 'auto', objectFit: 'cover', opacity: 0.35 }}>
              <source src="https://brown-traditional-sheep-998.mypinata.cloud/ipfs/bafybeicmrwektqnpcgast66rua3czhzwx2aasfncb6zdzysmnsfosewfw4" type="video/mp4" />
            </video>
            <div style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, background: 'radial-gradient(circle at 50% 35%, rgba(10,10,12,0.3) 0%, rgba(10,10,12,0.8) 50%, rgba(10,10,12,0.95) 100%)', pointerEvents: 'none' }} />
            <div style={{ position: 'relative', zIndex: 10, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '24px 20px', overflowY: 'auto' }}>
              <div style={{ textAlign: 'center', marginBottom: 16, animation: 'txSlideUp 0.4s ease-out' }}>
                <div style={{ fontSize: 11, fontWeight: 600, color: txVerificationModal.currentLayer === 'done' ? '#10b981' : 'rgba(255, 255, 255, 0.5)', textTransform: 'uppercase', letterSpacing: '2px', marginBottom: 4 }}>
                  {txVerificationModal.currentLayer === 'done' ? ' VERIFIED' : 'AUTHENTICATING'}
                </div>
                <h1 style={{ fontSize: 20, fontWeight: 600, color: '#fff', margin: 0 }}>
                  {txVerificationModal.currentLayer === 'done' ? 'Transaction Secured' : 'Security Verification'}
                </h1>
              </div>
              <div style={{ position: 'relative', width: 200, height: 200, margin: '8px 0 20px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <img src={getAssetUrl("assets/arguslogo.png")} alt="ARGUS" style={{ width: 75, height: 75, borderRadius: 18, objectFit: 'contain', zIndex: 10, position: 'relative', filter: txVerificationModal.currentLayer === 'done' ? 'drop-shadow(0 0 20px rgba(16, 185, 129, 0.5))' : 'none', animation: txVerificationModal.currentLayer === 'done' ? 'txSuccessPulse 2s ease-in-out infinite' : 'none' }} />
                <div style={{ position: 'absolute', width: 130, height: 130, borderRadius: '50%', border: txVerificationModal.currentLayer === 'done' ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255, 255, 255, 0.1)' }} />
                <div style={{ position: 'absolute', width: 190, height: 190, borderRadius: '50%', border: txVerificationModal.currentLayer === 'done' ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255, 255, 255, 0.1)' }} />
                <div style={{ position: 'absolute', width: 130, height: 130, borderRadius: '50%', animation: 'txOrbitRotate 30s linear infinite' }}>
                  {[{ id: 'voice', color: '#8b5cf6', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg> }, { id: 'geo', color: '#3b82f6', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> }, { id: 'usb', color: '#f59e0b', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg> }].map((layer, index) => {
                    const pos = [{ top: 0, left: '50%', marginLeft: -14, marginTop: -14 }, { bottom: '15%', right: '5%', marginRight: -14, marginBottom: -14 }, { bottom: '15%', left: '5%', marginLeft: -14, marginBottom: -14 }][index];
                    const isEnabled = txVerificationModal.enabledLayers[layer.id as keyof typeof txVerificationModal.enabledLayers];
                    const isCompleted = txVerificationModal.completedLayers[layer.id as keyof typeof txVerificationModal.completedLayers];
                    const isCurrent = txVerificationModal.currentLayer === layer.id;
                    return <div key={layer.id} style={{ position: 'absolute', width: 28, height: 28, padding: 6, background: 'rgba(20, 20, 20, 0.95)', border: '1px solid rgba(255, 255, 255, 0.15)', borderRadius: 7, display: 'flex', alignItems: 'center', justifyContent: 'center', color: isCompleted ? layer.color : isEnabled ? 'rgba(120, 120, 120, 0.8)' : 'rgba(255, 255, 255, 0.2)', animation: `txCounterRotate 30s linear infinite${isCurrent && isEnabled ? ', txIconPulseWhite 1.5s ease-in-out infinite' : ''}`, boxShadow: isCurrent && isEnabled ? '0 0 15px rgba(255, 255, 255, 0.4)' : 'none', opacity: isEnabled ? 1 : 0.3, ...pos }}>{layer.icon}</div>;
                  })}
                </div>
                <div style={{ position: 'absolute', width: 190, height: 190, borderRadius: '50%', animation: 'txOrbitRotateReverse 45s linear infinite' }}>
                  {[{ id: 'bluetooth', color: '#06b6d4', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/></svg> }, { id: 'biometric', color: '#ec4899', icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg> }, { id: 'deco1', color: '#10b981', isDecorative: true, icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg> }, { id: 'deco2', color: '#6366f1', isDecorative: true, icon: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> }].map((layer, index) => {
                    const pos = [{ top: 0, left: '50%', marginLeft: -14, marginTop: -14 }, { top: '50%', right: 0, marginRight: -14, marginTop: -14 }, { bottom: 0, left: '50%', marginLeft: -14, marginBottom: -14 }, { top: '50%', left: 0, marginLeft: -14, marginTop: -14 }][index];
                    const isDecorative = (layer as any).isDecorative;
                    const isEnabled = isDecorative ? false : txVerificationModal.enabledLayers[layer.id as keyof typeof txVerificationModal.enabledLayers];
                    const isCompleted = isDecorative ? false : txVerificationModal.completedLayers[layer.id as keyof typeof txVerificationModal.completedLayers];
                    const isCurrent = txVerificationModal.currentLayer === layer.id;
                    return <div key={layer.id} style={{ position: 'absolute', width: 28, height: 28, padding: 6, background: 'rgba(20, 20, 20, 0.95)', border: '1px solid rgba(255, 255, 255, 0.15)', borderRadius: 7, display: 'flex', alignItems: 'center', justifyContent: 'center', color: isCompleted ? layer.color : isEnabled ? 'rgba(120, 120, 120, 0.8)' : 'rgba(255, 255, 255, 0.2)', animation: `txCounterRotateReverse 45s linear infinite${isCurrent && isEnabled ? ', txIconPulseWhite 1.5s ease-in-out infinite' : ''}`, boxShadow: isCurrent && isEnabled ? '0 0 15px rgba(255, 255, 255, 0.4)' : 'none', opacity: isEnabled ? 1 : 0.3, ...pos }}>{layer.icon}</div>;
                  })}
                </div>
              </div>
              <div style={{ textAlign: 'center', marginBottom: 16, animation: 'txSlideUp 0.4s ease-out 0.1s both' }}>
                <div style={{ fontSize: 14, fontWeight: 500, color: txVerificationModal.currentLayer === 'done' ? '#10b981' : '#fff' }}>
                  {txVerificationModal.currentLayer === 'voice' && 'Verifying voice print...'}
                  {txVerificationModal.currentLayer === 'geo' && 'Checking location...'}
                  {txVerificationModal.currentLayer === 'bluetooth' && (txVerificationModal.pendingUserAction ? 'Tap to connect Bluetooth' : 'Connecting Bluetooth...')}
                  {txVerificationModal.currentLayer === 'usb' && (txVerificationModal.pendingUserAction ? 'Tap to verify USB key' : 'Reading USB key...')}
                  {txVerificationModal.currentLayer === 'biometric' && 'Verifying Face ID...'}
                  {txVerificationModal.currentLayer === 'proposal' && 'Creating proposal (1/3)...'}
                  {txVerificationModal.currentLayer === 'approval' && 'Awaiting approval (2/3)...'}
                  {txVerificationModal.currentLayer === 'execute' && 'Executing transaction (3/3)...'}
                  {txVerificationModal.currentLayer === 'done' && 'All security checks passed'}
                </div>
              </div>
              
              {/* TAP TO VERIFY Button - shown for USB and Bluetooth */}
              {txVerificationModal.pendingUserAction && (txVerificationModal.currentLayer === 'usb' || txVerificationModal.currentLayer === 'bluetooth') && (
                <button
                  onClick={handleVerifyButtonClick}
                  style={{
                    width: '100%',
                    padding: '16px',
                    background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                    border: 'none',
                    borderRadius: 16,
                    color: '#fff',
                    fontSize: 16,
                    fontWeight: 600,
                    cursor: 'pointer',
                    marginBottom: 16,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: 10,
                    boxShadow: '0 4px 20px rgba(16, 185, 129, 0.3)'
                  }}
                >
                  {txVerificationModal.currentLayer === 'usb' && (
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                  )}
                  {txVerificationModal.currentLayer === 'bluetooth' && (
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/></svg>
                  )}
                  TAP TO VERIFY
                </button>
              )}
              
              {/* QR Code for Biometric Verification */}
              {txVerificationModal.currentLayer === 'biometric' && txVerificationModal.biometricQrData && (
                <div style={{ 
                  width: '100%', 
                  display: 'flex', 
                  flexDirection: 'column', 
                  alignItems: 'center', 
                  gap: 12,
                  marginBottom: 20,
                  animation: 'txSlideUp 0.3s ease-out'
                }}>
                  <div style={{
                    background: '#fff',
                    padding: 12,
                    borderRadius: 12,
                    boxShadow: '0 4px 20px rgba(0,0,0,0.3)'
                  }}>
                    <img 
                      src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(txVerificationModal.biometricQrData)}`}
                      alt="Scan with phone"
                      style={{ width: 150, height: 150, display: 'block' }}
                    />
                  </div>
                  <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', textAlign: 'center' }}>
                    Open camera app on your phone<br/>and scan this QR code
                  </div>
                </div>
              )}
              
              <div style={{ display: 'flex', justifyContent: 'center', gap: 6, marginBottom: 20 }}>
                {['voice', 'geo', 'usb', 'bluetooth', 'biometric'].filter(id => txVerificationModal.enabledLayers[id as keyof typeof txVerificationModal.enabledLayers]).map(layerId => (
                  <div key={layerId} style={{ width: 8, height: 8, borderRadius: '50%', background: txVerificationModal.completedLayers[layerId as keyof typeof txVerificationModal.completedLayers] ? '#10b981' : '#fff', transition: 'all 0.3s ease' }} />
                ))}
              </div>
              <div style={{ flex: 1 }} />
              {txVerificationModal.txData && (
                <div style={{ width: '100%', background: 'rgba(255, 255, 255, 0.03)', borderRadius: 16, padding: 16, border: '1px solid rgba(255, 255, 255, 0.06)', animation: 'txSlideUp 0.4s ease-out 0.2s both' }}>
                  <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.4)', textTransform: 'uppercase', letterSpacing: '1.5px', marginBottom: 8 }}>
                    {txVerificationModal.txData.type === 'send' ? 'SENDING' : txVerificationModal.txData.type === 'swap' ? 'SWAPPING' : 'SIGNING'}
                  </div>
                  <div style={{ fontSize: 28, fontWeight: 700, color: '#fff', display: 'flex', alignItems: 'baseline', gap: 8 }}>
                    {txVerificationModal.txData.amount || '0.00'}
                    <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>{txVerificationModal.txData.token || 'SOL'}</span>
                    {txVerificationModal.txData.toToken && (<><span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.3)', margin: '0 4px' }}></span><span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>{txVerificationModal.txData.toToken}</span></>)}
                  </div>
                  {txVerificationModal.txData.recipient && (
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginTop: 12, padding: '8px 10px', background: 'rgba(0, 0, 0, 0.3)', borderRadius: 8 }}>
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                      <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.5)', fontFamily: 'monospace' }}>{txVerificationModal.txData.recipient}</div>
                    </div>
                  )}
                </div>
              )}
              <div style={{ width: '100%', paddingTop: 16 }}>
                {txVerificationModal.currentLayer === 'done' ? (
                  <button onClick={() => { setTxVerificationModal(prev => ({ ...prev, show: false })); setSendStep("success"); }} style={{ width: '100%', padding: '16px', background: 'linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%)', border: 'none', borderRadius: 16, color: '#000', fontSize: 16, fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 20px rgba(255, 255, 255, 0.15)' }}>Continue</button>
                ) : (
                  <div style={{ textAlign: 'center', padding: '12px', color: 'rgba(255, 255, 255, 0.3)', fontSize: 11 }}>
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}>
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                      Protected by ARGUS
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
          
          {/* Voice Enrollment Modal - MUST be inside txVerificationModal return block for vault send */}
          <VoiceEnrollmentModal
            show={voiceEnrollmentModal.show}
            mode={voiceEnrollmentModal.mode}
            walletAddress={voiceEnrollmentModal.walletAddress}
            enrolledFingerprint={voiceEnrollmentModal.enrolledFingerprint}
            onComplete={async (result) => {
              setVoiceEnrollmentModal(prev => ({ ...prev, show: false }))
              
              // Handle verify-for-tx mode - resolve the pending promise for transaction security verification
              if (voiceEnrollmentModal.mode === 'verify-for-tx') {
                if (pendingVoiceVerificationResolve.current) {
                  pendingVoiceVerificationResolve.current({ success: result.success })
                  pendingVoiceVerificationResolve.current = null
                }
                return
              }
            }}
            onClose={() => {
              setVoiceEnrollmentModal(prev => ({ ...prev, show: false }))
              // If we're in verify-for-tx mode and user closes, resolve with failure
              if (voiceEnrollmentModal.mode === 'verify-for-tx' && pendingVoiceVerificationResolve.current) {
                pendingVoiceVerificationResolve.current({ success: false })
                pendingVoiceVerificationResolve.current = null
              }
            }}
          />
        </>
      );
    }

    // Step 1: Select Token
    if (sendStep === "select") {
      return (
        <div style={containerStyle}>
          {/* Header */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '16px 20px',
            borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
          }}>
            <div style={{ width: 32 }} />
            <h3 style={{ margin: 0, fontSize: 17, fontWeight: 600, color: '#fff' }}>{t('send', lang)}</h3>
            <button 
              onClick={() => { setView("main"); setSendStep("select"); setSelectedToken(null); setTokenSearchQuery(""); }}
              style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.5)', cursor: 'pointer', fontSize: 13 }}
            >
              {t('close', lang)}
            </button>
          </div>

          {/* Search */}
          <div style={{ padding: '16px 20px 0' }}>
            <div style={{ position: 'relative' }}>
              <svg 
                width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2"
                style={{ position: 'absolute', left: 14, top: '50%', transform: 'translateY(-50%)' }}
              >
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input
                type="text"
                value={tokenSearchQuery}
                onChange={e => setTokenSearchQuery(e.target.value)}
                placeholder={t('searchAddress', lang).replace('...', '')}
                style={{
                  width: '100%',
                  padding: '12px 14px 12px 42px',
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: 12,
                  color: '#fff',
                  fontSize: 14,
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
            </div>
          </div>

          {/* Token List */}
          <div style={{ padding: '16px 20px', flex: 1, overflowY: 'auto' }}>
            {filteredTokensForSend.length === 0 ? (
              <div style={{ textAlign: 'center', padding: '40px 20px', color: 'rgba(255, 255, 255, 0.4)' }}>
                {t('noSavedAddresses', lang)}
              </div>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                {filteredTokensForSend.map(token => (
                  <button
                    key={token.mint}
                    onClick={() => { setSelectedToken(token); setSendStep("details"); setAmount(""); }}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: 12,
                      padding: '14px 16px',
                      background: 'rgba(255, 255, 255, 0.03)',
                      border: '1px solid rgba(255, 255, 255, 0.06)',
                      borderRadius: 16,
                      cursor: 'pointer',
                      transition: 'all 0.2s',
                      width: '100%',
                      textAlign: 'left'
                    }}
                  >
                    {/* Token Logo */}
                    <div style={{
                      width: 44,
                      height: 44,
                      borderRadius: 12,
                      background: 'rgba(255, 255, 255, 0.05)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      {token.logoURI ? (
                        <img 
                          src={token.logoURI} 
                          alt={token.symbol}
                          style={{ width: 28, height: 28, borderRadius: 8 }}
                          onError={(e) => { (e.target as HTMLImageElement).style.display = 'none' }}
                        />
                      ) : (
                        <span style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>{token.symbol.slice(0, 2)}</span>
                      )}
                    </div>
                    
                    {/* Token Info */}
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{token.symbol}</div>
                      <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                        {token.amount.toFixed(token.decimals > 4 ? 4 : token.decimals)} {token.symbol}
                      </div>
                    </div>

                    {/* Value */}
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>
                        {formatCurrency(token.value)}
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>

          {/* Close Button */}
          <div style={{ padding: '16px 20px', borderTop: '1px solid rgba(255, 255, 255, 0.06)' }}>
            <button
              onClick={() => { setView("main"); setSendStep("select"); setSelectedToken(null); setTokenSearchQuery(""); }}
              style={{
                width: '100%',
                padding: '14px',
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.1)',
                borderRadius: 14,
                color: 'rgba(255, 255, 255, 0.8)',
                fontSize: 15,
                fontWeight: 500,
                cursor: 'pointer'
              }}
            >
              {t('close', lang)}
            </button>
          </div>
        </div>
      )
    }

    // Step 3: Confirm Transaction
    if (sendStep === "confirm") {
      const savedRecipient = addressBook.find(a => a.address === recipient)
      const usdValue = parseFloat(amount || '0') * (selectedToken?.price || solPrice)
      const networkFee = 0.000005 // Approximate SOL fee
      const networkFeeUsd = networkFee * solPrice
      
      // Check if recipient is master key or vault
      const isMasterKey = wallet && recipient === wallet.publicKey.toBase58()
      const isVault = vaultPda && recipient === vaultPda
      const specialRecipientLabel = isMasterKey ? 'MasterKey' : isVault ? 'Vault' : null

      return (
        <div style={containerStyle}>
          {/* Header */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            padding: '16px 20px',
            borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
          }}>
            <button 
              onClick={() => setSendStep("details")}
              style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 0 }}
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
            </button>
            <h3 style={{ margin: 0, fontSize: 17, fontWeight: 600, color: '#fff', flex: 1, textAlign: 'center' }}>
              Review Transaction
            </h3>
            <div style={{ width: 20 }} />
          </div>

          {/* Content */}
          <div style={{ padding: '24px 20px', display: 'flex', flexDirection: 'column' }}>
            
            {/* Amount Section - Clean and prominent */}
            <div style={{
              textAlign: 'center',
              marginBottom: 20,
              padding: '20px',
              background: 'rgba(255, 255, 255, 0.02)',
              borderRadius: 20,
              border: '1px solid rgba(255, 255, 255, 0.04)'
            }}>
              {/* Token Icon */}
              <div style={{
                width: 48,
                height: 48,
                borderRadius: 12,
                background: 'rgba(255, 255, 255, 0.05)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                margin: '0 auto 12px',
                overflow: 'hidden'
              }}>
                {selectedToken?.logoURI ? (
                  <img src={selectedToken.logoURI} alt={selectedToken.symbol} style={{ width: 28, height: 28, borderRadius: 6 }} />
                ) : (
                  <span style={{ fontSize: 16, fontWeight: 700, color: '#fff' }}>{(selectedToken?.symbol || 'SOL').slice(0, 2)}</span>
                )}
              </div>

              {/* Amount Display */}
              <div style={{ fontSize: 28, fontWeight: 700, color: '#fff', marginBottom: 4, letterSpacing: '-0.5px' }}>
                -{amount} <span style={{ fontSize: 18, fontWeight: 500, opacity: 0.8 }}>{selectedToken?.symbol || 'SOL'}</span>
              </div>
              <div style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.4)' }}>
                 {formatCurrency(usdValue)}
              </div>
            </div>

            {/* Transaction Details */}
            <div style={{
              background: 'rgba(0, 0, 0, 0.2)',
              borderRadius: 16,
              overflow: 'hidden',
              border: '1px solid rgba(255, 255, 255, 0.06)'
            }}>
              {/* Recipient */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '14px 16px',
                borderBottom: '1px solid rgba(255, 255, 255, 0.04)'
              }}>
                <span style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.4)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                  {t('recipient', lang) || 'Recipient'}
                </span>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                  {/* Special icon for MasterKey or Vault */}
                  {(isMasterKey || isVault) && (
                    <div style={{
                      width: 28,
                      height: 28,
                      borderRadius: 8,
                      background: isVault 
                        ? 'rgba(16, 185, 129, 0.15)' 
                        : 'rgba(255, 255, 255, 0.05)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      {isVault ? (
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                          <path d="M7 11V7a5 5 0 0110 0v4"/>
                        </svg>
                      ) : (
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.7)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                        </svg>
                      )}
                    </div>
                  )}
                  <div style={{ textAlign: 'right' }}>
                    {(specialRecipientLabel || savedRecipient?.label) && (
                      <div style={{ fontSize: 14, fontWeight: 600, color: '#fff', marginBottom: 2 }}>
                        {specialRecipientLabel || savedRecipient?.label}
                      </div>
                    )}
                    <div style={{ 
                      fontSize: 13, 
                      color: (specialRecipientLabel || savedRecipient?.label) ? 'rgba(255, 255, 255, 0.5)' : '#fff', 
                      fontFamily: 'ui-monospace, monospace',
                      background: 'rgba(255, 255, 255, 0.05)',
                      padding: '4px 8px',
                      borderRadius: 6
                    }}>
                      {recipient.slice(0, 4)}...{recipient.slice(-4)}
                    </div>
                  </div>
                </div>
              </div>

              {/* Network */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '14px 16px',
                borderBottom: '1px solid rgba(255, 255, 255, 0.04)'
              }}>
                <span style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.4)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                  {t('network', lang) || 'Network'}
                </span>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <div style={{
                    width: 20,
                    height: 20,
                    borderRadius: 6,
                    background: 'rgba(255, 255, 255, 0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <img 
                      src="https://assets.coingecko.com/coins/images/4128/standard/solana.png" 
                      alt="Solana" 
                      style={{ width: 14, height: 14, borderRadius: 3 }}
                    />
                  </div>
                  <span style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>Solana</span>
                </div>
              </div>

              {/* Estimated Fee */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '14px 16px'
              }}>
                <span style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.4)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                  {t('estimatedFee', lang) || 'Est. Fee'}
                </span>
                <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.6)' }}>
                  ~${networkFeeUsd < 0.01 ? networkFeeUsd.toFixed(4) : networkFeeUsd.toFixed(2)}
                </span>
              </div>
            </div>
          </div>

          {/* Spacer to push footer to bottom */}
          <div style={{ flex: 1 }} />

          {/* Footer Buttons */}
          <div style={{ padding: '16px 20px' }}>
            {/* Security Badge for Vault - Minimal inline version */}
            {activeWallet === "vault" && (
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: 6,
                marginBottom: 12,
                padding: '6px 12px',
                background: 'rgba(16, 185, 129, 0.08)',
                border: '1px solid rgba(16, 185, 129, 0.15)',
                borderRadius: 20
              }}>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <span style={{ fontSize: 11, color: '#10b981', fontWeight: 500 }}>Protected by ARGUS</span>
              </div>
            )}
            <div style={{ display: 'flex', gap: 12 }}>
            <button
              onClick={() => setSendStep("details")}
              style={{
                flex: 1,
                padding: '16px',
                background: 'rgba(255, 255, 255, 0.04)',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                borderRadius: 14,
                color: 'rgba(255, 255, 255, 0.7)',
                fontSize: 15,
                fontWeight: 500,
                cursor: 'pointer'
              }}
            >
              {t('back', lang) || 'Back'}
            </button>
            <button
              onClick={handleTransfer}
              disabled={isLoading}
              style={{
                flex: 1.5,
                padding: '16px',
                background: isLoading ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.95)',
                border: 'none',
                borderRadius: 14,
                color: isLoading ? 'rgba(255, 255, 255, 0.4)' : '#000',
                fontSize: 15,
                fontWeight: 600,
                cursor: isLoading ? 'not-allowed' : 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: 8
              }}
            >
              {isLoading ? (
                <>
                  <div style={{
                    width: 16,
                    height: 16,
                    border: '2px solid rgba(255,255,255,0.2)',
                    borderTopColor: 'rgba(255,255,255,0.6)',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                  }} />
                  {t('processing', lang) || 'Processing...'}
                </>
              ) : (
                <>
                  SEND
                </>
              )}
            </button>
            </div>
          </div>
        </div>
      )
    }

    // Step 4: Success
    if (sendStep === "success") {
      const usdValue = parseFloat(amount || '0') * (selectedToken?.price || solPrice)

      return (
        <div className="app-container" style={{ background: '#0a0a0a' }}>
          {/* Content */}
          <div style={{ flex: 1, padding: '60px 20px', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
            {/* Success Icon - Matches swap success */}
            <div style={{
              width: 80,
              height: 80,
              borderRadius: '50%',
              background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.08) 100%)',
              border: '1px solid rgba(34, 197, 94, 0.2)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              marginBottom: 24
            }}>
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#22c55e" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </div>

            {/* Title */}
            <div style={{ fontSize: 22, fontWeight: 600, color: '#fff', marginBottom: 6, letterSpacing: '-0.02em' }}>
              Transaction Successful
            </div>

            {/* Amount */}
            <div style={{ fontSize: 32, fontWeight: 700, color: '#fff', marginBottom: 4 }}>
              {amount} {selectedToken?.symbol || 'SOL'}
            </div>
            <div style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 16 }}>
               {formatCurrency(usdValue)}
            </div>

            {/* Transaction Time */}
            {lastTxTime !== null && (
              <div style={{ 
                display: 'flex', 
                alignItems: 'center', 
                gap: 6,
                marginBottom: 32,
                padding: '6px 12px',
                background: 'rgba(34, 197, 94, 0.1)',
                borderRadius: 20,
                border: '1px solid rgba(34, 197, 94, 0.2)'
              }}>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#22c55e" strokeWidth="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span style={{ fontSize: 12, color: '#22c55e' }}>
                  {lastTxTime.toFixed(2)}s
                </span>
              </div>
            )}

            {/* View on Orbit Link */}
            {lastTxSignature && (
              <button
                onClick={() => window.open(`https://orb.helius.dev/tx/${lastTxSignature}?tab=summary`, '_blank')}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: 8,
                  padding: '10px 16px',
                  background: 'transparent',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: 10,
                  color: 'rgba(255, 255, 255, 0.5)',
                  fontSize: 13,
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.15)';
                  e.currentTarget.style.color = 'rgba(255, 255, 255, 0.7)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.08)';
                  e.currentTarget.style.color = 'rgba(255, 255, 255, 0.5)';
                }}
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                  <polyline points="15 3 21 3 21 9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                View on Orb
              </button>
            )}
          </div>

          {/* Done Button */}
          <div style={{ padding: '20px 24px' }}>
            <button
              onClick={() => { 
                setView("main"); 
                setSendStep("select"); 
                setSelectedToken(null); 
                setAmount(""); 
                setRecipient(""); 
                setLastTxSignature(null);
                setLastTxTime(null);
              }}
              style={{
                width: '100%',
                padding: '14px',
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                borderRadius: 12,
                color: '#fff',
                fontSize: 15,
                fontWeight: 500,
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = 'rgba(255, 255, 255, 0.05)';
              }}
            >
              Done
            </button>
          </div>
        </div>
      )
    }

    // Step 2: Enter Details
    if (sendStep === "details") {
    return (
      <div style={containerStyle}>
        {/* USB Device Not Connected Modal */}
        {usbErrorModal.show && (
          <>
            <style>
              {`
                @keyframes usbErrorFadeIn {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                @keyframes usbErrorScaleIn {
                  from { opacity: 0; transform: scale(0.95); }
                  to { opacity: 1; transform: scale(1); }
                }
                @keyframes usbShake {
                  0%, 100% { transform: translateX(0); }
                  20% { transform: translateX(-4px); }
                  40% { transform: translateX(4px); }
                  60% { transform: translateX(-4px); }
                  80% { transform: translateX(4px); }
                }
              `}
            </style>
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.85)',
              backdropFilter: 'blur(12px)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
              animation: 'usbErrorFadeIn 0.2s ease-out forwards'
            }}>
              <div style={{
                background: '#0a0f0a',
                borderRadius: 20,
                padding: '32px 28px',
                width: '85%',
                maxWidth: 300,
                textAlign: 'center',
                border: '1px solid rgba(239, 68, 68, 0.2)',
                animation: 'usbErrorScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              }}>
                <div style={{
                  width: 64,
                  height: 64,
                  margin: '0 auto 20px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  background: 'rgba(239, 68, 68, 0.1)',
                  borderRadius: '50%',
                  animation: 'usbShake 0.5s ease-out'
                }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M12 18v-6"/>
                    <path d="M8 18v-1"/>
                    <path d="M16 18v-1"/>
                    <rect x="6" y="18" width="12" height="4" rx="1"/>
                    <path d="M12 12a2 2 0 100-4 2 2 0 000 4z"/>
                    <path d="M12 2v6"/>
                    <line x1="4" y1="4" x2="20" y2="20" stroke="#ef4444" strokeWidth="2.5"/>
                  </svg>
                </div>
                <h3 style={{ fontSize: 17, fontWeight: 600, color: '#fff', margin: '0 0 8px 0' }}>USB Key Required</h3>
                <p style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.5)', margin: '0 0 8px 0', lineHeight: 1.5 }}>Please connect your security device</p>
                <p style={{ fontSize: 14, color: '#ef4444', fontWeight: 500, margin: '0 0 24px 0' }}>{usbErrorModal.deviceName}</p>
                <div style={{ display: 'flex', gap: 10 }}>
                  <button onClick={() => setUsbErrorModal({ show: false, deviceName: '' })} style={{ flex: 1, padding: '12px 16px', background: 'rgba(255, 255, 255, 0.05)', border: '1px solid rgba(255, 255, 255, 0.1)', borderRadius: 12, color: 'rgba(255, 255, 255, 0.7)', fontSize: 13, fontWeight: 500, cursor: 'pointer' }}>Cancel</button>
                  <button onClick={() => { setUsbErrorModal({ show: false, deviceName: '' }); handleTransfer(); }} style={{ flex: 1, padding: '12px 16px', background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', border: 'none', borderRadius: 12, color: '#fff', fontSize: 13, fontWeight: 600, cursor: 'pointer' }}>Retry</button>
                </div>
              </div>
            </div>
          </>
        )}

        {/* Bluetooth Device Not Found Modal */}
        {bluetoothErrorModal.show && (
          <>
            <style>{`@keyframes btErrorFadeIn { from { opacity: 0; } to { opacity: 1; } } @keyframes btErrorScaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } } @keyframes btPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }`}</style>
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0, 0, 0, 0.85)', backdropFilter: 'blur(12px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999, animation: 'btErrorFadeIn 0.2s ease-out forwards' }}>
              <div style={{ background: '#0a0f0a', borderRadius: 20, padding: '32px 28px', width: '85%', maxWidth: 300, textAlign: 'center', border: '1px solid rgba(59, 130, 246, 0.2)', animation: 'btErrorScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards' }}>
                <div style={{ width: 64, height: 64, margin: '0 auto 20px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '50%', animation: 'btPulse 1.5s ease-in-out infinite' }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2"><path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/></svg>
                </div>
                <h3 style={{ fontSize: 17, fontWeight: 600, color: '#fff', margin: '0 0 8px 0' }}>Bluetooth Device Required</h3>
                <p style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.5)', margin: '0 0 8px 0', lineHeight: 1.5 }}>Please select your registered device</p>
                <p style={{ fontSize: 14, color: '#3b82f6', fontWeight: 500, margin: '0 0 24px 0' }}>{bluetoothErrorModal.deviceName}</p>
                <div style={{ display: 'flex', gap: 10 }}>
                  <button onClick={() => setBluetoothErrorModal({ show: false, deviceName: '' })} style={{ flex: 1, padding: '12px 16px', background: 'rgba(255, 255, 255, 0.05)', border: '1px solid rgba(255, 255, 255, 0.1)', borderRadius: 12, color: 'rgba(255, 255, 255, 0.7)', fontSize: 13, fontWeight: 500, cursor: 'pointer' }}>Cancel</button>
                  <button onClick={() => { setBluetoothErrorModal({ show: false, deviceName: '' }); handleTransfer(); }} style={{ flex: 1, padding: '12px 16px', background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', border: 'none', borderRadius: 12, color: '#fff', fontSize: 13, fontWeight: 600, cursor: 'pointer' }}>Retry</button>
                </div>
              </div>
            </div>
          </>
        )}

        {/* Geo-Fence Error Modal */}
        {geoErrorModal.show && (
          <>
            <style>{`
              @keyframes geoErrorFadeIn { from { opacity: 0; } to { opacity: 1; } }
              @keyframes geoErrorScaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
              @keyframes geoPing { 
                0% { transform: scale(1); opacity: 1; } 
                50% { transform: scale(1.5); opacity: 0.5; } 
                100% { transform: scale(2); opacity: 0; } 
              }
              @keyframes geoRingPulse {
                0%, 100% { transform: scale(1); opacity: 0.3; }
                50% { transform: scale(1.1); opacity: 0.6; }
              }
            `}</style>
            <div style={{ 
              position: 'fixed', 
              top: 0, 
              left: 0, 
              right: 0, 
              bottom: 0, 
              background: 'rgba(0, 0, 0, 0.9)', 
              backdropFilter: 'blur(16px)', 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center', 
              zIndex: 9999, 
              animation: 'geoErrorFadeIn 0.2s ease-out forwards' 
            }}>
              <div style={{ 
                background: 'linear-gradient(180deg, #0a0f0a 0%, #0d1210 100%)', 
                borderRadius: 24, 
                padding: '36px 28px 28px', 
                width: '88%', 
                maxWidth: 320, 
                textAlign: 'center', 
                border: '1px solid rgba(239, 68, 68, 0.15)',
                boxShadow: '0 24px 48px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(239, 68, 68, 0.1)',
                animation: 'geoErrorScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards' 
              }}>
                {/* Location icon with animated rings */}
                <div style={{ position: 'relative', width: 80, height: 80, margin: '0 auto 24px' }}>
                  {/* Outer ring */}
                  <div style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    borderRadius: '50%',
                    border: '2px solid rgba(239, 68, 68, 0.2)',
                    animation: 'geoRingPulse 2s ease-in-out infinite'
                  }} />
                  {/* Middle ring */}
                  <div style={{
                    position: 'absolute',
                    top: 10,
                    left: 10,
                    right: 10,
                    bottom: 10,
                    borderRadius: '50%',
                    border: '2px solid rgba(239, 68, 68, 0.3)',
                    animation: 'geoRingPulse 2s ease-in-out infinite 0.3s'
                  }} />
                  {/* Center icon */}
                  <div style={{
                    position: 'absolute',
                    top: 20,
                    left: 20,
                    right: 20,
                    bottom: 20,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'rgba(239, 68, 68, 0.15)',
                    borderRadius: '50%',
                    border: '2px solid rgba(239, 68, 68, 0.4)'
                  }}>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                      <circle cx="12" cy="10" r="3"/>
                    </svg>
                  </div>
                  {/* Ping effect */}
                  <div style={{
                    position: 'absolute',
                    top: 20,
                    left: 20,
                    right: 20,
                    bottom: 20,
                    borderRadius: '50%',
                    border: '2px solid rgba(239, 68, 68, 0.6)',
                    animation: 'geoPing 2s ease-out infinite'
                  }} />
                </div>

                <h3 style={{ 
                  fontSize: 18, 
                  fontWeight: 700, 
                  color: '#fff', 
                  margin: '0 0 8px 0',
                  letterSpacing: '-0.02em'
                }}>
                  Location Verification Failed
                </h3>
                
                <p style={{ 
                  fontSize: 13, 
                  color: 'rgba(255, 255, 255, 0.5)', 
                  margin: '0 0 20px 0', 
                  lineHeight: 1.5 
                }}>
                  You are too far from your authorized location
                </p>

                {/* Distance display */}
                <div style={{
                  background: 'rgba(239, 68, 68, 0.08)',
                  border: '1px solid rgba(239, 68, 68, 0.15)',
                  borderRadius: 16,
                  padding: '16px 20px',
                  marginBottom: 24
                }}>
                  <div style={{ 
                    fontSize: 11, 
                    color: 'rgba(255, 255, 255, 0.4)', 
                    textTransform: 'uppercase', 
                    letterSpacing: '0.05em',
                    marginBottom: 6
                  }}>
                    Current Distance
                  </div>
                  <div style={{ 
                    fontSize: 28, 
                    fontWeight: 700, 
                    color: '#ef4444',
                    letterSpacing: '-0.02em'
                  }}>
                    {geoErrorModal.distance < 1 
                      ? `${Math.round(geoErrorModal.distance * 1000)} meters` 
                      : `${geoErrorModal.distance.toFixed(1)} km`}
                  </div>
                  <div style={{ 
                    fontSize: 12, 
                    color: 'rgba(255, 255, 255, 0.4)', 
                    marginTop: 4
                  }}>
                    away from approval zone
                  </div>
                </div>

                <button 
                  onClick={() => setGeoErrorModal({ show: false, distance: 0, requiredRange: 0 })} 
                  style={{ 
                    width: '100%',
                    padding: '14px 20px', 
                    background: 'rgba(255, 255, 255, 0.05)', 
                    border: '1px solid rgba(255, 255, 255, 0.1)', 
                    borderRadius: 14, 
                    color: '#fff', 
                    fontSize: 14, 
                    fontWeight: 600, 
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                  onMouseOver={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)'}
                  onMouseOut={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.05)'}
                >
                  Dismiss
                </button>
              </div>
            </div>
          </>
        )}

        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          padding: '16px 20px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)',
          flexShrink: 0
        }}>
          <button 
            onClick={() => setSendStep("select")}
            style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 4 }}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h3 style={{ flex: 1, textAlign: 'center', margin: 0, fontSize: 17, fontWeight: 600, color: '#fff' }}>
            {t('send', lang)} {selectedToken?.symbol || 'SOL'}
          </h3>
          <div style={{ width: 28 }} />
        </div>

        {/* Scrollable Content */}
        <div style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column' }}>
          {/* Token Icon */}
          <div style={{ display: 'flex', justifyContent: 'center', padding: '24px 0 16px', flexShrink: 0 }}>
            <div style={{
              width: 64,
              height: 64,
              borderRadius: 16,
              background: 'rgba(255, 255, 255, 0.05)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)'
            }}>
              {selectedToken?.logoURI ? (
                <img src={selectedToken.logoURI} alt={selectedToken.symbol} style={{ width: 40, height: 40, borderRadius: 10 }} />
              ) : (
                <span style={{ fontSize: 24, fontWeight: 700, color: '#fff' }}>{selectedToken?.symbol.slice(0, 2)}</span>
              )}
            </div>
          </div>

          {/* Form */}
          <div style={{ padding: '0 20px', flexShrink: 0 }}>
          {/* Recipient Input */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: '14px 16px',
            marginBottom: 12,
            display: 'flex',
            alignItems: 'center',
            gap: 12
          }}>
            <input
              type="text"
              value={recipient}
              onChange={e => setRecipient(e.target.value)}
              placeholder={t('enterAddress', lang)}
              style={{
                flex: 1,
                background: 'none',
                border: 'none',
                color: '#fff',
                fontSize: 14,
                outline: 'none'
              }}
            />
            <button
              onClick={() => { setAddressBookReturnView("send"); setView("address-book"); }}
              style={{
                width: 32,
                height: 32,
                borderRadius: 8,
                background: 'rgba(255, 255, 255, 0.05)',
                border: 'none',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer'
              }}
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
              </svg>
            </button>
          </div>

          {/* Amount Input */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: '14px 16px',
            marginBottom: 12
          }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>{t('amount', lang)}</span>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>{selectedToken?.symbol || 'SOL'}</span>
                <button
                  onClick={() => {
                    // For SOL on master wallet, reserve some for gas fees
                    // Vault doesn't need reserve - master wallet pays gas
                    const isSOL = selectedToken?.mint === "So11111111111111111111111111111111111111112" || selectedToken?.symbol === "SOL"
                    const needsReserve = isSOL && activeWallet === "master"
                    const maxAmount = needsReserve
                      ? Math.max(0, (selectedToken?.amount || 0) - MIN_SOL_RESERVE_FOR_FEES)
                      : (selectedToken?.amount || 0)
                    setAmount(String(maxAmount))
                  }}
                  style={{
                    padding: '4px 10px',
                    background: 'rgba(255, 255, 255, 0.08)',
                    border: 'none',
                    borderRadius: 6,
                    color: 'rgba(255, 255, 255, 0.7)',
                    fontSize: 11,
                    fontWeight: 600,
                    cursor: 'pointer'
                  }}
                >
                  MAX
                </button>
              </div>
            </div>
            <input
              type="text"
              value={amount}
              onChange={e => setAmount(e.target.value)}
              placeholder="0"
              style={{
                width: '100%',
                background: 'none',
                border: 'none',
                color: '#fff',
                fontSize: 28,
                fontWeight: 600,
                outline: 'none'
              }}
            />
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 8 }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                ~{formatCurrency(parseFloat(amount || '0') * (selectedToken?.price || solPrice))}
              </span>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                {t('available', lang) || 'Available'}: {(selectedToken?.amount || 0).toFixed(4)} {selectedToken?.symbol || 'SOL'}
              </span>
            </div>
          </div>

          {/* Vault gas fee notice */}
          {activeWallet === "vault" && (
            <div style={{ 
              textAlign: 'center',
              marginBottom: 12,
              fontSize: 11, 
              color: 'rgba(255, 255, 255, 0.35)'
            }}>
              Ensure your MasterKey has enough SOL to cover gas fees
            </div>
          )}

          {status && (
            <div style={{ marginBottom: 12, fontSize: 13, color: 'rgba(255, 255, 255, 0.6)', textAlign: 'center', padding: '10px 14px', background: 'rgba(255, 255, 255, 0.05)', borderRadius: 12 }}>
              {status}
            </div>
          )}
        </div>
        </div>

        {/* Footer Buttons */}
        <div style={{ padding: '16px 20px', paddingBottom: 'max(16px, env(safe-area-inset-bottom, 16px))', display: 'flex', gap: 12, flexShrink: 0, borderTop: '1px solid rgba(255, 255, 255, 0.06)', background: '#121216' }}>
          <button
            onClick={() => { setSendStep("select"); setSelectedToken(null); setAmount(""); setRecipient(""); }}
            style={{
              flex: 1,
              padding: '14px',
              background: 'rgba(255, 255, 255, 0.05)',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              borderRadius: 14,
              color: 'rgba(255, 255, 255, 0.8)',
              fontSize: 15,
              fontWeight: 500,
              cursor: 'pointer'
            }}
          >
            {t('cancel', lang)}
          </button>
          <button
            onClick={() => setSendStep("confirm")}
            disabled={!recipient || !amount || parseFloat(amount) <= 0}
            style={{
              flex: 1,
              padding: '14px',
              background: (recipient && amount && parseFloat(amount) > 0) ? 'rgba(255, 255, 255, 0.9)' : 'rgba(255, 255, 255, 0.1)',
              border: 'none',
              borderRadius: 14,
              color: (recipient && amount && parseFloat(amount) > 0) ? '#000' : 'rgba(255, 255, 255, 0.3)',
              fontSize: 15,
              fontWeight: 600,
              cursor: (recipient && amount && parseFloat(amount) > 0) ? 'pointer' : 'not-allowed'
            }}
          >
            {t('continue', lang) || 'Continue'}
          </button>
        </div>
      </div>
    )
    }

    // Fallback
    return null
  }

  // Address Book View
  if (view === "address-book") {
    const filteredAddresses = addressBook.filter(addr => 
      addr.label.toLowerCase().includes(addressBookSearch.toLowerCase()) ||
      addr.address.toLowerCase().includes(addressBookSearch.toLowerCase())
    )
    const sortedRecentAddresses = [...recentAddresses].sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0)).slice(0, 5)

    const handleSelectAddress = (address: string) => {
      setRecipient(address)
      setView("send")
    }

    const handleSaveAddress = () => {
      if (!addressInput.trim()) return
      
      const newAddress: SavedAddress = {
        address: addressInput.trim(),
        label: addressLabelInput.trim() || '',
        lastUsed: Date.now()
      }

      if (editingAddress) {
        // Update existing
        setAddressBook(prev => prev.map(a => 
          a.address === editingAddress.address ? newAddress : a
        ))
      } else {
        // Check if already exists
        const exists = addressBook.some(a => a.address === addressInput.trim())
        if (!exists) {
          setAddressBook(prev => [...prev, newAddress])
        }
      }

      // Reset modal state
      setShowAddressModal(false)
      setEditingAddress(null)
      setAddressLabelInput("")
      setAddressInput("")
    }

    const handleDeleteAddress = (address: string) => {
      setAddressBook(prev => prev.filter(a => a.address !== address))
    }

    const openEditModal = (addr: SavedAddress) => {
      setEditingAddress(addr)
      setAddressLabelInput(addr.label)
      setAddressInput(addr.address)
      setShowAddressModal(true)
    }

    const openAddModal = () => {
      setEditingAddress(null)
      setAddressLabelInput("")
      setAddressInput("")
      setShowAddressModal(true)
    }

    return (
      <div style={containerStyle}>
        {/* Add/Edit Address Modal */}
        {showAddressModal && (
          <>
            <style>
              {`
                @keyframes addressModalFadeIn {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                @keyframes addressModalScaleIn {
                  from { opacity: 0; transform: scale(0.95); }
                  to { opacity: 1; transform: scale(1); }
                }
              `}
            </style>
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.85)',
              backdropFilter: 'blur(12px)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
              animation: 'addressModalFadeIn 0.2s ease-out forwards'
            }}>
              <div style={{
                background: '#0a0f0a',
                borderRadius: 20,
                padding: '24px',
                width: '90%',
                maxWidth: 320,
                border: '1px solid rgba(255, 255, 255, 0.1)',
                animation: 'addressModalScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              }}>
                <h3 style={{
                  fontSize: 17,
                  fontWeight: 600,
                  color: '#fff',
                  margin: '0 0 20px 0',
                  textAlign: 'center'
                }}>
                  {editingAddress ? t('editAddress', lang) : t('addAddress', lang)}
                </h3>

                <div style={{ marginBottom: 16 }}>
                  <label style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 6, display: 'block' }}>
                    {t('addressLabel', lang)}
                  </label>
                  <input
                    type="text"
                    value={addressLabelInput}
                    onChange={e => setAddressLabelInput(e.target.value)}
                    placeholder={t('noLabel', lang)}
                    style={{
                      width: '100%',
                      padding: '12px 14px',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 12,
                      color: '#fff',
                      fontSize: 14,
                      outline: 'none',
                      boxSizing: 'border-box'
                    }}
                  />
                </div>

                <div style={{ marginBottom: 24 }}>
                  <label style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 6, display: 'block' }}>
                    {t('walletAddress', lang)}
                  </label>
                  <input
                    type="text"
                    value={addressInput}
                    onChange={e => setAddressInput(e.target.value)}
                    placeholder={t('enterAddress', lang)}
                    style={{
                      width: '100%',
                      padding: '12px 14px',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 12,
                      color: '#fff',
                      fontSize: 13,
                      fontFamily: 'monospace',
                      outline: 'none',
                      boxSizing: 'border-box'
                    }}
                    disabled={!!editingAddress}
                  />
                </div>

                <div style={{ display: 'flex', gap: 10 }}>
                  <button
                    onClick={() => {
                      setShowAddressModal(false)
                      setEditingAddress(null)
                      setAddressLabelInput("")
                      setAddressInput("")
                    }}
                    style={{
                      flex: 1,
                      padding: '12px 16px',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: 12,
                      color: 'rgba(255, 255, 255, 0.7)',
                      fontSize: 13,
                      fontWeight: 500,
                      cursor: 'pointer'
                    }}
                  >
                    {t('cancel', lang)}
                  </button>
                  <button
                    onClick={handleSaveAddress}
                    disabled={!addressInput.trim()}
                    style={{
                      flex: 1,
                      padding: '12px 16px',
                      background: addressInput.trim() ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'rgba(255, 255, 255, 0.1)',
                      border: 'none',
                      borderRadius: 12,
                      color: addressInput.trim() ? '#fff' : 'rgba(255, 255, 255, 0.3)',
                      fontSize: 13,
                      fontWeight: 600,
                      cursor: addressInput.trim() ? 'pointer' : 'not-allowed'
                    }}
                  >
                    {t('saveAddress', lang)}
                  </button>
                </div>
              </div>
            </div>
          </>
        )}

        <div style={styles.header}>
          <button 
            onClick={() => setView(addressBookReturnView)}
            style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 4 }}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h3 style={styles.headerTitle}>{t('addressBook', lang)}</h3>
          <button 
            onClick={openAddModal}
            style={{ background: 'none', border: 'none', color: '#10b981', cursor: 'pointer', padding: 4 }}
          >
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
          </button>
        </div>

        <div style={{ padding: '0 16px 16px' }}>
          {/* Search Input */}
          <div style={{ position: 'relative', marginBottom: 20 }}>
            <svg 
              width="16" 
              height="16" 
              viewBox="0 0 24 24" 
              fill="none" 
              stroke="rgba(255, 255, 255, 0.4)" 
              strokeWidth="2"
              style={{ position: 'absolute', left: 14, top: '50%', transform: 'translateY(-50%)' }}
            >
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input
              type="text"
              value={addressBookSearch}
              onChange={e => setAddressBookSearch(e.target.value)}
              placeholder={t('searchAddress', lang)}
              style={{
                width: '100%',
                padding: '12px 14px 12px 42px',
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                borderRadius: 12,
                color: '#fff',
                fontSize: 14,
                outline: 'none',
                boxSizing: 'border-box'
              }}
            />
          </div>

          {/* My Wallets Section - Show vault if on masterkey, show masterkey if on vault */}
          {!addressBookSearch && multisigPda && vaultPda && wallet && (
            <div style={{ marginBottom: 24 }}>
              <div style={{ 
                fontSize: 12, 
                fontWeight: 500, 
                color: 'rgba(255, 255, 255, 0.4)', 
                textTransform: 'uppercase', 
                letterSpacing: '0.5px',
                marginBottom: 12 
              }}>
                {t('myWallets', lang)}
              </div>
              <div style={{
                background: 'rgba(255, 255, 255, 0.02)',
                border: '1px solid rgba(255, 255, 255, 0.06)',
                borderRadius: 16,
                overflow: 'hidden'
              }}>
                <div
                  style={{
                    padding: '14px 16px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    cursor: 'pointer',
                    transition: 'background 0.2s'
                  }}
                  onClick={() => handleSelectAddress(activeWallet === "master" ? vaultPda : wallet.publicKey.toBase58())}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12, flex: 1, minWidth: 0 }}>
                    <div style={{
                      width: 36,
                      height: 36,
                      borderRadius: 10,
                      background: activeWallet === "master" 
                        ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%)'
                        : 'rgba(255, 255, 255, 0.05)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      {activeWallet === "master" ? (
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                          <path d="M7 11V7a5 5 0 0110 0v4"/>
                        </svg>
                      ) : (
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.7)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                        </svg>
                      )}
                    </div>
                    <div style={{ minWidth: 0, flex: 1 }}>
                      <div style={{ 
                        fontSize: 14, 
                        fontWeight: 500, 
                        color: '#fff',
                        marginBottom: 2,
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap'
                      }}>
                        {activeWallet === "master" ? t('myVault', lang) : 'MasterKey'}
                      </div>
                      <div style={{ 
                        fontSize: 12, 
                        color: 'rgba(255, 255, 255, 0.4)',
                        fontFamily: 'monospace',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap'
                      }}>
                        {activeWallet === "master" 
                          ? `${vaultPda.slice(0, 8)}...${vaultPda.slice(-8)}`
                          : `${wallet.publicKey.toBase58().slice(0, 8)}...${wallet.publicKey.toBase58().slice(-8)}`
                        }
                      </div>
                    </div>
                  </div>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.3)" strokeWidth="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </div>
              </div>
            </div>
          )}

          {/* Recently Used Section */}
          {sortedRecentAddresses.length > 0 && !addressBookSearch && (
            <div style={{ marginBottom: 24 }}>
              <div style={{ 
                fontSize: 12, 
                fontWeight: 500, 
                color: 'rgba(255, 255, 255, 0.4)', 
                textTransform: 'uppercase', 
                letterSpacing: '0.5px',
                marginBottom: 12 
              }}>
                {t('recentlyUsed', lang)}
              </div>
              <div style={{
                background: 'rgba(255, 255, 255, 0.02)',
                border: '1px solid rgba(255, 255, 255, 0.06)',
                borderRadius: 16,
                overflow: 'hidden'
              }}>
                {sortedRecentAddresses.map((addr, idx) => (
                  <div
                    key={addr.address}
                    style={{
                      padding: '14px 16px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      borderBottom: idx < sortedRecentAddresses.length - 1 ? '1px solid rgba(255, 255, 255, 0.06)' : 'none',
                      cursor: 'pointer',
                      transition: 'background 0.2s'
                    }}
                    onClick={() => handleSelectAddress(addr.address)}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: 12, flex: 1, minWidth: 0 }}>
                      <div style={{
                        width: 36,
                        height: 36,
                        borderRadius: 10,
                        background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        flexShrink: 0
                      }}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                          <path d="M12 8v4l3 3"/>
                          <circle cx="12" cy="12" r="10"/>
                        </svg>
                      </div>
                      <div style={{ minWidth: 0, flex: 1 }}>
                        <div style={{ 
                          fontSize: 14, 
                          fontWeight: 500, 
                          color: '#fff',
                          marginBottom: 2,
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {addr.label || t('noLabel', lang)}
                        </div>
                        <div style={{ 
                          fontSize: 12, 
                          color: 'rgba(255, 255, 255, 0.4)',
                          fontFamily: 'monospace',
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {addr.address.slice(0, 8)}...{addr.address.slice(-8)}
                        </div>
                      </div>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.3)" strokeWidth="2">
                      <polyline points="9 18 15 12 9 6"/>
                    </svg>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Saved Addresses Section */}
          <div>
            <div style={{ 
              fontSize: 12, 
              fontWeight: 500, 
              color: 'rgba(255, 255, 255, 0.4)', 
              textTransform: 'uppercase', 
              letterSpacing: '0.5px',
              marginBottom: 12 
            }}>
              {t('savedAddresses', lang)}
            </div>

            {filteredAddresses.length === 0 ? (
              <div style={{
                background: 'rgba(255, 255, 255, 0.02)',
                border: '1px solid rgba(255, 255, 255, 0.06)',
                borderRadius: 16,
                padding: '40px 20px',
                textAlign: 'center'
              }}>
                <div style={{
                  width: 48,
                  height: 48,
                  margin: '0 auto 16px',
                  borderRadius: 12,
                  background: 'rgba(255, 255, 255, 0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.3)" strokeWidth="2">
                    <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
                  </svg>
                </div>
                <p style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', margin: 0 }}>
                  {t('noSavedAddresses', lang)}
                </p>
              </div>
            ) : (
              <div style={{
                background: 'rgba(255, 255, 255, 0.02)',
                border: '1px solid rgba(255, 255, 255, 0.06)',
                borderRadius: 16,
                overflow: 'hidden'
              }}>
                {filteredAddresses.map((addr, idx) => (
                  <div
                    key={addr.address}
                    style={{
                      padding: '14px 16px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      borderBottom: idx < filteredAddresses.length - 1 ? '1px solid rgba(255, 255, 255, 0.06)' : 'none'
                    }}
                  >
                    <div 
                      style={{ display: 'flex', alignItems: 'center', gap: 12, flex: 1, minWidth: 0, cursor: 'pointer' }}
                      onClick={() => handleSelectAddress(addr.address)}
                    >
                      <div style={{
                        width: 36,
                        height: 36,
                        borderRadius: 10,
                        background: 'rgba(255, 255, 255, 0.05)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        flexShrink: 0
                      }}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                          <rect x="2" y="5" width="20" height="14" rx="2"/>
                          <path d="M2 10h20"/>
                        </svg>
                      </div>
                      <div style={{ minWidth: 0, flex: 1 }}>
                        <div style={{ 
                          fontSize: 14, 
                          fontWeight: 500, 
                          color: '#fff',
                          marginBottom: 2,
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {addr.label || t('noLabel', lang)}
                        </div>
                        <div style={{ 
                          fontSize: 12, 
                          color: 'rgba(255, 255, 255, 0.4)',
                          fontFamily: 'monospace',
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {addr.address.slice(0, 8)}...{addr.address.slice(-8)}
                        </div>
                      </div>
                    </div>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <button
                        onClick={() => openEditModal(addr)}
                        style={{
                          width: 32,
                          height: 32,
                          borderRadius: 8,
                          background: 'rgba(255, 255, 255, 0.05)',
                          border: 'none',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer'
                        }}
                      >
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                      </button>
                      <button
                        onClick={() => handleDeleteAddress(addr.address)}
                        style={{
                          width: 32,
                          height: 32,
                          borderRadius: 8,
                          background: 'rgba(239, 68, 68, 0.1)',
                          border: 'none',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer'
                        }}
                      >
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    )
  }

  if (view === "receive") {
    const displayAddress = multisigPda ? vaultPda : wallet?.publicKey.toBase58() || ""
    
    // Create SOL token for receive list
    const solTokenForReceive = {
      mint: "So11111111111111111111111111111111111111112",
      symbol: "SOL",
      name: "Solana",
      logoURI: "https://assets.coingecko.com/coins/images/4128/standard/solana.png"
    }
    
    // All tokens available for receive (any SPL token)
    const allReceiveTokens = [solTokenForReceive, ...tokens.map(t => ({ mint: t.mint, symbol: t.symbol, name: t.name, logoURI: t.logoURI }))]
    const filteredReceiveTokens = tokenSearchQuery 
      ? allReceiveTokens.filter(t => 
          t.symbol.toLowerCase().includes(tokenSearchQuery.toLowerCase()) ||
          t.name.toLowerCase().includes(tokenSearchQuery.toLowerCase())
        )
      : allReceiveTokens

    // Step 1: Token Selection
    if (!receiveSelectedToken) {
      return (
        <div style={containerStyle}>
          {/* Header */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '16px 20px',
            borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
          }}>
            <div style={{ width: 32 }} />
            <h3 style={{ margin: 0, fontSize: 17, fontWeight: 600, color: '#fff' }}>{t('receive', lang)}</h3>
            <button 
              onClick={() => { setView("main"); setReceiveSelectedToken(null); setTokenSearchQuery(""); }}
              style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.5)', cursor: 'pointer', fontSize: 13 }}
            >
              {t('close', lang)}
            </button>
          </div>

          {/* Search */}
          <div style={{ padding: '16px 20px 0' }}>
            <div style={{ position: 'relative' }}>
              <svg 
                width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2"
                style={{ position: 'absolute', left: 14, top: '50%', transform: 'translateY(-50%)' }}
              >
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input
                type="text"
                value={tokenSearchQuery}
                onChange={e => setTokenSearchQuery(e.target.value)}
                placeholder={t('searchAddress', lang).replace('...', '')}
                style={{
                  width: '100%',
                  padding: '12px 14px 12px 42px',
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: 12,
                  color: '#fff',
                  fontSize: 14,
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
            </div>
          </div>

          {/* Token List */}
          <div style={{ padding: '16px 20px', flex: 1, overflowY: 'auto' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
              {filteredReceiveTokens.map(token => (
                <button
                  key={token.mint}
                  onClick={() => setReceiveSelectedToken(token as TokenData)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: 12,
                    padding: '14px 16px',
                    background: 'rgba(255, 255, 255, 0.03)',
                    border: '1px solid rgba(255, 255, 255, 0.06)',
                    borderRadius: 16,
                    cursor: 'pointer',
                    transition: 'all 0.2s',
                    width: '100%',
                    textAlign: 'left'
                  }}
                >
                  {/* Token Logo */}
                  <div style={{
                    width: 44,
                    height: 44,
                    borderRadius: 12,
                    background: 'rgba(255, 255, 255, 0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0
                  }}>
                    {token.logoURI ? (
                      <img 
                        src={token.logoURI} 
                        alt={token.symbol}
                        style={{ width: 28, height: 28, borderRadius: 8 }}
                        onError={(e) => { (e.target as HTMLImageElement).style.display = 'none' }}
                      />
                    ) : (
                      <span style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>{token.symbol.slice(0, 2)}</span>
                    )}
                  </div>
                  
                  {/* Token Info */}
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{token.symbol}</div>
                    <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                      {token.mint.slice(0, 8)}...{token.mint.slice(-4)}
                    </div>
                  </div>

                  {/* QR Icon + Copy Icon */}
                  <div style={{ display: 'flex', gap: 8 }}>
                    <div style={{
                      width: 32,
                      height: 32,
                      borderRadius: 8,
                      background: 'rgba(255, 255, 255, 0.05)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                      </svg>
                    </div>
                    <div style={{
                      width: 32,
                      height: 32,
                      borderRadius: 8,
                      background: 'rgba(255, 255, 255, 0.05)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                        <rect x="9" y="9" width="13" height="13" rx="2"/>
                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                      </svg>
                    </div>
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* Close Button */}
          <div style={{ padding: '16px 20px', borderTop: '1px solid rgba(255, 255, 255, 0.06)' }}>
            <button
              onClick={() => { setView("main"); setReceiveSelectedToken(null); setTokenSearchQuery(""); }}
              style={{
                width: '100%',
                padding: '14px',
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.1)',
                borderRadius: 14,
                color: 'rgba(255, 255, 255, 0.8)',
                fontSize: 15,
                fontWeight: 500,
                cursor: 'pointer'
              }}
            >
              {t('close', lang)}
            </button>
          </div>
        </div>
      )
    }

    // Step 2: Show QR Code for selected token
    return (
      <div style={containerStyle}>
        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          padding: '16px 20px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
        }}>
          <button 
            onClick={() => setReceiveSelectedToken(null)}
            style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 4 }}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <h3 style={{ flex: 1, textAlign: 'center', margin: 0, fontSize: 17, fontWeight: 600, color: '#fff' }}>
            {t('receive', lang)}
          </h3>
          <div style={{ width: 28 }} />
        </div>

        <div style={{ padding: '24px 20px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
          {/* QR Code with logo overlay */}
          <div style={{ 
            position: 'relative',
            background: '#fff', 
            padding: 16, 
            borderRadius: 20, 
            marginBottom: 24,
            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)'
          }}>
            <QRCodeSVG value={displayAddress} size={180} level="M" />
            {/* Token logo overlay in center */}
            <div style={{
              position: 'absolute',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              width: 48,
              height: 48,
              borderRadius: 12,
              background: 'rgba(30, 30, 30, 1)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              border: '3px solid #fff',
              boxShadow: '0 2px 8px rgba(0,0,0,0.2)'
            }}>
              {receiveSelectedToken.logoURI ? (
                <img src={receiveSelectedToken.logoURI} alt={receiveSelectedToken.symbol} style={{ width: 28, height: 28, borderRadius: 6 }} />
              ) : (
                <span style={{ fontSize: 18, fontWeight: 700, color: '#fff' }}>
                  {receiveSelectedToken.symbol.slice(0, 2)}
                </span>
              )}
            </div>
          </div>
          
          {/* Token Info */}
          <div style={{ textAlign: 'center', marginBottom: 20 }}>
            <div style={{ fontSize: 16, fontWeight: 600, color: '#fff', marginBottom: 4 }}>
              {receiveSelectedToken.symbol}
            </div>
            <div style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.5)' }}>
              {multisigPda ? t('yourSecureVaultAddress', lang) : t('yourAddress', lang)}
            </div>
          </div>

          {/* Address Display */}
          <div style={{ 
            width: '100%',
            background: 'rgba(255, 255, 255, 0.03)', 
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: '16px',
            marginBottom: 20
          }}>
            <div style={{ 
              fontSize: 14, 
              fontFamily: 'monospace', 
              color: '#fff',
              wordBreak: 'break-all',
              textAlign: 'center',
              lineHeight: 1.6
            }}>
              {displayAddress}
            </div>
          </div>

          {/* Copy Button */}
          <button 
            onClick={async () => {
              copyToClipboardSafe(displayAddress)
              setStatus(t('copiedToClipboard', lang))
              setTimeout(() => setStatus(""), 2000)
            }}
            style={{
              width: '100%',
              padding: '14px',
              background: 'rgba(255, 255, 255, 0.05)',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              borderRadius: 14,
              color: '#fff',
              fontSize: 15,
              fontWeight: 500,
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: 8
            }}
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <rect x="9" y="9" width="13" height="13" rx="2"/>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
            </svg>
            {t('copyAddress', lang)}
          </button>
          
          {status && (
            <div style={{ marginTop: 16, fontSize: 13, color: '#10b981', textAlign: 'center' }}>
              {status}
            </div>
          )}

          {/* Info Note */}
          <p style={{ 
            marginTop: 20, 
            fontSize: 12, 
            color: 'rgba(255, 255, 255, 0.4)', 
            textAlign: 'center',
            lineHeight: 1.5
          }}>
            This address can only be used to receive compatible SPL tokens.
          </p>
        </div>
      </div>
    )
  }

  // ========== BUY CRYPTO VIEW ==========
  if (view === "buy") {
    const selectedWalletAddress = wallet?.publicKey.toBase58() || ''
    
    // Quick amount presets
    const amountPresets = ["50", "100", "250", "500"]
    
    const handleBuyConfirm = () => {
      if (!selectedWalletAddress) {
        setStatus('No wallet address available')
        return
      }
      if (!buySelectedToken) {
        setStatus('Please select a token to buy')
        return
      }
      
      // Transak URL with parameters - production integration
      const transakApiKey = process.env.PLASMO_PUBLIC_TRANSAK_API_KEY || ''
      const transakParams = new URLSearchParams({
        apiKey: transakApiKey,
        network: 'solana',
        defaultCryptoCurrency: buySelectedToken.symbol,
        cryptoCurrencyList: 'SOL,USDC',
        walletAddress: selectedWalletAddress,
        disableWalletAddressForm: 'true',
        defaultFiatAmount: buyAmount,
        defaultFiatCurrency: 'USD',
        themeColor: '22c55e',
        colorMode: 'DARK',
        productsAvailed: 'BUY',
        defaultPaymentMethod: buyPaymentMethod === 'card' ? 'credit_debit_card' : buyPaymentMethod === 'apple_pay' ? 'apple_pay' : 'google_pay',
        hideMenu: 'true',
        exchangeScreenTitle: 'Buy Crypto'
      })
      
      const transakUrl = `https://global.transak.com/?${transakParams.toString()}`
      
      // PWA: Open Transak in new browser tab
      window.open(transakUrl, '_blank')
    }
    
    return (
      <div style={containerStyle}>
        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '16px 20px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
        }}>
          <div style={{ width: 28 }} />
          <h3 style={{ margin: 0, fontSize: 17, fontWeight: 600, color: '#fff' }}>{t('buy', lang)}</h3>
          <button 
            onClick={() => setView("main")}
            style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.5)', cursor: 'pointer', fontSize: 13 }}
          >
            {t('close', lang)}
          </button>
        </div>

        <div style={{ padding: '16px', flex: 1, overflowY: 'auto' }}>
          {/* Token Selection Card */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: '12px 14px',
            marginBottom: 12
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>You're buying</span>
            </div>
            
            <div style={{ display: 'flex', gap: 8 }}>
              {buyableTokens.map((token) => (
                <button
                  key={token.symbol}
                  onClick={() => setBuySelectedToken(token)}
                  style={{
                    flex: 1,
                    display: 'flex',
                    alignItems: 'center',
                    gap: 10,
                    padding: '12px',
                    borderRadius: 12,
                    border: buySelectedToken?.symbol === token.symbol 
                      ? '1px solid rgba(255, 255, 255, 0.2)' 
                      : '1px solid rgba(255, 255, 255, 0.06)',
                    background: buySelectedToken?.symbol === token.symbol 
                      ? 'rgba(255, 255, 255, 0.1)' 
                      : 'rgba(255, 255, 255, 0.03)',
                    color: '#fff',
                    cursor: 'pointer',
                    transition: 'all 0.15s ease'
                  }}
                >
                  <div style={{
                    width: 32,
                    height: 32,
                    borderRadius: 8,
                    background: 'rgba(255,255,255,0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <img 
                      src={token.logoURI} 
                      alt={token.symbol}
                      style={{ width: 20, height: 20, borderRadius: 5 }}
                    />
                  </div>
                  <div style={{ textAlign: 'left' }}>
                    <div style={{ fontWeight: 600, fontSize: 14 }}>{token.symbol}</div>
                    <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)' }}>{token.name}</div>
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* Amount Card */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: '12px 14px',
            marginBottom: 12
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 10 }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>Amount (USD)</span>
            </div>
            
            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
              <input
                type="text"
                inputMode="decimal"
                value={buyAmount}
                onChange={(e) => {
                  const value = e.target.value.replace(/[^0-9.]/g, '')
                  setBuyAmount(value)
                }}
                placeholder="0"
                style={{
                  flex: 1,
                  background: 'transparent',
                  border: 'none',
                  outline: 'none',
                  fontSize: 28,
                  fontWeight: 600,
                  color: '#fff',
                  padding: 0
                }}
              />
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: 6,
                padding: '8px 12px',
                background: 'rgba(255, 255, 255, 0.05)',
                borderRadius: 10,
                fontSize: 14,
                fontWeight: 600,
                color: '#fff'
              }}>
                <span style={{ color: 'rgba(255,255,255,0.6)' }}>$</span>
                USD
              </div>
            </div>
            
            {/* Amount Presets */}
            <div style={{ display: 'flex', gap: 8, marginTop: 14 }}>
              {amountPresets.map((preset) => (
                <button
                  key={preset}
                  onClick={() => setBuyAmount(preset)}
                  style={{
                    flex: 1,
                    padding: '8px',
                    borderRadius: 10,
                    border: buyAmount === preset 
                      ? '1px solid rgba(255, 255, 255, 0.2)' 
                      : '1px solid rgba(255, 255, 255, 0.06)',
                    background: buyAmount === preset 
                      ? 'rgba(255, 255, 255, 0.1)' 
                      : 'transparent',
                    color: '#fff',
                    fontSize: 13,
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'all 0.15s ease'
                  }}
                >
                  ${preset}
                </button>
              ))}
            </div>
          </div>

          {/* Payment Method Card */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: '12px 14px'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>Pay with</span>
            </div>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
              {/* Credit/Debit Card */}
              <button
                onClick={() => setBuyPaymentMethod("card")}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  padding: '12px 14px',
                  background: buyPaymentMethod === "card" ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.03)',
                  border: buyPaymentMethod === "card" ? '1px solid rgba(255,255,255,0.2)' : '1px solid rgba(255,255,255,0.06)',
                  borderRadius: 12,
                  cursor: 'pointer'
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{
                    width: 8,
                    height: 8,
                    borderRadius: '50%',
                    background: buyPaymentMethod === "card" ? '#22c55e' : 'rgba(255,255,255,0.2)'
                  }} />
                  <div style={{ textAlign: 'left' }}>
                    <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>Credit or Debit Card</div>
                    <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)' }}>Visa, Mastercard, Discover</div>
                  </div>
                </div>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" strokeWidth="2">
                  <rect x="1" y="4" width="22" height="16" rx="2"/>
                  <line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
              </button>

              {/* Apple Pay */}
              <button
                onClick={() => setBuyPaymentMethod("apple_pay")}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  padding: '12px 14px',
                  background: buyPaymentMethod === "apple_pay" ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.03)',
                  border: buyPaymentMethod === "apple_pay" ? '1px solid rgba(255,255,255,0.2)' : '1px solid rgba(255,255,255,0.06)',
                  borderRadius: 12,
                  cursor: 'pointer'
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{
                    width: 8,
                    height: 8,
                    borderRadius: '50%',
                    background: buyPaymentMethod === "apple_pay" ? '#22c55e' : 'rgba(255,255,255,0.2)'
                  }} />
                  <div style={{ textAlign: 'left' }}>
                    <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>Apple Pay</div>
                    <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)' }}>Fast and secure</div>
                  </div>
                </div>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="rgba(255,255,255,0.4)">
                  <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83"/>
                </svg>
              </button>

              {/* Google Pay */}
              <button
                onClick={() => setBuyPaymentMethod("google_pay")}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  padding: '12px 14px',
                  background: buyPaymentMethod === "google_pay" ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.03)',
                  border: buyPaymentMethod === "google_pay" ? '1px solid rgba(255,255,255,0.2)' : '1px solid rgba(255,255,255,0.06)',
                  borderRadius: 12,
                  cursor: 'pointer'
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{
                    width: 8,
                    height: 8,
                    borderRadius: '50%',
                    background: buyPaymentMethod === "google_pay" ? '#22c55e' : 'rgba(255,255,255,0.2)'
                  }} />
                  <div style={{ textAlign: 'left' }}>
                    <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>Google Pay</div>
                    <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)' }}>Fast checkout</div>
                  </div>
                </div>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="rgba(255,255,255,0.4)"/>
                  <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="rgba(255,255,255,0.3)"/>
                  <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="rgba(255,255,255,0.3)"/>
                  <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="rgba(255,255,255,0.4)"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        {/* Provider Badge + Continue Button */}
        <div style={{ padding: '16px 20px', borderTop: '1px solid rgba(255, 255, 255, 0.06)' }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 6,
            marginBottom: 14,
            fontSize: 11,
            color: 'rgba(255,255,255,0.35)'
          }}>
            <span>Powered by</span>
            <span style={{ fontWeight: 600, color: 'rgba(255,255,255,0.5)' }}>Transak</span>
          </div>
          
          <button
            onClick={handleBuyConfirm}
            disabled={!buySelectedToken || !buyAmount || parseFloat(buyAmount) <= 0}
            style={{
              width: '100%',
              padding: '16px',
              background: (!buySelectedToken || !buyAmount || parseFloat(buyAmount) <= 0) 
                ? 'rgba(255, 255, 255, 0.1)' 
                : 'rgba(255, 255, 255, 0.9)',
              border: 'none',
              borderRadius: 14,
              color: (!buySelectedToken || !buyAmount || parseFloat(buyAmount) <= 0) 
                ? 'rgba(255, 255, 255, 0.3)' 
                : '#000',
              fontSize: 16,
              fontWeight: 600,
              cursor: (!buySelectedToken || !buyAmount || parseFloat(buyAmount) <= 0) 
                ? 'not-allowed' 
                : 'pointer'
            }}
          >
            Continue
          </button>
        </div>

        {/* Status Message */}
        {status && (
          <div style={{
            padding: '0 20px 16px',
            textAlign: 'center',
            fontSize: 13,
            color: status.includes('error') || status.includes('Error') ? '#ef4444' : '#10b981'
          }}>
            {status}
          </div>
        )}
      </div>
    )
  }

  if (view === "swap") {
    // All available tokens including SOL for swap
    const solTokenForSwap = {
      mint: "So11111111111111111111111111111111111111112",
      symbol: "SOL",
      name: "Solana",
      amount: activeWallet === "master" ? balance : vaultBalance,
      decimals: 9,
      price: solPrice,
      value: (activeWallet === "master" ? balance : vaultBalance) * solPrice,
      logoURI: "https://assets.coingecko.com/coins/images/4128/standard/solana.png"
    }
    const allSwapTokens = [solTokenForSwap, ...tokens].filter(t => t.amount > 0)
    
    // Helper: Check if swapping SOL leaves enough for fees (only for master wallet)
    const isSwappingSOL = swapFromToken?.mint === "So11111111111111111111111111111111111111112"
    const swapAmountNum = parseFloat(swapAmount) || 0
    // Vault doesn't need SOL reserve - master wallet pays gas
    const needsSolReserve = isSwappingSOL && activeWallet === "master"
    const maxSwappableSOL = needsSolReserve ? Math.max(0, (swapFromToken?.amount || 0) - MIN_SOL_RESERVE_FOR_FEES) : Infinity
    const insufficientForFees = needsSolReserve && swapAmountNum > maxSwappableSOL && swapAmountNum <= (swapFromToken?.amount || 0)

    // Fetch Jupiter quote when amount changes - using enhanced swap module
    const fetchSwapQuote = async (amount?: string) => {
      const amountToUse = amount ?? swapAmount
      if (!swapFromToken || !swapToToken || !amountToUse || parseFloat(amountToUse) <= 0) {
        setSwapQuote(null)
        return
      }
      
      // Note: We allow quote fetching even with insufficient balance
      // so users can see the rates. Balance is validated at swap time.

      // Validate decimals
      const fromDecimals = swapFromToken.decimals ?? 9
      
      setSwapLoading(true)
      try {
        const amountInSmallestUnit = Math.floor(
          parseFloat(amountToUse) * Math.pow(10, fromDecimals)
        ).toString()
        
        const quote = await getSwapQuote({
          inputMint: swapFromToken.mint,
          outputMint: swapToToken.mint,
          amount: amountInSmallestUnit,
          slippageBps: swapSlippage,
          restrictIntermediateTokens: true,  // Safer routing
        })
        
        setSwapQuote(quote)
      } catch (error) {
        console.error('Error fetching swap quote:', error)
        setSwapQuote(null)
      }
      setSwapLoading(false)
    }
    
    // Execute the swap
    const handleExecuteSwap = async () => {
      console.log("[Swap] handleExecuteSwap called", { 
        hasQuote: !!swapQuote, 
        hasFromToken: !!swapFromToken, 
        hasToToken: !!swapToToken, 
        hasWallet: !!wallet,
        activeWallet 
      })
      if (!swapQuote || !swapFromToken || !swapToToken || !wallet) {
        console.log("[Swap] Early return - missing requirements")
        return
      }
      
      console.log("[Swap] Proceeding with swap execution")
      
      setSwapExecuting(true)
      setSwapResult(null)
      
      try {
        // For vault wallet, show coming soon message
        if (activeWallet === "vault") {
          setSwapResult({
            success: false,
            error: "Vault Swap Coming Soon",
            errorType: "unknown",
          })
          setSwapExecuting(false)
          return
        } else {
          // Master wallet - use Jupiter Ultra API with fallback to Legacy
          console.log("[Swap] Setting simpleTxModal for master wallet (Ultra API with fallback)")
          setSimpleTxModal({
            show: true,
            type: 'swap',
            amount: swapAmount,
            token: swapFromToken.symbol,
            toToken: swapToToken.symbol,
            status: 'confirm',
            onConfirm: async () => {
              console.log("[Swap] onConfirm called - starting swap with fallback")
              setSimpleTxModal(prev => ({ ...prev, status: 'processing' }))
              const startTime = Date.now()
              
              try {
                // Calculate amount in smallest unit
                const fromDecimals = swapFromToken.decimals ?? 9
                const amountInSmallestUnit = Math.floor(parseFloat(swapAmount) * Math.pow(10, fromDecimals)).toString()
                
                console.log("[Swap] Using Jupiter swap with Ultra + Legacy fallback")
                console.log("[Swap] Amount:", amountInSmallestUnit, "From:", swapFromToken.symbol, "To:", swapToToken.symbol)
                
                // Use the fallback function - tries Ultra first, then Legacy
                // This provides maximum reliability
                const result = await executeSwapWithFallback(
                  {
                    inputMint: swapFromToken.mint,
                    outputMint: swapToToken.mint,
                    amount: amountInSmallestUnit,
                    taker: wallet.publicKey.toBase58(),
                    // Pass user's slippage preference for fallback
                    slippageBps: swapSlippage,
                  },
                  wallet,
                  connection
                )
                
                const executionTime = (Date.now() - startTime) / 1000
                console.log("[Swap] Final swap result:", result)
                setSwapResult(result)
                
                if (result.success) {
                  setSimpleTxModal(prev => ({ 
                    ...prev, 
                    status: 'success',
                    signature: result.signature,
                    executionTime
                  }))
                  
                  // Refresh balances after successful swap
                  setTimeout(async () => {
                    if (wallet) {
                      const newBalance = await connection.getBalance(wallet.publicKey)
                      setBalance(newBalance / 1e9)
                    }
                  }, 2000)
                  
                  // Close after showing success
                  setTimeout(() => {
                    setSimpleTxModal(prev => ({ ...prev, show: false }))
                  }, 2000)
                } else {
                  setSimpleTxModal(prev => ({ ...prev, status: 'error', error: result.error }))
                }
              } catch (e: any) {
                console.error("[Swap] Swap error:", e)
                setSimpleTxModal(prev => ({ ...prev, status: 'error', error: e.message || "Swap failed. Please try again." }))
              }
            }
          })
          setSwapExecuting(false)
          return // Early return - the modal handles execution
        }
      } catch (error: any) {
        console.error('Swap execution error:', error)
        
        // Detect insufficient master wallet funds error
        const errorMessage = error?.message || error?.toString() || ''
        const insufficientMatch = errorMessage.match(/insufficient lamports (\d+), need (\d+)/)
        
        if (insufficientMatch) {
          const currentLamports = parseInt(insufficientMatch[1])
          const neededLamports = parseInt(insufficientMatch[2])
          setSwapResult({
            success: false,
            error: 'Insufficient funds in master wallet',
            errorType: 'insufficient_master_funds',
            currentAmount: currentLamports / 1e9,
            neededAmount: neededLamports / 1e9,
          })
        } else if (errorMessage.includes('InvalidDestination') || errorMessage.includes('0x1789') || errorMessage.includes('InvalidTokenAccount')) {
          // Stale route/quote error - the AMM pool state has changed
          setSwapResult({
            success: false,
            error: 'Swap route expired. The market moved during execution. Please try again with a smaller amount or higher slippage.',
            errorType: 'stale_route',
          })
        } else if (errorMessage.includes('SlippageToleranceExceeded') || errorMessage.includes('6001')) {
          setSwapResult({
            success: false,
            error: 'Price moved beyond your slippage tolerance. Please try again with higher slippage.',
            errorType: 'slippage',
          })
        } else {
          setSwapResult({
            success: false,
            error: getSwapErrorMessage(error),
            errorType: 'unknown',
          })
        }
      }
      
      setSwapExecuting(false)
    }
    
    // Reset swap state
    const resetSwap = () => {
      setSwapFromToken(null)
      setSwapToToken(null)
      setSwapFromTokenDetail(null)
      setSwapToTokenDetail(null)
      setSwapAmount("")
      setSwapQuote(null)
      setSwapExecuting(false)
      setSwapResult(null)
      setSwapShowSettings(false)
    }
    
    // Get output amount formatted for display
    const getOutputAmount = (): string => {
      if (!swapQuote) return "0"
      const outDecimals = swapToToken?.decimals || (swapToToken?.mint === "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v" ? 6 : 9)
      return formatAmountDisplay(swapQuote.outAmount, outDecimals)
    }
    
    // Get minimum received (after slippage)
    const getMinimumReceived = (): string => {
      if (!swapQuote) return "0"
      const outDecimals = swapToToken?.decimals || (swapToToken?.mint === "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v" ? 6 : 9)
      return formatAmountDisplay(swapQuote.otherAmountThreshold, outDecimals)
    }
    
    // Get price impact level for styling
    const priceImpactLevel: PriceImpactLevel = swapQuote 
      ? getPriceImpactLevel(swapQuote.priceImpactPct) 
      : "safe"
    
    // Format price impact percentage
    const getPriceImpactDisplay = (): string => {
      if (!swapQuote) return "0%"
      const impact = parseFloat(swapQuote.priceImpactPct)
      return `${impact < 0.01 ? "<0.01" : impact.toFixed(2)}%`
    }
    
    // Get slippage display text
    const getSlippageDisplay = (): string => {
      return `${(swapSlippage / 100).toFixed(1)}%`
    }

    // Token selector modal
    if (swapSelectingToken) {
      const tokenList = swapSelectingToken === "from" ? allSwapTokens : [...popularTokens, ...tokens]
      
      // Check if search query looks like a mint address (32-44 chars, base58)
      const isMintAddress = tokenSearchQuery.length >= 32 && tokenSearchQuery.length <= 44 && /^[1-9A-HJ-NP-Za-km-z]+$/.test(tokenSearchQuery)
      
      const filteredSwapTokens = tokenSearchQuery 
        ? tokenList.filter(t => 
            t.symbol.toLowerCase().includes(tokenSearchQuery.toLowerCase()) ||
            t.name.toLowerCase().includes(tokenSearchQuery.toLowerCase()) ||
            t.mint.toLowerCase() === tokenSearchQuery.toLowerCase()
          )
        : tokenList
      
      // Add searched token to results if found and not already in list
      const displayTokens = searchedToken && !filteredSwapTokens.some(t => t.mint === searchedToken.mint)
        ? [searchedToken, ...filteredSwapTokens]
        : filteredSwapTokens
      
      // Look up token when mint address is pasted - try multiple sources
      const handleTokenSearch = async (query: string) => {
        // Validate it looks like a Solana address (base58, 32-44 chars)
        if (query.length >= 32 && query.length <= 44 && /^[1-9A-HJ-NP-Za-km-z]+$/.test(query)) {
          setSearchingToken(true)
          setSearchedToken(null)
          
          try {
            // Try Jupiter's token API first
            let tokenData = null
            
            // Method 1: Jupiter token endpoint
            try {
              const jupResponse = await fetch(`https://tokens.jup.ag/token/${query}`)
              if (jupResponse.ok) {
                const data = await jupResponse.json()
                if (data && data.symbol) {
                  tokenData = {
                    mint: data.address || query,
                    symbol: data.symbol,
                    name: data.name || data.symbol,
                    logoURI: data.logoURI,
                    decimals: data.decimals || 9
                  }
                }
              }
            } catch (e) {
              console.log('Jupiter token lookup failed, trying alternatives...')
            }
            
            // Method 2: Try Jupiter strict token list search
            if (!tokenData) {
              try {
                const searchResponse = await fetch(`https://tokens.jup.ag/tokens?tags=verified&mint=${query}`)
                if (searchResponse.ok) {
                  const tokens = await searchResponse.json()
                  if (tokens && tokens.length > 0) {
                    const t = tokens[0]
                    tokenData = {
                      mint: t.address || query,
                      symbol: t.symbol,
                      name: t.name || t.symbol,
                      logoURI: t.logoURI,
                      decimals: t.decimals || 9
                    }
                  }
                }
              } catch (e) {
                console.log('Jupiter search failed...')
              }
            }
            
            // Method 3: Try DexScreener API (good for pump.fun tokens) - includes rich data
            if (!tokenData) {
              try {
                const dexResponse = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${query}`)
                if (dexResponse.ok) {
                  const dexData = await dexResponse.json()
                  if (dexData?.pairs && dexData.pairs.length > 0) {
                    // Find the pair where our token is either base or quote
                    const pair = dexData.pairs[0]
                    const isBase = pair.baseToken?.address?.toLowerCase() === query.toLowerCase()
                    const token = isBase ? pair.baseToken : pair.quoteToken
                    if (token) {
                      // Pump.fun tokens end with "pump" and have 6 decimals
                      const isPumpFun = query.toLowerCase().endsWith('pump')
                      tokenData = {
                        mint: query,
                        symbol: token.symbol || 'UNKNOWN',
                        name: token.name || token.symbol || 'Unknown Token',
                        logoURI: pair.info?.imageUrl || undefined,
                        bannerURI: pair.info?.header || undefined,
                        decimals: isPumpFun ? 6 : 9, // Pump.fun tokens have 6 decimals
                        price: isBase ? parseFloat(pair.priceUsd || '0') : undefined,
                        marketCap: pair.marketCap ? parseFloat(pair.marketCap) : (pair.fdv ? parseFloat(pair.fdv) : undefined),
                        liquidity: pair.liquidity?.usd ? parseFloat(pair.liquidity.usd) : undefined,
                        volume24h: pair.volume?.h24 ? parseFloat(pair.volume.h24) : undefined,
                        priceChange24h: pair.priceChange?.h24 ? parseFloat(pair.priceChange.h24) : undefined,
                        dexId: pair.dexId || undefined,
                        socials: pair.info?.socials ? {
                          twitter: pair.info.socials.find((s: any) => s.type === 'twitter')?.url,
                          telegram: pair.info.socials.find((s: any) => s.type === 'telegram')?.url,
                          discord: pair.info.socials.find((s: any) => s.type === 'discord')?.url,
                          website: pair.info.websites?.[0]?.url
                        } : undefined
                      }
                    }
                  }
                }
              } catch (e) {
                console.log('DexScreener lookup failed...')
              }
            }
            
            // Method 4: If all else fails, try to get token info from chain
            if (!tokenData) {
              try {
                // At minimum, create a basic entry so user can still try to swap
                // Jupiter might still be able to route it even if not in their token list
                // Pump.fun tokens end with "pump" and have 6 decimals
                const isPumpFun = query.toLowerCase().endsWith('pump')
                tokenData = {
                  mint: query,
                  symbol: query.slice(0, 4).toUpperCase() + '...',
                  name: `Token ${query.slice(0, 6)}...${query.slice(-4)}`,
                  logoURI: undefined,
                  decimals: isPumpFun ? 6 : 9
                }
              } catch (e) {
                console.log('Fallback failed...')
              }
            }
            
            if (tokenData) {
              setSearchedToken(tokenData)
            }
          } catch (error) {
            console.error('Error looking up token:', error)
          }
          setSearchingToken(false)
        }
      }

      return (
        <div style={containerStyle}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            padding: '16px 20px',
            borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
          }}>
            <button 
              onClick={() => { setSwapSelectingToken(null); setTokenSearchQuery(""); setSearchedToken(null); }}
              style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 4 }}
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="15 18 9 12 15 6"/>
              </svg>
            </button>
            <h3 style={{ flex: 1, textAlign: 'center', margin: 0, fontSize: 17, fontWeight: 600, color: '#fff' }}>
              {swapSelectingToken === "from" ? "You pay" : "You receive"}
            </h3>
            <div style={{ width: 28 }} />
          </div>

          <div style={{ padding: '16px 20px 0' }}>
            <div style={{ position: 'relative' }}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2" style={{ position: 'absolute', left: 14, top: '50%', transform: 'translateY(-50%)' }}>
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input
                type="text"
                value={tokenSearchQuery}
                onChange={e => {
                  const val = e.target.value
                  setTokenSearchQuery(val)
                  setSearchedToken(null)
                  // Auto-lookup if it looks like a mint address
                  if (val.length >= 32) {
                    handleTokenSearch(val)
                  }
                }}
                placeholder="Search or paste token address..."
                style={{ width: '100%', padding: '12px 14px 12px 42px', background: 'rgba(255, 255, 255, 0.05)', border: '1px solid rgba(255, 255, 255, 0.08)', borderRadius: 12, color: '#fff', fontSize: 14, outline: 'none', boxSizing: 'border-box' }}
              />
            </div>
          </div>

          <div style={{ padding: '16px 20px', flex: 1, overflowY: 'auto' }}>
            {searchingToken && (
              <div style={{ textAlign: 'center', padding: 20, color: 'rgba(255, 255, 255, 0.5)' }}>
                <div style={{ marginBottom: 8 }}>Looking up token...</div>
              </div>
            )}
            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
              {displayTokens.map(token => {
                const hasBanner = 'bannerURI' in token && token.bannerURI
                return (
                <button
                  key={token.mint}
                  onClick={async () => {
                    // Set the token first
                    if (swapSelectingToken === "from") {
                      setSwapFromToken(token as TokenData)
                      setSwapFromTokenDetail(null)
                      // Fetch detail data in background
                      setLoadingSwapTokenDetail("from")
                      try {
                        const detail = await fetchTokenDetailData(token.mint)
                        if (detail) setSwapFromTokenDetail(detail)
                      } catch (e) { console.log('Failed to fetch from token detail') }
                      setLoadingSwapTokenDetail(null)
                    } else {
                      setSwapToToken(token)
                      setSwapToTokenDetail(null)
                      // Fetch detail data in background
                      setLoadingSwapTokenDetail("to")
                      try {
                        const detail = await fetchTokenDetailData(token.mint)
                        if (detail) setSwapToTokenDetail(detail)
                      } catch (e) { console.log('Failed to fetch to token detail') }
                      setLoadingSwapTokenDetail(null)
                    }
                    setSwapSelectingToken(null)
                    setTokenSearchQuery("")
                    setSearchedToken(null)
                    setSwapQuote(null)
                  }}
                  style={{
                    position: 'relative',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 12,
                    padding: '14px 16px',
                    background: 'rgba(255, 255, 255, 0.03)',
                    border: '1px solid rgba(255, 255, 255, 0.06)',
                    borderRadius: 16,
                    cursor: 'pointer',
                    width: '100%',
                    textAlign: 'left',
                    overflow: 'hidden'
                  }}
                >
                  {/* Banner Background */}
                  {hasBanner && (
                    <div style={{
                      position: 'absolute',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      backgroundImage: `url(${token.bannerURI})`,
                      backgroundSize: 'cover',
                      backgroundPosition: 'center',
                      opacity: 0.15,
                      zIndex: 0
                    }} />
                  )}
                  <div style={{
                    width: 40,
                    height: 40,
                    borderRadius: 10,
                    background: 'rgba(255, 255, 255, 0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    overflow: 'hidden',
                    position: 'relative',
                    zIndex: 1,
                    flexShrink: 0
                  }}>
                    {token.logoURI ? (
                      <img src={token.logoURI} alt={token.symbol} style={{ width: 26, height: 26, borderRadius: 6 }} />
                    ) : (
                      <span style={{ fontSize: 14, fontWeight: 600, color: '#fff' }}>{token.symbol.slice(0, 2)}</span>
                    )}
                  </div>
                  <div style={{ flex: 1, position: 'relative', zIndex: 1 }}>
                    <div style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{token.symbol}</div>
                    <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>{token.name}</div>
                  </div>
                  {'amount' in token && (
                    <div style={{ textAlign: 'right', position: 'relative', zIndex: 1 }}>
                      <div style={{ fontSize: 14, color: '#fff' }}>{(token as TokenData).amount.toFixed(4)}</div>
                    </div>
                  )}
                  {/* Show price if available */}
                  {'price' in token && token.price && !('amount' in token) && (
                    <div style={{ textAlign: 'right', position: 'relative', zIndex: 1 }}>
                      <div style={{ fontSize: 13, color: '#fff' }}>${token.price < 0.01 ? token.price.toExponential(2) : token.price.toFixed(4)}</div>
                      {'priceChange24h' in token && token.priceChange24h !== undefined && (
                        <div style={{ 
                          fontSize: 11, 
                          color: token.priceChange24h >= 0 ? '#22c55e' : '#ef4444' 
                        }}>
                          {token.priceChange24h >= 0 ? '+' : ''}{token.priceChange24h.toFixed(2)}%
                        </div>
                      )}
                    </div>
                  )}
                </button>
              );
              })}
              {!searchingToken && displayTokens.length === 0 && tokenSearchQuery && (
                <div style={{ textAlign: 'center', padding: 40, color: 'rgba(255, 255, 255, 0.4)' }}>
                  <div style={{ marginBottom: 8 }}>No tokens found</div>
                  <div style={{ fontSize: 12 }}>Try pasting a valid token address</div>
                </div>
              )}
            </div>
          </div>
        </div>
      )
    }

    // Swap Result Screen (Success/Error)
    if (swapResult) {
      // Special UI for insufficient master wallet funds
      if (swapResult.errorType === 'insufficient_master_funds') {
        const shortAddress = wallet ? `${wallet.publicKey.toBase58().slice(0, 6)}...${wallet.publicKey.toBase58().slice(-4)}` : ''
        const neededSol = swapResult.neededAmount ? (swapResult.neededAmount + 0.005).toFixed(4) : '0.02'
        
        return (
          <div style={containerStyle}>
            <div style={{
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              padding: 24,
              textAlign: 'center'
            }}>
              {/* Warning Icon with Glow */}
              <div style={{
                width: 88,
                height: 88,
                borderRadius: '50%',
                background: 'linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%)',
                boxShadow: '0 0 40px rgba(251, 191, 36, 0.15)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                marginBottom: 24,
                position: 'relative'
              }}>
                <div style={{
                  position: 'absolute',
                  inset: -2,
                  borderRadius: '50%',
                  background: 'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.1))',
                  opacity: 0.5,
                  filter: 'blur(8px)'
                }} />
                <svg width="42" height="42" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ position: 'relative', zIndex: 1 }}>
                  <path d="M12 9v4"/>
                  <path d="M12 17h.01"/>
                  <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                </svg>
              </div>
              
              <h2 style={{ 
                margin: '0 0 8px', 
                fontSize: 22, 
                fontWeight: 700, 
                color: '#fbbf24',
                letterSpacing: '-0.02em'
              }}>
                Master Wallet Needs Funds
              </h2>
              
              <p style={{ 
                margin: '0 0 24px', 
                fontSize: 14, 
                color: 'rgba(255, 255, 255, 0.5)',
                maxWidth: 280,
                lineHeight: 1.5
              }}>
                Your master wallet needs SOL to pay for creating the swap proposal on Squads multisig.
              </p>
              
              {/* Info Card */}
              <div style={{
                width: '100%',
                maxWidth: 300,
                background: 'linear-gradient(135deg, rgba(251, 191, 36, 0.08) 0%, rgba(245, 158, 11, 0.03) 100%)',
                border: '1px solid rgba(251, 191, 36, 0.2)',
                borderRadius: 16,
                padding: 20,
                marginBottom: 20
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between', 
                  alignItems: 'center',
                  marginBottom: 16,
                  paddingBottom: 16,
                  borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
                }}>
                  <span style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.5)' }}>Master Wallet</span>
                  <span style={{ 
                    fontSize: 13, 
                    color: 'rgba(255, 255, 255, 0.8)',
                    fontFamily: 'monospace',
                    background: 'rgba(255, 255, 255, 0.05)',
                    padding: '4px 8px',
                    borderRadius: 6
                  }}>
                    {shortAddress}
                  </span>
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                  <span style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.5)' }}>Current Balance</span>
                  <span style={{ fontSize: 14, color: '#ef4444', fontWeight: 600 }}>
                    {swapResult.currentAmount?.toFixed(6) || '0'} SOL
                  </span>
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.5)' }}>Recommended</span>
                  <span style={{ fontSize: 14, color: '#22c55e', fontWeight: 600 }}>
                    ~{neededSol} SOL
                  </span>
                </div>
              </div>
              
              {/* Explanation */}
              <div style={{
                display: 'flex',
                alignItems: 'flex-start',
                gap: 10,
                padding: 14,
                background: 'rgba(255, 255, 255, 0.03)',
                borderRadius: 12,
                maxWidth: 300,
                textAlign: 'left'
              }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.4)" strokeWidth="2" style={{ flexShrink: 0, marginTop: 1 }}>
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 16v-4"/>
                  <path d="M12 8h.01"/>
                </svg>
                <p style={{ margin: 0, fontSize: 12, color: 'rgba(255, 255, 255, 0.4)', lineHeight: 1.5 }}>
                  The master wallet pays network fees for Squads proposals. Your vault funds remain secure and untouched until the swap executes.
                </p>
              </div>
              
              {/* Copy Address Button */}
              <button
                onClick={async () => {
                  if (wallet) {
                    copyToClipboardSafe(wallet.publicKey.toBase58())
                    // Could add a toast notification here
                  }
                }}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: 8,
                  padding: '12px 20px',
                  marginTop: 20,
                  background: 'rgba(251, 191, 36, 0.1)',
                  border: '1px solid rgba(251, 191, 36, 0.3)',
                  borderRadius: 12,
                  color: '#fbbf24',
                  fontSize: 14,
                  fontWeight: 500,
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                  <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                </svg>
                Copy Master Wallet Address
              </button>
            </div>
            
            <div style={{ padding: '16px 20px', borderTop: '1px solid rgba(255, 255, 255, 0.06)' }}>
              <button
                onClick={() => { resetSwap(); setView("main"); }}
                style={{
                  width: '100%',
                  padding: '16px',
                  background: 'rgba(255, 255, 255, 0.08)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 14,
                  color: 'rgba(255, 255, 255, 0.9)',
                  fontSize: 16,
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                Close
              </button>
            </div>
          </div>
        )
      }
      
      // Success UI
      if (swapResult.success) {
        return (
          <div style={containerStyle}>
            <div style={{
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              padding: 32,
              textAlign: 'center'
            }}>
              {/* Success Icon - Elegant minimal design */}
              <div style={{
                width: 80,
                height: 80,
                borderRadius: '50%',
                background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.08) 100%)',
                border: '1px solid rgba(34, 197, 94, 0.2)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                marginBottom: 24,
                position: 'relative'
              }}>
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#22c55e" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              
              <h2 style={{ 
                margin: '0 0 6px', 
                fontSize: 22, 
                fontWeight: 600, 
                color: '#fff',
                letterSpacing: '-0.02em'
              }}>
                Swap Complete
              </h2>
              
              {swapFromToken && swapToToken && (
                <>
                  <p style={{ 
                    margin: '0 0 28px', 
                    fontSize: 14, 
                    color: 'rgba(255, 255, 255, 0.4)'
                  }}>
                    Transaction confirmed
                  </p>
                  
                  {/* Minimal Swap Summary */}
                  <div style={{
                    width: '100%',
                    maxWidth: 280,
                    marginBottom: 28
                  }}>
                    {/* From Token */}
                    <div style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      justifyContent: 'space-between',
                      padding: '14px 0',
                      borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                        <div style={{
                          width: 36,
                          height: 36,
                          borderRadius: '50%',
                          background: 'rgba(255, 255, 255, 0.05)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          overflow: 'hidden'
                        }}>
                          {swapFromToken.logoURI ? (
                            <img src={swapFromToken.logoURI} alt="" style={{ width: 28, height: 28, borderRadius: '50%' }} />
                          ) : (
                            <span style={{ fontSize: 14, fontWeight: 600, color: 'rgba(255, 255, 255, 0.5)' }}>
                              {swapFromToken.symbol.charAt(0)}
                            </span>
                          )}
                        </div>
                        <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)' }}>Sent</span>
                      </div>
                      <span style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>
                        -{swapAmount} {swapFromToken.symbol}
                      </span>
                    </div>
                    
                    {/* To Token */}
                    <div style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      justifyContent: 'space-between',
                      padding: '14px 0'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                        <div style={{
                          width: 36,
                          height: 36,
                          borderRadius: '50%',
                          background: 'rgba(34, 197, 94, 0.1)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          overflow: 'hidden'
                        }}>
                          {swapToToken.logoURI ? (
                            <img src={swapToToken.logoURI} alt="" style={{ width: 28, height: 28, borderRadius: '50%' }} />
                          ) : (
                            <span style={{ fontSize: 14, fontWeight: 600, color: 'rgba(34, 197, 94, 0.7)' }}>
                              {swapToToken.symbol.charAt(0)}
                            </span>
                          )}
                        </div>
                        <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)' }}>Received</span>
                      </div>
                      <span style={{ fontSize: 16, fontWeight: 600, color: '#22c55e' }}>
                        +{getOutputAmount()} {swapToToken.symbol}
                      </span>
                    </div>
                  </div>
                </>
              )}
              
              {swapResult.signature && (
                <button
                  onClick={() => window.open(`https://orb.helius.dev/tx/${swapResult.signature}?tab=summary`, '_blank')}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: 8,
                    padding: '10px 16px',
                    background: 'transparent',
                    border: '1px solid rgba(255, 255, 255, 0.08)',
                    borderRadius: 10,
                    color: 'rgba(255, 255, 255, 0.5)',
                    fontSize: 13,
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.15)';
                    e.currentTarget.style.color = 'rgba(255, 255, 255, 0.7)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.08)';
                    e.currentTarget.style.color = 'rgba(255, 255, 255, 0.5)';
                  }}
                >
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/>
                    <line x1="10" y1="14" x2="21" y2="3"/>
                  </svg>
                  View on Orb
                </button>
              )}
            </div>
            
            <div style={{ padding: '20px 24px' }}>
              <button
                onClick={() => { resetSwap(); setView("main"); }}
                style={{
                  width: '100%',
                  padding: '14px',
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: 12,
                  color: '#fff',
                  fontSize: 15,
                  fontWeight: 500,
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.05)';
                }}
              >
                Done
              </button>
            </div>
          </div>
        )
      }
      
      // Generic Error UI
      return (
        <div style={containerStyle}>
          <div style={{
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: 24,
            textAlign: 'center'
          }}>
            {/* Error Icon */}
            <div style={{
              width: 88,
              height: 88,
              borderRadius: '50%',
              background: 'linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.1) 100%)',
              boxShadow: '0 0 40px rgba(239, 68, 68, 0.15)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              marginBottom: 24,
              position: 'relative'
            }}>
              <svg width="42" height="42" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
              </svg>
            </div>
            
            <h2 style={{ 
              margin: '0 0 8px', 
              fontSize: 22, 
              fontWeight: 700, 
              color: '#ef4444',
              letterSpacing: '-0.02em'
            }}>
              Swap Failed
            </h2>
            
            {swapResult.error && (
              <p style={{ 
                margin: '0 0 24px', 
                fontSize: 14, 
                color: 'rgba(255, 255, 255, 0.5)',
                padding: '14px 18px',
                background: 'rgba(239, 68, 68, 0.08)',
                border: '1px solid rgba(239, 68, 68, 0.15)',
                borderRadius: 14,
                maxWidth: 300,
                lineHeight: 1.5
              }}>
                {swapResult.error}
              </p>
            )}
            
            <button
              onClick={() => { setSwapResult(null); }}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 8,
                padding: '12px 24px',
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.1)',
                borderRadius: 12,
                color: 'rgba(255, 255, 255, 0.7)',
                fontSize: 14,
                cursor: 'pointer'
              }}
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M1 4v6h6"/>
                <path d="M3.51 15a9 9 0 102.13-9.36L1 10"/>
              </svg>
              Try Again
            </button>
          </div>
          
          <div style={{ padding: '16px 20px', borderTop: '1px solid rgba(255, 255, 255, 0.06)' }}>
            <button
              onClick={() => { resetSwap(); setView("main"); }}
              style={{
                width: '100%',
                padding: '16px',
                background: 'rgba(255, 255, 255, 0.08)',
                border: '1px solid rgba(255, 255, 255, 0.1)',
                borderRadius: 14,
                color: 'rgba(255, 255, 255, 0.9)',
                fontSize: 16,
                fontWeight: 600,
                cursor: 'pointer'
              }}
            >
              Close
            </button>
          </div>
        </div>
      )
    }

    // Swap Settings Panel
    if (swapShowSettings) {
      return (
        <div style={containerStyle}>
          {/* Header */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '16px 20px',
            borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
          }}>
            <button 
              onClick={() => setSwapShowSettings(false)}
              style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 4 }}
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="15 18 9 12 15 6"/>
              </svg>
            </button>
            <h3 style={{ margin: 0, fontSize: 17, fontWeight: 600, color: '#fff' }}>Swap Settings</h3>
            <div style={{ width: 28 }} />
          </div>

          <div style={{ padding: 20, flex: 1 }}>
            {/* Slippage Tolerance */}
            <div style={{ marginBottom: 24 }}>
              <div style={{ 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'space-between',
                marginBottom: 12
              }}>
                <div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#fff', marginBottom: 2 }}>Slippage Tolerance</div>
                  <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.4)' }}>
                    Jupiter Ultra auto-optimizes for best execution
                  </div>
                </div>
              </div>
              
              {/* Preset Buttons */}
              <div style={{ display: 'flex', gap: 8, marginBottom: 12 }}>
                {[
                  { value: SLIPPAGE_PRESETS.LOW, label: '0.1%' },
                  { value: SLIPPAGE_PRESETS.NORMAL, label: '0.5%' },
                  { value: SLIPPAGE_PRESETS.HIGH, label: '1%' },
                  { value: SLIPPAGE_PRESETS.TURBO, label: '3%' },
                ].map(({ value, label }) => (
                  <button
                    key={value}
                    onClick={() => { setSwapSlippage(value); setSwapCustomSlippage(""); setSwapQuote(null); }}
                    style={{
                      flex: 1,
                      padding: '10px 8px',
                      background: swapSlippage === value && !swapCustomSlippage 
                        ? 'rgba(255,255,255,0.15)' 
                        : 'rgba(255,255,255,0.05)',
                      border: swapSlippage === value && !swapCustomSlippage 
                        ? '1px solid rgba(255,255,255,0.3)' 
                        : '1px solid rgba(255,255,255,0.1)',
                      borderRadius: 10,
                      color: '#fff',
                      fontSize: 13,
                      fontWeight: swapSlippage === value && !swapCustomSlippage ? 600 : 400,
                      cursor: 'pointer'
                    }}
                  >
                    {label}
                  </button>
                ))}
              </div>
              
              {/* Custom Input */}
              <div style={{ position: 'relative' }}>
                <input
                  type="text"
                  placeholder="Custom"
                  value={swapCustomSlippage}
                  onChange={e => {
                    const val = e.target.value.replace(/[^0-9.]/g, '')
                    setSwapCustomSlippage(val)
                    const num = parseFloat(val)
                    if (!isNaN(num) && num > 0 && num <= 50) {
                      setSwapSlippage(Math.round(num * 100))
                      setSwapQuote(null)
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '12px 40px 12px 14px',
                    background: 'rgba(255,255,255,0.05)',
                    border: swapCustomSlippage ? '1px solid rgba(255,255,255,0.3)' : '1px solid rgba(255,255,255,0.1)',
                    borderRadius: 10,
                    color: '#fff',
                    fontSize: 14,
                    outline: 'none'
                  }}
                />
                <span style={{
                  position: 'absolute',
                  right: 14,
                  top: '50%',
                  transform: 'translateY(-50%)',
                  color: 'rgba(255,255,255,0.4)',
                  fontSize: 14
                }}>%</span>
              </div>
              
              {/* Warning for high slippage */}
              {swapSlippage > SLIPPAGE_PRESETS.HIGH && (
                <div style={{
                  marginTop: 8,
                  padding: '8px 12px',
                  background: 'rgba(245, 158, 11, 0.1)',
                  borderRadius: 8,
                  fontSize: 12,
                  color: '#f59e0b',
                  display: 'flex',
                  alignItems: 'center',
                  gap: 6
                }}>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  High slippage may result in an unfavorable trade
                </div>
              )}
            </div>

            {/* Transaction Speed / Priority */}
            <div style={{ marginBottom: 24 }}>
              <div style={{ marginBottom: 12 }}>
                <div style={{ fontSize: 14, fontWeight: 600, color: '#fff', marginBottom: 2 }}>Transaction Speed</div>
                <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.4)' }}>
                  Ultra uses optimized landing for sub-second execution
                </div>
              </div>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                {(Object.keys(PRIORITY_LEVELS) as Array<keyof typeof PRIORITY_LEVELS>).map((key) => {
                  const { label, description, maxLamports } = PRIORITY_LEVELS[key]
                  const isSelected = swapPriorityLevel === key
                  const feeInSol = maxLamports / 1_000_000_000
                  
                  return (
                    <button
                      key={key}
                      onClick={() => setSwapPriorityLevel(key)}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        padding: '14px 16px',
                        background: isSelected ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.03)',
                        border: isSelected ? '1px solid rgba(255,255,255,0.2)' : '1px solid rgba(255,255,255,0.06)',
                        borderRadius: 12,
                        cursor: 'pointer'
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                        <div style={{
                          width: 8,
                          height: 8,
                          borderRadius: '50%',
                          background: isSelected ? '#22c55e' : 'rgba(255,255,255,0.2)'
                        }} />
                        <div style={{ textAlign: 'left' }}>
                          <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>{label}</div>
                          <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)' }}>{description}</div>
                        </div>
                      </div>
                      {maxLamports > 0 && (
                        <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)' }}>
                          +{feeInSol < 0.0001 ? '<0.0001' : feeInSol.toFixed(4)} SOL
                        </div>
                      )}
                    </button>
                  )
                })}
              </div>
            </div>

            {/* Degen Tools Divider - Only show if either feature is enabled */}
            {(FEATURES.DEGEN_MODE || FEATURES.SNIPER_CONTEXT_MENU) && (
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: 12, 
              margin: '8px 0 20px',
              paddingTop: 20,
              borderTop: '1px solid rgba(255, 255, 255, 0.08)'
            }}>
              <div style={{ 
                display: 'flex', 
                alignItems: 'center', 
                gap: 6,
                padding: '4px 10px',
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.1)',
                borderRadius: 8
              }}>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.6)" strokeWidth="2">
                  <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                <span style={{ fontSize: 12, fontWeight: 600, color: 'rgba(255, 255, 255, 0.7)' }}>Trading Tools</span>
              </div>
              <div style={{ flex: 1, height: 1, background: 'rgba(255, 255, 255, 0.06)' }} />
            </div>
            )}

            {/* Degen Mode Toggle */}
            {FEATURES.DEGEN_MODE ? (
            <div style={{ marginBottom: 16 }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '14px 16px',
                background: degenMode ? 'rgba(16, 185, 129, 0.08)' : 'rgba(255, 255, 255, 0.03)',
                border: degenMode ? '1px solid rgba(16, 185, 129, 0.2)' : '1px solid rgba(255, 255, 255, 0.06)',
                borderRadius: 12,
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
              onClick={() => {
                const newValue = !degenMode;
                setDegenMode(newValue);
                // Save to storage and notify background - EXTENSION ONLY
                if (isExtensionContext()) {
                  chrome.storage.sync.set({ 
                    degen_settings: { 
                      degenMode: newValue, 
                      sniperShortcuts, 
                      snipeAmounts 
                    } 
                  });
                }
              }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{
                    width: 36,
                    height: 36,
                    borderRadius: 10,
                    background: degenMode ? 'rgba(16, 185, 129, 0.15)' : 'rgba(255, 255, 255, 0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke={degenMode ? '#10b981' : 'rgba(255,255,255,0.5)'} strokeWidth="2">
                      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                  </div>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>Quick Trade Mode</div>
                    <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)' }}>
                      Side panel + auto-detect tokens from charts
                    </div>
                  </div>
                </div>
                <div style={{
                  width: 44,
                  height: 24,
                  borderRadius: 12,
                  background: degenMode ? '#10b981' : 'rgba(255, 255, 255, 0.15)',
                  padding: 2,
                  transition: 'all 0.2s ease'
                }}>
                  <div style={{
                    width: 20,
                    height: 20,
                    borderRadius: 10,
                    background: '#fff',
                    transform: degenMode ? 'translateX(20px)' : 'translateX(0)',
                    transition: 'transform 0.2s ease',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.3)'
                  }} />
                </div>
              </div>
              {degenMode && (
                <div style={{
                  marginTop: 8,
                  padding: '10px 12px',
                  background: 'rgba(16, 185, 129, 0.08)',
                  borderRadius: 8,
                  fontSize: 11,
                  color: 'rgba(16, 185, 129, 0.9)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 }}>
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/></svg>
                    Opens as side panel on DEX sites
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    Auto-detects token from DexScreener/Pump.fun URL
                  </div>
                </div>
              )}
            </div>
            ) : null}

            {/* Sniper Shortcuts Toggle */}
            {FEATURES.SNIPER_CONTEXT_MENU ? (
            <div>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '14px 16px',
                background: sniperShortcuts ? 'rgba(16, 185, 129, 0.08)' : 'rgba(255, 255, 255, 0.03)',
                border: sniperShortcuts ? '1px solid rgba(16, 185, 129, 0.2)' : '1px solid rgba(255, 255, 255, 0.06)',
                borderRadius: 12,
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
              onClick={() => {
                const newValue = !sniperShortcuts;
                setSniperShortcuts(newValue);
                // Save to storage and notify background - EXTENSION ONLY
                if (isExtensionContext()) {
                  chrome.storage.sync.set({ 
                    degen_settings: { 
                      degenMode, 
                      sniperShortcuts: newValue, 
                      snipeAmounts 
                    } 
                  });
                }
              }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{
                    width: 36,
                    height: 36,
                    borderRadius: 10,
                    background: sniperShortcuts ? 'rgba(16, 185, 129, 0.15)' : 'rgba(255, 255, 255, 0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke={sniperShortcuts ? '#10b981' : 'rgba(255,255,255,0.5)'} strokeWidth="2">
                      <circle cx="12" cy="12" r="10"/>
                      <circle cx="12" cy="12" r="6"/>
                      <circle cx="12" cy="12" r="2"/>
                      <line x1="12" y1="2" x2="12" y2="6"/>
                      <line x1="12" y1="18" x2="12" y2="22"/>
                      <line x1="2" y1="12" x2="6" y2="12"/>
                      <line x1="18" y1="12" x2="22" y2="12"/>
                    </svg>
                  </div>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>Quick Snipe</div>
                    <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)' }}>
                      Right-click  ARGUS Snipe on addresses
                    </div>
                  </div>
                </div>
                <div style={{
                  width: 44,
                  height: 24,
                  borderRadius: 12,
                  background: sniperShortcuts ? '#10b981' : 'rgba(255, 255, 255, 0.15)',
                  padding: 2,
                  transition: 'all 0.2s ease'
                }}>
                  <div style={{
                    width: 20,
                    height: 20,
                    borderRadius: 10,
                    background: '#fff',
                    transform: sniperShortcuts ? 'translateX(20px)' : 'translateX(0)',
                    transition: 'transform 0.2s ease',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.3)'
                  }} />
                </div>
              </div>

              {/* Snipe Amount Inputs - Only show when Sniper Shortcuts is ON */}
              {sniperShortcuts && (
                <div style={{
                  marginTop: 12,
                  padding: 14,
                  background: 'rgba(255, 255, 255, 0.03)',
                  borderRadius: 10,
                  border: '1px solid rgba(255, 255, 255, 0.06)'
                }}>
                  <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', marginBottom: 10 }}>
                    Quick buy amounts (SOL)
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
                    {snipeAmounts.map((amount, index) => (
                      <div key={index} style={{ position: 'relative' }}>
                        <input
                          type="text"
                          value={amount}
                          onChange={(e) => {
                            const val = e.target.value.replace(/[^0-9.]/g, '');
                            const newAmounts = [...snipeAmounts] as [string, string, string, string];
                            newAmounts[index] = val;
                            setSnipeAmounts(newAmounts);
                            // Save to storage - EXTENSION ONLY
                            if (isExtensionContext()) {
                              chrome.storage.sync.set({ 
                                degen_settings: { 
                                  degenMode, 
                                  sniperShortcuts, 
                                  snipeAmounts: newAmounts 
                                } 
                              });
                            }
                          }}
                          placeholder={`Amount ${index + 1}`}
                          style={{
                            width: '100%',
                            padding: '10px 40px 10px 12px',
                            background: 'rgba(255, 255, 255, 0.05)',
                            border: '1px solid rgba(255, 255, 255, 0.1)',
                            borderRadius: 8,
                            color: '#fff',
                            fontSize: 13,
                            outline: 'none'
                          }}
                        />
                        <span style={{
                          position: 'absolute',
                          right: 10,
                          top: '50%',
                          transform: 'translateY(-50%)',
                          fontSize: 11,
                          color: 'rgba(255, 255, 255, 0.4)'
                        }}>SOL</span>
                      </div>
                    ))}
                  </div>
                  <div style={{
                    marginTop: 10,
                    padding: '8px 10px',
                    background: 'rgba(239, 68, 68, 0.1)',
                    borderRadius: 6,
                    fontSize: 10,
                    color: 'rgba(239, 68, 68, 0.8)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 6
                  }}>
                    <span></span>
                    Select any token address  Right-click  ARGUS Snipe  Buy instantly
                  </div>
                </div>
              )}
            </div>
            ) : null}
          </div>

          {/* Save Button */}
          <div style={{ padding: '16px 20px', borderTop: '1px solid rgba(255, 255, 255, 0.06)' }}>
            <button
              onClick={() => { setSwapShowSettings(false); if (swapFromToken && swapToToken && swapAmount) fetchSwapQuote(); }}
              style={{
                width: '100%',
                padding: '16px',
                background: 'rgba(255, 255, 255, 0.9)',
                border: 'none',
                borderRadius: 14,
                color: '#000',
                fontSize: 16,
                fontWeight: 600,
                cursor: 'pointer'
              }}
            >
              Save Settings
            </button>
          </div>
        </div>
      )
    }

    return (
      <div style={containerStyle}>
        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '16px 20px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)',
          flexShrink: 0
        }}>
          <button 
            onClick={() => setSwapShowSettings(true)}
            style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.5)', cursor: 'pointer', padding: 4 }}
            title="Swap Settings"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
          </button>
          <h3 style={{ margin: 0, fontSize: 17, fontWeight: 600, color: '#fff' }}>Swap</h3>
          <button 
            onClick={() => { resetSwap(); setView("main"); }}
            style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.5)', cursor: 'pointer', fontSize: 13 }}
          >
            {t('close', lang)}
          </button>
        </div>

        <div style={{ padding: '16px', flex: 1, overflowY: 'auto' }}>
          {/* You Pay Card */}
          <div style={{
            position: 'relative',
            overflow: 'hidden',
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: '12px 14px',
            marginBottom: 6
          }}>
            {/* Banner background for "from" token */}
            {(swapFromTokenDetail?.bannerURI || swapFromToken?.bannerURI) && (
              <>
                <div style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  backgroundImage: `url(${swapFromTokenDetail?.bannerURI || swapFromToken?.bannerURI})`,
                  backgroundSize: 'cover',
                  backgroundPosition: 'center',
                  opacity: 0.12
                }} />
                <div style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'linear-gradient(135deg, rgba(10, 15, 10, 0.8) 0%, rgba(10, 15, 10, 0.6) 100%)'
                }} />
              </>
            )}
            <div style={{ position: 'relative', zIndex: 1 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>You pay</span>
              {swapFromToken && swapFromToken.amount !== undefined && parseFloat(swapAmount) > swapFromToken.amount ? (
                <span style={{ fontSize: 12, color: '#ef4444' }}>Insufficient balance</span>
              ) : insufficientForFees ? (
                <span style={{ fontSize: 12, color: '#ef4444' }}>Keep ~{MIN_SOL_RESERVE_FOR_FEES} SOL for fees</span>
              ) : null}
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
              <input
                type="text"
                value={swapAmount}
                onChange={e => { 
                  const val = e.target.value
                  setSwapAmount(val)
                  swapAmountRef.current = val
                  setSwapQuote(null)
                  // Clear previous timeout
                  if (swapQuoteTimeoutRef.current) {
                    clearTimeout(swapQuoteTimeoutRef.current)
                  }
                  // Auto-fetch quote after short delay (debounce)
                  if (swapFromToken && swapToToken && val && parseFloat(val) > 0) {
                    swapQuoteTimeoutRef.current = setTimeout(() => {
                      // Only fetch if value hasn't changed
                      if (swapAmountRef.current === val) {
                        fetchSwapQuote(val)
                      }
                    }, 500)
                  }
                }}
                placeholder="0"
                style={{
                  flex: 1,
                  background: 'none',
                  border: 'none',
                  color: swapFromToken && swapFromToken.amount !== undefined && parseFloat(swapAmount) > swapFromToken.amount ? '#ef4444' : '#fff',
                  fontSize: 28,
                  fontWeight: 600,
                  outline: 'none',
                  width: '50%',
                  caretColor: '#fff'
                }}
              />
              <button
                onClick={() => setSwapSelectingToken("from")}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: 8,
                  padding: '8px 12px',
                  background: 'rgba(255, 255, 255, 0.08)',
                  border: 'none',
                  borderRadius: 12,
                  cursor: 'pointer'
                }}
              >
                {swapFromToken ? (
                  <>
                    <div style={{
                      width: 28,
                      height: 28,
                      borderRadius: 8,
                      background: 'rgba(255, 255, 255, 0.05)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      {swapFromToken.logoURI ? (
                        <img src={swapFromToken.logoURI} alt="" style={{ width: 18, height: 18, borderRadius: 5 }} />
                      ) : (
                        <span style={{ fontSize: 10, fontWeight: 600, color: '#fff' }}>{swapFromToken.symbol.slice(0, 2)}</span>
                      )}
                    </div>
                    <span style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{swapFromToken.symbol}</span>
                  </>
                ) : (
                  <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.6)' }}>Select</span>
                )}
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </button>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: 8 }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                ~{formatCurrency(parseFloat(swapAmount || '0') * (swapFromToken?.price || 0))}
              </span>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                {/* Balance display */}
                {swapFromToken && swapFromToken.amount !== undefined && (
                  <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                    {(swapFromToken.amount || 0).toFixed((swapFromToken.amount || 0) < 0.01 ? 6 : (swapFromToken.amount || 0) < 1 ? 4 : 2)}
                  </span>
                )}
                {swapFromToken && swapFromToken.amount !== undefined && ['50%', 'MAX'].map(pct => {
                  // For SOL on master wallet, MAX should leave reserve for fees
                  // Vault doesn't need reserve - master wallet pays gas
                  const isSOL = swapFromToken.mint === "So11111111111111111111111111111111111111112"
                  const needsReserve = isSOL && activeWallet === "master"
                  const maxAmount = needsReserve 
                    ? Math.max(0, swapFromToken.amount - MIN_SOL_RESERVE_FOR_FEES)
                    : swapFromToken.amount
                  const amt = pct === '50%' 
                    ? String(maxAmount / 2) 
                    : String(maxAmount)
                  return (
                    <button
                      key={pct}
                      onClick={() => {
                        setSwapAmount(amt)
                        setSwapQuote(null)
                        // Auto-fetch quote after setting amount
                        setTimeout(fetchSwapQuote, 100)
                      }}
                      style={{
                        padding: '2px 8px',
                        background: 'rgba(255, 255, 255, 0.05)',
                        border: 'none',
                        borderRadius: 4,
                        color: 'rgba(255, 255, 255, 0.5)',
                        fontSize: 11,
                        cursor: 'pointer'
                      }}
                    >
                      {pct}
                    </button>
                  )
                })}
              </div>
            </div>
            </div>
          </div>

          {/* Swap Direction Button */}
          <div style={{ display: 'flex', justifyContent: 'center', margin: '-16px 0', position: 'relative', zIndex: 1 }}>
            <button
              onClick={() => {
                // Swap tokens
                const tempToken = swapFromToken
                const tempDetail = swapFromTokenDetail
                setSwapFromToken(swapToToken as TokenData | null)
                setSwapFromTokenDetail(swapToTokenDetail)
                setSwapToToken(tempToken)
                setSwapToTokenDetail(tempDetail)
                setSwapQuote(null)
              }}
              style={{
                width: 40,
                height: 40,
                borderRadius: 12,
                background: '#1a1a1f',
                border: '3px solid #0a0f0a',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2">
                <path d="M7 16V4M7 4L3 8M7 4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/>
              </svg>
            </button>
          </div>

          {/* You Receive Card */}
          <div style={{
            position: 'relative',
            overflow: 'hidden',
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: '12px 14px',
            marginBottom: 10
          }}>
            {/* Banner background for "to" token */}
            {(swapToTokenDetail?.bannerURI || swapToToken?.bannerURI) && (
              <>
                <div style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  backgroundImage: `url(${swapToTokenDetail?.bannerURI || swapToToken?.bannerURI})`,
                  backgroundSize: 'cover',
                  backgroundPosition: 'center',
                  opacity: 0.12
                }} />
                <div style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'linear-gradient(135deg, rgba(10, 15, 10, 0.8) 0%, rgba(10, 15, 10, 0.6) 100%)'
                }} />
              </>
            )}
            <div style={{ position: 'relative', zIndex: 1 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
              <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>You receive</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
              <div style={{ flex: 1, fontSize: 28, fontWeight: 600, color: swapQuote ? '#22c55e' : 'rgba(255, 255, 255, 0.3)' }}>
                {swapLoading ? '...' : swapQuote ? getOutputAmount() : '0'}
              </div>
              <button
                onClick={() => setSwapSelectingToken("to")}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: 8,
                  padding: '8px 12px',
                  background: 'rgba(255, 255, 255, 0.08)',
                  border: 'none',
                  borderRadius: 12,
                  cursor: 'pointer'
                }}
              >
                {swapToToken ? (
                  <>
                    <div style={{
                      width: 28,
                      height: 28,
                      borderRadius: 8,
                      background: 'rgba(255, 255, 255, 0.05)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      {swapToToken.logoURI ? (
                        <img src={swapToToken.logoURI} alt="" style={{ width: 18, height: 18, borderRadius: 5 }} />
                      ) : (
                        <span style={{ fontSize: 10, fontWeight: 600, color: '#fff' }}>{swapToToken.symbol.slice(0, 2)}</span>
                      )}
                    </div>
                    <span style={{ fontSize: 15, fontWeight: 600, color: '#fff' }}>{swapToToken.symbol}</span>
                  </>
                ) : (
                  <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.6)' }}>Select</span>
                )}
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.5)" strokeWidth="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </button>
            </div>
            
            {/* Price Impact Warning (inline) */}
            {swapQuote && priceImpactLevel !== 'safe' && (
              <div style={{ 
                marginTop: 8, 
                fontSize: 12, 
                color: priceImpactLevel === 'warning' ? '#f59e0b' : '#ef4444',
                fontWeight: 500 
              }}>
                 Price impact: {getPriceImpactDisplay()}
              </div>
            )}
            </div>
          </div>

          {/* Token Info Card - "You receive" token - Elegant design */}
          {swapToToken && (swapToTokenDetail || swapToToken.marketCap || swapToToken.bannerURI || swapToToken.price) && (
            <div style={{
              position: 'relative',
              overflow: 'hidden',
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 14,
              marginBottom: 12
            }}>
              {/* Banner Background */}
              {(swapToTokenDetail?.bannerURI || swapToToken.bannerURI) && (
                <div style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  height: 56,
                  backgroundImage: `url(${swapToTokenDetail?.bannerURI || swapToToken.bannerURI})`,
                  backgroundSize: 'cover',
                  backgroundPosition: 'center',
                  opacity: 0.4
                }} />
              )}
              <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                height: 56,
                background: 'linear-gradient(to bottom, transparent 0%, rgba(10, 15, 10, 0.95) 100%)'
              }} />
              
              {/* Token Header */}
              <div style={{
                position: 'relative',
                padding: '10px 12px',
                display: 'flex',
                alignItems: 'center',
                gap: 8,
                borderBottom: '1px solid rgba(255, 255, 255, 0.05)'
              }}>
                <div style={{
                  width: 32,
                  height: 32,
                  borderRadius: 8,
                  background: 'rgba(255,255,255,0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0,
                  border: '2px solid rgba(255,255,255,0.1)'
                }}>
                  {(swapToTokenDetail?.logoURI || swapToToken.logoURI) ? (
                    <img src={swapToTokenDetail?.logoURI || swapToToken.logoURI} alt="" style={{ width: 20, height: 20, borderRadius: 5 }} />
                  ) : (
                    <span style={{ fontSize: 11, fontWeight: 600, color: '#fff' }}>{swapToToken.symbol.slice(0, 2)}</span>
                  )}
                </div>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                    <span style={{ fontSize: 13, fontWeight: 600, color: '#fff' }}>{swapToToken.symbol}</span>
                    {/* DEX Badge with Logo - Clean elegant style */}
                    {(swapToTokenDetail?.dexId || swapToToken.dexId) && (() => {
                      const dexId = swapToTokenDetail?.dexId || swapToToken.dexId || ''
                      // Get DEX display name
                      const getDexName = (id: string) => {
                        if (id.includes('pumpswap') || id.includes('pumpfun') || id.includes('pump')) return 'PumpSwap'
                        if (id.includes('raydium')) return 'Raydium'
                        if (id.includes('orca')) return 'Orca'
                        if (id.includes('meteora')) return 'Meteora'
                        if (id.includes('jupiter')) return 'Jupiter'
                        if (id.includes('lifinity')) return 'Lifinity'
                        if (id.includes('phoenix')) return 'Phoenix'
                        return id.charAt(0).toUpperCase() + id.slice(1)
                      }
                      const dexName = getDexName(dexId)
                      const logoUrl = `https://dd.dexscreener.com/ds-data/dexes/${dexId}.png`
                      return (
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 4,
                          padding: '2px 6px 2px 4px',
                          background: 'rgba(255, 255, 255, 0.05)',
                          border: '1px solid rgba(255, 255, 255, 0.1)',
                          borderRadius: 6,
                          fontSize: 9,
                          fontWeight: 500,
                          color: 'rgba(255, 255, 255, 0.6)'
                        }}>
                          <img 
                            src={logoUrl} 
                            alt="" 
                            style={{ width: 12, height: 12, borderRadius: 2, opacity: 0.8 }}
                            onError={(e) => { (e.target as HTMLImageElement).style.display = 'none' }}
                          />
                          {dexName}
                        </div>
                      )
                    })()}
                  </div>
                  <div style={{ fontSize: 10, color: 'rgba(255,255,255,0.4)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                    {swapToTokenDetail?.name || swapToToken.name}
                  </div>
                </div>
                {/* Socials */}
                <div style={{ display: 'flex', gap: 4 }}>
                  {(swapToTokenDetail?.socials?.twitter || swapToToken.socials?.twitter) && (
                    <a 
                      href={swapToTokenDetail?.socials?.twitter || swapToToken.socials?.twitter}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{ color: 'rgba(255,255,255,0.5)', padding: 3 }}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                      </svg>
                    </a>
                  )}
                  {(swapToTokenDetail?.socials?.telegram || swapToToken.socials?.telegram) && (
                    <a 
                      href={swapToTokenDetail?.socials?.telegram || swapToToken.socials?.telegram}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{ color: 'rgba(255,255,255,0.5)', padding: 3 }}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                      </svg>
                    </a>
                  )}
                  {(swapToTokenDetail?.socials?.website || swapToToken.socials?.website) && (
                    <a 
                      href={swapToTokenDetail?.socials?.website || swapToToken.socials?.website}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{ color: 'rgba(255,255,255,0.5)', padding: 3 }}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                      </svg>
                    </a>
                  )}
                </div>
              </div>
              
              {/* Market Data Grid - 4 columns compact */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(4, 1fr)',
                gap: 1,
                background: 'rgba(255,255,255,0.03)'
              }}>
                {/* Price */}
                <div style={{ padding: '8px 10px', background: '#0a0f0a' }}>
                  <div style={{ fontSize: 9, color: 'rgba(255,255,255,0.4)', marginBottom: 1, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Price</div>
                  <div style={{ fontSize: 12, color: '#fff', fontWeight: 500 }}>
                    ${(() => {
                      const price = swapToTokenDetail?.price || swapToToken.price || 0
                      if (price === 0) return ''
                      if (price < 0.00001) return price.toExponential(1)
                      if (price < 0.01) return price.toFixed(5)
                      if (price < 1) return price.toFixed(4)
                      return price.toFixed(2)
                    })()}
                  </div>
                </div>
                
                {/* 24h Change */}
                <div style={{ padding: '8px 10px', background: '#0a0f0a' }}>
                  <div style={{ fontSize: 9, color: 'rgba(255,255,255,0.4)', marginBottom: 1, textTransform: 'uppercase', letterSpacing: '0.5px' }}>24h</div>
                  <div style={{ 
                    fontSize: 12, 
                    fontWeight: 500,
                    color: (() => {
                      const change = swapToTokenDetail?.priceChange24h || swapToToken.priceChange24h
                      if (change === undefined) return 'rgba(255,255,255,0.4)'
                      return change >= 0 ? '#22c55e' : '#ef4444'
                    })()
                  }}>
                    {(() => {
                      const change = swapToTokenDetail?.priceChange24h || swapToToken.priceChange24h
                      if (change === undefined) return ''
                      return `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`
                    })()}
                  </div>
                </div>
                
                {/* Market Cap */}
                <div style={{ padding: '8px 10px', background: '#0a0f0a' }}>
                  <div style={{ fontSize: 9, color: 'rgba(255,255,255,0.4)', marginBottom: 1, textTransform: 'uppercase', letterSpacing: '0.5px' }}>MCap</div>
                  <div style={{ fontSize: 12, color: '#fff', fontWeight: 500 }}>
                    {(() => {
                      const mcap = swapToTokenDetail?.marketCap || swapToToken.marketCap
                      if (!mcap) return ''
                      if (mcap >= 1e9) return `$${(mcap / 1e9).toFixed(1)}B`
                      if (mcap >= 1e6) return `$${(mcap / 1e6).toFixed(1)}M`
                      if (mcap >= 1e3) return `$${(mcap / 1e3).toFixed(0)}K`
                      return `$${mcap.toFixed(0)}`
                    })()}
                  </div>
                </div>
                
                {/* Liquidity */}
                <div style={{ padding: '8px 10px', background: '#0a0f0a' }}>
                  <div style={{ fontSize: 9, color: 'rgba(255,255,255,0.4)', marginBottom: 1, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Liq</div>
                  <div style={{ fontSize: 12, color: '#fff', fontWeight: 500 }}>
                    {(() => {
                      const liq = swapToTokenDetail?.liquidity || swapToToken.liquidity
                      if (!liq) return ''
                      if (liq >= 1e9) return `$${(liq / 1e9).toFixed(1)}B`
                      if (liq >= 1e6) return `$${(liq / 1e6).toFixed(1)}M`
                      if (liq >= 1e3) return `$${(liq / 1e3).toFixed(0)}K`
                      return `$${liq.toFixed(0)}`
                    })()}
                  </div>
                </div>
              </div>
              
              {/* Loading indicator */}
              {loadingSwapTokenDetail === "to" && (
                <div style={{
                  position: 'absolute',
                  top: 10,
                  right: 10,
                  width: 14,
                  height: 14,
                  border: '2px solid rgba(255,255,255,0.1)',
                  borderTopColor: '#fff',
                  borderRadius: '50%',
                  animation: 'swapSpin 1s linear infinite'
                }} />
              )}
            </div>
          )}

          {/* Swap Info Panel */}
          {swapFromToken && swapToToken && swapQuote && (
            <div style={{
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px solid rgba(255, 255, 255, 0.06)',
              borderRadius: 12,
              padding: '12px 14px',
              marginBottom: 16
            }}>
              {/* Rate */}
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8, fontSize: 13 }}>
                <span style={{ color: 'rgba(255, 255, 255, 0.5)' }}>Rate</span>
                <span style={{ color: '#fff' }}>
                  1 {swapFromToken.symbol}  {calculateRate(
                    swapQuote.inAmount, 
                    swapQuote.outAmount, 
                    swapFromToken.decimals, 
                    swapToToken?.decimals || 9
                  ).toFixed(6)} {swapToToken.symbol}
                </span>
              </div>
              
              {/* Route */}
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8, fontSize: 13 }}>
                <span style={{ color: 'rgba(255, 255, 255, 0.5)' }}>Route</span>
                <span style={{ color: 'rgba(255, 255, 255, 0.7)' }}>{formatRoute(swapQuote.routePlan)}</span>
              </div>
              
              {/* Slippage & Settings Link */}
              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 13 }}>
                <span style={{ color: 'rgba(255, 255, 255, 0.5)' }}>Slippage</span>
                <button 
                  onClick={() => setSwapShowSettings(true)}
                  style={{ 
                    background: 'none', 
                    border: 'none', 
                    color: 'rgba(255, 255, 255, 0.7)', 
                    cursor: 'pointer',
                    fontSize: 13,
                    display: 'flex',
                    alignItems: 'center',
                    gap: 4
                  }}
                >
                  {getSlippageDisplay()}
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </button>
              </div>
            </div>
          )}
        </div>

        {/* Swap Button */}
        <div style={{ padding: '16px 20px', paddingBottom: 'max(16px, env(safe-area-inset-bottom, 16px))', borderTop: '1px solid rgba(255, 255, 255, 0.06)', flexShrink: 0, background: '#121216' }}>
          <button
            disabled={!swapFromToken || !swapToToken || !swapAmount || parseFloat(swapAmount) <= 0 || !swapQuote || (swapFromToken && swapFromToken.amount !== undefined && parseFloat(swapAmount) > swapFromToken.amount) || insufficientForFees || swapExecuting}
            onClick={handleExecuteSwap}
            style={{
              width: '100%',
              padding: '16px',
              background: (swapFromToken && swapToToken && swapAmount && parseFloat(swapAmount) > 0 && swapQuote && (swapFromToken.amount === undefined || parseFloat(swapAmount) <= swapFromToken.amount) && !insufficientForFees && !swapExecuting) 
                ? 'rgba(255, 255, 255, 0.9)' 
                : 'rgba(255, 255, 255, 0.1)',
              border: 'none',
              borderRadius: 14,
              color: (swapFromToken && swapToToken && swapAmount && parseFloat(swapAmount) > 0 && swapQuote && (swapFromToken.amount === undefined || parseFloat(swapAmount) <= swapFromToken.amount) && !insufficientForFees && !swapExecuting) 
                ? '#000' 
                : 'rgba(255, 255, 255, 0.3)',
              fontSize: 16,
              fontWeight: 600,
              cursor: (swapFromToken && swapToToken && swapAmount && parseFloat(swapAmount) > 0 && swapQuote && (swapFromToken.amount === undefined || parseFloat(swapAmount) <= swapFromToken.amount) && !insufficientForFees && !swapExecuting) 
                ? 'pointer' 
                : 'not-allowed'
            }}
          >
            {!swapFromToken || !swapToToken 
              ? 'Select tokens' 
              : !swapAmount || parseFloat(swapAmount) <= 0 
              ? 'Enter amount' 
              : swapFromToken && swapFromToken.amount !== undefined && parseFloat(swapAmount) > swapFromToken.amount
              ? 'Insufficient balance'
              : insufficientForFees
              ? `Keep ${MIN_SOL_RESERVE_FOR_FEES} SOL for fees`
              : swapLoading 
              ? 'Loading...' 
              : swapExecuting
              ? 'Swapping...'
              : 'SWAP'}
          </button>
          <p style={{ margin: '12px 0 0', fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', textAlign: 'center' }}>
            Powered by Jupiter  Slippage: {getSlippageDisplay()}
          </p>
        </div>

        {/* Simple Transaction Modal (Master Wallet - No Security Layers) */}
        {simpleTxModal.show && (
          <>
            <style>
              {`
                @keyframes simpleTxFadeIn {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                @keyframes simpleTxSlideUp {
                  from { transform: translateY(20px); opacity: 0; }
                  to { transform: translateY(0); opacity: 1; }
                }
                @keyframes simpleTxSpin {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(360deg); }
                }
                @keyframes simpleTxSuccessPop {
                  0% { transform: scale(0); }
                  50% { transform: scale(1.2); }
                  100% { transform: scale(1); }
                }
              `}
            </style>
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.85)',
              backdropFilter: 'blur(10px)',
              zIndex: 10000,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              padding: 24,
              animation: 'simpleTxFadeIn 0.3s ease-out'
            }}>
              {/* Warning Banner - Not Protected */}
              <div style={{
                background: 'linear-gradient(90deg, rgba(245, 158, 11, 0.15), rgba(239, 68, 68, 0.15))',
                border: '1px solid rgba(245, 158, 11, 0.3)',
                borderRadius: 12,
                padding: '10px 16px',
                marginBottom: 24,
                display: 'flex',
                alignItems: 'center',
                gap: 10,
                animation: 'simpleTxSlideUp 0.3s ease-out'
              }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <span style={{ fontSize: 12, color: '#f59e0b', fontWeight: 500 }}>
                  Master Wallet - Not Protected by ARGUS
                </span>
              </div>

              {/* Main Content */}
              <div style={{
                background: 'rgba(20, 20, 20, 0.95)',
                borderRadius: 24,
                padding: 24,
                width: '100%',
                maxWidth: 320,
                border: '1px solid rgba(255, 255, 255, 0.1)',
                animation: 'simpleTxSlideUp 0.3s ease-out 0.1s both'
              }}>
                {/* Status Icon */}
                <div style={{ display: 'flex', justifyContent: 'center', marginBottom: 20 }}>
                  {simpleTxModal.status === 'confirm' && (
                    <div style={{
                      width: 64, height: 64, borderRadius: '50%',
                      background: 'rgba(59, 130, 246, 0.1)',
                      border: '2px solid rgba(59, 130, 246, 0.3)',
                      display: 'flex', alignItems: 'center', justifyContent: 'center'
                    }}>
                      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                      </svg>
                    </div>
                  )}
                  {simpleTxModal.status === 'processing' && (
                    <div style={{
                      width: 64, height: 64, borderRadius: '50%',
                      border: '3px solid rgba(59, 130, 246, 0.2)',
                      borderTopColor: '#3b82f6',
                      animation: 'simpleTxSpin 1s linear infinite'
                    }} />
                  )}
                  {simpleTxModal.status === 'success' && (
                    <div style={{
                      width: 64, height: 64, borderRadius: '50%',
                      background: 'rgba(16, 185, 129, 0.1)',
                      border: '2px solid #10b981',
                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                      animation: 'simpleTxSuccessPop 0.4s ease-out'
                    }}>
                      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="3">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    </div>
                  )}
                  {simpleTxModal.status === 'error' && (
                    <div style={{
                      width: 64, height: 64, borderRadius: '50%',
                      background: 'rgba(239, 68, 68, 0.1)',
                      border: '2px solid #ef4444',
                      display: 'flex', alignItems: 'center', justifyContent: 'center'
                    }}>
                      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </div>
                  )}
                </div>

                {/* Title */}
                <div style={{ textAlign: 'center', marginBottom: 20 }}>
                  <div style={{ fontSize: 18, fontWeight: 600, color: '#fff', marginBottom: 4 }}>
                    {simpleTxModal.status === 'confirm' && 'Confirm Swap'}
                    {simpleTxModal.status === 'processing' && 'Processing...'}
                    {simpleTxModal.status === 'success' && 'Swap Complete!'}
                    {simpleTxModal.status === 'error' && 'Swap Failed'}
                  </div>
                  <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>
                    {simpleTxModal.status === 'confirm' && 'Review the details below'}
                    {simpleTxModal.status === 'processing' && 'Please wait...'}
                    {simpleTxModal.status === 'success' && 'Your swap was successful'}
                    {simpleTxModal.status === 'error' && (simpleTxModal.error || 'Something went wrong')}
                  </div>
                </div>

                {/* Transaction Details */}
                <div style={{
                  background: 'rgba(0, 0, 0, 0.3)',
                  borderRadius: 12,
                  padding: 16,
                  marginBottom: 20
                }}>
                  <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.4)', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: 8 }}>
                    SWAPPING
                  </div>
                  <div style={{ fontSize: 24, fontWeight: 700, color: '#fff', display: 'flex', alignItems: 'baseline', gap: 6 }}>
                    {simpleTxModal.amount}
                    <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>{simpleTxModal.token}</span>
                    <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.3)', margin: '0 2px' }}></span>
                    <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.5)', fontWeight: 500 }}>{simpleTxModal.toToken}</span>
                  </div>
                </div>

                {/* Action Buttons */}
                {simpleTxModal.status === 'confirm' && (
                  <div style={{ display: 'flex', gap: 10 }}>
                    <button
                      onClick={() => setSimpleTxModal(prev => ({ ...prev, show: false }))}
                      style={{
                        flex: 1, padding: '14px',
                        background: 'rgba(255, 255, 255, 0.05)',
                        border: '1px solid rgba(255, 255, 255, 0.1)',
                        borderRadius: 12, color: 'rgba(255, 255, 255, 0.7)',
                        fontSize: 14, fontWeight: 500, cursor: 'pointer'
                      }}
                    >
                      Cancel
                    </button>
                    <button
                      onClick={() => simpleTxModal.onConfirm()}
                      style={{
                        flex: 1, padding: '14px',
                        background: '#3b82f6', border: 'none',
                        borderRadius: 12, color: '#fff',
                        fontSize: 14, fontWeight: 600, cursor: 'pointer'
                      }}
                    >
                      Confirm
                    </button>
                  </div>
                )}
                {simpleTxModal.status === 'success' && (
                  <button
                    onClick={() => setSimpleTxModal(prev => ({ ...prev, show: false }))}
                    style={{
                      width: '100%', padding: '14px',
                      background: '#10b981', border: 'none',
                      borderRadius: 12, color: '#fff',
                      fontSize: 14, fontWeight: 600, cursor: 'pointer'
                    }}
                  >
                    Done
                  </button>
                )}
                {simpleTxModal.status === 'error' && (
                  <div style={{ display: 'flex', gap: 10 }}>
                    <button
                      onClick={() => setSimpleTxModal(prev => ({ ...prev, show: false }))}
                      style={{
                        flex: 1, padding: '14px',
                        background: 'rgba(255, 255, 255, 0.05)',
                        border: '1px solid rgba(255, 255, 255, 0.1)',
                        borderRadius: 12, color: 'rgba(255, 255, 255, 0.7)',
                        fontSize: 14, fontWeight: 500, cursor: 'pointer'
                      }}
                    >
                      Close
                    </button>
                    <button
                      onClick={() => setSimpleTxModal(prev => ({ ...prev, status: 'confirm' }))}
                      style={{
                        flex: 1, padding: '14px',
                        background: '#ef4444', border: 'none',
                        borderRadius: 12, color: '#fff',
                        fontSize: 14, fontWeight: 600, cursor: 'pointer'
                      }}
                    >
                      Try Again
                    </button>
                  </div>
                )}
              </div>
            </div>
          </>
        )}
      </div>
    )
  }

  // ==========================================
  // DEGEN MODE - Quick Trading Panel
  // ==========================================
  if (view === "degen") {
    // Refresh detected token balance
    const refreshDegenTokenBalance = async () => {
      if (wallet && detectedToken && connection) {
        try {
          const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
            wallet.publicKey,
            { mint: new PublicKey(detectedToken.address) }
          );
          if (tokenAccounts.value.length > 0) {
            const tokenInfo = tokenAccounts.value[0].account.data.parsed.info.tokenAmount;
            const bal = tokenInfo.uiAmount || 0;
            const decimals = tokenInfo.decimals || 6;
            setDegenTokenBalance(bal);
            setDegenTokenDecimals(decimals);
          } else {
            setDegenTokenBalance(0);
          }
        } catch (e) {
          console.error('[Degen] Failed to refresh token balance:', e);
        }
      }
    };

    // Execute quick buy with retry logic
    const executeDegenBuy = async (solAmount: string) => {
      if (!wallet || !detectedToken) return;
      
      setDegenTradeExecuting(`buy_${solAmount}`);
      
      const amountLamports = Math.floor(parseFloat(solAmount) * 1_000_000_000).toString();
      
      // Retry logic - get fresh quote each attempt
      const maxRetries = 3;
      let lastError: Error | null = null;
      let expectedTokens = 0;
      
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        // Escalate slippage each attempt: 49% -> 65% -> 85%
        const slippageBps = attempt === 1 ? 4900 : attempt === 2 ? 6500 : 8500;
        
        try {
          console.log(`[Degen] Buy attempt ${attempt}/${maxRetries} (slippage: ${slippageBps/100}%)`);
          
          // Get FRESH quote each attempt - use direct routes
          const quote = await getSwapQuote({
            inputMint: 'So11111111111111111111111111111111111111112',
            outputMint: detectedToken.address,
            amount: amountLamports,
            slippageBps,
            onlyDirectRoutes: true, // Direct route = less slippage risk
          });
          
          if (!quote) throw new Error('Failed to get quote');
          
          expectedTokens = parseFloat(quote.outAmount) / 1_000_000_000;
          
          console.log('[Degen] Quote:', {
            outAmount: quote.outAmount,
            minOutput: quote.otherAmountThreshold,
            slippage: quote.slippageBps,
            route: quote.routePlan?.map(r => r.label).join('  ')
          });
          
          // Build transaction IMMEDIATELY after quote
          const swapTx = await buildSwapTransaction({
            quote,
            userPublicKey: wallet.publicKey.toBase58(),
            priorityLevel: 'TURBO', // Always TURBO for degen
            feeAccount: getSwapFeeAccount('So11111111111111111111111111111111111111112', detectedToken.address),
          });
          
          // Execute IMMEDIATELY
          const result = degenMevProtection 
            ? await executeSwapJito(swapTx, wallet, 1_000_000, connection)
            : await executeSwap(swapTx, wallet, connection);
          
          if (result.success) {
            const newTrade: DegenTrade = { 
              type: 'buy', 
              amount: solAmount, 
              success: true, 
              signature: result.signature,
              solAmount: parseFloat(solAmount),
              tokenAmount: expectedTokens,
              symbol: detectedToken.symbol,
              tokenAddress: detectedToken.address,
              tokenLogo: detectedToken.logoURI,
              priceUsd: detectedToken.priceUsd,
              costBasisAtTrade: degenCostBasis ? { ...degenCostBasis } : null,
              timestamp: Date.now(),
            };
            setDegenTradeHistory(prev => [newTrade, ...prev].slice(0, 10)); // Keep last 10 trades
            
            // Update cost basis for PNL tracking
            const solSpent = parseFloat(solAmount);
            const newCostBasis = degenCostBasis 
              ? {
                  totalSolSpent: degenCostBasis.totalSolSpent + solSpent,
                  totalTokensBought: degenCostBasis.totalTokensBought + expectedTokens
                }
              : { totalSolSpent: solSpent, totalTokensBought: expectedTokens };
            
            setDegenCostBasis(newCostBasis);
            saveCostBasis(detectedToken.address, newCostBasis);
            
            // Refresh balances
            const newBalance = await connection.getBalance(wallet.publicKey);
            setBalance(newBalance / 1_000_000_000);
            setTimeout(() => refreshDegenTokenBalance(), 1500);
            setTimeout(() => refreshDegenTokenBalance(), 4000);
            
            setDegenTradeExecuting(null);
            return; // Success!
          }
          
          // Check if slippage error - retry
          if (result.errorCode === 'SLIPPAGE_EXCEEDED' || result.errorCode === 'TX_FAILED') {
            console.log(`[Degen] Attempt ${attempt} failed with slippage, retrying...`);
            lastError = new Error(result.error || 'Slippage exceeded');
            continue;
          }
          
          throw new Error(result.error || 'Swap failed');
          
        } catch (e) {
          lastError = e as Error;
          console.error(`[Degen] Attempt ${attempt} error:`, e);
          
          if (attempt < maxRetries) {
            await new Promise(r => setTimeout(r, 500));
          }
        }
      }
      
      // All retries failed
      console.error('[Degen] All buy attempts failed:', lastError);
      setDegenTradeHistory(prev => [{ type: 'buy', amount: solAmount, success: false, timestamp: Date.now(), symbol: detectedToken?.symbol } as DegenTrade, ...prev].slice(0, 10));
      setDegenTradeExecuting(null);
    };

    // Execute quick sell with retry logic
    const executeDegenSell = async (percentage: string) => {
      if (!wallet || !detectedToken || degenTokenBalance <= 0) return;
      
      setDegenTradeExecuting(`sell_${percentage}`);
      
      // Calculate amount based on percentage - use ACTUAL token decimals!
      const sellAmount = (degenTokenBalance * parseFloat(percentage)) / 100;
      const amountSmallest = Math.floor(sellAmount * Math.pow(10, degenTokenDecimals)).toString();
      console.log(`[Degen] Selling ${sellAmount} tokens (${amountSmallest} smallest units, ${degenTokenDecimals} decimals)`);
      
      // Retry logic - get fresh quote each attempt
      const maxRetries = 3;
      let lastError: Error | null = null;
      
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        // Escalate slippage each attempt: 49% -> 65% -> 85%
        const slippageBps = attempt === 1 ? 4900 : attempt === 2 ? 6500 : 8500;
        
        try {
          console.log(`[Degen] Sell attempt ${attempt}/${maxRetries} (slippage: ${slippageBps/100}%)`);
          
          // Get FRESH quote each attempt - this is crucial!
          // Use direct routes only to avoid multi-hop slippage compound
          const quote = await getSwapQuote({
            inputMint: detectedToken.address,
            outputMint: 'So11111111111111111111111111111111111111112',
            amount: amountSmallest,
            slippageBps,
            onlyDirectRoutes: true, // Direct route = less slippage risk
          });
          
          if (!quote) throw new Error('Failed to get quote');
          
          console.log('[Degen] Quote:', {
            outAmount: quote.outAmount,
            minOutput: quote.otherAmountThreshold,
            slippage: quote.slippageBps,
            route: quote.routePlan?.map(r => r.label).join('  ')
          });
          
          // Build transaction IMMEDIATELY after quote
          const swapTx = await buildSwapTransaction({
            quote,
            userPublicKey: wallet.publicKey.toBase58(),
            priorityLevel: 'TURBO', // Always use TURBO for degen
            feeAccount: getSwapFeeAccount(detectedToken.address, 'So11111111111111111111111111111111111111112'),
          });
          
          // Execute IMMEDIATELY - no delays!
          const result = degenMevProtection 
            ? await executeSwapJito(swapTx, wallet, 1_000_000, connection)
            : await executeSwap(swapTx, wallet, connection);
          
          if (result.success) {
            const solReceived = parseFloat(quote.outAmount) / 1_000_000_000;
            const newTrade: DegenTrade = { 
              type: 'sell', 
              amount: percentage, 
              success: true, 
              signature: result.signature,
              solAmount: solReceived,
              tokenAmount: sellAmount,
              symbol: detectedToken.symbol,
              tokenAddress: detectedToken.address,
              tokenLogo: detectedToken.logoURI,
              priceUsd: detectedToken.priceUsd,
              costBasisAtTrade: degenCostBasis ? { ...degenCostBasis } : null,
              timestamp: Date.now(),
            };
            setDegenTradeHistory(prev => [newTrade, ...prev].slice(0, 10)); // Keep last 10 trades
            
            // Refresh balances
            const newBalance = await connection.getBalance(wallet.publicKey);
            setBalance(newBalance / 1_000_000_000);
            // If selling 100%, immediately set to 0 and clear cost basis
            if (percentage === '100') {
              setDegenTokenBalance(0);
              setDegenCostBasis(null);
              saveCostBasis(detectedToken.address, null);
            } else {
              const expectedRemaining = degenTokenBalance * (1 - parseFloat(percentage) / 100);
              setDegenTokenBalance(expectedRemaining);
            }
            setTimeout(() => refreshDegenTokenBalance(), 1500);
            setTimeout(() => refreshDegenTokenBalance(), 4000);
            
            setDegenTradeExecuting(null);
            return; // Success! Exit retry loop
          }
          
          // Check if it's a slippage error - retry with fresh quote
          if (result.errorCode === 'SLIPPAGE_EXCEEDED' || result.errorCode === 'TX_FAILED') {
            console.log(`[Degen] Attempt ${attempt} failed with slippage, retrying with fresh quote...`);
            lastError = new Error(result.error || 'Slippage exceeded');
            continue; // Try again with fresh quote
          }
          
          // Other error - don't retry
          throw new Error(result.error || 'Swap failed');
          
        } catch (e) {
          lastError = e as Error;
          console.error(`[Degen] Attempt ${attempt} error:`, e);
          
          if (attempt < maxRetries) {
            // Small delay before retry
            await new Promise(r => setTimeout(r, 500));
          }
        }
      }
      
      // All retries failed
      console.error('[Degen] All sell attempts failed:', lastError);
      setDegenTradeHistory(prev => [{ type: 'sell', amount: percentage, success: false, timestamp: Date.now(), symbol: detectedToken?.symbol } as DegenTrade, ...prev].slice(0, 10));
      setDegenTradeExecuting(null);
    };

    return (
      <div className="app-container" style={{
        height: 'auto',
        minHeight: '100%',
        background: 'linear-gradient(180deg, rgba(15, 15, 20, 1) 0%, rgba(8, 8, 12, 1) 100%)',
      }}>
        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '10px 14px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)',
          background: 'rgba(18, 18, 22, 0.95)',
          backdropFilter: 'blur(20px)'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            <button 
              onClick={() => setView("main")}
              style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 4 }}
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="15 18 9 12 15 6"/>
              </svg>
            </button>
            <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
              </svg>
              <span style={{ fontSize: 14, fontWeight: 600, color: '#fff' }}>
                Quick Trade
              </span>
              {/* LIVE indicator when using scraped data */}
              {dataSource === 'scraper' && (
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: 4,
                  padding: '2px 6px',
                  background: 'rgba(16, 185, 129, 0.15)',
                  borderRadius: 4,
                  fontSize: 9,
                  fontWeight: 600,
                  color: '#10b981'
                }}>
                  <div style={{
                    width: 6,
                    height: 6,
                    borderRadius: '50%',
                    background: '#10b981',
                    animation: 'pulse 1.5s ease-in-out infinite'
                  }} />
                  LIVE
                </div>
              )}
            </div>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            {/* MEV Protection Toggle */}
            <div 
              onClick={() => setDegenMevProtection(!degenMevProtection)}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 5,
                padding: '4px 8px',
                background: degenMevProtection ? 'rgba(16, 185, 129, 0.15)' : 'rgba(255, 255, 255, 0.05)',
                border: `1px solid ${degenMevProtection ? 'rgba(16, 185, 129, 0.3)' : 'rgba(255, 255, 255, 0.1)'}`,
                borderRadius: 6,
                cursor: 'pointer',
                fontSize: 10,
                color: degenMevProtection ? '#10b981' : 'rgba(255, 255, 255, 0.5)'
              }}
            >
              <svg width="10" height="10" viewBox="0 0 24 24" fill={degenMevProtection ? '#10b981' : 'none'} stroke="currentColor" strokeWidth="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              MEV
            </div>
            {/* Settings */}
            <button 
              onClick={() => setSwapShowSettings(true)}
              style={{ background: 'rgba(255, 255, 255, 0.05)', border: 'none', borderRadius: 6, padding: 6, cursor: 'pointer', color: 'rgba(255, 255, 255, 0.5)' }}
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
              </svg>
            </button>
          </div>
        </div>

        {/* Balance Display - More compact */}
        <div style={{ padding: '10px 14px', borderBottom: '1px solid rgba(255, 255, 255, 0.05)' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div>
              <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 1 }}>Available</div>
              <div style={{ fontSize: 16, fontWeight: 700 }}>{balance.toFixed(4)} <span style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.5)' }}>SOL</span></div>
            </div>
            <div style={{ textAlign: 'right' }}>
              <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 1 }}> USD</div>
              <div style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.7)' }}>{formatCurrency(balance * solPrice)}</div>
            </div>
          </div>
        </div>

        {/* Token Info - Compact Design */}
        <div style={{ padding: '10px 14px' }}>
          {isLoadingDetectedToken ? (
            <div style={{
              padding: '20px',
              background: 'rgba(255, 255, 255, 0.03)',
              borderRadius: 12,
              textAlign: 'center'
            }}>
              <div style={{ 
                width: 24, height: 24, 
                border: '2px solid rgba(255, 255, 255, 0.1)', 
                borderTopColor: 'rgba(255, 255, 255, 0.6)',
                borderRadius: '50%',
                animation: 'spin 1s linear infinite',
                margin: '0 auto 12px'
              }} />
              <div style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.5)' }}>Detecting token...</div>
            </div>
          ) : detectedToken ? (
            <div style={{
              background: 'rgba(255, 255, 255, 0.03)',
              border: '1px solid rgba(255, 255, 255, 0.08)',
              borderRadius: 16,
              overflow: 'hidden'
            }}>
              {/* Banner with Token Logo */}
              <div style={{ 
                position: 'relative',
                height: 70,
                background: detectedToken.headerURI 
                  ? `linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(18,18,22,0.9)), url(${detectedToken.headerURI})`
                  : 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%)',
                backgroundSize: 'cover',
                backgroundPosition: 'center',
                borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
              }}>
                {/* Token Logo - positioned on right side of banner */}
                <div style={{
                  position: 'absolute',
                  right: 16,
                  bottom: -24,
                  width: 56,
                  height: 56,
                  borderRadius: 14,
                  border: '3px solid #121216',
                  background: '#1a1a1f',
                  overflow: 'hidden',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  {detectedToken.logoURI ? (
                    <img src={detectedToken.logoURI} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                  ) : (
                    <div style={{ 
                      width: '100%', height: '100%',
                      background: 'rgba(255, 255, 255, 0.1)',
                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                      fontSize: 20, fontWeight: 700, color: 'rgba(255, 255, 255, 0.6)'
                    }}>
                      {detectedToken.symbol?.[0] || '?'}
                    </div>
                  )}
                </div>
              </div>

              {/* Token Info Below Banner */}
              <div style={{ padding: '14px 16px 12px' }}>
                <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', marginBottom: 12 }}>
                  <div style={{ flex: 1, paddingRight: 70 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      <span style={{ fontSize: 18, fontWeight: 700 }}>{detectedToken.symbol || 'Unknown'}</span>
                      {/* DEX Badge with Logo */}
                      {detectedToken.dexId && (() => {
                        const dexId = detectedToken.dexId || ''
                        const getDexName = (id: string) => {
                          if (id.includes('pumpswap') || id.includes('pumpfun') || id.includes('pump')) return 'PumpSwap'
                          if (id.includes('raydium')) return 'Raydium'
                          if (id.includes('orca')) return 'Orca'
                          if (id.includes('meteora')) return 'Meteora'
                          if (id.includes('jupiter')) return 'Jupiter'
                          if (id.includes('lifinity')) return 'Lifinity'
                          if (id.includes('phoenix')) return 'Phoenix'
                          return id.charAt(0).toUpperCase() + id.slice(1)
                        }
                        const dexName = getDexName(dexId)
                        const logoUrl = `https://dd.dexscreener.com/ds-data/dexes/${dexId}.png`
                        return (
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: 4,
                            padding: '2px 6px 2px 4px',
                            background: 'rgba(255, 255, 255, 0.05)',
                            border: '1px solid rgba(255, 255, 255, 0.1)',
                            borderRadius: 6,
                            fontSize: 9,
                            fontWeight: 500,
                            color: 'rgba(255, 255, 255, 0.6)'
                          }}>
                            <img 
                              src={logoUrl} 
                              alt="" 
                              style={{ width: 12, height: 12, borderRadius: 2, opacity: 0.8 }}
                              onError={(e) => { (e.target as HTMLImageElement).style.display = 'none' }}
                            />
                            {dexName}
                          </div>
                        )
                      })()}
                    </div>
                    <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', fontFamily: 'monospace' }}>
                      {detectedToken.address.slice(0, 8)}...{detectedToken.address.slice(-6)}
                    </div>
                  </div>
                </div>

                {/* Price Display */}
                <div style={{ display: 'flex', alignItems: 'baseline', gap: 10, marginBottom: 16 }}>
                  <div style={{ fontSize: 24, fontWeight: 700 }}>
                    ${detectedToken.priceUsd ? (detectedToken.priceUsd < 0.0001 ? detectedToken.priceUsd.toExponential(2) : detectedToken.priceUsd < 1 ? detectedToken.priceUsd.toFixed(6) : detectedToken.priceUsd.toFixed(4)) : ''}
                  </div>
                  {detectedToken.priceChange5m !== undefined && (
                    <div style={{ 
                      fontSize: 13, 
                      fontWeight: 600,
                      color: detectedToken.priceChange5m >= 0 ? '#10b981' : '#ef4444',
                      display: 'flex',
                      alignItems: 'center',
                      gap: 3
                    }}>
                      {detectedToken.priceChange5m >= 0 ? '' : ''} {Math.abs(detectedToken.priceChange5m).toFixed(1)}%
                      <span style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.35)', fontWeight: 400 }}>5m</span>
                    </div>
                  )}
                </div>

                {/* Market Stats - LIQ | MCAP | VOL 24H */}
                <div style={{ 
                  display: 'grid', 
                  gridTemplateColumns: 'repeat(3, 1fr)', 
                  gap: 12,
                  padding: '14px 0',
                  borderTop: '1px solid rgba(255, 255, 255, 0.06)',
                  borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
                }}>
                  {/* Liquidity */}
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 4, fontWeight: 500 }}>LIQ</div>
                    <div style={{ fontSize: 14, fontWeight: 700 }}>
                      {detectedToken.liquidity ? (detectedToken.liquidity >= 1_000_000 ? `$${(detectedToken.liquidity / 1_000_000).toFixed(1)}M` : `$${(detectedToken.liquidity / 1_000).toFixed(0)}K`) : ''}
                    </div>
                  </div>
                  {/* Market Cap - CENTER */}
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 4, fontWeight: 500 }}>MCAP</div>
                    <div style={{ fontSize: 14, fontWeight: 700 }}>
                      {detectedToken.marketCap ? (detectedToken.marketCap >= 1_000_000 ? `$${(detectedToken.marketCap / 1_000_000).toFixed(1)}M` : `$${(detectedToken.marketCap / 1_000).toFixed(0)}K`) : ''}
                    </div>
                  </div>
                  {/* 24h Volume */}
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 4, fontWeight: 500 }}>VOL 24H</div>
                    <div style={{ fontSize: 14, fontWeight: 700 }}>
                      {detectedToken.volume24h ? (detectedToken.volume24h >= 1_000_000 ? `$${(detectedToken.volume24h / 1_000_000).toFixed(1)}M` : `$${(detectedToken.volume24h / 1_000).toFixed(0)}K`) : ''}
                    </div>
                  </div>
                </div>
              </div>

              {/* Price Changes Row */}
              {(detectedToken.priceChange1h !== undefined || detectedToken.priceChange6h !== undefined || detectedToken.priceChange24h !== undefined) && (
                <div style={{ padding: '10px 16px', display: 'flex', justifyContent: 'space-around' }}>
                  {detectedToken.priceChange1h !== undefined && (
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.35)', marginBottom: 2 }}>1H</div>
                      <div style={{ fontSize: 13, fontWeight: 600, color: detectedToken.priceChange1h >= 0 ? '#10b981' : '#ef4444' }}>
                        {detectedToken.priceChange1h >= 0 ? '+' : ''}{detectedToken.priceChange1h.toFixed(1)}%
                      </div>
                    </div>
                  )}
                  {detectedToken.priceChange6h !== undefined && (
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.35)', marginBottom: 2 }}>6H</div>
                      <div style={{ fontSize: 13, fontWeight: 600, color: detectedToken.priceChange6h >= 0 ? '#10b981' : '#ef4444' }}>
                        {detectedToken.priceChange6h >= 0 ? '+' : ''}{detectedToken.priceChange6h.toFixed(1)}%
                      </div>
                    </div>
                  )}
                  {detectedToken.priceChange24h !== undefined && (
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.35)', marginBottom: 2 }}>24H</div>
                      <div style={{ fontSize: 13, fontWeight: 600, color: detectedToken.priceChange24h >= 0 ? '#10b981' : '#ef4444' }}>
                        {detectedToken.priceChange24h >= 0 ? '+' : ''}{detectedToken.priceChange24h.toFixed(1)}%
                      </div>
                    </div>
                  )}
                  {detectedToken.txns24h && (
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: 10, color: 'rgba(255, 255, 255, 0.35)', marginBottom: 2 }}>TXS</div>
                      <div style={{ fontSize: 12, fontWeight: 600 }}>
                        <span style={{ color: '#10b981' }}>{detectedToken.txns24h.buys}</span>
                        <span style={{ color: 'rgba(255, 255, 255, 0.3)' }}>/</span>
                        <span style={{ color: '#ef4444' }}>{detectedToken.txns24h.sells}</span>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Token holdings */}
              {degenTokenBalance > 0 && (
                <div style={{
                  padding: '12px 16px',
                  background: 'rgba(0, 0, 0, 0.15)',
                  borderTop: '1px solid rgba(255, 255, 255, 0.05)',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>Your balance</span>
                  <div style={{ textAlign: 'right' }}>
                    <span style={{ fontSize: 14, fontWeight: 600 }}>
                      {degenTokenBalance.toLocaleString(undefined, { maximumFractionDigits: 2 })} {detectedToken.symbol}
                    </span>
                    {detectedToken.priceUsd && (
                      <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)' }}>
                         ${(degenTokenBalance * detectedToken.priceUsd).toFixed(2)}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Auto-refresh indicator */}
              <div style={{ 
                padding: '8px 16px', 
                borderTop: '1px solid rgba(255, 255, 255, 0.03)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                fontSize: 10,
                color: 'rgba(255, 255, 255, 0.3)'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                  {degenAutoRefresh && (
                    <>
                      <div style={{ 
                        width: 6, height: 6, 
                        borderRadius: '50%', 
                        background: '#10b981',
                        animation: 'pulse 2s infinite'
                      }} />
                      <span>LIVE</span>
                    </>
                  )}
                </div>
                <span>via DexScreener</span>
              </div>
            </div>
          ) : (
            <div style={{
              padding: '32px 20px',
              background: 'rgba(255, 255, 255, 0.02)',
              border: '1px dashed rgba(255, 255, 255, 0.1)',
              borderRadius: 14,
              textAlign: 'center'
            }}>
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.2)" strokeWidth="1.5" style={{ margin: '0 auto 12px' }}>
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <div style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 4 }}>No token detected</div>
              <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.25)' }}>Open a chart on DexScreener or Pump.fun</div>
            </div>
          )}
        </div>

        {/* Quick Trade Buttons - Clean Minimal Design */}
        {detectedToken && (
          <div style={{ padding: '0 16px 16px' }}>
            {/* Buy Row */}
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: 6,
              marginBottom: 8
            }}>
              <span style={{ 
                fontSize: 13, 
                fontWeight: 500, 
                color: 'rgba(255, 255, 255, 0.4)',
                width: 32
              }}>Buy</span>
              {degenBuyAmounts.map((amt) => (
                <button
                  key={`buy_${amt}`}
                  onClick={() => executeDegenBuy(amt)}
                  disabled={!!degenTradeExecuting || balance < parseFloat(amt)}
                  style={{
                    flex: 1,
                    padding: '10px 0',
                    background: 'transparent',
                    border: '1px solid rgba(255, 255, 255, 0.12)',
                    borderRadius: 8,
                    color: balance < parseFloat(amt) ? 'rgba(255, 255, 255, 0.2)' : '#fff',
                    fontSize: 12,
                    fontWeight: 500,
                    cursor: balance < parseFloat(amt) ? 'not-allowed' : 'pointer',
                    opacity: degenTradeExecuting ? 0.5 : 1,
                    transition: 'border-color 0.15s'
                  }}
                  onMouseEnter={(e) => { if (balance >= parseFloat(amt)) e.currentTarget.style.borderColor = '#10b981'; }}
                  onMouseLeave={(e) => { e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.12)'; }}
                >
                  {degenTradeExecuting === `buy_${amt}` ? '' : amt}
                </button>
              ))}
              {/* Custom Buy Input */}
              <div style={{ display: 'flex', alignItems: 'center', width: 70 }}>
                <input
                  type="text"
                  value={degenCustomBuy}
                  onChange={(e) => setDegenCustomBuy(e.target.value.replace(/[^0-9.]/g, ''))}
                  onKeyDown={(e) => { if (e.key === 'Enter' && degenCustomBuy && parseFloat(degenCustomBuy) > 0) executeDegenBuy(degenCustomBuy); }}
                  placeholder="SOL"
                  style={{
                    width: '100%',
                    padding: '10px 6px',
                    background: 'transparent',
                    border: '1px solid rgba(255, 255, 255, 0.12)',
                    borderRadius: 8,
                    color: '#fff',
                    fontSize: 12,
                    fontWeight: 500,
                    textAlign: 'center',
                    outline: 'none'
                  }}
                  onFocus={(e) => e.currentTarget.style.borderColor = '#10b981'}
                  onBlur={(e) => e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.12)'}
                />
              </div>
            </div>

            {/* Sell Row */}
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: 6,
              marginBottom: 12
            }}>
              <span style={{ 
                fontSize: 13, 
                fontWeight: 500, 
                color: 'rgba(255, 255, 255, 0.4)',
                width: 32
              }}>Sell</span>
              {degenSellPercentages.map((pct) => (
                <button
                  key={`sell_${pct}`}
                  onClick={() => executeDegenSell(pct)}
                  disabled={!!degenTradeExecuting || degenTokenBalance <= 0}
                  style={{
                    flex: 1,
                    padding: '10px 0',
                    background: 'transparent',
                    border: '1px solid rgba(255, 255, 255, 0.12)',
                    borderRadius: 8,
                    color: degenTokenBalance <= 0 ? 'rgba(255, 255, 255, 0.2)' : '#fff',
                    fontSize: 12,
                    fontWeight: 500,
                    cursor: degenTokenBalance <= 0 ? 'not-allowed' : 'pointer',
                    opacity: degenTradeExecuting ? 0.5 : 1,
                    transition: 'border-color 0.15s'
                  }}
                  onMouseEnter={(e) => { if (degenTokenBalance > 0) e.currentTarget.style.borderColor = '#ef4444'; }}
                  onMouseLeave={(e) => { e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.12)'; }}
                >
                  {degenTradeExecuting === `sell_${pct}` ? '' : `${pct}%`}
                </button>
              ))}
              {/* Custom Sell Input */}
              <div style={{ display: 'flex', alignItems: 'center', width: 70 }}>
                <input
                  type="text"
                  value={degenCustomSell}
                  onChange={(e) => setDegenCustomSell(e.target.value.replace(/[^0-9.]/g, ''))}
                  onKeyDown={(e) => { if (e.key === 'Enter' && degenCustomSell && parseFloat(degenCustomSell) > 0) executeDegenSell(degenCustomSell); }}
                  placeholder="%"
                  style={{
                    width: '100%',
                    padding: '10px 6px',
                    background: 'transparent',
                    border: '1px solid rgba(255, 255, 255, 0.12)',
                    borderRadius: 8,
                    color: '#fff',
                    fontSize: 12,
                    fontWeight: 500,
                    textAlign: 'center',
                    outline: 'none'
                  }}
                  onFocus={(e) => e.currentTarget.style.borderColor = '#ef4444'}
                  onBlur={(e) => e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.12)'}
                />
              </div>
            </div>

            {/* Stats Row - Minimal */}
            <div style={{ 
              display: 'flex', 
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '10px 0',
              borderTop: '1px solid rgba(255, 255, 255, 0.06)',
              fontSize: 12,
              color: 'rgba(255, 255, 255, 0.4)'
            }}>
              <span>
                {degenTokenBalance > 0 
                  ? `${degenTokenBalance < 1000 ? degenTokenBalance.toFixed(1) : (degenTokenBalance/1000).toFixed(1)+'K'} ${detectedToken.symbol?.slice(0,5)}`
                  : 'No holdings'}
              </span>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                {/* PNL Display - show if we have cost basis and valid data */}
                {degenCostBasis && degenCostBasis.totalTokensBought > 0 && degenTokenBalance > 0 && detectedToken.priceUsd && solPrice > 0 && (() => {
                  // Calculate average cost per token in USD
                  const avgCostPerTokenSol = degenCostBasis.totalSolSpent / degenCostBasis.totalTokensBought;
                  const avgCostPerTokenUsd = avgCostPerTokenSol * solPrice;
                  
                  // Current value per token
                  const currentPriceUsd = detectedToken.priceUsd;
                  
                  // PNL percentage based on price change
                  const pnl = ((currentPriceUsd - avgCostPerTokenUsd) / avgCostPerTokenUsd) * 100;
                  
                  // Sanity check - if PNL is absurdly large, something is wrong
                  if (Math.abs(pnl) > 10000) return null;
                  
                  return (
                    <span style={{ color: pnl >= 0 ? '#10b981' : '#ef4444', fontWeight: 500 }}>
                      {pnl >= 0 ? '+' : ''}{pnl.toFixed(1)}%
                    </span>
                  );
                })()}
                
                {/* Share PNL Button - show when user has holdings OR cost basis */}
                {(degenTokenBalance > 0 || degenCostBasis) && detectedToken.priceUsd && (
                  <button
                    onClick={() => setShowPnlCard(true)}
                    style={{
                      background: 'rgba(16, 185, 129, 0.15)',
                      border: '1px solid rgba(16, 185, 129, 0.3)',
                      borderRadius: 6,
                      padding: '4px 8px',
                      color: '#10b981',
                      fontSize: 10,
                      fontWeight: 600,
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: 4
                    }}
                  >
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                      <circle cx="18" cy="5" r="3"/>
                      <circle cx="6" cy="12" r="3"/>
                      <circle cx="18" cy="19" r="3"/>
                      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                    Share
                  </button>
                )}
              </div>
            </div>

            {/* Trade History Feed */}
            {degenTradeHistory.length > 0 && (
              <div style={{
                marginTop: 4,
                maxHeight: 120,
                overflowY: 'auto',
                borderRadius: 8,
                background: 'rgba(0,0,0,0.2)',
              }}>
                {degenTradeHistory.map((trade, index) => (
                  <div 
                    key={trade.signature || index}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      padding: '6px 10px',
                      background: trade.success 
                        ? (trade.type === 'buy' ? 'rgba(59, 130, 246, 0.08)' : 'rgba(16, 185, 129, 0.08)')
                        : 'rgba(239, 68, 68, 0.08)',
                      borderBottom: index < degenTradeHistory.length - 1 ? '1px solid rgba(255,255,255,0.03)' : 'none',
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ 
                        fontSize: 10, 
                        color: trade.success 
                          ? (trade.type === 'buy' ? '#3b82f6' : '#10b981')
                          : '#ef4444',
                        fontWeight: 600,
                      }}>
                        {trade.success ? '' : ''}
                      </span>
                      <span style={{ fontSize: 11, color: trade.success ? '#fff' : '#ef4444' }}>
                        {trade.success 
                          ? (trade.type === 'buy' 
                              ? `Bought ${trade.tokenAmount ? (trade.tokenAmount < 1000 ? trade.tokenAmount.toFixed(1) : (trade.tokenAmount/1000).toFixed(1)+'K') : ''} ${trade.symbol || ''}`
                              : `Sold ${trade.tokenAmount ? (trade.tokenAmount < 1000 ? trade.tokenAmount.toFixed(1) : (trade.tokenAmount/1000).toFixed(1)+'K') : ''} ${trade.symbol || ''}`)
                          : (trade.type === 'buy' 
                              ? `Buy failed`
                              : `Sell failed`)
                        }
                      </span>
                      <span style={{ fontSize: 10, color: 'rgba(255,255,255,0.4)' }}>
                        {trade.solAmount ? `${trade.type === 'buy' ? '-' : '+'}${trade.solAmount.toFixed(4)} SOL` : ''}
                      </span>
                    </div>
                    {trade.success && trade.signature && (
                      <button
                        onClick={() => {
                          setSelectedTrade(trade);
                          setShowTradeSummary(true);
                        }}
                        style={{ background: 'none', border: 'none', color: 'rgba(255,255,255,0.5)', cursor: 'pointer', fontSize: 10, fontWeight: 500 }}
                      >
                        View 
                      </button>
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* Trade Summary Modal */}
            {showTradeSummary && selectedTrade && selectedTrade.success && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.85)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 9999,
                backdropFilter: 'blur(8px)',
              }}>
                <div style={{
                  background: 'linear-gradient(145deg, rgba(30,30,35,0.98), rgba(20,20,25,0.98))',
                  borderRadius: 16,
                  padding: 20,
                  width: '90%',
                  maxWidth: 340,
                  border: '1px solid rgba(255,255,255,0.1)',
                  boxShadow: '0 20px 60px rgba(0,0,0,0.5)',
                }}>
                  {/* Header */}
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                    <span style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>Trade Summary</span>
                    <button
                      onClick={() => {
                        setShowTradeSummary(false);
                        setSelectedTrade(null);
                      }}
                      style={{ background: 'none', border: 'none', color: 'rgba(255,255,255,0.5)', cursor: 'pointer', fontSize: 18 }}
                    >
                      
                    </button>
                  </div>

                  {/* Token Info */}
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: 12, 
                    padding: 12,
                    background: 'rgba(255,255,255,0.03)',
                    borderRadius: 12,
                    marginBottom: 12,
                  }}>
                    {selectedTrade.tokenLogo ? (
                      <img src={selectedTrade.tokenLogo} alt="" style={{ width: 40, height: 40, borderRadius: '50%' }} />
                    ) : (
                      <div style={{ width: 40, height: 40, borderRadius: '50%', background: 'linear-gradient(135deg, #10b981, #059669)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700, fontSize: 16 }}>
                        {selectedTrade.symbol?.charAt(0) || '?'}
                      </div>
                    )}
                    <div>
                      <div style={{ fontWeight: 600, color: '#fff', fontSize: 15 }}>{selectedTrade.symbol || 'Token'}</div>
                      <div style={{ 
                        fontSize: 11, 
                        color: selectedTrade.type === 'sell' ? '#10b981' : '#3b82f6',
                        fontWeight: 600,
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                      }}>
                        {selectedTrade.type === 'sell' ? ' SOLD' : ' BOUGHT'}
                      </div>
                    </div>
                  </div>

                  {/* Trade Details */}
                  <div style={{ 
                    background: 'rgba(255,255,255,0.03)', 
                    borderRadius: 12, 
                    padding: 12,
                    marginBottom: 12,
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
                      <span style={{ color: 'rgba(255,255,255,0.5)', fontSize: 12 }}>
                        {selectedTrade.type === 'sell' ? 'Tokens Sold' : 'Tokens Received'}
                      </span>
                      <span style={{ color: '#fff', fontSize: 12, fontWeight: 500 }}>
                        {selectedTrade.tokenAmount ? (selectedTrade.tokenAmount < 1000 ? selectedTrade.tokenAmount.toFixed(2) : (selectedTrade.tokenAmount/1000).toFixed(2)+'K') : '0'} {selectedTrade.symbol}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
                      <span style={{ color: 'rgba(255,255,255,0.5)', fontSize: 12 }}>
                        {selectedTrade.type === 'sell' ? 'SOL Received' : 'SOL Spent'}
                      </span>
                      <span style={{ color: '#fff', fontSize: 12, fontWeight: 500 }}>
                        {selectedTrade.solAmount?.toFixed(4)} SOL
                      </span>
                    </div>
                    {selectedTrade.priceUsd && (
                      <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span style={{ color: 'rgba(255,255,255,0.5)', fontSize: 12 }}>USD Value</span>
                        <span style={{ color: '#fff', fontSize: 12, fontWeight: 500 }}>
                          ~${((selectedTrade.solAmount || 0) * 230).toFixed(2)}
                        </span>
                      </div>
                    )}
                  </div>

                  {/* PNL Section - Only for sells with cost basis */}
                  {selectedTrade.type === 'sell' && selectedTrade.costBasisAtTrade && (
                    <div style={{ 
                      background: 'rgba(255,255,255,0.03)', 
                      borderRadius: 12, 
                      padding: 12,
                      marginBottom: 12,
                      border: '1px solid rgba(16, 185, 129, 0.2)',
                    }}>
                      <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', marginBottom: 8, fontWeight: 500 }}>
                        PROFIT/LOSS
                      </div>
                      {(() => {
                        const costBasis = selectedTrade.costBasisAtTrade;
                        const avgCostPerToken = costBasis.totalSolSpent / costBasis.totalTokensBought;
                        const costOfSoldTokens = (selectedTrade.tokenAmount || 0) * avgCostPerToken;
                        const profit = (selectedTrade.solAmount || 0) - costOfSoldTokens;
                        const profitPercent = costOfSoldTokens > 0 ? (profit / costOfSoldTokens) * 100 : 0;
                        const isProfit = profit >= 0;
                        
                        return (
                          <>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>
                              <span style={{ color: 'rgba(255,255,255,0.5)', fontSize: 12 }}>Cost Basis</span>
                              <span style={{ color: '#fff', fontSize: 12 }}>{costOfSoldTokens.toFixed(4)} SOL</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>
                              <span style={{ color: 'rgba(255,255,255,0.5)', fontSize: 12 }}>Realized P/L</span>
                              <span style={{ 
                                color: isProfit ? '#10b981' : '#ef4444', 
                                fontSize: 12, 
                                fontWeight: 600 
                              }}>
                                {isProfit ? '+' : ''}{profit.toFixed(4)} SOL
                              </span>
                            </div>
                            <div style={{ 
                              textAlign: 'center', 
                              padding: '8px 0', 
                              marginTop: 4,
                              background: isProfit ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                              borderRadius: 8,
                            }}>
                              <span style={{ 
                                fontSize: 18, 
                                fontWeight: 700, 
                                color: isProfit ? '#10b981' : '#ef4444' 
                              }}>
                                {isProfit ? '+' : ''}{profitPercent.toFixed(1)}%
                              </span>
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  )}

                  {/* Action Buttons */}
                  <div style={{ display: 'flex', gap: 8 }}>
                    <button
                      onClick={() => window.open(`https://orb.helius.dev/tx/${selectedTrade.signature}?tab=summary`, '_blank')}
                      style={{
                        flex: 1,
                        padding: '10px',
                        background: 'rgba(255,255,255,0.05)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        borderRadius: 8,
                        color: '#fff',
                        fontSize: 12,
                        fontWeight: 500,
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: 6,
                      }}
                    >
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                      </svg>
                      View on Orb
                    </button>
                    {selectedTrade.type === 'sell' && (
                      <button
                        onClick={() => {
                          setShowTradeSummary(false);
                          setShowPnlCard(true);
                        }}
                        style={{
                          flex: 1,
                          padding: '10px',
                          background: 'linear-gradient(135deg, #10b981, #059669)',
                          border: 'none',
                          borderRadius: 8,
                          color: '#fff',
                          fontSize: 12,
                          fontWeight: 600,
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: 6,
                        }}
                      >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                          <circle cx="18" cy="5" r="3"/>
                          <circle cx="6" cy="12" r="3"/>
                          <circle cx="18" cy="19" r="3"/>
                          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                        Share PNL
                      </button>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Regular Swap Link */}
        <div style={{ padding: '0 16px 16px', marginTop: 'auto' }}>
          <button
            onClick={() => {
              if (detectedToken) {
                // Set up swap with detected token
                setSwapFromToken({
                  mint: 'So11111111111111111111111111111111111111112',
                  symbol: 'SOL',
                  name: 'Solana',
                  logoURI: 'https://assets.coingecko.com/coins/images/4128/standard/solana.png',
                  decimals: 9,
                  amount: balance,
                  price: solPrice,
                  value: balance * solPrice
                });
                setSwapToToken({
                  mint: detectedToken.address,
                  symbol: detectedToken.symbol,
                  name: detectedToken.name,
                  logoURI: detectedToken.logoURI
                });
              }
              setView('swap');
            }}
            style={{
              width: '100%',
              padding: '12px',
              background: 'rgba(255, 255, 255, 0.05)',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              borderRadius: 12,
              color: 'rgba(255, 255, 255, 0.6)',
              fontSize: 13,
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: 8
            }}
          >
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/>
              <polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
            </svg>
            Advanced Swap
          </button>
        </div>

        {/* Footer */}
        <div style={{
          padding: '10px 16px',
          borderTop: '1px solid rgba(255, 255, 255, 0.05)',
          fontSize: 10,
          color: 'rgba(255, 255, 255, 0.25)',
          textAlign: 'center'
        }}>
          Slippage: {(degenSlippage / 100).toFixed(0)}%  Priority: {degenMevProtection ? 'Turbo (MEV Protected)' : swapPriorityLevel}
        </div>

        {/* PNL Share Card Modal */}
        {showPnlCard && detectedToken && (() => {
          // Current position value
          const tokenPrice = detectedToken.priceUsd || 0;
          const positionUsd = degenTokenBalance * tokenPrice;
          const positionSol = solPrice > 0 ? positionUsd / solPrice : 0;
          
          // Calculate PNL if we have cost basis
          let investedSol = 0;
          let investedUsd = 0;
          let pnlSol = 0;
          let pnlUsd = 0;
          let pnlPercent = 0;
          
          if (degenCostBasis && degenCostBasis.totalSolSpent > 0) {
            // What we invested
            investedSol = degenCostBasis.totalSolSpent;
            investedUsd = investedSol * solPrice;
            
            // Simple PNL: current value - invested (adjusted for tokens held)
            // If we still hold all tokens, PNL = positionUsd - investedUsd
            // If we hold partial, we scale the cost basis proportionally
            const holdingRatio = degenCostBasis.totalTokensBought > 0 
              ? degenTokenBalance / degenCostBasis.totalTokensBought 
              : 0;
            
            const adjustedCostUsd = investedUsd * holdingRatio;
            const adjustedCostSol = investedSol * holdingRatio;
            
            pnlUsd = positionUsd - adjustedCostUsd;
            pnlSol = positionSol - adjustedCostSol;
            pnlPercent = adjustedCostUsd > 0 ? (pnlUsd / adjustedCostUsd) * 100 : 0;
          }
          
          console.log('[PNL Card] Data:', {
            degenTokenBalance,
            tokenPrice,
            positionUsd,
            positionSol,
            degenCostBasis,
            investedSol,
            investedUsd,
            pnlSol,
            pnlUsd,
            pnlPercent
          });
          
          return (
            <PnlShareCard
              tokenName={detectedToken.name}
              tokenSymbol={detectedToken.symbol}
              tokenLogo={detectedToken.logoURI}
              invested={investedSol}
              position={positionSol}
              pnlSol={pnlSol}
              pnlPercent={pnlPercent}
              pnlUsd={pnlUsd}
              investedUsd={investedUsd}
              positionUsd={positionUsd}
              onClose={() => setShowPnlCard(false)}
              onDownload={() => setShowPnlCard(false)}
            />
          );
        })()}
      </div>
    )
  }

  // Vault Rules Configuration Modal
  if (view === "vault_rules") {
    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        width: '100%',
        height: '100%',
        display: 'flex',
        flexDirection: 'column',
        backgroundColor: '#121216',
        color: '#fff'
      }}>
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '18px 20px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)',
          minHeight: 60
        }}>
          <button 
            onClick={() => setView("main")}
            onTouchEnd={(e) => {
              e.preventDefault();
              setView("main");
            }}
            style={{ 
              background: 'rgba(255, 255, 255, 0.06)', 
              border: 'none', 
              color: 'rgba(255, 255, 255, 0.7)', 
              cursor: 'pointer', 
              padding: 0,
              width: 44,
              height: 44,
              borderRadius: 12,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              WebkitTapHighlightColor: 'transparent',
              touchAction: 'manipulation'
            }}
          >
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
          </button>
          <h3 style={{ margin: 0, fontSize: 20, fontWeight: 600, color: '#fff' }}>Vault Security Rules</h3>
          <div style={{ width: 44 }} />
        </div>

        <div style={{ 
          flex: 1,
          minHeight: 0,
          overflowY: 'auto',
          overflowX: 'hidden',
          padding: '20px',
          display: 'flex', 
          flexDirection: 'column', 
          gap: 20,
          WebkitOverflowScrolling: 'touch'
        }}>
          {/* Description */}
          <div style={{ 
            background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(16, 185, 129, 0.03) 100%)',
            border: '1px solid rgba(16, 185, 129, 0.25)',
            borderRadius: 16,
            padding: 18
          }}>
            <p style={{ margin: 0, fontSize: 15, color: 'rgba(255, 255, 255, 0.8)', lineHeight: 1.6 }}>
              Configure the security rules for your Vault. These settings can only be set once during creation.
            </p>
          </div>

          {/* Geo Signature Rule */}
          <div style={{
            background: '#1a1a1f',
            borderRadius: 20,
            border: '1px solid rgba(255, 255, 255, 0.08)'
          }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              padding: '18px 20px'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 14 }}>
                <div style={{
                  width: 48,
                  height: 48,
                  borderRadius: 14,
                  background: vaultRules.geoEnabled ? 'rgba(16, 185, 129, 0.18)' : 'rgba(255, 255, 255, 0.06)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  transition: 'all 0.2s ease'
                }}>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke={vaultRules.geoEnabled ? '#10b981' : 'rgba(255,255,255,0.4)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="10" r="3"/>
                    <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/>
                  </svg>
                </div>
                <div>
                  <div style={{ fontSize: 17, fontWeight: 600, color: '#fff' }}>Geo Signature</div>
                  <div style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.55)' }}>Location-based approval</div>
                </div>
              </div>
              
              {/* Toggle */}
              <button
                onClick={() => setVaultRules(prev => ({ ...prev, geoEnabled: !prev.geoEnabled }))}
                onTouchEnd={(e) => {
                  e.preventDefault();
                  setVaultRules(prev => ({ ...prev, geoEnabled: !prev.geoEnabled }));
                }}
                style={{
                  width: 56,
                  height: 32,
                  borderRadius: 16,
                  background: vaultRules.geoEnabled ? '#10b981' : 'rgba(255, 255, 255, 0.12)',
                  border: 'none',
                  cursor: 'pointer',
                  position: 'relative',
                  transition: 'background 0.2s ease',
                  WebkitTapHighlightColor: 'transparent',
                  touchAction: 'manipulation',
                  flexShrink: 0
                }}
              >
                <div style={{
                  position: 'absolute',
                  top: 3,
                  left: vaultRules.geoEnabled ? 27 : 3,
                  width: 26,
                  height: 26,
                  borderRadius: 13,
                  background: '#fff',
                  transition: 'left 0.2s ease',
                  boxShadow: '0 2px 6px rgba(0,0,0,0.25)'
                }} />
              </button>
            </div>

            {/* Range Slider - Only visible when geo is enabled */}
            {vaultRules.geoEnabled && (
              <div style={{
                padding: '20px',
                borderTop: '1px solid rgba(255, 255, 255, 0.08)',
                background: 'rgba(0, 0, 0, 0.15)'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between', 
                  alignItems: 'center',
                  marginBottom: 24
                }}>
                  <span style={{ fontSize: 16, color: 'rgba(255, 255, 255, 0.8)', fontWeight: 500 }}>Approval Range</span>
                  <span style={{ 
                    fontSize: 17, 
                    fontWeight: 600, 
                    color: '#10b981',
                    background: 'rgba(16, 185, 129, 0.15)',
                    padding: '8px 16px',
                    borderRadius: 12,
                    border: '1px solid rgba(16, 185, 129, 0.3)'
                  }}>
                    {vaultRules.geoRange < 1 ? `${(vaultRules.geoRange * 1000).toFixed(0)}m` : `${vaultRules.geoRange.toFixed(1)}km`}
                  </span>
                </div>
                
                {/* Custom Range Slider */}
                <div style={{ position: 'relative', height: 44, display: 'flex', alignItems: 'center' }}>
                  {/* Track background */}
                  <div style={{
                    position: 'absolute',
                    left: 0,
                    right: 0,
                    height: 6,
                    background: 'rgba(255, 255, 255, 0.12)',
                    borderRadius: 3
                  }}>
                    {/* Progress fill */}
                    <div style={{
                      height: '100%',
                      width: `${((vaultRules.geoRange - 0.1) / 4.9) * 100}%`,
                      background: '#10b981',
                      borderRadius: 3
                    }} />
                  </div>
                  {/* Thumb */}
                  <div style={{
                    position: 'absolute',
                    left: `calc(${((vaultRules.geoRange - 0.1) / 4.9) * 100}% - 14px)`,
                    width: 28,
                    height: 28,
                    borderRadius: '50%',
                    background: '#fff',
                    border: '3px solid #10b981',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.3)',
                    pointerEvents: 'none'
                  }} />
                  {/* Invisible input on top */}
                  <input
                    type="range"
                    min="0.1"
                    max="5"
                    step="0.1"
                    value={vaultRules.geoRange}
                    onChange={(e) => setVaultRules(prev => ({ ...prev, geoRange: parseFloat(e.target.value) }))}
                    style={{
                      position: 'absolute',
                      left: 0,
                      top: 0,
                      width: '100%',
                      height: '100%',
                      opacity: 0,
                      cursor: 'pointer',
                      margin: 0,
                      padding: 0,
                      zIndex: 2
                    }}
                  />
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 12 }}>
                  <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.45)' }}>100m</span>
                  <span style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.45)' }}>5km</span>
                </div>
              </div>
            )}
          </div>

          {/* Additional Security Note */}
          <div style={{
            background: 'rgba(255, 255, 255, 0.03)',
            border: '1px solid rgba(255, 255, 255, 0.08)',
            borderRadius: 16,
            padding: 18
          }}>
            <p style={{ margin: 0, fontSize: 15, color: 'rgba(255, 255, 255, 0.75)', lineHeight: 1.7 }}>
              After activation, you can add more security layers like <span style={{ color: '#3b82f6', fontWeight: 500 }}>2FA Mobile</span>, <span style={{ color: '#3b82f6', fontWeight: 500 }}>Bluetooth</span>, <span style={{ color: '#a855f7', fontWeight: 500 }}>USB Key</span>, <span style={{ color: '#ec4899', fontWeight: 500 }}>Biometric</span>, and <span style={{ color: '#22c55e', fontWeight: 500 }}>Voice Unlock</span> from your wallet settings.
            </p>
          </div>

          {/* Info Note */}
          <div style={{
            padding: 18,
            background: 'rgba(16, 185, 129, 0.08)',
            border: '1px solid rgba(16, 185, 129, 0.2)',
            borderRadius: 16
          }}>
            <p style={{ margin: 0, fontSize: 14, color: 'rgba(16, 185, 129, 0.95)', lineHeight: 1.6 }}>
              <strong>Note:</strong> Geo-location cannot be disabled once activated. Other security layers can be managed anytime.
            </p>
          </div>

          {/* Vault Password Section */}
          <div style={{
            background: '#1a1a1f',
            borderRadius: 20,
            border: '1px solid rgba(255, 255, 255, 0.08)',
            padding: 20
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 14, marginBottom: 20 }}>
              <div style={{
                width: 48,
                height: 48,
                borderRadius: 14,
                background: 'rgba(16, 185, 129, 0.18)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
              </div>
              <div>
                <div style={{ fontSize: 17, fontWeight: 600, color: '#fff' }}>Vault Password</div>
                <div style={{ fontSize: 14, color: 'rgba(255, 255, 255, 0.55)' }}>Required for security layer activation</div>
              </div>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 14 }}>
              <input
                type="password"
                value={vaultRules.password}
                onChange={(e) => setVaultRules(prev => ({ ...prev, password: e.target.value, passwordError: '' }))}
                placeholder="Create password (min 6 characters)"
                style={{
                  width: '100%',
                  padding: '16px 18px',
                  background: 'rgba(255, 255, 255, 0.04)',
                  border: vaultRules.passwordError ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 14,
                  fontSize: 16,
                  color: '#fff',
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
              <input
                type="password"
                value={vaultRules.confirmPassword}
                onChange={(e) => setVaultRules(prev => ({ ...prev, confirmPassword: e.target.value, passwordError: '' }))}
                placeholder="Confirm password"
                style={{
                  width: '100%',
                  padding: '16px 18px',
                  background: 'rgba(255, 255, 255, 0.04)',
                  border: vaultRules.passwordError ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 14,
                  fontSize: 16,
                  color: '#fff',
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
              {vaultRules.passwordError && (
                <div style={{ fontSize: 14, color: '#ef4444' }}>
                  {vaultRules.passwordError}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Continue Button - At bottom of scroll area */}
        <div style={{ 
          padding: '20px',
          paddingBottom: 'calc(24px + env(safe-area-inset-bottom))',
          background: '#121216',
          borderTop: '1px solid rgba(255, 255, 255, 0.06)'
        }}>
          <button 
            onClick={() => {
              // Validate password
              if (!vaultRules.password || vaultRules.password.length < 6) {
                setVaultRules(prev => ({ ...prev, passwordError: 'Password must be at least 6 characters' }))
                return
              }
              if (vaultRules.password !== vaultRules.confirmPassword) {
                setVaultRules(prev => ({ ...prev, passwordError: 'Passwords do not match' }))
                return
              }
              setView("activation_disclosure")
            }}
            onTouchEnd={(e) => {
              e.preventDefault();
              if (!vaultRules.geoEnabled || !vaultRules.password || !vaultRules.confirmPassword) return;
              if (!vaultRules.password || vaultRules.password.length < 6) {
                setVaultRules(prev => ({ ...prev, passwordError: 'Password must be at least 6 characters' }))
                return
              }
              if (vaultRules.password !== vaultRules.confirmPassword) {
                setVaultRules(prev => ({ ...prev, passwordError: 'Passwords do not match' }))
                return
              }
              setView("activation_disclosure")
            }}
            disabled={!vaultRules.geoEnabled || !vaultRules.password || !vaultRules.confirmPassword}
            style={{
              width: '100%',
              padding: '18px 24px',
              background: (vaultRules.geoEnabled && vaultRules.password && vaultRules.confirmPassword) ? '#fff' : 'rgba(255, 255, 255, 0.1)',
              border: 'none',
              borderRadius: 16,
              fontSize: 17,
              fontWeight: 600,
              color: (vaultRules.geoEnabled && vaultRules.password && vaultRules.confirmPassword) ? '#000' : 'rgba(255, 255, 255, 0.3)',
              cursor: (vaultRules.geoEnabled && vaultRules.password && vaultRules.confirmPassword) ? 'pointer' : 'not-allowed',
              WebkitTapHighlightColor: 'transparent',
              touchAction: 'manipulation'
            }}
          >
            Continue to Activation
          </button>
        </div>

        {/* Custom slider styles */}
        <style>{`
          input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border: 3px solid #10b981;
          }
          input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border: 3px solid #10b981;
          }
        `}</style>
      </div>
    )
  }


  if (view === "activation_disclosure") {
    return (
      <div className="app-container-padded" style={{
        ...containerStyle,
        display: 'flex',
        flexDirection: 'column'
      }}>
        <div style={styles.header}>
          <button 
            onClick={() => setView("vault_rules")}
            style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', padding: 8 }}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
          </button>
          <h3 style={styles.headerTitle}>Confirm Activation</h3>
          <button 
            onClick={() => setView("main")}
            style={{ background: 'none', border: 'none', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', fontSize: 14 }}
          >
            Cancel
          </button>
        </div>

        <div style={{ flex: 1, overflowY: 'auto', padding: 20, paddingBottom: 40 }}>
            <div style={{ textAlign: 'center', marginBottom: 24 }}>
                <div style={{ width: 72, height: 72, borderRadius: 20, background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.05) 100%)', border: '1px solid rgba(16, 185, 129, 0.3)', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px auto' }}>
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                </div>
                <h2 style={{ fontSize: 20, margin: 0, fontWeight: 600 }}>Secure Your Vault</h2>
            </div>

            {/* Security Rules Summary */}
            <div style={{ 
              background: 'rgba(16, 185, 129, 0.08)', 
              border: '1px solid rgba(16, 185, 129, 0.2)', 
              borderRadius: 12, 
              padding: 14, 
              marginBottom: 16 
            }}>
              <div style={{ fontSize: 12, color: 'rgba(16, 185, 129, 0.8)', marginBottom: 10, fontWeight: 500 }}>YOUR SECURITY RULES</div>
              {/* Geo Signature */}
              <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: vaultRules.usbEnabled ? 8 : 0 }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <circle cx="12" cy="10" r="3"/>
                  <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/>
                </svg>
                <span style={{ fontSize: 14, color: '#fff' }}>Geo Signature</span>
                <span style={{ marginLeft: 'auto', fontSize: 13, color: '#10b981', fontWeight: 600 }}>
                  {vaultRules.geoRange < 1 ? `${(vaultRules.geoRange * 1000).toFixed(0)}m` : `${vaultRules.geoRange.toFixed(1)}km`} range
                </span>
              </div>
              {/* USB Device */}
              {vaultRules.usbEnabled && vaultRules.usbDevice && (
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#a855f7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M12 18v-6"/>
                    <path d="M8 18v-1"/>
                    <path d="M16 18v-1"/>
                    <rect x="6" y="18" width="12" height="4" rx="1"/>
                    <path d="M12 12a2 2 0 100-4 2 2 0 000 4z"/>
                    <path d="M12 2v6"/>
                  </svg>
                  <span style={{ fontSize: 14, color: '#fff' }}>USB Device</span>
                  <span style={{ marginLeft: 'auto', fontSize: 12, color: '#a855f7', fontWeight: 500, maxWidth: 120, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                    {vaultRules.usbDevice.productName}
                  </span>
                </div>
              )}
            </div>

            <div style={{ background: 'rgba(255, 255, 255, 0.03)', padding: 20, borderRadius: 16, marginBottom: 24, fontSize: 14, lineHeight: '1.6', color: 'rgba(255, 255, 255, 0.8)', border: '1px solid rgba(255, 255, 255, 0.06)' }}>
                <p style={{ marginTop: 0 }}>You are about to upgrade your wallet to a <strong style={{ color: '#fff' }}>Geo-Locked Vault</strong>.</p>
                <ul style={{ paddingLeft: 20, margin: '14px 0', color: 'rgba(255, 255, 255, 0.6)' }}>
                    <li style={{ marginBottom: 10 }}>We will capture your current physical location as your "Home Base".</li>
                    <li style={{ marginBottom: 10 }}>A Multisig Smart Account will be deployed on Solana.</li>
                    <li>Future withdrawals will require you to be within <strong style={{ color: '#10b981' }}>{vaultRules.geoRange < 1 ? `${(vaultRules.geoRange * 1000).toFixed(0)} meters` : `${vaultRules.geoRange.toFixed(1)} km`}</strong> of this location.</li>
                </ul>
                <p style={{ marginBottom: 0, color: 'rgba(255, 255, 255, 0.4)', fontSize: 12, paddingTop: 10, borderTop: '1px solid rgba(255, 255, 255, 0.06)' }}>Estimated Network Fee: ~0.02 SOL</p>
            </div>

            <button 
                style={styles.button}
                onClick={executeActivation}
                disabled={isLoading}
            >
                {isLoading ? "Activating..." : "I Understand, Activate Now"}
            </button>
            
             {status && (
                <div style={{ marginTop: 16, fontSize: 13, color: 'rgba(255, 255, 255, 0.6)', textAlign: 'center', padding: '10px 14px', background: 'rgba(255, 255, 255, 0.05)', borderRadius: 12 }}>
                {status}
                </div>
            )}
        </div>
      </div>
    )
  }

  // Activation Loading Screen with Globe
  if (view === "activation_loading") {
    return (
      <div className="app-container" style={{
        display: 'flex',
        flexDirection: 'column',
        overflow: 'hidden'
      }}>
        {/* Globe Container */}
        <div style={{
          position: 'relative',
          flex: 1,
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          overflow: 'hidden'
        }}>
          {/* Radial gradient overlay */}
          <div style={{
            position: 'absolute',
            inset: 0,
            background: 'radial-gradient(circle at 50% 80%, rgba(16, 185, 129, 0.15) 0%, transparent 50%)',
            pointerEvents: 'none',
            zIndex: 1
          }} />
          
          {/* Title - positioned at top */}
          <div style={{
            position: 'absolute',
            top: 60,
            left: 0,
            right: 0,
            zIndex: 10,
            textAlign: 'center'
          }}>
            <h1 style={{
              fontSize: 32,
              fontWeight: 700,
              margin: 0,
              background: 'linear-gradient(180deg, #fff 0%, rgba(255,255,255,0.4) 100%)',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent',
              backgroundClip: 'text',
              letterSpacing: '-0.02em'
            }}>
              ARGUS-1
            </h1>
            <p style={{
              fontSize: 10,
              color: 'rgba(255, 255, 255, 0.4)',
              margin: '4px 0 0 0',
              letterSpacing: '0.15em',
              textTransform: 'uppercase'
            }}>
              Geo-Protection
            </p>
          </div>

          {/* Globe - centered below title */}
          <div style={{
            position: 'absolute',
            top: 130,
            left: 0,
            right: 0,
            bottom: 80,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
          }}>
            <div style={{
              position: 'relative',
              width: '100%',
              height: '100%',
              maxHeight: 320
            }}>
              <Globe activated={status.includes("Activated")} />
            </div>
          </div>

          {/* Bottom gradient fade */}
          <div style={{
            position: 'absolute',
            bottom: 0,
            left: 0,
            right: 0,
            height: 150,
            background: 'linear-gradient(to top, #1a1a1f 0%, transparent 100%)',
            pointerEvents: 'none',
            zIndex: 2
          }} />
        </div>

        {/* Status Section */}
        <div style={{
          padding: '0 24px 32px 24px',
          position: 'relative',
          zIndex: 10
        }}>
          {/* Status text - centered */}
          <div style={{
            textAlign: 'center',
            marginBottom: 20
          }}>
            {status.includes("Failed") && (
              <div style={{
                display: 'inline-flex',
                alignItems: 'center',
                justifyContent: 'center',
                width: 24,
                height: 24,
                background: 'rgba(239, 68, 68, 0.2)',
                borderRadius: '50%',
                marginBottom: 8
              }}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="3">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </div>
            )}
            <p style={{
              fontSize: 14,
              fontWeight: 500,
              color: status.includes("Activated") ? '#10b981' : status.includes("Failed") ? '#ef4444' : 'rgba(255, 255, 255, 0.7)',
              margin: 0
            }}>
              {status ? status.replace(' ', '') : "Initializing..."}
            </p>
          </div>

          {/* Step progress dots with checkmarks */}
          <div style={{
            display: 'flex',
            justifyContent: 'center',
            gap: 12
          }}>
            {(() => {
              // Calculate current step based on status
              const getStepProgress = () => {
                if (status.includes("Activated")) return 5
                if (status.includes("Finalizing")) return 4
                if (status.includes("Deploying")) return 3
                if (status.includes("Generating zero")) return 2
                if (status.includes("Encrypting")) return 1
                if (status.includes("secured")) return 1
                return 0 // Acquiring GPS
              }
              const currentStep = getStepProgress()
              const isFailed = status.includes("Failed")

              return [0, 1, 2, 3, 4].map((i) => {
                const isCompleted = i < currentStep
                const isActive = i === currentStep && !isFailed
                
                return (
                  <div key={i} style={{
                    width: 10,
                    height: 10,
                    borderRadius: '50%',
                    background: isFailed ? 'rgba(239, 68, 68, 0.3)' : isCompleted ? '#10b981' : 'rgba(16, 185, 129, 0.2)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'all 0.3s ease',
                    animation: isActive ? 'dotPulse 1s ease-in-out infinite' : 'none',
                    boxShadow: isCompleted ? '0 0 8px rgba(16, 185, 129, 0.5)' : 'none'
                  }}>
                    {isCompleted && (
                      <svg width="6" height="6" viewBox="0 0 24 24" fill="none" stroke="#1a1a1f" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    )}
                  </div>
                )
              })
            })()}
          </div>
        </div>

        {/* CSS Animation for dots */}
        <style>{`
          @keyframes dotPulse {
            0%, 100% { 
              opacity: 0.5;
              transform: scale(1);
              box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% { 
              opacity: 1;
              transform: scale(1.3);
              box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
            }
          }
        `}</style>
      </div>
    )
  }

  // Main View
  return (
    <div className="app-container" style={containerStyle}>
      {/* Vault Background Globe - Shows when vault is active */}
      {activeWallet === "vault" && multisigPda && (
        <div style={{
          position: 'absolute',
          top: -80,
          left: '50%',
          transform: 'translateX(-50%)',
          width: 500,
          height: 500,
          opacity: 0.5,
          pointerEvents: 'none',
          zIndex: 0,
          maskImage: 'linear-gradient(to bottom, black 0%, black 55%, transparent 85%)',
          WebkitMaskImage: 'linear-gradient(to bottom, black 0%, black 55%, transparent 85%)'
        }}>
          <Globe activated={true} showLockIcon={false} />
        </div>
      )}

      {/* Confirm Modal */}
      {confirmModal.show && (
        <>
          <div 
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.8)',
              backdropFilter: 'blur(8px)',
              zIndex: 2000
            }} 
            onClick={() => setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })} 
          />
          <div style={{
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            width: 300,
            background: '#1a1a1f',
            border: '1px solid rgba(255, 255, 255, 0.1)',
            borderRadius: 20,
            padding: 24,
            zIndex: 2001
          }}>
            <div style={{
              width: 48,
              height: 48,
              borderRadius: 14,
              background: confirmModal.danger ? 'rgba(239, 68, 68, 0.1)' : 'rgba(255, 255, 255, 0.05)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              margin: '0 auto 16px auto'
            }}>
              {confirmModal.danger ? (
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              ) : (
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" strokeWidth="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
              )}
            </div>
            <h3 style={{ 
              margin: '0 0 8px 0', 
              fontSize: 16, 
              fontWeight: 600, 
              color: '#fff',
              textAlign: 'center'
            }}>
              {confirmModal.title}
            </h3>
            <p style={{ 
              margin: '0 0 16px 0', 
              fontSize: 13, 
              color: 'rgba(255, 255, 255, 0.5)',
              textAlign: 'center',
              lineHeight: 1.5
            }}>
              {confirmModal.message}
            </p>
            {confirmModal.requirePassword && (
              <div style={{ marginBottom: 16 }}>
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => {
                    setConfirmPassword(e.target.value)
                    setConfirmPasswordError("")
                  }}
                  placeholder="Enter your password"
                  style={{
                    width: '100%',
                    padding: '12px 14px',
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: confirmPasswordError ? '1px solid #ef4444' : '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 10,
                    fontSize: 14,
                    color: '#fff',
                    outline: 'none',
                    boxSizing: 'border-box'
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && confirmPassword) {
                      confirmModal.onConfirm(confirmPassword)
                    }
                  }}
                  autoFocus
                />
                {confirmPasswordError && (
                  <div style={{ fontSize: 11, color: '#ef4444', marginTop: 6 }}>
                    {confirmPasswordError}
                  </div>
                )}
              </div>
            )}
            <div style={{ display: 'flex', gap: 10 }}>
              <button
                onClick={() => {
                  setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} })
                  setConfirmPassword("")
                  setConfirmPasswordError("")
                }}
                style={{
                  flex: 1,
                  padding: '12px 16px',
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 12,
                  color: 'rgba(255, 255, 255, 0.7)',
                  fontSize: 13,
                  fontWeight: 500,
                  cursor: 'pointer'
                }}
              >
                Cancel
              </button>
              <button
                onClick={() => confirmModal.onConfirm(confirmPassword)}
                disabled={confirmModal.requirePassword && !confirmPassword}
                style={{
                  flex: 1,
                  padding: '12px 16px',
                  background: confirmModal.danger ? '#ef4444' : (confirmModal.requirePassword && !confirmPassword) ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.1)',
                  border: 'none',
                  borderRadius: 12,
                  color: (confirmModal.requirePassword && !confirmPassword) ? 'rgba(255, 255, 255, 0.3)' : '#fff',
                  fontSize: 13,
                  fontWeight: 600,
                  cursor: (confirmModal.requirePassword && !confirmPassword) ? 'not-allowed' : 'pointer'
                }}
              >
                {confirmModal.confirmText || 'Confirm'}
              </button>
            </div>
          </div>
        </>
      )}

      {/* Sidebar Overlay */}
      {showSidebar && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.6)',
          backdropFilter: 'blur(4px)',
          zIndex: 1000
        }} onClick={() => setShowSidebar(false)} />
      )}

      {/* Sidebar */}
      <div 
        ref={sidebarRef}
        style={{
          position: 'fixed',
          top: 0,
          left: showSidebar ? 0 : -280,
          width: 260,
          height: '100%',
          background: '#1a1a1f',
          borderRight: '1px solid rgba(255, 255, 255, 0.1)',
          zIndex: 1001,
          transition: 'left 0.3s ease',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden'
        }}
      >
        {/* Sidebar Header */}
        <div style={{
          padding: '20px 18px',
          borderBottom: '1px solid rgba(255, 255, 255, 0.06)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <img 
              src={getAssetUrl('assets/arguslogo.png')} 
              alt="ARGUS" 
              style={{ width: 32, height: 32, objectFit: 'contain' }}
              onError={(e) => { e.currentTarget.style.display = 'none' }}
            />
            <span style={{ fontSize: 17, fontWeight: 600, color: '#fff' }}>{t('wallets', lang)}</span>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
            <button 
              onClick={() => {
                setShowSidebar(false)
                setView("settings")
              }}
              onTouchEnd={(e) => {
                e.preventDefault();
                setShowSidebar(false);
                setView("settings");
              }}
              style={{ 
                background: 'none', 
                border: 'none', 
                color: 'rgba(255, 255, 255, 0.5)', 
                cursor: 'pointer',
                padding: 10,
                borderRadius: 10,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                transition: 'all 0.2s ease',
                WebkitTapHighlightColor: 'transparent',
                touchAction: 'manipulation',
                minWidth: 44,
                minHeight: 44
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)'
                e.currentTarget.style.color = '#fff'
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = 'none'
                e.currentTarget.style.color = 'rgba(255, 255, 255, 0.5)'
              }}
            >
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3" />
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
              </svg>
            </button>
            <button 
              onClick={() => setShowSidebar(false)}
              style={{ 
                background: 'none', 
                border: 'none', 
                color: 'rgba(255, 255, 255, 0.4)', 
                cursor: 'pointer',
                padding: 6,
                borderRadius: 8,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                transition: 'all 0.2s ease'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)'
                e.currentTarget.style.color = '#fff'
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = 'none'
                e.currentTarget.style.color = 'rgba(255, 255, 255, 0.4)'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M15 18l-6-6 6-6" />
              </svg>
            </button>
          </div>
        </div>

        {/* Wallet List */}
        <div style={{ flex: 1, overflowY: 'auto', padding: '12px 8px' }}>
          {walletAccounts.filter(acc => acc && acc.publicKey).map((account, index) => (
            <div
              key={account.publicKey || index}
              onClick={() => switchToAccount(index)}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px',
                borderRadius: 12,
                cursor: 'pointer',
                background: activeAccountIndex === index ? 'rgba(255, 255, 255, 0.08)' : 'transparent',
                marginBottom: 4,
                transition: 'background 0.2s ease'
              }}
              onMouseEnter={(e) => {
                if (activeAccountIndex !== index) {
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.04)'
                }
              }}
              onMouseLeave={(e) => {
                if (activeAccountIndex !== index) {
                  e.currentTarget.style.background = 'transparent'
                }
              }}
            >
              {/* Account Avatar */}
              <div style={{
                width: 40,
                height: 40,
                borderRadius: '50%',
                overflow: 'hidden',
                border: activeAccountIndex === index 
                  ? '2px solid #10b981'
                  : '2px solid transparent',
                boxSizing: 'content-box',
                flexShrink: 0,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                position: 'relative'
              }}>
                <PlanetAvatar seed={account.publicKey || ''} size={40} />
                {account.isWatchOnly && (
                  <div style={{
                    position: 'absolute',
                    inset: 0,
                    background: 'rgba(0, 0, 0, 0.35)',
                    borderRadius: '50%',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.6)" strokeWidth="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                  </div>
                )}
              </div>

              {/* Account Info */}
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ 
                  fontSize: 14, 
                  fontWeight: 500, 
                  color: '#fff',
                  marginBottom: 2
                }}>
                  {account.name}
                </div>
                <div style={{ 
                  fontSize: 12, 
                  color: 'rgba(255, 255, 255, 0.4)',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  whiteSpace: 'nowrap'
                }}>
                  {account.publicKey?.slice(0, 4) || '????'}...{account.publicKey?.slice(-4) || '????'}
                </div>
              </div>

              {/* Active Indicator */}
              {activeAccountIndex === index && (
                <div style={{
                  width: 8,
                  height: 8,
                  borderRadius: 4,
                  background: '#10b981'
                }} />
              )}
            </div>
          ))}
        </div>

        {/* Add Wallet Button */}
        <div style={{ padding: '12px 8px 0 8px', borderTop: '1px solid rgba(255, 255, 255, 0.06)' }}>
          <button
            onClick={() => setShowAddWalletModal(true)}
            style={{
              width: '100%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: 8,
              padding: '14px',
              background: 'rgba(255, 255, 255, 0.04)',
              border: '1px dashed rgba(255, 255, 255, 0.15)',
              borderRadius: 12,
              color: 'rgba(255, 255, 255, 0.6)',
              fontSize: 14,
              fontWeight: 500,
              cursor: 'pointer',
              transition: 'all 0.2s ease'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)'
              e.currentTarget.style.color = '#fff'
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.background = 'rgba(255, 255, 255, 0.04)'
              e.currentTarget.style.color = 'rgba(255, 255, 255, 0.6)'
            }}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            {t('addWallet', lang)}
          </button>
        </div>

        {/* Manage Wallets Button */}
        <div style={{ padding: '8px 8px 16px 8px' }}>
          <button
            onClick={() => {
              setShowSidebar(false)
              setView("manage-wallets")
            }}
            style={{
              width: '100%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: 8,
              padding: '12px',
              background: 'none',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              borderRadius: 12,
              color: 'rgba(255, 255, 255, 0.5)',
              fontSize: 13,
              fontWeight: 500,
              cursor: 'pointer',
              transition: 'all 0.2s ease'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.background = 'rgba(255, 255, 255, 0.04)'
              e.currentTarget.style.color = '#fff'
              e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.2)'
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.background = 'none'
              e.currentTarget.style.color = 'rgba(255, 255, 255, 0.5)'
              e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.1)'
            }}
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M12 20h9"/>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
            {t('manageWallets', lang)}
          </button>
        </div>
      </div>

      {/* Add Wallet Modal */}
      {showAddWalletModal && (
        <>
          {/* Modal Backdrop */}
          <div 
            onClick={closeAddWalletModal}
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.8)',
              backdropFilter: 'blur(8px)',
              zIndex: 2000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            {/* Modal Content */}
            <div 
              onClick={(e) => e.stopPropagation()}
              style={{
                width: 320,
                background: '#1a1a1f',
                borderRadius: 16,
                border: '1px solid rgba(255, 255, 255, 0.1)',
                overflow: 'hidden',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.9)'
              }}
            >
              {/* Modal Header */}
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '20px 20px 16px 20px',
                borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  {addWalletView !== 'menu' && (
                    <button
                      onClick={() => {
                        setAddWalletView('menu')
                        setImportInput('')
                        setNewWalletName('')
                        setStatus('')
                      }}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: 'rgba(255, 255, 255, 0.5)',
                        cursor: 'pointer',
                        padding: 4,
                        display: 'flex',
                        alignItems: 'center'
                      }}
                    >
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M15 18l-6-6 6-6" />
                      </svg>
                    </button>
                  )}
                  <span style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>
                    {addWalletView === 'menu' && t('addWallet', lang)}
                    {addWalletView === 'import-pk' && t('importPrivateKey', lang)}
                    {addWalletView === 'import-seed' && t('importSeedPhrase', lang)}
                    {addWalletView === 'create' && t('createNewWallet', lang)}
                    {addWalletView === 'track' && t('trackWallet', lang)}
                  </span>
                </div>
                <button
                  onClick={closeAddWalletModal}
                  style={{
                    background: 'none',
                    border: 'none',
                    color: 'rgba(255, 255, 255, 0.5)',
                    cursor: 'pointer',
                    padding: 4
                  }}
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                  </svg>
                </button>
              </div>

              {/* Modal Body */}
              <div style={{ padding: '16px 20px 20px 20px' }}>
                {/* Menu View */}
                {addWalletView === 'menu' && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                    {/* Import Private Key Option */}
                    <button
                      onClick={() => setAddWalletView('import-pk')}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 14,
                        padding: '16px',
                        background: 'rgba(255, 255, 255, 0.03)',
                        border: '1px solid rgba(255, 255, 255, 0.08)',
                        borderRadius: 14,
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.06)'
                        e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.15)'
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.03)'
                        e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.08)'
                      }}
                    >
                      <div style={{
                        width: 44,
                        height: 44,
                        borderRadius: 12,
                        background: 'rgba(34, 211, 238, 0.1)',
                        border: '1px solid rgba(34, 211, 238, 0.2)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" strokeWidth="2">
                          <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
                        </svg>
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>
                          Import Private Key
                        </div>
                        <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                          Add an existing wallet
                        </div>
                      </div>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2">
                        <path d="M9 18l6-6-6-6" />
                      </svg>
                    </button>

                    {/* Import Seed Phrase Option */}
                    <button
                      onClick={() => setAddWalletView('import-seed')}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 14,
                        padding: '16px',
                        background: 'rgba(255, 255, 255, 0.03)',
                        border: '1px solid rgba(255, 255, 255, 0.08)',
                        borderRadius: 14,
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.06)'
                        e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.15)'
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.03)'
                        e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.08)'
                      }}
                    >
                      <div style={{
                        width: 44,
                        height: 44,
                        borderRadius: 12,
                        background: 'rgba(168, 85, 247, 0.1)',
                        border: '1px solid rgba(168, 85, 247, 0.2)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" strokeWidth="2">
                          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>
                          Import Seed Phrase
                        </div>
                        <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                          Recover with 12/24 words
                        </div>
                      </div>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2">
                        <path d="M9 18l6-6-6-6" />
                      </svg>
                    </button>

                    {/* Create New Wallet Option */}
                    <button
                      onClick={() => setAddWalletView('create')}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 14,
                        padding: '16px',
                        background: 'rgba(255, 255, 255, 0.03)',
                        border: '1px solid rgba(255, 255, 255, 0.08)',
                        borderRadius: 14,
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.06)'
                        e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.15)'
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.03)'
                        e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.08)'
                      }}
                    >
                      <div style={{
                        width: 44,
                        height: 44,
                        borderRadius: 12,
                        background: 'rgba(16, 185, 129, 0.1)',
                        border: '1px solid rgba(16, 185, 129, 0.2)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                          <line x1="12" y1="5" x2="12" y2="19" />
                          <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>
                          {t('createNewWallet', lang)}
                        </div>
                        <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                          {t('deriveFromSeed', lang)}
                        </div>
                      </div>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2">
                        <path d="M9 18l6-6-6-6" />
                      </svg>
                    </button>

                    {/* Track Wallet Option */}
                    <button
                      onClick={() => setAddWalletView('track')}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 14,
                        padding: '16px',
                        background: 'rgba(255, 255, 255, 0.03)',
                        border: '1px solid rgba(255, 255, 255, 0.08)',
                        borderRadius: 14,
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.06)'
                        e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.15)'
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.03)'
                        e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.08)'
                      }}
                    >
                      <div style={{
                        width: 44,
                        height: 44,
                        borderRadius: 12,
                        background: 'rgba(59, 130, 246, 0.1)',
                        border: '1px solid rgba(59, 130, 246, 0.2)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2">
                          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                          <circle cx="12" cy="12" r="3" />
                        </svg>
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 14, fontWeight: 500, color: '#fff', marginBottom: 3 }}>
                          Track Wallet
                        </div>
                        <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)' }}>
                          Watch any address (view only)
                        </div>
                      </div>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2">
                        <path d="M9 18l6-6-6-6" />
                      </svg>
                    </button>
                  </div>
                )}

                {/* Import Private Key View */}
                {addWalletView === 'import-pk' && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                    {!importVaultDetected.detected ? (
                      <>
                        <div>
                          <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                            Private Key (Base58 or Base64)
                          </label>
                          <input
                            type="password"
                            value={importInput}
                            onChange={(e) => setImportInput(e.target.value)}
                            placeholder="Enter your private key..."
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              fontFamily: 'monospace',
                              boxSizing: 'border-box'
                            }}
                          />
                        </div>
                        <div>
                          <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                            Wallet Name (optional)
                          </label>
                          <input
                            type="text"
                            value={newWalletName}
                            onChange={(e) => setNewWalletName(e.target.value)}
                            placeholder="My Imported Wallet"
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              boxSizing: 'border-box'
                            }}
                          />
                        </div>
                        {status && (
                          <div style={{ fontSize: 12, color: '#ef4444', padding: '8px 12px', background: 'rgba(239, 68, 68, 0.1)', borderRadius: 8 }}>
                            {status}
                          </div>
                        )}
                        <button
                          onClick={importWalletFromPrivateKey}
                          disabled={isAddingWallet || !importInput.trim()}
                          style={{
                            width: '100%',
                            padding: '14px',
                            background: importInput.trim() ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'rgba(255, 255, 255, 0.1)',
                            border: 'none',
                            borderRadius: 12,
                            fontSize: 14,
                            fontWeight: 600,
                            color: importInput.trim() ? '#000' : 'rgba(255, 255, 255, 0.3)',
                            cursor: isAddingWallet || !importInput.trim() ? 'not-allowed' : 'pointer',
                            transition: 'all 0.2s ease',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: 8
                          }}
                        >
                          {isAddingWallet ? (
                            <>
                              <div style={{
                                width: 16,
                                height: 16,
                                border: '2px solid rgba(0, 0, 0, 0.2)',
                                borderTopColor: '#000',
                                borderRadius: '50%',
                                animation: 'spin 1s linear infinite'
                              }} />
                              {isCheckingVault ? 'Checking...' : 'Importing...'}
                            </>
                          ) : 'Import Wallet'}
                        </button>
                      </>
                    ) : (
                      <>
                        {/* Vault Detected - Show password input */}
                        <div style={{
                          padding: '16px',
                          background: 'rgba(16, 185, 129, 0.08)',
                          border: '1px solid rgba(16, 185, 129, 0.2)',
                          borderRadius: 12,
                          textAlign: 'center'
                        }}>
                          <div style={{
                            width: 48,
                            height: 48,
                            borderRadius: 12,
                            background: 'rgba(16, 185, 129, 0.15)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            margin: '0 auto 12px auto'
                          }}>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                          </div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#10b981', marginBottom: 4 }}>
                            ARGUS Vault Detected
                          </div>
                          <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>
                            This wallet has security layers enabled
                          </div>
                        </div>

                        <div>
                          <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                            Vault Password
                          </label>
                          <input
                            type="password"
                            value={importVaultPassword}
                            onChange={(e) => {
                              setImportVaultPassword(e.target.value)
                              setImportVaultError("")
                            }}
                            placeholder="Enter the vault's password"
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: importVaultError ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              boxSizing: 'border-box'
                            }}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && importVaultPassword.trim()) {
                                completeVaultImport()
                              }
                            }}
                            autoFocus
                          />
                          {importVaultError && (
                            <div style={{ fontSize: 12, color: '#ef4444', marginTop: 8 }}>
                              {importVaultError}
                            </div>
                          )}
                        </div>

                        <div style={{ display: 'flex', gap: 12 }}>
                          <button
                            onClick={() => {
                              setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' })
                              setImportVaultPassword("")
                              setImportVaultError("")
                            }}
                            style={{
                              flex: 1,
                              padding: '14px',
                              background: 'rgba(255, 255, 255, 0.05)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              fontWeight: 500,
                              color: 'rgba(255, 255, 255, 0.7)',
                              cursor: 'pointer'
                            }}
                          >
                            Back
                          </button>
                          <button
                            onClick={completeVaultImport}
                            disabled={isVerifyingImportPassword || importVaultPassword.trim() === ''}
                            style={{
                              flex: 1,
                              padding: '14px',
                              background: importVaultPassword.trim() ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'rgba(255, 255, 255, 0.1)',
                              border: 'none',
                              borderRadius: 12,
                              fontSize: 14,
                              fontWeight: 600,
                              color: importVaultPassword.trim() ? '#000' : 'rgba(255, 255, 255, 0.3)',
                              cursor: isVerifyingImportPassword || !importVaultPassword.trim() ? 'not-allowed' : 'pointer'
                            }}
                          >
                            {isVerifyingImportPassword ? 'Verifying...' : 'Import Vault'}
                          </button>
                        </div>
                      </>
                    )}
                  </div>
                )}

                {/* Import Seed Phrase View */}
                {addWalletView === 'import-seed' && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                    {!importVaultDetected.detected ? (
                      <>
                        <div>
                          <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                            Seed Phrase (12 or 24 words)
                          </label>
                          <textarea
                            value={importInput}
                            onChange={(e) => setImportInput(e.target.value)}
                            placeholder="Enter your seed phrase separated by spaces..."
                            rows={4}
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              resize: 'none',
                              fontFamily: 'monospace',
                              boxSizing: 'border-box',
                              lineHeight: 1.6
                            }}
                          />
                        </div>
                        <div>
                          <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                            Wallet Name (optional)
                          </label>
                          <input
                            type="text"
                            value={newWalletName}
                            onChange={(e) => setNewWalletName(e.target.value)}
                            placeholder="My Imported Wallet"
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              boxSizing: 'border-box'
                            }}
                          />
                        </div>
                        {status && (
                          <div style={{ fontSize: 12, color: '#ef4444', padding: '8px 12px', background: 'rgba(239, 68, 68, 0.1)', borderRadius: 8 }}>
                            {status}
                          </div>
                        )}
                        <button
                          onClick={importWalletFromSeedPhrase}
                          disabled={isAddingWallet || !importInput.trim()}
                          style={{
                            width: '100%',
                            padding: '14px',
                            background: importInput.trim() ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : 'rgba(255, 255, 255, 0.1)',
                            border: 'none',
                            borderRadius: 12,
                            fontSize: 14,
                            fontWeight: 600,
                            color: importInput.trim() ? '#fff' : 'rgba(255, 255, 255, 0.3)',
                            cursor: isAddingWallet || !importInput.trim() ? 'not-allowed' : 'pointer',
                            transition: 'all 0.2s ease',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: 8
                          }}
                        >
                          {isAddingWallet ? (
                            <>
                              <div style={{
                                width: 16,
                                height: 16,
                                border: '2px solid rgba(255, 255, 255, 0.2)',
                                borderTopColor: '#fff',
                                borderRadius: '50%',
                                animation: 'spin 1s linear infinite'
                              }} />
                              {isCheckingVault ? 'Checking...' : 'Importing...'}
                            </>
                          ) : 'Import Wallet'}
                        </button>
                      </>
                    ) : (
                      <>
                        {/* Vault Detected - Show password input */}
                        <div style={{
                          padding: '16px',
                          background: 'rgba(139, 92, 246, 0.08)',
                          border: '1px solid rgba(139, 92, 246, 0.2)',
                          borderRadius: 12,
                          textAlign: 'center'
                        }}>
                          <div style={{
                            width: 48,
                            height: 48,
                            borderRadius: 12,
                            background: 'rgba(139, 92, 246, 0.15)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            margin: '0 auto 12px auto'
                          }}>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2">
                              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                          </div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#8b5cf6', marginBottom: 4 }}>
                            ARGUS Vault Detected
                          </div>
                          <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>
                            This wallet has security layers enabled
                          </div>
                        </div>

                        <div>
                          <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                            Vault Password
                          </label>
                          <input
                            type="password"
                            value={importVaultPassword}
                            onChange={(e) => {
                              setImportVaultPassword(e.target.value)
                              setImportVaultError("")
                            }}
                            placeholder="Enter the vault's password"
                            style={{
                              width: '100%',
                              padding: '14px 16px',
                              background: 'rgba(255, 255, 255, 0.03)',
                              border: importVaultError ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              color: '#fff',
                              outline: 'none',
                              boxSizing: 'border-box'
                            }}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && importVaultPassword.trim()) {
                                completeVaultImport()
                              }
                            }}
                            autoFocus
                          />
                          {importVaultError && (
                            <div style={{ fontSize: 12, color: '#ef4444', marginTop: 8 }}>
                              {importVaultError}
                            </div>
                          )}
                        </div>

                        <div style={{ display: 'flex', gap: 12 }}>
                          <button
                            onClick={() => {
                              setImportVaultDetected({ detected: false, publicKey: '', keypair: null, walletName: '' })
                              setImportVaultPassword("")
                              setImportVaultError("")
                            }}
                            style={{
                              flex: 1,
                              padding: '14px',
                              background: 'rgba(255, 255, 255, 0.05)',
                              border: '1px solid rgba(255, 255, 255, 0.1)',
                              borderRadius: 12,
                              fontSize: 14,
                              fontWeight: 500,
                              color: 'rgba(255, 255, 255, 0.7)',
                              cursor: 'pointer'
                            }}
                          >
                            Back
                          </button>
                          <button
                            onClick={completeVaultImport}
                            disabled={isVerifyingImportPassword || importVaultPassword.trim() === ''}
                            style={{
                              flex: 1,
                              padding: '14px',
                              background: importVaultPassword.trim() ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : 'rgba(255, 255, 255, 0.1)',
                              border: 'none',
                              borderRadius: 12,
                              fontSize: 14,
                              fontWeight: 600,
                              color: importVaultPassword.trim() ? '#fff' : 'rgba(255, 255, 255, 0.3)',
                              cursor: isVerifyingImportPassword || !importVaultPassword.trim() ? 'not-allowed' : 'pointer'
                            }}
                          >
                            {isVerifyingImportPassword ? 'Verifying...' : 'Import Vault'}
                          </button>
                        </div>
                      </>
                    )}
                  </div>
                )}

                {/* Create New Wallet View */}
                {addWalletView === 'create' && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                    <div style={{
                      padding: '16px',
                      background: 'rgba(16, 185, 129, 0.08)',
                      border: '1px solid rgba(16, 185, 129, 0.2)',
                      borderRadius: 12
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 8 }}>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                          <circle cx="12" cy="12" r="10" />
                          <path d="M12 16v-4" />
                          <path d="M12 8h.01" />
                        </svg>
                        <span style={{ fontSize: 13, fontWeight: 500, color: '#10b981' }}>Derived Wallet</span>
                      </div>
                      <p style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', margin: 0, lineHeight: 1.5 }}>
                        This will create a new wallet derived from your existing seed phrase. Your seed phrase stays secure and unchanged.
                      </p>
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                        Wallet Name (optional)
                      </label>
                      <input
                        type="text"
                        value={newWalletName}
                        onChange={(e) => setNewWalletName(e.target.value)}
                        placeholder={`Account ${walletAccounts.length + 1}`}
                        style={{
                          width: '100%',
                          padding: '14px 16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.1)',
                          borderRadius: 12,
                          fontSize: 14,
                          color: '#fff',
                          outline: 'none',
                          boxSizing: 'border-box'
                        }}
                      />
                    </div>
                    {status && (
                      <div style={{ fontSize: 12, color: '#ef4444', padding: '8px 12px', background: 'rgba(239, 68, 68, 0.1)', borderRadius: 8 }}>
                        {status}
                      </div>
                    )}
                    <button
                      onClick={createNewWalletFromSeed}
                      disabled={isAddingWallet}
                      style={{
                        width: '100%',
                        padding: '14px',
                        background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                        border: 'none',
                        borderRadius: 12,
                        fontSize: 14,
                        fontWeight: 600,
                        color: '#000',
                        cursor: isAddingWallet ? 'not-allowed' : 'pointer',
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: 8
                      }}
                    >
                      {isAddingWallet ? (
                        <>
                          <div style={{
                            width: 16,
                            height: 16,
                            border: '2px solid rgba(0, 0, 0, 0.2)',
                            borderTopColor: '#000',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                          }} />
                          Creating...
                        </>
                      ) : 'Create Wallet'}
                    </button>
                  </div>
                )}

                {/* Track Wallet View */}
                {addWalletView === 'track' && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                    <div style={{
                      padding: '16px',
                      background: 'rgba(59, 130, 246, 0.08)',
                      border: '1px solid rgba(59, 130, 246, 0.2)',
                      borderRadius: 12
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 8 }}>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2">
                          <circle cx="12" cy="12" r="10" />
                          <circle cx="12" cy="12" r="6" />
                          <circle cx="12" cy="12" r="2" />
                        </svg>
                        <span style={{ fontSize: 13, fontWeight: 500, color: '#3b82f6' }}>Watch Only</span>
                      </div>
                      <p style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', margin: 0, lineHeight: 1.5 }}>
                        Track any Solana wallet. You can view balance, tokens, and activity, but cannot make transactions.
                      </p>
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                        Wallet Address
                      </label>
                      <input
                        type="text"
                        value={trackAddressInput}
                        onChange={(e) => setTrackAddressInput(e.target.value)}
                        placeholder="Enter wallet address"
                        style={{
                          width: '100%',
                          padding: '14px 16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.1)',
                          borderRadius: 12,
                          fontSize: 14,
                          color: '#fff',
                          outline: 'none',
                          fontFamily: 'monospace',
                          boxSizing: 'border-box'
                        }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 8 }}>
                        Wallet Name (optional)
                      </label>
                      <input
                        type="text"
                        value={newWalletName}
                        onChange={(e) => setNewWalletName(e.target.value)}
                        placeholder="e.g. Whale Wallet"
                        style={{
                          width: '100%',
                          padding: '14px 16px',
                          background: 'rgba(255, 255, 255, 0.03)',
                          border: '1px solid rgba(255, 255, 255, 0.1)',
                          borderRadius: 12,
                          fontSize: 14,
                          color: '#fff',
                          outline: 'none',
                          boxSizing: 'border-box'
                        }}
                      />
                    </div>
                    <button
                      onClick={async () => {
                        if (!trackAddressInput.trim()) {
                          setStatus("Please enter a wallet address")
                          return
                        }
                        
                        // Validate the address
                        try {
                          new PublicKey(trackAddressInput.trim())
                        } catch {
                          setStatus("Invalid wallet address")
                          return
                        }
                        
                        // Check if already tracking this address
                        if (walletAccounts.some(acc => acc.publicKey === trackAddressInput.trim())) {
                          setStatus("This wallet is already added")
                          return
                        }
                        
                        setIsAddingWallet(true)
                        
                        const newAccount: WalletAccount = {
                          index: -1, // Watch-only wallets don't have an index
                          name: newWalletName.trim() || `Tracked ${walletAccounts.filter(a => a.isWatchOnly).length + 1}`,
                          publicKey: trackAddressInput.trim(),
                          secretKey: '', // No secret key for watch-only
                          isWatchOnly: true
                        }
                        
                        const updatedAccounts = [...walletAccounts, newAccount]
                        setWalletAccounts(updatedAccounts)
                        setStoredAccounts(updatedAccounts)
                        
                        // Switch to the tracked wallet
                        const newIndex = updatedAccounts.length - 1
                        setActiveAccountIndex(newIndex)
                        setStoredActiveIndex(newIndex)
                        
                        setStatus("Wallet added for tracking!")
                        setTrackAddressInput("")
                        setNewWalletName("")
                        setShowAddWalletModal(false)
                        setAddWalletView("menu")
                        setIsAddingWallet(false)
                      }}
                      disabled={isAddingWallet || !trackAddressInput.trim()}
                      style={{
                        width: '100%',
                        padding: '14px',
                        background: !trackAddressInput.trim() ? 'rgba(59, 130, 246, 0.3)' : 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                        border: 'none',
                        borderRadius: 12,
                        fontSize: 14,
                        fontWeight: 600,
                        color: '#fff',
                        cursor: isAddingWallet || !trackAddressInput.trim() ? 'not-allowed' : 'pointer',
                        opacity: !trackAddressInput.trim() ? 0.5 : 1,
                        transition: 'all 0.2s ease',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: 8
                      }}
                    >
                      {isAddingWallet ? (
                        <>
                          <div style={{
                            width: 16,
                            height: 16,
                            border: '2px solid rgba(255, 255, 255, 0.2)',
                            borderTopColor: '#fff',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                          }} />
                          Adding...
                        </>
                      ) : 'Track Wallet'}
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        </>
      )}

      {/* Vault Password Setup Modal (for enabling security layers on wallets without password) */}
      {vaultPasswordSetup.show && (
        <>
          {/* Modal Backdrop */}
          <div 
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.9)',
              backdropFilter: 'blur(12px)',
              zIndex: 2001,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            {/* Modal Content */}
            <div 
              onClick={(e) => e.stopPropagation()}
              style={{
                width: 320,
                background: '#131318',
                borderRadius: 16,
                border: '1px solid rgba(255, 255, 255, 0.1)',
                overflow: 'hidden',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.9)'
              }}
            >
              {/* Modal Header */}
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '20px 20px 16px 20px',
                borderBottom: '1px solid rgba(255, 255, 255, 0.06)'
              }}>
                <span style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>
                  Set Vault Password
                </span>
              </div>

              {/* Modal Body */}
              <div style={{ padding: 20, display: 'flex', flexDirection: 'column', gap: 16 }}>
                {/* Info Box */}
                <div style={{
                  padding: '16px',
                  background: 'rgba(139, 92, 246, 0.1)',
                  border: '1px solid rgba(139, 92, 246, 0.3)',
                  borderRadius: 12,
                  textAlign: 'center'
                }}>
                  <div style={{
                    width: 48,
                    height: 48,
                    borderRadius: 12,
                    background: 'rgba(139, 92, 246, 0.15)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    margin: '0 auto 12px auto'
                  }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                  </div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#8b5cf6', marginBottom: 4 }}>
                    Vault Password Required
                  </div>
                  <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', lineHeight: 1.5 }}>
                    Create a password to enable security layers on this wallet. This password will be used for vault transactions.
                  </div>
                </div>

                {/* Wallet Info */}
                <div style={{
                  padding: '12px',
                  background: 'rgba(255, 255, 255, 0.03)',
                  borderRadius: 10,
                  display: 'flex',
                  alignItems: 'center',
                  gap: 12
                }}>
                  <PlanetAvatar seed={vaultPasswordSetup.publicKey} size={36} />
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 500, color: '#fff' }}>{walletAccounts.find(w => w.publicKey === vaultPasswordSetup.publicKey)?.name || 'Wallet'}</div>
                    <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', fontFamily: 'monospace' }}>
                      {vaultPasswordSetup.publicKey.slice(0, 8)}...{vaultPasswordSetup.publicKey.slice(-6)}
                    </div>
                  </div>
                </div>

                {/* Password Input */}
                <input
                  type="password"
                  value={vaultPasswordSetup.password}
                  onChange={(e) => {
                    setVaultPasswordSetup(prev => ({ ...prev, password: e.target.value, error: '' }))
                  }}
                  placeholder="Password (min 6 characters)"
                  autoFocus
                  style={{
                    width: '100%',
                    padding: '14px 16px',
                    background: 'rgba(255, 255, 255, 0.03)',
                    border: vaultPasswordSetup.error ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 12,
                    fontSize: 14,
                    color: '#fff',
                    outline: 'none',
                    boxSizing: 'border-box'
                  }}
                />

                {/* Confirm Password Input */}
                <input
                  type="password"
                  value={vaultPasswordSetup.confirmPassword}
                  onChange={(e) => {
                    setVaultPasswordSetup(prev => ({ ...prev, confirmPassword: e.target.value, error: '' }))
                  }}
                  placeholder="Confirm Password"
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && vaultPasswordSetup.password && vaultPasswordSetup.confirmPassword) {
                      completeVaultPasswordSetup()
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '14px 16px',
                    background: 'rgba(255, 255, 255, 0.03)',
                    border: vaultPasswordSetup.error ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 12,
                    fontSize: 14,
                    color: '#fff',
                    outline: 'none',
                    boxSizing: 'border-box'
                  }}
                />

                {/* Error Message */}
                {vaultPasswordSetup.error && (
                  <div style={{ fontSize: 12, color: '#ef4444', marginTop: -8 }}>
                    {vaultPasswordSetup.error}
                  </div>
                )}

                {/* Submit Button */}
                <button
                  onClick={completeVaultPasswordSetup}
                  disabled={vaultPasswordSetup.isSubmitting || !vaultPasswordSetup.password || !vaultPasswordSetup.confirmPassword}
                  style={{
                    width: '100%',
                    padding: '14px',
                    background: (vaultPasswordSetup.password && vaultPasswordSetup.confirmPassword) 
                      ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' 
                      : 'rgba(255, 255, 255, 0.1)',
                    border: 'none',
                    borderRadius: 12,
                    fontSize: 14,
                    fontWeight: 600,
                    color: (vaultPasswordSetup.password && vaultPasswordSetup.confirmPassword) ? '#fff' : 'rgba(255, 255, 255, 0.3)',
                    cursor: vaultPasswordSetup.isSubmitting || !vaultPasswordSetup.password || !vaultPasswordSetup.confirmPassword ? 'not-allowed' : 'pointer'
                  }}
                >
                  {vaultPasswordSetup.isSubmitting ? 'Setting password...' : 'Set Password & Continue'}
                </button>

                {/* Cancel Button */}
                <button
                  onClick={() => {
                    setVaultPasswordSetup({ show: false, publicKey: '', password: '', confirmPassword: '', error: '', isSubmitting: false, layerToEnable: null })
                  }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    background: 'transparent',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: 12,
                    fontSize: 13,
                    color: 'rgba(255, 255, 255, 0.5)',
                    cursor: 'pointer'
                  }}
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </>
      )}

      {/* Header */}
      <div style={styles.header}>
        <div style={styles.headerTitle}>
          
          {/* Profile Picture - Clickable */}
          <div 
            onClick={() => setShowSidebar(true)}
            onTouchEnd={(e) => {
              e.preventDefault();
              setShowSidebar(true);
            }}
            style={{
              width: 42,
              height: 42,
              borderRadius: '50%',
              border: '2px solid rgba(255, 255, 255, 0.18)',
              overflow: 'hidden',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              boxSizing: 'content-box',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              position: 'relative',
              WebkitTapHighlightColor: 'transparent',
              touchAction: 'manipulation'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.4)'
              e.currentTarget.style.transform = 'scale(1.05)'
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.borderColor = 'rgba(255, 255, 255, 0.18)'
              e.currentTarget.style.transform = 'scale(1)'
            }}
          >
            <PlanetAvatar seed={walletAccounts[activeAccountIndex]?.isWatchOnly ? walletAccounts[activeAccountIndex]?.publicKey : wallet?.publicKey.toBase58() || "default"} size={42} />
            {walletAccounts[activeAccountIndex]?.isWatchOnly && (
              <div style={{
                position: 'absolute',
                inset: 0,
                background: 'rgba(0, 0, 0, 0.35)',
                borderRadius: '50%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" strokeWidth="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
              </div>
            )}
          </div>
          
          {/* Address Pill & Tooltip */}
          <div style={{ position: 'relative' }} ref={dropdownRef}>
            <div 
                style={styles.addressPill}
                onClick={() => setShowAddressTooltip(!showAddressTooltip)}
            >
                {walletAccounts[activeAccountIndex]?.isWatchOnly ? (
                  // Blue dot for watch-only
                  <div style={{
                    width: 8, 
                    height: 8, 
                    borderRadius: 4, 
                    background: '#3b82f6'
                  }}></div>
                ) : activeWallet === "vault" ? (
                  // Green lock for vault
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="#10b981" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0110 0v4"/>
                  </svg>
                ) : (
                  // Yellow/orange dot for master key
                  <div style={{
                    width: 8, 
                    height: 8, 
                    borderRadius: 4, 
                    background: '#f59e0b'
                  }}></div>
                )}
                {shortenAddress(
                  walletAccounts[activeAccountIndex]?.isWatchOnly 
                    ? walletAccounts[activeAccountIndex]?.publicKey 
                    : activeWallet === "vault" 
                      ? vaultPda 
                      : wallet?.publicKey.toBase58() || ""
                )}
                <span style={{ opacity: 0.4, fontSize: 10 }}>{showAddressTooltip ? "" : ""}</span>
            </div>
          </div>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            {/* Geo-Protection Toggle with Hover Tooltip */}
            <div 
                ref={geoToggleRef}
                style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: 8, 
                    opacity: multisigPda ? 1 : (balance > 0.02 ? 1 : 0.5),
                    cursor: multisigPda ? 'default' : (balance > 0.02 ? 'pointer' : 'not-allowed'),
                    filter: multisigPda ? 'none' : (balance > 0.02 ? 'none' : 'grayscale(0.5)'),
                    position: 'relative'
                }}
                onClick={() => {
                    // Direct click to activate if not already activated and has enough balance
                    if (!multisigPda && balance > 0.02) {
                        activateSecurity()
                    }
                }}
                onMouseEnter={() => !multisigPda && setShowGeoTooltip(true)}
                onMouseLeave={() => setShowGeoTooltip(false)}
            >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={multisigPda ? '#10b981' : 'rgba(255,255,255,0.5)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <div style={{
                    width: 38,
                    height: 22,
                    background: multisigPda ? '#10b981' : 'rgba(255, 255, 255, 0.1)',
                    borderRadius: 11,
                    position: 'relative',
                    transition: 'background 0.3s ease',
                    border: '1px solid rgba(255, 255, 255, 0.1)'
                }}>
                    <div style={{
                        width: 16,
                        height: 16,
                        background: '#fff',
                        borderRadius: 8,
                        position: 'absolute',
                        top: 2,
                        left: multisigPda ? 18 : 2,
                        transition: 'left 0.3s ease',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                    }} />
                </div>
            </div>

            {/* Lock Wallet button */}
            <button 
            onClick={async () => {
              // Clear the unlocked state and set wallet as locked
              localStorage.removeItem('geovault_wallet_unlocked');
              setWalletStatus({ isOnboarded: true, isLocked: true });
            }}
            style={{ background: 'rgba(255, 255, 255, 0.05)', border: '1px solid rgba(255, 255, 255, 0.1)', color: 'rgba(255, 255, 255, 0.6)', cursor: 'pointer', fontSize: 14, padding: '5px 7px', borderRadius: 8, display: 'flex', alignItems: 'center', justifyContent: 'center' }}
            title="Lock Wallet"
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0110 0v4"></path></svg>
            </button>
        </div>
      </div>

      {/* Wallet Dropdown - Rendered at root level for proper z-index (outside header backdrop-filter) */}
      {showAddressTooltip && (
        <div 
          ref={walletDropdownMenuRef}
          style={{
            position: 'absolute',
            top: 76,
            left: 16,
            width: 260,
            background: '#131318',
            border: '1px solid rgba(255, 255, 255, 0.15)',
            borderRadius: 16,
            padding: 8,
            zIndex: 9999,
            boxShadow: '0 12px 40px rgba(0, 0, 0, 1)'
          }}
        >
          {/* Master Row / Tracked Wallet Row */}
          <div 
            style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '10px 12px',
              borderRadius: 12,
              cursor: 'pointer',
              background: activeWallet === "master" ? 'rgba(255, 255, 255, 0.08)' : '#131318'
            }}
            onClick={() => {
              setActiveWallet("master")
              setShowAddressTooltip(false)
            }}
            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)'}
            onMouseLeave={(e) => e.currentTarget.style.background = activeWallet === "master" ? 'rgba(255, 255, 255, 0.08)' : '#131318'}
          >
            <div>
              <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 3, textTransform: 'uppercase', letterSpacing: '0.3px' }}>
                {walletAccounts[activeAccountIndex]?.isWatchOnly ? 'Tracked Wallet' : 'MasterKey'}
              </div>
              <div style={{ fontSize: 13, color: '#fff', fontFamily: 'monospace' }}>
                {shortenAddress(walletAccounts[activeAccountIndex]?.isWatchOnly 
                  ? walletAccounts[activeAccountIndex]?.publicKey 
                  : wallet?.publicKey.toBase58() || "")}
              </div>
            </div>
            <div 
              style={{ 
                color: 'rgba(255, 255, 255, 0.6)', 
                cursor: 'pointer', 
                padding: 8,
                marginRight: -4,
                borderRadius: 8,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}
              onClick={async (e) => {
                e.stopPropagation()
                e.preventDefault()
                const addressToCopy = walletAccounts[activeAccountIndex]?.isWatchOnly 
                  ? walletAccounts[activeAccountIndex]?.publicKey 
                  : wallet?.publicKey.toBase58() || ""
                copyToClipboardSafe(addressToCopy)
                setCopiedState("master")
                setTimeout(() => setCopiedState(null), 2000)
              }}
              onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.1)'}
              onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
            >
              {copiedState === "master" ? (
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
              ) : (
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
              )}
            </div>
          </div>

          {/* Vault Row */}
          {multisigPda && (
            <div 
              style={{ 
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '10px 12px',
                borderRadius: 12,
                cursor: 'pointer',
                marginTop: 4,
                background: activeWallet === "vault" ? 'rgba(255, 255, 255, 0.08)' : '#131318'
              }}
              onClick={() => {
                setActiveWallet("vault")
                setShowAddressTooltip(false)
              }}
              onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)'}
              onMouseLeave={(e) => e.currentTarget.style.background = activeWallet === "vault" ? 'rgba(255, 255, 255, 0.08)' : '#131318'}
            >
              <div>
                <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.5)', marginBottom: 3, textTransform: 'uppercase', letterSpacing: '0.3px' }}>ARGUS Vault</div>
                <div style={{ fontSize: 13, color: '#fff', fontFamily: 'monospace' }}>{shortenAddress(vaultPda)}</div>
              </div>
              <div 
                style={{ color: '#10b981', cursor: 'pointer', padding: 4 }}
                onClick={async (e) => {
                  e.stopPropagation()
                  copyToClipboardSafe(vaultPda)
                  setCopiedState("vault")
                  setTimeout(() => setCopiedState(null), 2000)
                }}
              >
                {copiedState === "vault" ? (
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                ) : (
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                )}
              </div>
            </div>
          )}
        </div>
      )}

      {/* Geo-Protection Hover Tooltip - Rendered at root level for proper z-index */}
      {showGeoTooltip && !multisigPda && (
        <div 
          style={{
            position: 'absolute',
            top: 76,
            left: 16,
            right: 16,
            background: '#1a1a1f',
            border: '1px solid rgba(255, 255, 255, 0.1)',
            borderRadius: 16,
            padding: 16,
            zIndex: 9999,
            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.9)'
          }}
          onMouseEnter={() => setShowGeoTooltip(true)}
          onMouseLeave={() => setShowGeoTooltip(false)}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 10 }}>
            <div style={{ width: 28, height: 28, borderRadius: 8, background: 'rgba(16, 185, 129, 0.15)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            </div>
            <span style={{ fontSize: 14, fontWeight: 600, color: '#fff' }}>Enable Geo-Protection</span>
          </div>
          <p style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)', margin: '0 0 12px 0', lineHeight: '1.5' }}>
            Lock your funds to your physical location with ZK-verified proofs.
          </p>
          {balance > 0.02 ? (
            <div 
              style={{ fontSize: 11, color: '#10b981', display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}
              onClick={() => { setShowGeoTooltip(false); activateSecurity(); }}
            >
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
              Click to activate
            </div>
          ) : (
            <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', background: 'rgba(255, 255, 255, 0.05)', padding: '8px 10px', borderRadius: 8, textAlign: 'center' }}>
              Requires ~0.02 SOL for setup fees
            </div>
          )}
        </div>
      )}

      {/* Balance Section */}
      <div style={{...styles.balanceContainer, position: 'relative'}}>
        {/* Watch Only Badge - Above Total Balance label */}
        {walletAccounts[activeAccountIndex]?.isWatchOnly && (
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 4,
            padding: '3px 10px',
            marginBottom: 6,
            background: 'rgba(59, 130, 246, 0.08)',
            border: '1px solid rgba(59, 130, 246, 0.15)',
            borderRadius: 12,
          }}>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
              <circle cx="12" cy="12" r="3" />
            </svg>
            <span style={{ fontSize: 10, color: '#3b82f6', fontWeight: 500 }}>{t('watchOnly', lang)}</span>
          </div>
        )}
        <div style={styles.balanceLabel}>{t('totalBalance', lang)}</div>
        <div style={styles.balanceValue}>
          {formatCurrency(((activeWallet === "vault" ? vaultBalance : balance) * (solPrice || 0)) + tokens.reduce((sum, token) => sum + (token.value || 0), 0))}
        </div>
        <div style={styles.balanceChange}>
          +{formatCurrency((((activeWallet === "vault" ? vaultBalance : balance) * (solPrice || 0)) + tokens.reduce((sum, token) => sum + (token.value || 0), 0)) * 0.01)} +1.00%
        </div>
      </div>

      {/* Security Status Icons - Horizontal row above action buttons */}
      {activeWallet === "vault" && multisigPda && (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: 8,
          marginBottom: 14,
          paddingTop: 2
        }}>
          {/* Geo Icon */}
          <div 
            onClick={() => {
              setEditingWallet(walletAccounts[activeAccountIndex])
              setView("edit-wallet")
            }}
            style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              width: 28,
              height: 28,
              borderRadius: 8,
              background: securitySettings?.geoEnabled ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255, 255, 255, 0.03)',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              border: securitySettings?.geoEnabled ? '1px solid rgba(16, 185, 129, 0.15)' : '1px solid rgba(255, 255, 255, 0.05)'
            }}
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.geoEnabled ? '#10b981' : 'rgba(255,255,255,0.3)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="10" r="3"/>
              <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/>
            </svg>
          </div>
          {/* Bluetooth Icon */}
          <div 
            onClick={() => {
              setEditingWallet(walletAccounts[activeAccountIndex])
              setView("edit-wallet")
            }}
            style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              width: 28,
              height: 28,
              borderRadius: 8,
              background: securitySettings?.bluetoothEnabled ? 'rgba(59, 130, 246, 0.1)' : 'rgba(255, 255, 255, 0.03)',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              border: securitySettings?.bluetoothEnabled ? '1px solid rgba(59, 130, 246, 0.15)' : '1px solid rgba(255, 255, 255, 0.05)'
            }}
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.bluetoothEnabled ? '#3b82f6' : 'rgba(255,255,255,0.3)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
            </svg>
          </div>
          {/* WiFi/Mobile Icon */}
          <div 
            onClick={() => {
              setEditingWallet(walletAccounts[activeAccountIndex])
              setView("edit-wallet")
            }}
            style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              width: 28,
              height: 28,
              borderRadius: 8,
              background: securitySettings?.wifiEnabled ? 'rgba(245, 158, 11, 0.1)' : 'rgba(255, 255, 255, 0.03)',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              border: securitySettings?.wifiEnabled ? '1px solid rgba(245, 158, 11, 0.15)' : '1px solid rgba(255, 255, 255, 0.05)'
            }}
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.wifiEnabled ? '#f59e0b' : 'rgba(255,255,255,0.3)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M5 12.55a11 11 0 0 1 14.08 0"/>
              <path d="M1.42 9a16 16 0 0 1 21.16 0"/>
              <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
              <circle cx="12" cy="20" r="1"/>
            </svg>
          </div>
          {/* USB Icon */}
          <div 
            onClick={() => {
              setEditingWallet(walletAccounts[activeAccountIndex])
              setView("edit-wallet")
            }}
            style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              width: 28,
              height: 28,
              borderRadius: 8,
              background: securitySettings?.usbEnabled ? 'rgba(168, 85, 247, 0.1)' : 'rgba(255, 255, 255, 0.03)',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              border: securitySettings?.usbEnabled ? '1px solid rgba(168, 85, 247, 0.15)' : '1px solid rgba(255, 255, 255, 0.05)'
            }}
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.usbEnabled ? '#a855f7' : 'rgba(255,255,255,0.3)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M12 18v-6"/>
              <path d="M8 18v-1"/>
              <path d="M16 18v-1"/>
              <rect x="6" y="18" width="12" height="4" rx="1"/>
              <path d="M12 12a2 2 0 100-4 2 2 0 000 4z"/>
              <path d="M12 2v6"/>
            </svg>
          </div>
          {/* Biometric Icon (Happy Face) */}
          <div 
            onClick={() => {
              setEditingWallet(walletAccounts[activeAccountIndex])
              setView("edit-wallet")
            }}
            style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              width: 28,
              height: 28,
              borderRadius: 8,
              background: securitySettings?.biometricEnabled ? 'rgba(236, 72, 153, 0.1)' : 'rgba(255, 255, 255, 0.03)',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              border: securitySettings?.biometricEnabled ? '1px solid rgba(236, 72, 153, 0.15)' : '1px solid rgba(255, 255, 255, 0.05)'
            }}
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.biometricEnabled ? '#ec4899' : 'rgba(255,255,255,0.3)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
              <line x1="9" y1="9" x2="9.01" y2="9"/>
              <line x1="15" y1="9" x2="15.01" y2="9"/>
            </svg>
          </div>
          {/* Voice Layer Icon (Microphone) */}
          <div 
            onClick={() => {
              setEditingWallet(walletAccounts[activeAccountIndex])
              setView("edit-wallet")
            }}
            style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              width: 28,
              height: 28,
              borderRadius: 8,
              background: securitySettings?.voiceLayerEnabled ? 'rgba(34, 197, 94, 0.1)' : 'rgba(255, 255, 255, 0.03)',
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              border: securitySettings?.voiceLayerEnabled ? '1px solid rgba(34, 197, 94, 0.15)' : '1px solid rgba(255, 255, 255, 0.05)'
            }}
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke={securitySettings?.voiceLayerEnabled ? '#22c55e' : 'rgba(255,255,255,0.3)'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" y1="19" x2="12" y2="23"/>
              <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
          </div>
        </div>
      )}

      {/* Action Buttons - Hidden for watch-only wallets */}
      {!walletAccounts[activeAccountIndex]?.isWatchOnly && (
        <div style={styles.actionButtons}>
          <button style={styles.actionButton} onClick={() => setView("receive")}>
            <div style={styles.actionIcon}></div>
            <span style={styles.actionLabel}>{t('receive', lang)}</span>
          </button>
          <button style={styles.actionButton} onClick={() => setView("send")}>
            <div style={styles.actionIcon}></div>
            <span style={styles.actionLabel}>{t('send', lang)}</span>
          </button>
          <div style={{ position: 'relative' }}>
            <button 
              style={{
                ...styles.actionButton,
                ...(activeWallet === "vault" ? { opacity: 0.5, cursor: 'not-allowed' } : {})
              }} 
              onClick={activeWallet === "vault" ? undefined : async () => {
                // Set default tokens: SOL -> ARGUS
                const solToken = {
                  mint: "So11111111111111111111111111111111111111112",
                  symbol: "SOL",
                  name: "Solana",
                  amount: activeWallet === "master" ? balance : vaultBalance,
                  decimals: 9,
                  price: solPrice,
                  value: (activeWallet === "master" ? balance : vaultBalance) * solPrice,
                  logoURI: "https://assets.coingecko.com/coins/images/4128/standard/solana.png"
                }
                setSwapFromToken(solToken)
                setSwapToToken(ARGUS_TOKEN)
                setSwapFromTokenDetail(null)
                setSwapToTokenDetail(null)
                setView("swap")
                // Fetch ARGUS detail data in background
                try {
                  const argusDetail = await fetchTokenDetailData(ARGUS_TOKEN.mint)
                  if (argusDetail) setSwapToTokenDetail(argusDetail)
                } catch (e) { console.log('Failed to fetch ARGUS detail') }
              }}
              onMouseEnter={(e) => {
                if (activeWallet === "vault") {
                  const tooltip = e.currentTarget.parentElement?.querySelector('.vault-swap-tooltip') as HTMLElement;
                  if (tooltip) tooltip.style.opacity = '1';
                }
              }}
              onMouseLeave={(e) => {
                const tooltip = e.currentTarget.parentElement?.querySelector('.vault-swap-tooltip') as HTMLElement;
                if (tooltip) tooltip.style.opacity = '0';
              }}
            >
              <div style={styles.actionIcon}></div>
              <span style={styles.actionLabel}>{t('swap', lang)}</span>
            </button>
            {activeWallet === "vault" && (
              <div 
                className="vault-swap-tooltip"
                style={{
                  position: 'absolute',
                  bottom: '100%',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  marginBottom: 8,
                  padding: '8px 12px',
                  background: 'rgba(0, 0, 0, 0.9)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: 8,
                  fontSize: 11,
                  color: 'rgba(255, 255, 255, 0.8)',
                  whiteSpace: 'nowrap',
                  opacity: 0,
                  transition: 'opacity 0.2s ease',
                  pointerEvents: 'none',
                  zIndex: 100
                }}
              >
                Vault Swap Coming Soon
              </div>
            )}
          </div>
          <button style={styles.actionButton} onClick={() => {
            // Navigate to buy view with Phantom-like selection UI
            setBuySelectedToken(buyableTokens[0]) // Default to SOL
            setBuyAmount("50")
            setBuyPaymentMethod("card")
            setView("buy")
          }}>
            <div style={styles.actionIcon}>$</div>
            <span style={styles.actionLabel}>{t('buy', lang)}</span>
          </button>
        </div>
      )}

      {/* Tabs */}
      <div style={styles.tabs}>
        <div style={activeTab === 'tokens' ? styles.tab : styles.inactiveTab} onClick={() => setActiveTab('tokens')}>{t('tokens', lang)}</div>
        <div style={activeTab === 'activity' ? styles.tab : styles.inactiveTab} onClick={() => setActiveTab('activity')}>{t('activity', lang)}</div>
      </div>

      {/* Content */}
      {activeTab === 'tokens' ? (
        <div style={styles.tokenList}>
            <div style={styles.tokenItem}>
            <div style={{...styles.tokenIcon, background: 'rgba(255, 255, 255, 0.05)', borderRadius: 12}}>
                <img 
                  src="https://assets.coingecko.com/coins/images/4128/standard/solana.png" 
                  alt="SOL" 
                  style={{width: 28, height: 28, borderRadius: 8}} 
                />
            </div>
            <div style={styles.tokenInfo}>
                <div style={styles.tokenName}>Solana</div>
                <div style={styles.tokenAmount}>{((activeWallet === "vault" ? vaultBalance : balance) === 0 ? '0.00' : (activeWallet === "vault" ? vaultBalance : balance).toFixed(4))} SOL</div>
            </div>
            <div style={styles.tokenValue}>
                <div style={styles.tokenValueText}>{formatCurrency((activeWallet === "vault" ? vaultBalance : balance) * (solPrice || 0))}</div>
                <div style={styles.tokenChange}>+0.00%</div>
            </div>
            </div>

            {/* ARGUS Token - Always visible, shows real balance if held */}
            {(() => {
              const argusToken = tokens.find(t => t.mint === ARGUS_TOKEN.mint);
              const argusBalance = argusToken?.amount || 0;
              const argusValue = argusToken?.value || 0;
              
              return (
                <div 
                  style={{
                    ...styles.tokenItem,
                    cursor: argusToken ? 'pointer' : 'default'
                  }}
                  onClick={() => {
                    if (argusToken) {
                      setSelectedToken(argusToken);
                      setView("token-detail");
                    }
                  }}
                >
                  <div style={styles.tokenIcon}>
                    <img 
                      src="/assets/arguslogo.png"
                      alt="ARGUS" 
                      style={{width: '100%', height: '100%', borderRadius: 12}} 
                      onError={(e) => {
                        e.currentTarget.style.display = 'none';
                        e.currentTarget.parentElement!.innerHTML = '<div style="width:100%;height:100%;border-radius:12px;background:linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff;font-size:10px">ARGUS</div>';
                      }}
                    />
                  </div>
                  <div style={styles.tokenInfo}>
                    <div style={styles.tokenName}>ARGUS</div>
                    <div style={styles.tokenAmount}>{argusBalance > 0 ? argusBalance.toLocaleString(undefined, { maximumFractionDigits: 2 }) : '0.00'} ARGUS</div>
                  </div>
                  <div style={styles.tokenValue}>
                    <div style={styles.tokenValueText}>{formatCurrency(argusValue)}</div>
                    <div style={{
                      ...styles.tokenChange,
                      color: (argusToken?.change24h || 0) >= 0 ? '#22c55e' : '#ef4444'
                    }}>
                      {(argusToken?.change24h || 0) >= 0 ? '+' : ''}{(argusToken?.change24h || 0).toFixed(2)}%
                    </div>
                  </div>
                </div>
              );
            })()}
            
            {/* SPL Tokens (excluding ARGUS since it's shown above) */}
            {tokens.filter(t => t.mint !== ARGUS_TOKEN.mint).map((token) => (
                <div key={token.mint} style={{
                    ...styles.tokenItem,
                    position: 'relative' as const,
                    overflow: 'hidden',
                    cursor: 'pointer'
                }}
                onClick={() => {
                    setSelectedToken(token);
                    setView("token-detail");
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.06)'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.03)'}
                >
                    {/* Banner Background */}
                    {token.bannerURI && (
                        <div style={{
                            position: 'absolute',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundImage: `url(${token.bannerURI})`,
                            backgroundSize: 'cover',
                            backgroundPosition: 'center',
                            opacity: 0.15,
                            zIndex: 0
                        }} />
                    )}
                    <div style={{...styles.tokenIcon, position: 'relative', zIndex: 1, flexShrink: 0}}>
                        {token.logoURI && !failedLogos.has(token.mint) ? (
                            <img 
                              src={token.logoURI} 
                              alt={token.symbol} 
                              width={42}
                              height={42}
                              style={{borderRadius: 12}} 
                              onLoad={() => {
                                // Cache successful logo for future loads
                                cacheSuccessfulLogo(token.mint, token.logoURI!, token.symbol, token.name);
                              }}
                              onError={() => {
                                // Mark this logo as failed and cache it
                                setFailedLogos(prev => new Set(prev).add(token.mint));
                                cacheFailedLogo(token.mint, token.symbol, token.name);
                              }}
                            />
                        ) : (
                          <div style={{
                            width: 42, 
                            height: 42, 
                            borderRadius: 12, 
                            background: 'rgba(255, 255, 255, 0.1)', 
                            display: 'flex', 
                            alignItems: 'center', 
                            justifyContent: 'center', 
                            fontSize: 14, 
                            fontWeight: 600,
                            color: 'rgba(255, 255, 255, 0.6)'
                          }}>
                            {token.symbol?.[0] || '?'}
                          </div>
                        )}
                    </div>
                    <div style={{...styles.tokenInfo, position: 'relative', zIndex: 1}}>
                        <div style={styles.tokenName}>{token.name}</div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                          <span style={styles.tokenAmount}>{token.amount.toFixed(4)} {token.symbol}</span>
                        </div>
                    </div>
                    <div style={{...styles.tokenValue, position: 'relative', zIndex: 1}}>
                        <div style={styles.tokenValueText}>{formatCurrency(token.value)}</div>
                        <div style={styles.tokenChange}>{token.change24h ? `${token.change24h >= 0 ? '+' : ''}${token.change24h.toFixed(2)}%` : '0.00%'}</div>
                    </div>
                </div>
            ))}
        </div>
      ) : (
        <div style={{ padding: 20 }}>
          {loadingTxs ? (
            <div style={{ textAlign: 'center', color: 'rgba(255, 255, 255, 0.4)', marginTop: 40 }}>
              <div style={{ fontSize: 14, marginBottom: 16 }}>{t('loadingTransactions', lang)}</div>
            </div>
          ) : transactions.length > 0 ? (
            <div>
              {transactions.map((tx, i) => (
                <div
                  key={tx.signature}
                  style={{
                    padding: '14px 16px',
                    marginBottom: '8px',
                    background: 'rgba(255, 255, 255, 0.03)',
                    border: '1px solid rgba(255, 255, 255, 0.05)',
                    borderRadius: '16px',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                  }}
                  onClick={() => setSelectedTransaction(tx)}
                  onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.06)'}
                  onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255, 255, 255, 0.03)'}
                >
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                      {/* Transaction Type Icon */}
                      <div style={{
                        width: 40,
                        height: 40,
                        borderRadius: 12,
                        background: tx.type === 'vault-proposal' || tx.type === 'vault-execute' ? 'rgba(255, 255, 255, 0.08)' : tx.type === 'swap' ? 'rgba(255, 255, 255, 0.08)' : tx.type === 'receive' ? 'rgba(16, 185, 129, 0.15)' : tx.type === 'send' ? 'rgba(239, 68, 68, 0.15)' : 'rgba(255, 255, 255, 0.1)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        overflow: 'hidden'
                      }}>
                        {tx.type === 'vault-proposal' || tx.type === 'vault-execute' ? (
                          <img src={getAssetUrl('assets/squads-logo.png')} alt="Squads" style={{ width: 24, height: 24, objectFit: 'contain', filter: 'brightness(0) invert(1)' }} />
                        ) : (
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke={tx.type === 'swap' ? 'rgba(255, 255, 255, 0.7)' : tx.type === 'receive' ? '#10b981' : tx.type === 'send' ? '#ef4444' : '#fff'} strokeWidth="2">
                            {tx.type === 'swap' ? (
                              <><path d="M7 16V4M7 4L3 8M7 4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/></>
                            ) : tx.type === 'receive' ? (
                              <><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></>
                            ) : tx.type === 'send' ? (
                              <><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></>
                            ) : (
                              <><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></>
                            )}
                          </svg>
                        )}
                      </div>
                      <div>
                        <div style={{ fontSize: '14px', fontWeight: '500', marginBottom: '4px' }}>
                          {tx.type === 'vault-proposal' ? 'Vault Proposal' : tx.type === 'vault-execute' ? 'Vault Execution' : tx.type === 'swap' ? 'Swap' : tx.type === 'receive' ? 'Received' : tx.type === 'send' ? 'Sent' : 'Transaction'}
                        </div>
                        <div style={{ fontSize: '11px', color: 'rgba(255, 255, 255, 0.4)' }}>
                          {new Date(tx.timestamp).toLocaleDateString()} {new Date(tx.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </div>
                      </div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{
                        fontSize: '14px',
                        fontWeight: '600',
                        color: tx.type === 'vault-proposal' || tx.type === 'vault-execute' ? 'rgba(255, 255, 255, 0.7)' : tx.type === 'swap' ? '#fff' : tx.type === 'receive' ? '#10b981' : tx.type === 'send' ? '#ef4444' : '#fff',
                        marginBottom: '4px'
                      }}>
                        {tx.type === 'swap' ? '' : tx.type === 'receive' ? '+' : tx.type === 'send' || tx.type === 'vault-proposal' || tx.type === 'vault-execute' ? '-' : ''}{tx.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 })} SOL
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'flex-end', gap: 4 }}>
                        {/* Show shield icon if vault transaction */}
                        {activeWallet === 'vault' && tx.type === 'send' && (
                          <svg width="11" height="11" viewBox="0 0 24 24" fill="#10b981" stroke="none">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                          </svg>
                        )}
                        <span style={{ fontSize: '11px', color: tx.status === 'success' ? '#10b981' : '#ef4444' }}>
                          {tx.status === 'success' ? 'Success' : 'Failed'}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div style={{ textAlign: 'center', color: 'rgba(255, 255, 255, 0.4)', marginTop: 40 }}>
              <div style={{ fontSize: 14 }}>No recent transactions</div>
            </div>
          )}
        </div>
      )}

      {/* Transaction Detail Modal */}
      {selectedTransaction && (
        <div style={{
          position: 'fixed',
          inset: 0,
          backgroundColor: '#121216',
          zIndex: 10000,
          display: 'flex',
          flexDirection: 'column'
        }}>
          {/* Scrollable Content */}
          <div style={{
            padding: '16px 20px',
            width: '100%',
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            overflowY: 'auto'
          }}>
            {/* Header */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16, flexShrink: 0 }}>
              <h2 style={{ fontSize: 17, fontWeight: 600, margin: 0 }}>Transaction Details</h2>
              <button onClick={() => setSelectedTransaction(null)} style={{
                background: 'rgba(255, 255, 255, 0.1)',
                border: 'none',
                borderRadius: 8,
                width: 32,
                height: 32,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                color: 'rgba(255, 255, 255, 0.6)'
              }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>

            {/* Transaction Icon & Amount */}
            <div style={{ textAlign: 'center', marginBottom: 16 }}>
              <div style={{
                width: 56,
                height: 56,
                borderRadius: 16,
                background: selectedTransaction.type === 'vault-proposal' || selectedTransaction.type === 'vault-execute' ? 'rgba(255, 255, 255, 0.08)' : selectedTransaction.type === 'swap' ? 'rgba(255, 255, 255, 0.08)' : selectedTransaction.type === 'receive' ? 'rgba(16, 185, 129, 0.15)' : selectedTransaction.type === 'send' ? 'rgba(239, 68, 68, 0.15)' : 'rgba(255, 255, 255, 0.1)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                margin: '0 auto 12px'
              }}>
                {selectedTransaction.type === 'vault-proposal' || selectedTransaction.type === 'vault-execute' ? (
                  <img src={getAssetUrl('assets/squads-logo.png')} alt="Squads" style={{ width: 32, height: 32, objectFit: 'contain', filter: 'brightness(0) invert(1)' }} />
                ) : (
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke={selectedTransaction.type === 'swap' ? 'rgba(255, 255, 255, 0.7)' : selectedTransaction.type === 'receive' ? '#10b981' : selectedTransaction.type === 'send' ? '#ef4444' : '#fff'} strokeWidth="2">
                    {selectedTransaction.type === 'swap' ? (
                      <><path d="M7 16V4M7 4L3 8M7 4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/></>
                    ) : selectedTransaction.type === 'receive' ? (
                      <><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></>
                    ) : selectedTransaction.type === 'send' ? (
                      <><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></>
                    ) : (
                      <><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></>
                    )}
                  </svg>
                )}
              </div>
              <div style={{
                fontSize: 24,
                fontWeight: 700,
                color: selectedTransaction.type === 'vault-proposal' || selectedTransaction.type === 'vault-execute' ? 'rgba(255, 255, 255, 0.7)' : selectedTransaction.type === 'swap' ? '#fff' : selectedTransaction.type === 'receive' ? '#10b981' : selectedTransaction.type === 'send' ? '#ef4444' : '#fff',
                marginBottom: 2
              }}>
                {selectedTransaction.type === 'vault-proposal' || selectedTransaction.type === 'vault-execute' ? '-' : selectedTransaction.type === 'swap' ? '' : selectedTransaction.type === 'receive' ? '+' : selectedTransaction.type === 'send' ? '-' : ''}{selectedTransaction.amount.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 6 })} SOL
              </div>
              <div style={{ fontSize: 13, color: 'rgba(255, 255, 255, 0.5)' }}>
                 {formatCurrency(selectedTransaction.amount * (solPrice || 0))}
              </div>
            </div>

            {/* Status Badge */}
            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: 16 }}>
              <div style={{
                padding: '6px 14px',
                borderRadius: 20,
                background: selectedTransaction.status === 'success' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)',
                border: `1px solid ${selectedTransaction.status === 'success' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'}`,
                display: 'flex',
                alignItems: 'center',
                gap: 6
              }}>
                <div style={{
                  width: 8,
                  height: 8,
                  borderRadius: '50%',
                  background: selectedTransaction.status === 'success' ? '#10b981' : '#ef4444'
                }} />
                <span style={{ fontSize: 13, fontWeight: 500, color: selectedTransaction.status === 'success' ? '#10b981' : '#ef4444' }}>
                  {selectedTransaction.status === 'success' ? 'Confirmed' : 'Failed'}
                </span>
              </div>
            </div>

            {/* Details */}
            <div style={{ background: 'rgba(255, 255, 255, 0.03)', borderRadius: 12, padding: 14, marginBottom: 12 }}>
              {/* Type */}
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 10 }}>
                <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>Type</span>
                <span style={{ fontSize: 12, fontWeight: 500 }}>
                  {selectedTransaction.type === 'vault-proposal' ? 'Vault Proposal' : selectedTransaction.type === 'vault-execute' ? 'Vault Execution' : selectedTransaction.type === 'swap' ? 'Swap' : selectedTransaction.type === 'receive' ? 'Received' : selectedTransaction.type === 'send' ? 'Sent' : 'Transaction'}
                </span>
              </div>
              
              {/* Date */}
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 10 }}>
                <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>Date</span>
                <span style={{ fontSize: 12, fontWeight: 500 }}>
                  {new Date(selectedTransaction.timestamp).toLocaleDateString()} {new Date(selectedTransaction.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </span>
              </div>

              {/* From Address */}
              {selectedTransaction.from && (
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 10 }}>
                  <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>From</span>
                  <span style={{ fontSize: 12, fontWeight: 500, fontFamily: 'monospace' }}>
                    {selectedTransaction.from.slice(0, 4)}...{selectedTransaction.from.slice(-4)}
                  </span>
                </div>
              )}

              {/* To Address */}
              {selectedTransaction.to && (
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 10 }}>
                  <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>To</span>
                  <span style={{ fontSize: 12, fontWeight: 500, fontFamily: 'monospace' }}>
                    {selectedTransaction.to.slice(0, 4)}...{selectedTransaction.to.slice(-4)}
                  </span>
                </div>
              )}

              {/* Signature */}
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.5)' }}>Signature</span>
                <span 
                  style={{ fontSize: 12, fontWeight: 500, fontFamily: 'monospace', color: '#3b82f6', cursor: 'pointer' }}
                  onClick={async () => {
                    copyToClipboardSafe(selectedTransaction.signature);
                  }}
                >
                  {selectedTransaction.signature.slice(0, 4)}...{selectedTransaction.signature.slice(-4)}
                  <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginLeft: 4, verticalAlign: 'middle' }}>
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                  </svg>
                </span>
              </div>
            </div>

            {/* Squads Info - Only for vault transactions */}
            {(selectedTransaction.type === 'vault-proposal' || selectedTransaction.type === 'vault-execute') && (
              <div style={{ 
                background: 'rgba(255, 255, 255, 0.03)', 
                borderRadius: 12, 
                padding: 12, 
                marginBottom: 12,
                border: '1px solid rgba(255, 255, 255, 0.05)'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }}>
                  <img src={getAssetUrl('assets/squads-logo.png')} alt="Squads" style={{ width: 16, height: 16, filter: 'brightness(0) invert(1)', opacity: 0.7 }} />
                  <span style={{ fontSize: 12, fontWeight: 600, color: 'rgba(255, 255, 255, 0.7)' }}>Powered by Squads</span>
                </div>
                <div style={{ fontSize: 11, color: 'rgba(255, 255, 255, 0.4)', lineHeight: 1.4 }}>
                  {selectedTransaction.type === 'vault-proposal' 
                    ? 'This transaction created a vault proposal and requested approval from the Argus security server. The proposal was verified against your geo-fence settings.'
                    : 'This transaction executed the approved vault proposal, transferring funds from your protected vault after security verification was complete.'}
                </div>
              </div>
            )}

            {/* Security Layers - Only show for vault outgoing transactions */}
            {activeWallet === 'vault' && selectedTransaction.type === 'send' && (
              <div style={{ marginBottom: 20 }}>
                <div style={{ fontSize: 12, color: 'rgba(255, 255, 255, 0.4)', marginBottom: 10, textAlign: 'center' }}>
                  Protected by Security Layers
                </div>
                <div style={{ display: 'flex', justifyContent: 'center', gap: 8, flexWrap: 'wrap' }}>
                  {/* Voice */}
                  <div style={{ 
                    display: 'flex', alignItems: 'center', gap: 5, padding: '6px 10px', 
                    background: 'rgba(139, 92, 246, 0.15)', border: '1px solid rgba(139, 92, 246, 0.3)',
                    borderRadius: 8
                  }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2">
                      <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/>
                    </svg>
                    <span style={{ fontSize: 11, color: '#8b5cf6', fontWeight: 500 }}>Voice</span>
                  </div>
                  {/* Geo */}
                  <div style={{ 
                    display: 'flex', alignItems: 'center', gap: 5, padding: '6px 10px', 
                    background: 'rgba(59, 130, 246, 0.15)', border: '1px solid rgba(59, 130, 246, 0.3)',
                    borderRadius: 8
                  }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2">
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                    </svg>
                    <span style={{ fontSize: 11, color: '#3b82f6', fontWeight: 500 }}>Geo</span>
                  </div>
                  {/* USB */}
                  <div style={{ 
                    display: 'flex', alignItems: 'center', gap: 5, padding: '6px 10px', 
                    background: 'rgba(245, 158, 11, 0.15)', border: '1px solid rgba(245, 158, 11, 0.3)',
                    borderRadius: 8
                  }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2">
                      <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                    </svg>
                    <span style={{ fontSize: 11, color: '#f59e0b', fontWeight: 500 }}>USB</span>
                  </div>
                  {/* Bluetooth */}
                  <div style={{ 
                    display: 'flex', alignItems: 'center', gap: 5, padding: '6px 10px', 
                    background: 'rgba(6, 182, 212, 0.15)', border: '1px solid rgba(6, 182, 212, 0.3)',
                    borderRadius: 8
                  }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" strokeWidth="2">
                      <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
                    </svg>
                    <span style={{ fontSize: 11, color: '#06b6d4', fontWeight: 500 }}>BT</span>
                  </div>
                  {/* WiFi/2FA */}
                  <div style={{ 
                    display: 'flex', alignItems: 'center', gap: 5, padding: '6px 10px', 
                    background: 'rgba(16, 185, 129, 0.15)', border: '1px solid rgba(16, 185, 129, 0.3)',
                    borderRadius: 8
                  }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                      <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>
                    </svg>
                    <span style={{ fontSize: 11, color: '#10b981', fontWeight: 500 }}>2FA</span>
                  </div>
                  {/* Biometric */}
                  <div style={{ 
                    display: 'flex', alignItems: 'center', gap: 5, padding: '6px 10px', 
                    background: 'rgba(236, 72, 153, 0.15)', border: '1px solid rgba(236, 72, 153, 0.3)',
                    borderRadius: 8
                  }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ec4899" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M12 11c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2"/><path d="M16 11c0-1.1-.9-2-2-2"/><path d="M20 11c0-4.4-3.6-8-8-8s-8 3.6-8 8"/><path d="M4 11v3a8 8 0 0 0 16 0v-3"/>
                    </svg>
                    <span style={{ fontSize: 11, color: '#ec4899', fontWeight: 500 }}>Bio</span>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Fixed Footer - View on Orb Button */}
          <div style={{ 
            padding: '16px 20px', 
            borderTop: '1px solid rgba(255, 255, 255, 0.06)',
            flexShrink: 0,
            background: '#121216'
          }}>
            <button
              onClick={() => window.open(`https://orb.helius.dev/tx/${selectedTransaction.signature}?tab=summary`, '_blank')}
              style={{
                width: '100%',
                padding: '14px 16px',
                background: 'rgba(255, 255, 255, 0.05)',
                border: '1px solid rgba(255, 255, 255, 0.1)',
                borderRadius: 12,
                color: 'rgba(255, 255, 255, 0.8)',
                fontSize: 14,
                fontWeight: 500,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: 8,
                transition: 'all 0.2s ease'
              }}
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
              </svg>
              View on Orb
            </button>
          </div>
        </div>
      )}

      <div style={{
          textAlign: "center",
          fontSize: "10px",
          color: "rgba(255, 255, 255, 0.15)",
          padding: "12px 0 8px 0"
        }}>
          v1.0.2 Mobile Beta
        </div>
    </div>
  )
}

export default IndexPopup
